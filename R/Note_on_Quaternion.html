<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.0.36">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">

<meta name="author" content="Oliver Dürr">

<title>Notes on Rotations and Quaternions</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
span.underline{text-decoration: underline;}
div.column{display: inline-block; vertical-align: top; width: 50%;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
    color: #aaaaaa;
  }
pre.numberSource { margin-left: 3em; border-left: 1px solid #aaaaaa;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
code span.al { color: #ff0000; font-weight: bold; } /* Alert */
code span.an { color: #60a0b0; font-weight: bold; font-style: italic; } /* Annotation */
code span.at { color: #7d9029; } /* Attribute */
code span.bn { color: #40a070; } /* BaseN */
code span.bu { } /* BuiltIn */
code span.cf { color: #007020; font-weight: bold; } /* ControlFlow */
code span.ch { color: #4070a0; } /* Char */
code span.cn { color: #880000; } /* Constant */
code span.co { color: #60a0b0; font-style: italic; } /* Comment */
code span.cv { color: #60a0b0; font-weight: bold; font-style: italic; } /* CommentVar */
code span.do { color: #ba2121; font-style: italic; } /* Documentation */
code span.dt { color: #902000; } /* DataType */
code span.dv { color: #40a070; } /* DecVal */
code span.er { color: #ff0000; font-weight: bold; } /* Error */
code span.ex { } /* Extension */
code span.fl { color: #40a070; } /* Float */
code span.fu { color: #06287e; } /* Function */
code span.im { } /* Import */
code span.in { color: #60a0b0; font-weight: bold; font-style: italic; } /* Information */
code span.kw { color: #007020; font-weight: bold; } /* Keyword */
code span.op { color: #666666; } /* Operator */
code span.ot { color: #007020; } /* Other */
code span.pp { color: #bc7a00; } /* Preprocessor */
code span.sc { color: #4070a0; } /* SpecialChar */
code span.ss { color: #bb6688; } /* SpecialString */
code span.st { color: #4070a0; } /* String */
code span.va { color: #19177c; } /* Variable */
code span.vs { color: #4070a0; } /* VerbatimString */
code span.wa { color: #60a0b0; font-weight: bold; font-style: italic; } /* Warning */
</style>


<script src="Note_on_Quaternion_files/libs/clipboard/clipboard.min.js"></script>
<script src="Note_on_Quaternion_files/libs/quarto-html/quarto.js"></script>
<script src="Note_on_Quaternion_files/libs/quarto-html/popper.min.js"></script>
<script src="Note_on_Quaternion_files/libs/quarto-html/tippy.umd.min.js"></script>
<script src="Note_on_Quaternion_files/libs/quarto-html/anchor.min.js"></script>
<link href="Note_on_Quaternion_files/libs/quarto-html/tippy.css" rel="stylesheet">
<link href="Note_on_Quaternion_files/libs/quarto-html/quarto-syntax-highlighting.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="Note_on_Quaternion_files/libs/bootstrap/bootstrap.min.js"></script>
<link href="Note_on_Quaternion_files/libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="Note_on_Quaternion_files/libs/bootstrap/bootstrap.min.css" rel="stylesheet" id="quarto-bootstrap" data-mode="light">

  <script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-chtml-full.js" type="text/javascript"></script>

</head>

<body class="fullcontent">

<div id="quarto-content" class="page-columns page-rows-contents page-layout-article">

<main class="content" id="quarto-document-content">

<header id="title-block-header" class="quarto-title-block default">
<div class="quarto-title">
<h1 class="title">Notes on Rotations and Quaternions</h1>
</div>



<div class="quarto-title-meta">

    <div>
    <div class="quarto-title-meta-heading">Author</div>
    <div class="quarto-title-meta-contents">
             <p>Oliver Dürr </p>
          </div>
  </div>
    
    
  </div>
  

</header>

<p>This is a primer on rotations and quaternions, as needed to describe rotations.</p>
<section id="a-short-note-on-rotations" class="level2">
<h2 class="anchored" data-anchor-id="a-short-note-on-rotations">A short note on rotations</h2>
<p>In the figure, you can see a sketch of the situation for gesture recognition. We are interested in “the relative positions” between the palm and thumb on the one side and the laboratory system. As we will see this can be described in the framework of rotations.</p>
<div id="fig-hand" class="quarto-figure quarto-figure-center anchored">
<figure class="figure">
<p><img src="images/hand.jpg" class="img-fluid figure-img" width="1000"></p>
<p></p><figcaption class="figure-caption">Figure 1: Simplyfied gesture recognition with 2 IMUs (thumb, palm). Show are a fixed coordinate system in space (toothpicks on table), a body centered coordinate system on the thumb and one on the plam.</figcaption><p></p>
</figure>
</div>
<section id="a-first-rotation" class="level3">
<h3 class="anchored" data-anchor-id="a-first-rotation">A first rotation</h3>
<p>Before we go into some math, lets have a first look how a rotation might look like. On the left side you see data points in the original space. On the right side a rotation by 45 degrees around the z-axis that have been applied to the points. This rotation can be obtained by a rotation matrix R:</p>
<div class="cell" data-layout-align="center" name="bunny" data-hash="Note_on_Quaternion_cache/html/unnamed-chunk-2_20ccc9d3d46308f602a636df6ec75aa9">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb1"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a><span class="co">#dim(rabbit) #5000     3 A subsampled version of the standford buny with head up z-Axis</span></span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true" tabindex="-1"></a>R <span class="ot">=</span> <span class="fu">matrix</span>(<span class="fu">c</span>(<span class="fl">0.7071068</span>,  <span class="fl">0.7071068</span>,  <span class="fl">0.0000000</span>, <span class="sc">-</span><span class="fl">0.7071068</span>,  <span class="fl">0.7071068</span>,  <span class="fl">0.0000000</span>,  <span class="fl">0.0000000</span>,  <span class="fl">0.0000000</span>,  <span class="fl">1.0000000</span>), <span class="at">nrow=</span><span class="dv">3</span>)</span>
<span id="cb1-3"><a href="#cb1-3" aria-hidden="true" tabindex="-1"></a><span class="fu">round</span>(R,<span class="dv">4</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>       [,1]    [,2] [,3]
[1,] 0.7071 -0.7071    0
[2,] 0.7071  0.7071    0
[3,] 0.0000  0.0000    1</code></pre>
</div>
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb3"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb3-1"><a href="#cb3-1" aria-hidden="true" tabindex="-1"></a><span class="fu">par</span>(<span class="at">mfrow=</span><span class="fu">c</span>(<span class="dv">1</span>,<span class="dv">2</span>))</span>
<span id="cb3-2"><a href="#cb3-2" aria-hidden="true" tabindex="-1"></a><span class="fu">p3d</span>(rabbit, <span class="at">h=</span><span class="cn">NULL</span>, <span class="at">xlab=</span><span class="st">'x'</span>, <span class="at">ylab=</span><span class="st">'y'</span>, <span class="at">zlab=</span><span class="st">'z'</span>, )</span>
<span id="cb3-3"><a href="#cb3-3" aria-hidden="true" tabindex="-1"></a><span class="co">#It's vector times Matrix for row-vectors</span></span>
<span id="cb3-4"><a href="#cb3-4" aria-hidden="true" tabindex="-1"></a><span class="co">#Therefore we have to transpose (R x) to x^T R^T</span></span>
<span id="cb3-5"><a href="#cb3-5" aria-hidden="true" tabindex="-1"></a><span class="fu">p3d</span>(rabbit <span class="sc">%*%</span> <span class="fu">t</span>(R), <span class="at">h=</span><span class="cn">NULL</span>) </span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="Note_on_Quaternion_files/figure-html/unnamed-chunk-2-1.png" class="img-fluid figure-img" width="960"></p>
<p></p><figcaption class="figure-caption">Left: orinial data. Right: data rotated by 45 degrees around y-axis (or coordinate system rotated by -45) degrees. The y-axis points up and the rotation is done in counter clock-wise manner</figcaption><p></p>
</figure>
</div>
</div>
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb4"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb4-1"><a href="#cb4-1" aria-hidden="true" tabindex="-1"></a><span class="fu">par</span>(<span class="at">mfrow=</span><span class="fu">c</span>(<span class="dv">1</span>,<span class="dv">1</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
</section>
</section>
<section id="definition-of-rotations" class="level2">
<h2 class="anchored" data-anchor-id="definition-of-rotations">Definition of rotations</h2>
<p>Rotations between rigid objects can be described as a linear transformation from one coordinate system to another, with the same origin. A first example is the bunny from above. A practical example of such a rotation is the orientation of your cell phone after you picked it up compared to the position on the table, or the orientation of the thumb in figure. Another good example is a plane which is at <span class="math inline">\(t=0\)</span> on the ground and at <span class="math inline">\(t=t\)</span> in the air. Besides the translation, the orientation of the plane at <span class="math inline">\(t=0\)</span> relative to the plane at <span class="math inline">\(t=t\)</span> can be described by a different heading (the <em>yaw</em> angle) obtained while taxing, the <em>pitch</em> angle obtained in the climbing phase and a rotation around the axis of flight the <em>roll</em> angle. During this phase many rotations can happen but they can all be summarized in a single rotation.</p>
<p>More formally the rotations between the two planes can be described by a rotation matrix <span class="math inline">\(R\)</span> , which transforms the coordinate system of the plane at <span class="math inline">\(t=0\)</span> to the coordinate system of the plane at <span class="math inline">\(t=t\)</span>. This matrix is defined by the transformation of unit vectors <span class="math inline">\(\vec{e_x},\vec{e_y},\vec{e_z}\)</span> of coordinate system (say that at <span class="math inline">\(t=0\)</span>) to a coordinate system <span class="math inline">\(\vec{e'_x},\vec{e'_y},\vec{e'_z}\)</span> at <span class="math inline">\(t=t\)</span>. As my famous professor in linear algebra always repeated the columns of a (transformation) matrix are the images of the unit vectors<a href="#fn1" class="footnote-ref" id="fnref1" role="doc-noteref"><sup>1</sup></a>. So the first column of <span class="math inline">\(R\)</span> is given by <span class="math inline">\(R \cdot \vec{e_x}\)</span> second by <span class="math inline">\(R \cdot \vec{e_y}\)</span>, and the third by <span class="math inline">\(R \cdot \vec{e_z}\)</span>.</p>
</section>
<section id="parameterization" class="level2">
<h2 class="anchored" data-anchor-id="parameterization">Parameterization</h2>
<section id="definition-of-rotations-1" class="level3">
<h3 class="anchored" data-anchor-id="definition-of-rotations-1">Definition of rotations</h3>
<p>Rotations can be seen as linear transformation from one coordinate system into another. There are several way to parametrize them. The first is via a rotation matrix.</p>
</section>
<section id="rotation-matrix" class="level3">
<h3 class="anchored" data-anchor-id="rotation-matrix">Rotation matrix</h3>
<p>In principal a rotation is given by the 9 matrix elements of <span class="math inline">\(R\)</span>. However they cannot be arbitrary, they still need to describe rotations. What are the defining properties of rotations? It turns out that a rotation, has an inverse and the inverse simply the transposed <span class="math inline">\(R^{-1} = R^T\)</span> (this is the orthogonality). Further, <span class="math inline">\(det(R)=1\)</span> this is a consequence that the volume in the rotated system stays constant and also the orientation (it’s <span class="math inline">\(det(R)=1\)</span> and not just <span class="math inline">\(|det(d)|=1\)</span>). So in matrix notation a rotation is defined by</p>
<p><span id="eq-rot"><span class="math display">\[
R=\begin{bmatrix}r_{11} &amp; r_{12} &amp; r_{13} \\r_{21} &amp; r_{22} &amp; r_{23} \\r_{31} &amp; r_{32} &amp; r_{33} \end{bmatrix}, \quad R^TR=RR^T=1,\quad det(R)=1  
\tag{1}\]</span></span></p>
<p>Multiplying two rotation matrices <span class="math inline">\(R_1\)</span> and <span class="math inline">\(R_2\)</span> is a again a rotation matrix, this is why rotations in 3D are also called special orthogonal group <code>SO(3)</code>. Note that the order of rotations matter and <span class="math inline">\(R_1 R_2 \ne R_2 R_1\)</span></p>
<p>So it’s obvious that is over parameterized using 9 values and there are constrains on the <span class="math inline">\(r_{ij}\)</span> so that eq. 1 is fulfilled.</p>
<section id="parameterization-using-elementary-rotation." class="level4">
<h4 class="anchored" data-anchor-id="parameterization-using-elementary-rotation.">Parameterization using elementary rotation.</h4>
<p>Many repeated rotation again form a rotations and it can be shown that an arbitrary rotation can be build out of three elementary rotations. First, a counter-clockwise rotation <span class="math inline">\(R_x(\alpha)\)</span> around the <span class="math inline">\(x\)</span>-axis by an angle of <span class="math inline">\(\alpha\)</span>. Second, <span class="math inline">\(R_y(\beta)\)</span> rotates around “the new” <span class="math inline">\(y\)</span>-axis and finally by <span class="math inline">\(R_z(\gamma)\)</span> around the new <span class="math inline">\(z\)</span>-axis. So the complete transformation is given by <span class="math inline">\(R(\alpha, \beta, \gamma) = R_z(\gamma) R_y(\beta) R_x(\alpha)\)</span>. The individual transformations can be derived by looking where the unit vectors are transformed, yielding e.g.&nbsp;for <span class="math inline">\(R_z(\gamma)\)</span> to</p>
<p><span id="eq-rx"><span class="math display">\[
R_z(\gamma)=\begin{bmatrix}\cos(\gamma) &amp; \sin(\gamma) &amp; 0 \\-\sin(\gamma) &amp;\cos(\gamma) &amp; 0 \\0 &amp; 0 &amp; 1 \end{bmatrix}
\tag{2}\]</span></span></p>
<p>In the figure below you see a derivation of the rotation matrix.</p>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="images/rz_gamma.png" class="img-fluid figure-img"></p>
<p></p><figcaption class="figure-caption">Derivation of the rotation matrix transforming from a fixed coordinate system to a rotated one.</figcaption><p></p>
</figure>
</div>
<p>The question is “how do the unit vectors look in the rotated system”. Note that this transformation matrix transforms from the laboratory system to the “body centric system”. Note that the inverse is the transpose and this corresponds to setting <span class="math inline">\(\gamma\)</span> to <span class="math inline">\(-\gamma\)</span> since <span class="math inline">\(\sin\)</span> is asymmetric. For the initial rotation of the rabbit, we transformed the data and not the coordinate system hence, we have to use <span class="math inline">\(R^T\)</span> (or change <span class="math inline">\(\gamma \to -\gamma\)</span>) and with <span class="math inline">\(\sin(45^0) = \cos(45^0) \approx 0.7071\)</span> we get same rotation as used in the code used to transform the data.</p>
</section>
<section id="connections-with-yaw-pitch-roll" class="level4">
<h4 class="anchored" data-anchor-id="connections-with-yaw-pitch-roll">Connections with yaw, pitch, roll</h4>
<p>Using the above definition, we can make the following connections (todo check)</p>
<ul>
<li>The yaw angle is <span class="math inline">\(\gamma\)</span></li>
<li>The pitch is <span class="math inline">\(-\beta\)</span></li>
<li>The roll is <span class="math inline">\(\alpha\)</span></li>
</ul>
<p>The problem with the approach of elementary rotations is that there is are many possible combinations to chain the elemetary operations. For example some use <span class="math inline">\(R_x(\gamma) R_y(\beta) R_x(\alpha)\)</span> i.e.&nbsp;using <span class="math inline">\(R_x\)</span> twice, some go from body to fixed some the other way. Further, in this parameterization the effect of changing the angles by a bit has different effects depending on the values. In the extreme case changing the angle does nothing anymore, which is known under the name gimbals look (see e.g.&nbsp;<a href="https://towardsdatascience.com/better-rotation-representations-for-accurate-pose-estimation-e890a7e1317f">here</a> for a nice demonstration).</p>
</section>
</section>
</section>
<section id="quaternions" class="level1">
<h1>Quaternions</h1>
<p>Besides defining a rotation by 3 elementary rotations, with the many implied ambiguities and the gimbal lock there are other possibilities to describe rotations. Quaterions are such a possibility used as standard output format of many libraries such as <a href="https://ahrs.readthedocs.io/en/latest/index.html#">AHRS</a>. Rotations can be described by unit<a href="#fn2" class="footnote-ref" id="fnref2" role="doc-noteref"><sup>2</sup></a> vector <span class="math inline">\(\vec{v}=(v_x,v_y,v_z)\)</span> and a counter clock wise rotation around this vector by an angle <span class="math inline">\(\theta\)</span>.</p>
<div id="fig-rot" class="quarto-figure quarto-figure-center anchored">
<figure class="figure">
<p><img src="images/rotation_abitrary_vector.png" class="img-fluid figure-img"></p>
<p></p><figcaption class="figure-caption">Figure 2: Rotation around a vector</figcaption><p></p>
</figure>
</div>
<p>Quaternions are objects which consists of 4 numbers, and the rotation around a vector can be nicely described with them as we will see in a second. But they also have some mathematical raison d’etre.</p>
<section id="definition-of-quaternions" class="level3">
<h3 class="anchored" data-anchor-id="definition-of-quaternions">Definition of Quaternions</h3>
<p>Complex numbers <span class="math inline">\(|a|e^{i \theta}\)</span> describe points in the real / imaginary space and rotations in 2D can be nicely described by them using multiplications. Quaternions can be seen as a generalization of complex numbers with two more imaginary like units <span class="math inline">\(i,j,k\)</span>. Using these, the quaternion can be written as:</p>
<p><span class="math display">\[
q =  (q_w, q_1, q_2, q_3) = q_w + q_1 i + q_2 j + q_3 k
\]</span></p>
<p>The basis have some properties (there are more)</p>
<p><span class="math display">\[
  i^2=j^2=k^2=ijk=-1 \;\; ij = -ji = k
\]</span></p>
<p>The length of a quaternion can be determined as:</p>
<p><span class="math display">\[
  ||q|| = \sqrt{q_w^2 + q_1^2 + q_2^2 + q_3^2 }
\]</span></p>
<p>Here, we are dealing with quaternions of length 1 and almost all quaternions used in Computergraphics are unit quaternions or a.k.a. rotation quaterions.</p>
</section>
<section id="geometric-representation" class="level3">
<h3 class="anchored" data-anchor-id="geometric-representation">Geometric Representation</h3>
<p>For quaternions <span class="math inline">\(q = (w, r_1, r_2, r_3)\)</span> they following connection to the unit rotation vector <span class="math inline">\(\vec{r}=(v_1, v_2, v_3)\)</span> holds:</p>
<p><span class="math display">\[
  q(\theta, v) = \cos(\frac{\theta}{2}) w + i \sin(\frac{\theta}{2}) v_1 +
  j \sin(\frac{\theta}{2}) v_2 + k \sin(\frac{\theta}{2}) v_3 = \\\left(\cos(\frac{\theta}{2}) w,\; \sin(\frac{\theta}{2})  v_1, \;\sin(\frac{\theta} {2}) v_2, \;\sin(\frac{\theta}{2}) v_3 \right)
\]</span></p>
<p>here <span class="math inline">\(\theta\)</span> is the rotation about the unit vector.</p>
<p>The length of <span class="math inline">\(q\)</span> is <span class="math inline">\(||q||=\cos^2(\theta/2) w + \sin^2(\theta/2) (v_1^2 + v_2^2 + v_3^2) = \cos^2(\theta/2) w + \sin^2(\theta/2)\)</span> and hence we need to choose <span class="math inline">\(w=1\)</span> for the unit quaternion.</p>
<section id="construction-of-quaternion-from-vector-and-angle" class="level4">
<h4 class="anchored" data-anchor-id="construction-of-quaternion-from-vector-and-angle">Construction of quaternion from vector and angle</h4>
<p>Consider the plane from above. At the start (<span class="math inline">\(t=0\)</span>) the laboratory coordinate system corresponds to the one in the plane. This can be described by no rotation <span class="math inline">\(\theta=0\)</span> about any axis <span class="math inline">\(q(0) = (\cos(0), v_1 \sin(0), v_2 \sin(0), v_3 \sin(0) = (1,0,0,0)\)</span>. Then before the liftoff it looks in the xy-direction, that is a rotation about 45 degres (<span class="math inline">\(\theta = 45/360 \cdot 2 \cdot pi \approx 0.785\)</span>) around <span class="math inline">\(\vec{r} = (0,0,1)\)</span> and <span class="math inline">\(q(1) = (\cos(0.785/2), 0, 0, \sin(0.785/2))\)</span>.</p>
</section>
</section>
<section id="quaterion-algebra" class="level3">
<h3 class="anchored" data-anchor-id="quaterion-algebra">Quaterion Algebra</h3>
<ul>
<li><p>Addition (easy but no geometeric interpretation), just for reference <span class="math display">\[
q + p = p + q =  q_w + p_w + (q_1 + p_1) i + (q_2 + p_2) j + (q_3 + p_3) k
\]</span></p></li>
<li><p>Multiplication: The multiplication is not commutative <span class="math display">\[
q * p \ne p * q = \tt{Complicated Formula}
\]</span></p></li>
<li><p>Conjugate (just i –&gt; -i same for j and k) <span class="math display">\[
q^* = q_w − i q_x − j q_y − k q_z
\]</span></p></li>
<li><p>Inverse <span class="math display">\[
q^{-1} = q^*/||q||
\]</span></p></li>
</ul>
<p>So for unit quaternions, you just have to conjugate to get the inverse. Luckily, we don’t have to remember the formulaes and can use the onion-package.</p>
</section>
<section id="chaining-rotations-with-quaterions-just-multiply-them" class="level3">
<h3 class="anchored" data-anchor-id="chaining-rotations-with-quaterions-just-multiply-them">Chaining rotations with quaterions (just multiply them)</h3>
<p>Now comes properly the most useful thing, that successive rotations can be done by multiplying the respective quaternions. Let’s try this out.</p>
<p>Let’s multiply several quaternions</p>
<div class="cell" data-layout-align="center" name="bunny1" data-hash="Note_on_Quaternion_cache/html/unnamed-chunk-4_051b5574946b716dcb7602679ac0292e">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb5"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb5-1"><a href="#cb5-1" aria-hidden="true" tabindex="-1"></a>  q0 <span class="ot">=</span> onion<span class="sc">::</span><span class="fu">quaternion</span>(<span class="at">Re =</span> <span class="dv">1</span>)</span>
<span id="cb5-2"><a href="#cb5-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">p3d</span>(bunny <span class="sc">%*%</span> <span class="fu">quat_to_mat</span>(q0), <span class="at">h=</span><span class="cn">NULL</span>, <span class="at">main =</span> <span class="st">'q0'</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="Note_on_Quaternion_files/figure-html/unnamed-chunk-4-1.png" class="img-fluid figure-img" width="480"></p>
</figure>
</div>
</div>
</div>
<div class="cell" data-layout-align="center" name="bunny1" data-hash="Note_on_Quaternion_cache/html/unnamed-chunk-6_010118c164285c1ae8ac9f6749f2e16c">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb6"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb6-1"><a href="#cb6-1" aria-hidden="true" tabindex="-1"></a>  q1 <span class="ot">=</span> <span class="fu">quaternion</span>(<span class="at">Re=</span><span class="fu">cos</span>(<span class="sc">-</span><span class="dv">45</span><span class="sc">/</span><span class="dv">360</span> <span class="sc">*</span>pi), <span class="at">i =</span> <span class="dv">0</span>, <span class="at">j =</span> <span class="dv">1</span><span class="sc">*</span><span class="fu">sin</span>(<span class="sc">-</span><span class="dv">45</span><span class="sc">/</span><span class="dv">360</span> <span class="sc">*</span>pi), <span class="at">k =</span> <span class="dv">0</span>) </span>
<span id="cb6-2"><a href="#cb6-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">p3d</span>(bunny <span class="sc">%*%</span> <span class="fu">quat_to_mat</span>(q0 <span class="sc">*</span> q1), <span class="at">h=</span><span class="cn">NULL</span>, <span class="at">main =</span> <span class="st">'q0 * q1'</span>) </span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="Note_on_Quaternion_files/figure-html/unnamed-chunk-6-1.png" class="img-fluid figure-img" width="480"></p>
</figure>
</div>
</div>
</div>
<div class="cell" data-layout-align="center" name="bunny1" data-hash="Note_on_Quaternion_cache/html/unnamed-chunk-8_7d87fa1d6de1b8365e944c971f77fc41">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb7"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb7-1"><a href="#cb7-1" aria-hidden="true" tabindex="-1"></a>  q2 <span class="ot">=</span> <span class="fu">quaternion</span>(<span class="at">Re=</span><span class="fu">cos</span>(<span class="sc">-</span><span class="dv">45</span><span class="sc">/</span><span class="dv">360</span> <span class="sc">*</span>pi), <span class="at">i =</span> <span class="dv">1</span><span class="sc">*</span><span class="fu">sin</span>(<span class="sc">-</span><span class="dv">45</span><span class="sc">/</span><span class="dv">360</span> <span class="sc">*</span>pi), <span class="at">j =</span> <span class="dv">0</span>, <span class="at">k =</span> <span class="dv">0</span>) </span>
<span id="cb7-2"><a href="#cb7-2" aria-hidden="true" tabindex="-1"></a>  q012 <span class="ot">=</span> q0 <span class="sc">*</span> q1 <span class="sc">*</span> q2</span>
<span id="cb7-3"><a href="#cb7-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">p3d</span>(bunny <span class="sc">%*%</span> <span class="fu">quat_to_mat</span>(q012), <span class="at">h=</span><span class="cn">NULL</span>, <span class="at">main =</span> <span class="st">'q0 * q1 * q2'</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="Note_on_Quaternion_files/figure-html/unnamed-chunk-8-1.png" class="img-fluid figure-img" width="480"></p>
</figure>
</div>
</div>
</div>
</section>
<section id="vector-quaterions-not-sure-if-this-word-fits" class="level3">
<h3 class="anchored" data-anchor-id="vector-quaterions-not-sure-if-this-word-fits">Vector Quaterions (not sure if this word fits)</h3>
<p>We can also use use quaterions to transform vectors, without the need to explicitly construct the rotation matrix as done with the bunny data above. In this case, we set the real part to 0 and use the vector in the vector part. That is a vector in a certain direction withgout doing the rotation.</p>
<div class="cell">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb8"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb8-1"><a href="#cb8-1" aria-hidden="true" tabindex="-1"></a> q <span class="ot">=</span> q0 <span class="sc">*</span> q1 <span class="sc">*</span> q2</span>
<span id="cb8-2"><a href="#cb8-2" aria-hidden="true" tabindex="-1"></a> vec <span class="ot">=</span> <span class="fu">matrix</span>(<span class="fu">c</span>(<span class="dv">12</span>,<span class="dv">13</span>,<span class="dv">45</span>), <span class="at">ncol=</span><span class="dv">1</span>)</span>
<span id="cb8-3"><a href="#cb8-3" aria-hidden="true" tabindex="-1"></a> <span class="fu">quat_to_mat</span>(q) <span class="sc">%*%</span> vec</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>          [,1]
[1,] -7.514719
[2,] 41.012193
[3,] 24.485281</code></pre>
</div>
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb10"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb10-1"><a href="#cb10-1" aria-hidden="true" tabindex="-1"></a> vec_q <span class="ot">=</span> <span class="fu">quaternion</span>(<span class="at">Re =</span> <span class="dv">0</span>, <span class="at">i =</span> vec[<span class="dv">1</span>], <span class="at">j=</span>vec[<span class="dv">2</span>], <span class="at">k=</span>vec[<span class="dv">3</span>])</span>
<span id="cb10-2"><a href="#cb10-2" aria-hidden="true" tabindex="-1"></a> <span class="co">#q^-1 is the inverse, which for rotation quaternions is the conjugate </span></span>
<span id="cb10-3"><a href="#cb10-3" aria-hidden="true" tabindex="-1"></a> q <span class="sc">*</span> vec_q <span class="sc">*</span> q<span class="sc">^-</span><span class="dv">1</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>              Re
Re -8.881784e-16
i  -7.514719e+00
j   4.101219e+01
k   2.448528e+01</code></pre>
</div>
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb12"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb12-1"><a href="#cb12-1" aria-hidden="true" tabindex="-1"></a> <span class="co">#q^1 onion_inverse(q) #The inverse</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
</section>
<section id="flight-coordinates-from-quaterions-todo" class="level3">
<h3 class="anchored" data-anchor-id="flight-coordinates-from-quaterions-todo">Flight Coordinates from Quaterions (TODO)</h3>
<div class="cell">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb13"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb13-1"><a href="#cb13-1" aria-hidden="true" tabindex="-1"></a>  qx <span class="ot">=</span> <span class="fu">quaternion</span>(<span class="dv">0</span>,<span class="dv">1</span>,<span class="dv">0</span>,<span class="dv">0</span>)</span>
<span id="cb13-2"><a href="#cb13-2" aria-hidden="true" tabindex="-1"></a>  qx <span class="sc">*</span> q012 <span class="sc">*</span> qx<span class="sc">^</span><span class="dv">1</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>           Re
Re  0.8535534
i  -0.3535534
j  -0.3535534
k  -0.1464466</code></pre>
</div>
</div>
</section>
<section id="rotation-between-two-quaternions." class="level3">
<h3 class="anchored" data-anchor-id="rotation-between-two-quaternions.">Rotation between two quaternions.</h3>
<p>Consider the two IMUs, the orientation of the first (w.r.t. the laboratory system) is given by <span class="math inline">\(q_1\)</span> the orientation of the second by <span class="math inline">\(q_2\)</span>. How are these related? Well the questions is then: which rotation <span class="math inline">\(q_{12}\)</span> translates between them. So we ask which <span class="math inline">\(q_12\)</span> fulfills</p>
<p><span class="math display">\[
  q_2 = q_1 \; q_{12}
\]</span></p>
<p>Just calculate the inverse of <span class="math inline">\(q_1\)</span> and you are done</p>
<p><span class="math display">\[
  q_1^{-1} \; q_2 = q_{12}  
\]</span></p>
<section id="constructing-a-rotation-matrix-from-quaterions" class="level4">
<h4 class="anchored" data-anchor-id="constructing-a-rotation-matrix-from-quaterions">Constructing a rotation matrix from Quaterions</h4>
<p>It’s possible to translate the quaternions back to a rotation matrix, see</p>
<div class="cell">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb15"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb15-1"><a href="#cb15-1" aria-hidden="true" tabindex="-1"></a>  t_05 <span class="ot">=</span> <span class="dv">0</span> <span class="co">#half of theta</span></span>
<span id="cb15-2"><a href="#cb15-2" aria-hidden="true" tabindex="-1"></a>  q0_d <span class="ot">=</span> <span class="fu">c</span>(<span class="fu">cos</span>(t_05), <span class="fu">sin</span>(t_05), <span class="fu">sin</span>(t_05), <span class="fu">sin</span>(t_05))</span>
<span id="cb15-3"><a href="#cb15-3" aria-hidden="true" tabindex="-1"></a>  t_05 <span class="ot">=</span> <span class="dv">45</span><span class="sc">/</span><span class="dv">360</span> <span class="sc">*</span> pi <span class="co">#half of theta</span></span>
<span id="cb15-4"><a href="#cb15-4" aria-hidden="true" tabindex="-1"></a>  q01 <span class="ot">=</span> <span class="fu">c</span>(<span class="fu">cos</span>(t_05), <span class="dv">0</span><span class="sc">*</span><span class="fu">sin</span>(t_05), <span class="dv">0</span><span class="sc">*</span><span class="fu">sin</span>(t_05), <span class="dv">1</span><span class="sc">*</span><span class="fu">sin</span>(t_05))</span>
<span id="cb15-5"><a href="#cb15-5" aria-hidden="true" tabindex="-1"></a>  <span class="co">#sum(q01^2) #1</span></span>
<span id="cb15-6"><a href="#cb15-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">quat_to_mat</span>(q01)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>          [,1]       [,2] [,3]
[1,] 0.7071068 -0.7071068    0
[2,] 0.7071068  0.7071068    0
[3,] 0.0000000  0.0000000    1</code></pre>
</div>
</div>
<p><br>
</p>
</section>
</section>
<section id="software-package" class="level2">
<h2 class="anchored" data-anchor-id="software-package">Software package</h2>
<section id="the-ahrs-python-package" class="level3">
<h3 class="anchored" data-anchor-id="the-ahrs-python-package">The AHRS Python Package</h3>
<p>The AHRS package (https://ahrs.readthedocs.io/en/latest/index.html) used to estimate the rotation of a IMUs (sensors in e.g.&nbsp;cell phones and drones), uses quaternion as lot and also provides some basic operations.</p>
<div class="cell">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb17"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb17-1"><a href="#cb17-1" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> ahrs <span class="im">import</span> Quaternion</span>
<span id="cb17-2"><a href="#cb17-2" aria-hidden="true" tabindex="-1"></a>p <span class="op">=</span> Quaternion([<span class="fl">0.7071</span>, <span class="fl">0.0</span>, <span class="fl">0.7071</span>, <span class="fl">0.0</span>])</span>
<span id="cb17-3"><a href="#cb17-3" aria-hidden="true" tabindex="-1"></a>p </span>
<span id="cb17-4"><a href="#cb17-4" aria-hidden="true" tabindex="-1"></a>q <span class="op">=</span> Quaternion([<span class="dv">0</span>, <span class="fl">0.7071</span>, <span class="fl">0.0</span>, <span class="fl">0.7071</span>])</span>
<span id="cb17-5"><a href="#cb17-5" aria-hidden="true" tabindex="-1"></a>p <span class="op">*</span> q <span class="co">#0., 1., 0., 0.</span></span>
<span id="cb17-6"><a href="#cb17-6" aria-hidden="true" tabindex="-1"></a>q <span class="op">*</span> p <span class="co">#0., 0., 0., 1.</span></span>
<span id="cb17-7"><a href="#cb17-7" aria-hidden="true" tabindex="-1"></a>q.conj<span class="co">#0., -0.70710678, -0., -0.70710678</span></span>
<span id="cb17-8"><a href="#cb17-8" aria-hidden="true" tabindex="-1"></a>d <span class="op">=</span> q<span class="op">*</span>q.conj </span>
<span id="cb17-9"><a href="#cb17-9" aria-hidden="true" tabindex="-1"></a>d</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
</section>
</section>
<section id="r-package" class="level2">
<h2 class="anchored" data-anchor-id="r-package">R Package</h2>
<p>We used the package <code>onion</code> above.</p>
</section>
</section>


<div id="quarto-appendix" class="default"><section class="footnotes footnotes-end-of-document" role="doc-endnotes"><h2 class="anchored quarto-appendix-heading">Footnotes</h2>

<ol>
<li id="fn1" role="doc-endnote"><p>He was German and said: “Die Spalten einer Matrix sind die Bilder der Einheitsvektoren”.<a href="#fnref1" class="footnote-back" role="doc-backlink">↩︎</a></p></li>
<li id="fn2" role="doc-endnote"><p>Strictly we could also use a non unit vector but it turns out to be easier for later to consider unit vectors.<a href="#fnref2" class="footnote-back" role="doc-backlink">↩︎</a></p></li>
</ol>
</section></div></main>
<!-- /main column -->
<script id="quarto-html-after-body" type="application/javascript">
window.document.addEventListener("DOMContentLoaded", function (event) {
  const toggleBodyColorMode = (bsSheetEl) => {
    const mode = bsSheetEl.getAttribute("data-mode");
    const bodyEl = window.document.querySelector("body");
    if (mode === "dark") {
      bodyEl.classList.add("quarto-dark");
      bodyEl.classList.remove("quarto-light");
    } else {
      bodyEl.classList.add("quarto-light");
      bodyEl.classList.remove("quarto-dark");
    }
  }
  const toggleBodyColorPrimary = () => {
    const bsSheetEl = window.document.querySelector("link#quarto-bootstrap");
    if (bsSheetEl) {
      toggleBodyColorMode(bsSheetEl);
    }
  }
  toggleBodyColorPrimary();  
  const icon = "";
  const anchorJS = new window.AnchorJS();
  anchorJS.options = {
    placement: 'right',
    icon: icon
  };
  anchorJS.add('.anchored');
  const clipboard = new window.ClipboardJS('.code-copy-button', {
    target: function(trigger) {
      return trigger.previousElementSibling;
    }
  });
  clipboard.on('success', function(e) {
    // button target
    const button = e.trigger;
    // don't keep focus
    button.blur();
    // flash "checked"
    button.classList.add('code-copy-button-checked');
    var currentTitle = button.getAttribute("title");
    button.setAttribute("title", "Copied!");
    setTimeout(function() {
      button.setAttribute("title", currentTitle);
      button.classList.remove('code-copy-button-checked');
    }, 1000);
    // clear code selection
    e.clearSelection();
  });
  function tippyHover(el, contentFn) {
    const config = {
      allowHTML: true,
      content: contentFn,
      maxWidth: 500,
      delay: 100,
      arrow: false,
      appendTo: function(el) {
          return el.parentElement;
      },
      interactive: true,
      interactiveBorder: 10,
      theme: 'quarto',
      placement: 'bottom-start'
    };
    window.tippy(el, config); 
  }
  const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
  for (var i=0; i<noterefs.length; i++) {
    const ref = noterefs[i];
    tippyHover(ref, function() {
      let href = ref.getAttribute('href');
      try { href = new URL(href).hash; } catch {}
      const id = href.replace(/^#\/?/, "");
      const note = window.document.getElementById(id);
      return note.innerHTML;
    });
  }
  var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
  for (var i=0; i<bibliorefs.length; i++) {
    const ref = bibliorefs[i];
    const cites = ref.parentNode.getAttribute('data-cites').split(' ');
    tippyHover(ref, function() {
      var popup = window.document.createElement('div');
      cites.forEach(function(cite) {
        var citeDiv = window.document.createElement('div');
        citeDiv.classList.add('hanging-indent');
        citeDiv.classList.add('csl-entry');
        var biblioDiv = window.document.getElementById('ref-' + cite);
        if (biblioDiv) {
          citeDiv.innerHTML = biblioDiv.innerHTML;
        }
        popup.appendChild(citeDiv);
      });
      return popup.innerHTML;
    });
  }
});
</script>
</div> <!-- /content -->



</body></html>