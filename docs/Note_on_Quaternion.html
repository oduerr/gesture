<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.0.36">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">

<meta name="author" content="Oliver DÃ¼rr">

<title>Notes on Rotations and Quaternions</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
span.underline{text-decoration: underline;}
div.column{display: inline-block; vertical-align: top; width: 50%;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
    color: #aaaaaa;
  }
pre.numberSource { margin-left: 3em; border-left: 1px solid #aaaaaa;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
code span.al { color: #ff0000; font-weight: bold; } /* Alert */
code span.an { color: #60a0b0; font-weight: bold; font-style: italic; } /* Annotation */
code span.at { color: #7d9029; } /* Attribute */
code span.bn { color: #40a070; } /* BaseN */
code span.bu { } /* BuiltIn */
code span.cf { color: #007020; font-weight: bold; } /* ControlFlow */
code span.ch { color: #4070a0; } /* Char */
code span.cn { color: #880000; } /* Constant */
code span.co { color: #60a0b0; font-style: italic; } /* Comment */
code span.cv { color: #60a0b0; font-weight: bold; font-style: italic; } /* CommentVar */
code span.do { color: #ba2121; font-style: italic; } /* Documentation */
code span.dt { color: #902000; } /* DataType */
code span.dv { color: #40a070; } /* DecVal */
code span.er { color: #ff0000; font-weight: bold; } /* Error */
code span.ex { } /* Extension */
code span.fl { color: #40a070; } /* Float */
code span.fu { color: #06287e; } /* Function */
code span.im { } /* Import */
code span.in { color: #60a0b0; font-weight: bold; font-style: italic; } /* Information */
code span.kw { color: #007020; font-weight: bold; } /* Keyword */
code span.op { color: #666666; } /* Operator */
code span.ot { color: #007020; } /* Other */
code span.pp { color: #bc7a00; } /* Preprocessor */
code span.sc { color: #4070a0; } /* SpecialChar */
code span.ss { color: #bb6688; } /* SpecialString */
code span.st { color: #4070a0; } /* String */
code span.va { color: #19177c; } /* Variable */
code span.vs { color: #4070a0; } /* VerbatimString */
code span.wa { color: #60a0b0; font-weight: bold; font-style: italic; } /* Warning */
div.csl-bib-body { }
div.csl-entry {
  clear: both;
}
.hanging div.csl-entry {
  margin-left:2em;
  text-indent:-2em;
}
div.csl-left-margin {
  min-width:2em;
  float:left;
}
div.csl-right-inline {
  margin-left:2em;
  padding-left:1em;
}
div.csl-indent {
  margin-left: 2em;
}
</style>


<script src="Note_on_Quaternion_files/libs/clipboard/clipboard.min.js"></script>
<script src="Note_on_Quaternion_files/libs/quarto-html/quarto.js"></script>
<script src="Note_on_Quaternion_files/libs/quarto-html/popper.min.js"></script>
<script src="Note_on_Quaternion_files/libs/quarto-html/tippy.umd.min.js"></script>
<script src="Note_on_Quaternion_files/libs/quarto-html/anchor.min.js"></script>
<link href="Note_on_Quaternion_files/libs/quarto-html/tippy.css" rel="stylesheet">
<link href="Note_on_Quaternion_files/libs/quarto-html/quarto-syntax-highlighting.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="Note_on_Quaternion_files/libs/bootstrap/bootstrap.min.js"></script>
<link href="Note_on_Quaternion_files/libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="Note_on_Quaternion_files/libs/bootstrap/bootstrap.min.css" rel="stylesheet" id="quarto-bootstrap" data-mode="light">

  <script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-chtml-full.js" type="text/javascript"></script>

</head>

<body>

<div id="quarto-content" class="page-columns page-rows-contents page-layout-article">
<div id="quarto-margin-sidebar" class="sidebar margin-sidebar">
  <nav id="TOC" role="doc-toc">
    <h2 id="toc-title">Table of contents</h2>
   
  <ul>
  <li><a href="#a-short-note-on-rotations" id="toc-a-short-note-on-rotations" class="nav-link active" data-scroll-target="#a-short-note-on-rotations"> <span class="header-section-number">1</span> A short note on rotations</a>
  <ul class="collapse">
  <li><a href="#a-first-rotation" id="toc-a-first-rotation" class="nav-link" data-scroll-target="#a-first-rotation"> <span class="header-section-number">1.1</span> A first rotation</a></li>
  <li><a href="#introduction" id="toc-introduction" class="nav-link" data-scroll-target="#introduction"> <span class="header-section-number">1.2</span> Introduction</a></li>
  <li><a href="#parameterization" id="toc-parameterization" class="nav-link" data-scroll-target="#parameterization"> <span class="header-section-number">1.3</span> Parameterization</a>
  <ul class="collapse">
  <li><a href="#definition-of-rotations" id="toc-definition-of-rotations" class="nav-link" data-scroll-target="#definition-of-rotations"> <span class="header-section-number">1.3.1</span> Definition of rotations</a></li>
  <li><a href="#rotation-matrix-general-properties" id="toc-rotation-matrix-general-properties" class="nav-link" data-scroll-target="#rotation-matrix-general-properties"> <span class="header-section-number">1.3.2</span> Rotation matrix (general properties)</a></li>
  <li><a href="#parameterization-using-elementary-rotation." id="toc-parameterization-using-elementary-rotation." class="nav-link" data-scroll-target="#parameterization-using-elementary-rotation."> <span class="header-section-number">1.3.3</span> Parameterization using elementary rotation.</a></li>
  </ul></li>
  </ul></li>
  <li><a href="#quaternions" id="toc-quaternions" class="nav-link" data-scroll-target="#quaternions"> <span class="header-section-number">2</span> Quaternions</a>
  <ul class="collapse">
  <li><a href="#definition-of-quaternions" id="toc-definition-of-quaternions" class="nav-link" data-scroll-target="#definition-of-quaternions"> <span class="header-section-number">2.1</span> Definition of Quaternions</a>
  <ul class="collapse">
  <li><a href="#geometric-representation-with-rotation-quaternions" id="toc-geometric-representation-with-rotation-quaternions" class="nav-link" data-scroll-target="#geometric-representation-with-rotation-quaternions"> <span class="header-section-number">2.1.1</span> Geometric Representation with rotation quaternions</a></li>
  <li><a href="#quaterion-algebra" id="toc-quaterion-algebra" class="nav-link" data-scroll-target="#quaterion-algebra"> <span class="header-section-number">2.1.2</span> Quaterion Algebra</a></li>
  <li><a href="#constructing-a-rotation-matrix-from-quaterions-first-solution" id="toc-constructing-a-rotation-matrix-from-quaterions-first-solution" class="nav-link" data-scroll-target="#constructing-a-rotation-matrix-from-quaterions-first-solution"> <span class="header-section-number">2.1.3</span> Constructing a rotation matrix from Quaterions (first solution)</a></li>
  <li><a href="#chaining-rotations-with-quaterions-just-multiply-them" id="toc-chaining-rotations-with-quaterions-just-multiply-them" class="nav-link" data-scroll-target="#chaining-rotations-with-quaterions-just-multiply-them"> <span class="header-section-number">2.1.4</span> Chaining rotations with quaterions (just multiply them)</a></li>
  <li><a href="#pure-quaternions-real-part-0" id="toc-pure-quaternions-real-part-0" class="nav-link" data-scroll-target="#pure-quaternions-real-part-0"> <span class="header-section-number">2.1.5</span> Pure Quaternions (real part = 0)</a></li>
  <li><a href="#flight-coordinates-from-quaterions" id="toc-flight-coordinates-from-quaterions" class="nav-link" data-scroll-target="#flight-coordinates-from-quaterions"> <span class="header-section-number">2.1.6</span> Flight Coordinates from Quaterions</a></li>
  <li><a href="#rotation-between-two-quaternions." id="toc-rotation-between-two-quaternions." class="nav-link" data-scroll-target="#rotation-between-two-quaternions."> <span class="header-section-number">2.1.7</span> Rotation between two quaternions.</a></li>
  </ul></li>
  <li><a href="#software-package" id="toc-software-package" class="nav-link" data-scroll-target="#software-package"> <span class="header-section-number">2.2</span> Software package</a>
  <ul class="collapse">
  <li><a href="#the-ahrs-python-package" id="toc-the-ahrs-python-package" class="nav-link" data-scroll-target="#the-ahrs-python-package"> <span class="header-section-number">2.2.1</span> The AHRS Python Package</a></li>
  </ul></li>
  </ul></li>
  </ul>
</nav>
</div>
<main class="content" id="quarto-document-content">

<header id="title-block-header" class="quarto-title-block default">
<div class="quarto-title">
<div class="quarto-title-block"><div><h1 class="title">Notes on Rotations and Quaternions</h1><button type="button" class="btn code-tools-button dropdown-toggle" id="quarto-code-tools-menu" data-bs-toggle="dropdown" aria-expanded="false"><i class="bi"></i> Code</button><ul class="dropdown-menu dropdown-menu-end" aria-labelelledby="quarto-code-tools-menu"><li><a id="quarto-show-all-code" class="dropdown-item" href="javascript:void(0)" role="button">Show All Code</a></li><li><a id="quarto-hide-all-code" class="dropdown-item" href="javascript:void(0)" role="button">Hide All Code</a></li><li><hr class="dropdown-divider"></li><li><a id="quarto-view-source" class="dropdown-item" href="javascript:void(0)" role="button">View Source</a></li></ul></div></div>
</div>



<div class="quarto-title-meta">

    <div>
    <div class="quarto-title-meta-heading">Author</div>
    <div class="quarto-title-meta-contents">
             <p>Oliver DÃ¼rr </p>
          </div>
  </div>
    
    
  </div>
  

</header>

<p>This is a primer on rotations and quaternions, as needed to describe rotations. Rotations are a constant source of confusion and they have confused me several time. This is kind of a letter to my future self.</p>
<p><strong>This is Work in Progress TODOS</strong></p>
<ul>
<li><p><strong>Still need corrections.</strong></p></li>
<li><p>Add arrows showing coordinate system to plane plot</p></li>
</ul>
<p>Some handwritten note are also availible as <a href="https://www.dropbox.com/s/n3oc5fjwrn1zaiu/Rotations%20without%20tears.pdf?dl=0">pdf</a>.</p>
<section id="a-short-note-on-rotations" class="level1" data-number="1">
<h1 data-number="1"><span class="header-section-number">1</span> A short note on rotations</h1>
<p>In the figure, you can see a sketch of the situation for gesture recognition. We are interested in âthe relative positionsâ between the palm and thumb on the one side and the laboratory system on the other. As we will see this (and many more things) can be described in the framework of rotations.</p>
<div id="fig-hand" class="quarto-figure quarto-figure-center anchored">
<figure class="figure">
<p><img src="images/hand.jpg" class="img-fluid figure-img" width="1000"></p>
<p></p><figcaption class="figure-caption">Figure 1: Rotations transform between coordinate system, such as a fixed coordinate system in space (toothpicks on table), a body centered coordinate system on the thumb and one on the plam.</figcaption><p></p>
</figure>
</div>
<section id="a-first-rotation" class="level2" data-number="1.1">
<h2 data-number="1.1" class="anchored" data-anchor-id="a-first-rotation"><span class="header-section-number">1.1</span> A first rotation</h2>
<p>Before we go into some math, lets have a first look how a rotation might look like. On the left side you see data points in the original space. On the right side a rotation by 45 degrees around the z-axis that have been applied to the points. This rotation can be obtained by a rotation matrix R:</p>
<div class="cell">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb1"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a>R <span class="ot">=</span> <span class="fu">matrix</span>(<span class="fu">c</span>(<span class="fl">0.7071068</span>,  <span class="fl">0.7071068</span>,  <span class="fl">0.0000000</span>, <span class="sc">-</span><span class="fl">0.7071068</span>,  <span class="fl">0.7071068</span>,  <span class="fl">0.0000000</span>,  <span class="fl">0.0000000</span>,  <span class="fl">0.0000000</span>,  <span class="fl">1.0000000</span>), <span class="at">nrow=</span><span class="dv">3</span>)</span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true" tabindex="-1"></a><span class="fu">round</span>(R,<span class="dv">4</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>       [,1]    [,2] [,3]
[1,] 0.7071 -0.7071    0
[2,] 0.7071  0.7071    0
[3,] 0.0000  0.0000    1</code></pre>
</div>
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb3"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb3-1"><a href="#cb3-1" aria-hidden="true" tabindex="-1"></a><span class="fu">par</span>(<span class="at">mfrow=</span><span class="fu">c</span>(<span class="dv">1</span>,<span class="dv">2</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<p>As we will see in a second an example a point <span class="math inline">\(x\)</span> of the rabid cloud is transformed via:</p>
<p><span class="math display">\[
  x_\text{rot} = R \, x
\]</span></p>
<div class="cell" data-layout-align="center" data-hash="Note_on_Quaternion_cache/html/rot-bunny-plot_726dc3a3331617c266b0e64cbfd2d469">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb4"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb4-1"><a href="#cb4-1" aria-hidden="true" tabindex="-1"></a><span class="fu">p3d</span>(rabbit, <span class="at">h=</span><span class="cn">NULL</span>, <span class="at">xlab=</span><span class="st">'x'</span>, <span class="at">ylab=</span><span class="st">'y'</span>, <span class="at">zlab=</span><span class="st">'z'</span>, )</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="Note_on_Quaternion_files/figure-html/rot-bunny-plot-1.png" class="img-fluid figure-img" width="960"></p>
<p></p><figcaption class="figure-caption">Left: orinial data. Right: data rotated by 45 degrees around y-axis (or coordinate system rotated by -45) degrees. The y-axis points up and the rotation is done in counter clock-wise manner</figcaption><p></p>
</figure>
</div>
</div>
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb5"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb5-1"><a href="#cb5-1" aria-hidden="true" tabindex="-1"></a><span class="co">#It's vector times Matrix for row-vectors</span></span>
<span id="cb5-2"><a href="#cb5-2" aria-hidden="true" tabindex="-1"></a><span class="co">#Therefore we have to transpose (R x) to x^T R^T</span></span>
<span id="cb5-3"><a href="#cb5-3" aria-hidden="true" tabindex="-1"></a><span class="fu">p3d</span>(rabbit <span class="sc">%*%</span> <span class="fu">t</span>(R), <span class="at">h=</span><span class="cn">NULL</span>) </span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="Note_on_Quaternion_files/figure-html/rot-bunny-plot-2.png" class="img-fluid figure-img" width="960"></p>
<p></p><figcaption class="figure-caption">Left: orinial data. Right: data rotated by 45 degrees around y-axis (or coordinate system rotated by -45) degrees. The y-axis points up and the rotation is done in counter clock-wise manner</figcaption><p></p>
</figure>
</div>
</div>
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb6"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb6-1"><a href="#cb6-1" aria-hidden="true" tabindex="-1"></a><span class="fu">par</span>(<span class="at">mfrow=</span><span class="fu">c</span>(<span class="dv">1</span>,<span class="dv">1</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
</section>
<section id="introduction" class="level2" data-number="1.2">
<h2 data-number="1.2" class="anchored" data-anchor-id="introduction"><span class="header-section-number">1.2</span> Introduction</h2>
<p>Rotations between rigid objects can be described as a linear transformation from one coordinate system to another, with the same origin. A first example is the bunny from above. Another similar example of such a rotation is the orientation of your cell phone after you picked it up compared to the position on the table, or the orientation of the thumb in figure compared to the coordinate system of the palm.</p>
<p>A very illustrative example is an airplane which is at <span class="math inline">\(t=0\)</span> on the ground and is at <span class="math inline">\(t=t\)</span> in the air. Besides the translation, the orientation of the plane at <span class="math inline">\(t=0\)</span> relative to the plane at <span class="math inline">\(t=t\)</span> can be described by a different heading (the <em>yaw</em> angle) obtained while taxing, the <em>pitch</em> angle obtained in the climbing phase and a rotation around the axis of flight the <em>roll</em> angle. During this phase many rotations happen but they can all be summarized in a single rotation.</p>
</section>
<section id="parameterization" class="level2" data-number="1.3">
<h2 data-number="1.3" class="anchored" data-anchor-id="parameterization"><span class="header-section-number">1.3</span> Parameterization</h2>
<section id="definition-of-rotations" class="level3" data-number="1.3.1">
<h3 data-number="1.3.1" class="anchored" data-anchor-id="definition-of-rotations"><span class="header-section-number">1.3.1</span> Definition of rotations</h3>
<p>Rotations can be seen as linear transformation from one coordinate system into another. But there are several way to parametrize them. The first is via a rotation matrix.</p>
</section>
<section id="rotation-matrix-general-properties" class="level3" data-number="1.3.2">
<h3 data-number="1.3.2" class="anchored" data-anchor-id="rotation-matrix-general-properties"><span class="header-section-number">1.3.2</span> Rotation matrix (general properties)</h3>
<p>In principal a rotation is given by the 9 matrix elements of <span class="math inline">\(R\)</span>. However they cannot be arbitrary, they still need to describe rotations. What are the defining properties of rotations? It turns out that a rotation, has an inverse and the inverse simply the transposed <span class="math inline">\(R^{-1} = R^T\)</span> (this is the orthogonality). Further, <span class="math inline">\(det(R)=1\)</span> this is a consequence that the volume in the rotated system stays constant and also the orientation (itâs <span class="math inline">\(det(R)=1\)</span> and not just <span class="math inline">\(|det(d)|=1\)</span>). So in matrix notation a rotation is defined by</p>
<p><span id="eq-rot"><span class="math display">\[
R=\begin{bmatrix}r_{11} &amp; r_{12} &amp; r_{13} \\r_{21} &amp; r_{22} &amp; r_{23} \\r_{31} &amp; r_{32} &amp; r_{33} \end{bmatrix}, \quad R^TR=RR^T=1,\quad det(R)=1  
\tag{1}\]</span></span></p>
<p>Multiplying two rotation matrices <span class="math inline">\(R_1\)</span> and <span class="math inline">\(R_2\)</span> is a again a rotation matrix, this is why rotations in 3D are also called special orthogonal group <code>SO(3)</code>. Note that the order of rotations matter and <span class="math inline">\(R_1 R_2 \ne R_2 R_1\)</span></p>
<p>So itâs obvious that is over parameterized using 9 values and there are constrains on the <span class="math inline">\(r_{ij}\)</span> so that eq. 1 is fulfilled.</p>
<section id="rotation-matrices-the-from-to-pitfall" class="level4" data-number="1.3.2.1">
<h4 data-number="1.3.2.1" class="anchored" data-anchor-id="rotation-matrices-the-from-to-pitfall"><span class="header-section-number">1.3.2.1</span> Rotation-Matrices (âthe from toâ pitfall)</h4>
<p>When we condescend ourselves to the depth of matrix multiplication, the first of two pitfalls lingers around. This is due to the fact that matrix multiplication introduces an order. Say, we want to transform a vector <span class="math inline">\(\vec{f}\)</span> from a âfrom coordinate systemâ into a vector <span class="math inline">\(\vec{t}\)</span> given in coordinates of the âto coordinate systemâ. We can do this via:</p>
<p><span class="math display">\[
\vec{t}=R \,\vec{f}
\]</span></p>
<p>To go the other way around, use <span class="math inline">\(\vec{f}=R^{-1} \vec{t}\)</span>. Figure XXX gives an example.</p>
<div id="fig-fromto" class="quarto-figure quarto-figure-center anchored">
<figure class="figure">
<p><img src="images/from_to_in_2D.png" class="img-fluid figure-img" width="1000"></p>
<p></p><figcaption class="figure-caption">Figure 2: A rotation, transforms the coordinates of a point, from the red coordinate system into the green.</figcaption><p></p>
</figure>
</div>
</section>
<section id="the-body-and-the-lab-frame" class="level4" data-number="1.3.2.2">
<h4 data-number="1.3.2.2" class="anchored" data-anchor-id="the-body-and-the-lab-frame"><span class="header-section-number">1.3.2.2</span> The body and the lab frame</h4>
<p>Rotations are just transformation between to coordinate system. Some coordinate system have special meanings. Itâs good to think of the airplane again and think of two coordinate systems. One is fixed with the airplane, this is called body frame one is fixed with the earth this is called lab frame.</p>
<ul>
<li><p>In the <strong>body frame</strong> of points of the plane have the same x,y,z coordinates (if nothing bad happens), a plane is rigid body.</p></li>
<li><p>In the <strong>lab frame</strong> the gravity stays constant (it points down). People not sitting in the plane see the coordinates of the plane in this system.</p></li>
</ul>
</section>
<section id="choosing-the-direction-of-the-rotation" class="level4" data-number="1.3.2.3">
<h4 data-number="1.3.2.3" class="anchored" data-anchor-id="choosing-the-direction-of-the-rotation"><span class="header-section-number">1.3.2.3</span> Choosing the direction of the rotation</h4>
<p>The question is with is the âto systemâ and which is the âfrom systemâ. As often when there is no mathematical reason for a certain way to do things, it gets ugly. There is no natural way to choose one over the other but for some applications a certain order is quite handy.</p>
<ul>
<li><p><strong>Body to Lab</strong>: If you do visualizations, it is a least concepually nicer to describe the rotation from body to lab. Knowing the points of the airplane and the rotation, you can draw a picture of the rotated airplane. They are also called <strong>frame rotations</strong>, as they involve rotating an object or coordinate frame around a specific axis. Some call them also just rotations <span class="citation" data-cites="grossekatthofer2012introduction">(<a href="#ref-grossekatthofer2012introduction" role="doc-biblioref">GroÃekatthÃ¶fer and Yoon 2012</a>)</span>.</p></li>
<li><p><strong>Lab to body:</strong> In the lab frame the gravity stays constant, often chosen in z-direction as <span class="math inline">\((0,0,-g)\)</span>, then knowing the rotation allows to calculate the gravity on the x-component of an IMU sensor in the plane. These are also called <strong>point</strong> <strong>rotations</strong> since they are made relative to a fix point in space (such as the gravity). Sometimes they go under the name (coordinate) <strong>transformations</strong>, see <span class="citation" data-cites="grossekatthofer2012introduction">(<a href="#ref-grossekatthofer2012introduction" role="doc-biblioref">GroÃekatthÃ¶fer and Yoon 2012</a>)</span>.</p></li>
</ul>
<p>It is important to state the direction of the transformation and ideally stick to that order. I find it easier use <strong>body to lab</strong> and use this transformation here.</p>
<div class="callout-important callout callout-style-default callout-captioned">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-caption-container flex-fill">
We use body to lab (a.k.a. frame) rotations in this text.
</div>
</div>
<div class="callout-body-container callout-body">

</div>
</div>
</section>
</section>
<section id="parameterization-using-elementary-rotation." class="level3" data-number="1.3.3">
<h3 data-number="1.3.3" class="anchored" data-anchor-id="parameterization-using-elementary-rotation."><span class="header-section-number">1.3.3</span> Parameterization using elementary rotation.</h3>
<p>Many repeated rotations are again a rotation (closure). Moreover it can be shown that an arbitrary rotation can be build out of three elementary rotations. Here the mess begins, there are many ways to define such as decomposition. For example one possibility is: First, a counter-clockwise rotation <span class="math inline">\(R_z(\alpha)\)</span> around the <span class="math inline">\(z\)</span>-axis by an angle of <span class="math inline">\(\alpha\)</span>. Second, <span class="math inline">\(R_x(\beta)\)</span> rotates around âthe newâ <span class="math inline">\(x\)</span>-axis and finally by <span class="math inline">\(R_z(\gamma)\)</span> around the new <span class="math inline">\(z\)</span>-axis.</p>
<div id="fig-rot-ball" class="quarto-figure quarto-figure-center anchored">
<figure class="figure">
<p><a href="https://en.wikipedia.org/wiki/Euler_angles"><img src="images/Euler2a.gif" class="img-fluid figure-img"></a></p>
<p></p><figcaption class="figure-caption">Figure 3: Animation showing the sequence of elementary rotation. Taken from wikepedia</figcaption><p></p>
</figure>
</div>
<p>The animation in <a href="#fig-rot-ball">Figure&nbsp;3</a> shows three consecutive rotations. Is is important not to forget that, we use column vector and do matrix times vector hence. The complete rotation for first <span class="math inline">\(R_1\)</span> then <span class="math inline">\(R_2\)</span> then <span class="math inline">\(R_3\)</span> is written as</p>
<div class="callout-caution callout callout-style-default callout-captioned">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-caption-container flex-fill">
Danger
</div>
</div>
<div class="callout-body-container callout-body">
<p><span class="math display">\[
R = R_3 R_2 R_1
\]</span></p>
</div>
</div>
<p>Going the other way around is also possible, you just need to redefine matrix multiplications.</p>
<div class="callout-caution callout callout-style-default callout-captioned">
<div class="callout-header d-flex align-content-center" data-bs-toggle="collapse" data-bs-target=".callout-3-contents" aria-controls="callout-3" aria-expanded="false" aria-label="Toggle callout">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-caption-container flex-fill">
More details on the order.
</div>
<div class="callout-btn-toggle d-inline-block border-0 py-1 ps-1 pe-0 float-end"><i class="callout-toggle"></i></div>
</div>
<div id="callout-3" class="callout-3-contents callout-collapse collapse">
<div class="callout-body-container callout-body">
<p>Here is an explanation (taken from stackexchange)</p>
<p>The product <span class="math inline">\(AB\)</span> of matrices is the effect of applying <span class="math inline">\(A\)</span> after applying <span class="math inline">\(B\)</span>, simply because we write the âeffectâ of a matrix <span class="math inline">\(A\)</span> on a vector <span class="math inline">\(v\)</span> as <span class="math inline">\(Av\)</span> (i.e., the convention is to work with column vectors). Thus <span class="math inline">\((AB)v = A(Bv)\)</span> is <span class="math inline">\(A\)</span> applied to <span class="math inline">\(Bv\)</span>. Note that this convention matches the usual notation for (nested) functions: <span class="math inline">\(\log(\sin(x))\)</span> is the logarithm function applied to the result from applying the sine function to <span class="math inline">\(x\)</span>.</p>
<p>Of course, the rules for computing the product of matrices are just right for this convention. Or, if one wanted <span class="math inline">\(AB\)</span> to stand for âfirst apply <span class="math inline">\(A\)</span>, then apply <span class="math inline">\(B\)</span>â, one would use row vectors instead and write âA applied to <span class="math inline">\(v\)</span>â as <span class="math inline">\(vA\)</span> - which is very uncommon (and in effect just means that one works with the transposed matrices, relative to the usual convention).</p>
</div>
</div>
</div>
<section id="deriving-the-elementary-transformations" class="level4" data-number="1.3.3.1">
<h4 data-number="1.3.3.1" class="anchored" data-anchor-id="deriving-the-elementary-transformations"><span class="header-section-number">1.3.3.1</span> Deriving the elementary transformations</h4>
<p>The individual transformations can be derived by looking where the unit vectors are transformed. In the figure below you see a derivation of the rotation matrix <span class="math inline">\(R_z(\alpha)\)</span> around the z axis with an angle of <span class="math inline">\(\alpha&gt;0\)</span> . We move the body centric coordinate system w.r.t the fixed system the direction is determined by the right-hand rule (thumb show in direction of the rotation and fingers indicate the direction)</p>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="images/rz_alpha.png" class="img-fluid figure-img"></p>
<p></p><figcaption class="figure-caption">Rotation around z-axis with positve <span class="math inline">\(\alpha\)</span> the dots from the airplane in the fixed body system.</figcaption><p></p>
</figure>
</div>
<p>So in this case we have for a rotation about <span class="math inline">\(\alpha\)</span> around the z-Axis.</p>
<p><span id="eq-yaw"><span class="math display">\[
  R_z(\alpha) = R_{L \leftarrow B}^z(\alpha) =\begin{bmatrix}\cos(\alpha) &amp; -\sin(\alpha) &amp; 0 \\\sin(\alpha) &amp;\cos(\alpha) &amp; 0 \\0 &amp; 0 &amp; 1 \end{bmatrix}
\tag{2}\]</span></span></p>
<p>For moving the rabit , we get the following rotation matrix:</p>
<div class="cell">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb7"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb7-1"><a href="#cb7-1" aria-hidden="true" tabindex="-1"></a>Rz <span class="ot">=</span> <span class="cf">function</span>(a){</span>
<span id="cb7-2"><a href="#cb7-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">return</span>(</span>
<span id="cb7-3"><a href="#cb7-3" aria-hidden="true" tabindex="-1"></a>    <span class="fu">matrix</span>(</span>
<span id="cb7-4"><a href="#cb7-4" aria-hidden="true" tabindex="-1"></a>        <span class="fu">c</span>(<span class="fu">cos</span>(a), <span class="sc">-</span><span class="fu">sin</span>(a), <span class="dv">0</span>, <span class="fu">sin</span>(a), <span class="fu">cos</span>(a), <span class="dv">0</span>, <span class="dv">0</span>, <span class="dv">0</span>, <span class="dv">1</span>)</span>
<span id="cb7-5"><a href="#cb7-5" aria-hidden="true" tabindex="-1"></a>        , <span class="at">nrow=</span><span class="dv">3</span>, <span class="at">byrow =</span> R<span class="sc">+</span><span class="cn">TRUE</span>) </span>
<span id="cb7-6"><a href="#cb7-6" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb7-7"><a href="#cb7-7" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb7-8"><a href="#cb7-8" aria-hidden="true" tabindex="-1"></a><span class="fu">Rz</span>(<span class="dv">45</span><span class="sc">*</span><span class="dv">2</span><span class="sc">*</span>pi<span class="sc">/</span><span class="dv">360</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>          [,1]       [,2] [,3]
[1,] 0.7071068 -0.7071068    0
[2,] 0.7071068  0.7071068    0
[3,] 0.0000000  0.0000000    1</code></pre>
</div>
</div>
<p>which is same rotation as used in the code used to transform the data.</p>
</section>
<section id="a-worked-out-example-yaw-pitch-roll" class="level4" data-number="1.3.3.2">
<h4 data-number="1.3.3.2" class="anchored" data-anchor-id="a-worked-out-example-yaw-pitch-roll"><span class="header-section-number">1.3.3.2</span> A worked out example (Yaw-Pitch-Roll)</h4>
<p>Using an airplane, we know what happens (taxiing, take-off, rolling) and we can derive a nice chain of elementary rotations, which will serve as reference for later. The derivation can also be found at the following <a href="https://www.dropbox.com/s/n3oc5fjwrn1zaiu/Rotations%20without%20tears.pdf?dl=0">notes</a>.</p>
<p>In the example, we use the following angles</p>
<div class="cell">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb9"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb9-1"><a href="#cb9-1" aria-hidden="true" tabindex="-1"></a>yaw <span class="ot">=</span> <span class="dv">60</span> <span class="sc">*</span> <span class="dv">2</span> <span class="sc">*</span> pi <span class="sc">/</span> <span class="dv">360</span>     <span class="co">#This is w.r.t. the tower / labframe</span></span>
<span id="cb9-2"><a href="#cb9-2" aria-hidden="true" tabindex="-1"></a>pitch <span class="ot">=</span> <span class="sc">-</span><span class="dv">50</span> <span class="sc">*</span> <span class="dv">2</span> <span class="sc">*</span> pi <span class="sc">/</span> <span class="dv">360</span>  <span class="co">#Angle of climb</span></span>
<span id="cb9-3"><a href="#cb9-3" aria-hidden="true" tabindex="-1"></a>roll <span class="ot">=</span> <span class="dv">40</span> <span class="sc">*</span> <span class="dv">2</span> <span class="sc">*</span> pi <span class="sc">/</span> <span class="dv">360</span>    <span class="co">#Angle of roll</span></span>
<span id="cb9-4"><a href="#cb9-4" aria-hidden="true" tabindex="-1"></a><span class="fu">print</span>(<span class="fu">paste</span>(<span class="st">'In rad yaw '</span>, yaw, <span class="st">' pitch '</span>, pitch, <span class="st">' roll '</span>,roll))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>[1] "In rad yaw  1.0471975511966  pitch  -0.872664625997165  roll  0.698131700797732"</code></pre>
</div>
</div>
<p>The pitch needs to be negative in order that a the rotation leads to a ascent (see later).</p>
<section id="taxiing-yaw-alpha" class="level5" data-number="1.3.3.2.1">
<h5 data-number="1.3.3.2.1" class="anchored" data-anchor-id="taxiing-yaw-alpha"><span class="header-section-number">1.3.3.2.1</span> Taxiing yaw <span class="math inline">\(\alpha\)</span></h5>
<p>For the given yaw we have:</p>
<div class="cell">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb11"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb11-1"><a href="#cb11-1" aria-hidden="true" tabindex="-1"></a>R.yaw <span class="ot">=</span> <span class="fu">Rz</span>(yaw) </span>
<span id="cb11-2"><a href="#cb11-2" aria-hidden="true" tabindex="-1"></a>R.yaw</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>          [,1]       [,2] [,3]
[1,] 0.5000000 -0.8660254    0
[2,] 0.8660254  0.5000000    0
[3,] 0.0000000  0.0000000    1</code></pre>
</div>
</div>
</section>
<section id="construction-of-data-points-for-the-airplane." class="level5" data-number="1.3.3.2.2">
<h5 data-number="1.3.3.2.2" class="anchored" data-anchor-id="construction-of-data-points-for-the-airplane."><span class="header-section-number">1.3.3.2.2</span> Construction of data points for the airplane.</h5>
<p>We create <span class="math inline">\(3 \times N\)</span> data points so that it is easier for plotting. When we want to use the normal data points in statistics, we could use vector times matrix and do proper transposing.</p>
<div class="cell">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb13"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb13-1"><a href="#cb13-1" aria-hidden="true" tabindex="-1"></a><span class="fu">set.seed</span>(<span class="dv">42</span>)</span>
<span id="cb13-2"><a href="#cb13-2" aria-hidden="true" tabindex="-1"></a>n <span class="ot">=</span> <span class="dv">1100</span></span>
<span id="cb13-3"><a href="#cb13-3" aria-hidden="true" tabindex="-1"></a>x <span class="ot">=</span> <span class="fu">runif</span>(n,<span class="sc">-</span><span class="dv">1</span>,<span class="dv">1</span>)</span>
<span id="cb13-4"><a href="#cb13-4" aria-hidden="true" tabindex="-1"></a>y <span class="ot">=</span> <span class="fu">runif</span>(n, <span class="sc">-</span><span class="fl">0.4</span>,<span class="fl">0.4</span>)</span>
<span id="cb13-5"><a href="#cb13-5" aria-hidden="true" tabindex="-1"></a>z <span class="ot">=</span> <span class="fu">runif</span>(n,<span class="sc">-</span><span class="fl">0.1</span>,<span class="fl">0.1</span>)</span>
<span id="cb13-6"><a href="#cb13-6" aria-hidden="true" tabindex="-1"></a>col <span class="ot">=</span> <span class="fu">rep</span>(<span class="st">'blue'</span>,n)</span>
<span id="cb13-7"><a href="#cb13-7" aria-hidden="true" tabindex="-1"></a>col[x<span class="sc">&gt;</span><span class="fl">0.5</span>] <span class="ot">=</span> <span class="st">'red'</span></span>
<span id="cb13-8"><a href="#cb13-8" aria-hidden="true" tabindex="-1"></a>col[x<span class="sc">&lt;=</span> <span class="sc">-</span><span class="fl">0.5</span>] <span class="ot">=</span> <span class="st">'green'</span></span>
<span id="cb13-9"><a href="#cb13-9" aria-hidden="true" tabindex="-1"></a>col[y<span class="sc">&lt;=</span> <span class="sc">-</span><span class="fl">0.2</span>] <span class="ot">=</span> <span class="st">'gray30'</span></span>
<span id="cb13-10"><a href="#cb13-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-11"><a href="#cb13-11" aria-hidden="true" tabindex="-1"></a>plane <span class="ot">=</span> <span class="fu">as.matrix</span>(<span class="fu">data.frame</span>(<span class="at">x=</span>x,<span class="at">y=</span>y,<span class="at">z=</span>z))</span>
<span id="cb13-12"><a href="#cb13-12" aria-hidden="true" tabindex="-1"></a>plane <span class="ot">=</span> <span class="fu">t</span>(plane) <span class="co">#3xN</span></span>
<span id="cb13-13"><a href="#cb13-13" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(rgl)</span>
<span id="cb13-14"><a href="#cb13-14" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(scatterplot3d) <span class="co"># load</span></span>
<span id="cb13-15"><a href="#cb13-15" aria-hidden="true" tabindex="-1"></a> </span>
<span id="cb13-16"><a href="#cb13-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-17"><a href="#cb13-17" aria-hidden="true" tabindex="-1"></a>make_plot <span class="ot">=</span> <span class="cf">function</span>(p1, p2, <span class="at">l1=</span><span class="fu">c</span>(<span class="st">'x'</span>,<span class="st">'y'</span>,<span class="st">'z'</span>), <span class="at">l2=</span><span class="fu">c</span>(<span class="st">'x'</span>,<span class="st">'y'</span>,<span class="st">'z'</span>), <span class="at">angle =</span> <span class="dv">55</span>) {</span>
<span id="cb13-18"><a href="#cb13-18" aria-hidden="true" tabindex="-1"></a>  <span class="fu">par</span>(<span class="at">mfrow=</span><span class="fu">c</span>(<span class="dv">1</span>,<span class="dv">2</span>))</span>
<span id="cb13-19"><a href="#cb13-19" aria-hidden="true" tabindex="-1"></a>  p1 <span class="ot">=</span> <span class="fu">t</span>(p1)</span>
<span id="cb13-20"><a href="#cb13-20" aria-hidden="true" tabindex="-1"></a>  p2 <span class="ot">=</span> <span class="fu">t</span>(p2)</span>
<span id="cb13-21"><a href="#cb13-21" aria-hidden="true" tabindex="-1"></a>  <span class="co">#First plot</span></span>
<span id="cb13-22"><a href="#cb13-22" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scatterplot3d</span>(p1[,<span class="dv">1</span>],p1[,<span class="dv">2</span>],p1[,<span class="dv">3</span>], </span>
<span id="cb13-23"><a href="#cb13-23" aria-hidden="true" tabindex="-1"></a>                <span class="at">xlim=</span><span class="fu">c</span>(<span class="sc">-</span><span class="dv">1</span>,<span class="dv">1</span>), <span class="at">ylim=</span><span class="fu">c</span>(<span class="sc">-</span><span class="dv">1</span>,<span class="dv">1</span>), <span class="at">zlim=</span><span class="fu">c</span>(<span class="sc">-</span><span class="dv">1</span>,<span class="dv">1</span>), </span>
<span id="cb13-24"><a href="#cb13-24" aria-hidden="true" tabindex="-1"></a>                <span class="at">color =</span> col,</span>
<span id="cb13-25"><a href="#cb13-25" aria-hidden="true" tabindex="-1"></a>                <span class="at">xlab=</span>l1[<span class="dv">1</span>], <span class="at">ylab=</span>l1[<span class="dv">2</span>], <span class="at">zlab =</span> l1[<span class="dv">3</span>],<span class="at">angle =</span> angle, <span class="at">pch=</span><span class="dv">16</span>)</span>
<span id="cb13-26"><a href="#cb13-26" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scatterplot3d</span>(p2[,<span class="dv">1</span>],p2[,<span class="dv">2</span>],p2[,<span class="dv">3</span>], </span>
<span id="cb13-27"><a href="#cb13-27" aria-hidden="true" tabindex="-1"></a>                <span class="at">xlim=</span><span class="fu">c</span>(<span class="sc">-</span><span class="dv">1</span>,<span class="dv">1</span>), <span class="at">ylim=</span><span class="fu">c</span>(<span class="sc">-</span><span class="dv">1</span>,<span class="dv">1</span>), <span class="at">zlim=</span><span class="fu">c</span>(<span class="sc">-</span><span class="dv">1</span>,<span class="dv">1</span>), </span>
<span id="cb13-28"><a href="#cb13-28" aria-hidden="true" tabindex="-1"></a>                <span class="at">color =</span> col,</span>
<span id="cb13-29"><a href="#cb13-29" aria-hidden="true" tabindex="-1"></a>                <span class="at">xlab=</span>l2[<span class="dv">1</span>], <span class="at">ylab=</span>l2[<span class="dv">2</span>], <span class="at">zlab =</span> l2[<span class="dv">3</span>],<span class="at">angle =</span> angle, <span class="at">pch=</span><span class="dv">16</span>)</span>
<span id="cb13-30"><a href="#cb13-30" aria-hidden="true" tabindex="-1"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<p>To visualize, we need the body coordinates, transformed to lab coordinates.</p>
<div class="cell">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb14"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb14-1"><a href="#cb14-1" aria-hidden="true" tabindex="-1"></a><span class="do">##Since we have column vector, we have to transpose once more yielding</span></span>
<span id="cb14-2"><a href="#cb14-2" aria-hidden="true" tabindex="-1"></a>plane.yaw  <span class="ot">=</span> R.yaw <span class="sc">%*%</span> plane </span>
<span id="cb14-3"><a href="#cb14-3" aria-hidden="true" tabindex="-1"></a><span class="fu">make_plot</span>(plane, plane.yaw, <span class="at">l2=</span><span class="fu">c</span>(<span class="st">"x'"</span>,<span class="st">"y'"</span>,<span class="st">"z'"</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="Note_on_Quaternion_files/figure-html/yaw-plane-1.png" class="img-fluid figure-img" width="960"></p>
<p></p><figcaption class="figure-caption">Left: orinial data. Right: data rotated by yaw degrees around z-axis</figcaption><p></p>
</figure>
</div>
</div>
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb15"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb15-1"><a href="#cb15-1" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> (<span class="cn">FALSE</span>){<span class="co">#Debuggin</span></span>
<span id="cb15-2"><a href="#cb15-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">print</span>(<span class="st">'Maximal difference, in x-direction'</span>)</span>
<span id="cb15-3"><a href="#cb15-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">max</span>(<span class="fu">abs</span>(plane.yaw[,<span class="dv">3</span>] <span class="sc">-</span> plane[,<span class="dv">3</span>]))</span>
<span id="cb15-4"><a href="#cb15-4" aria-hidden="true" tabindex="-1"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
</section>
<section id="take-off-the-pitch-beta" class="level5" data-number="1.3.3.2.3">
<h5 data-number="1.3.3.2.3" class="anchored" data-anchor-id="take-off-the-pitch-beta"><span class="header-section-number">1.3.3.2.3</span> Take-off the pitch <span class="math inline">\(\beta\)</span></h5>
<p>When the plane takes off, all rotates rotated about <span class="math inline">\(\beta\)</span> about the y-axis. This is given by</p>
<p><span class="math display">\[
  R^y(\beta) = \begin{bmatrix}\cos(\beta) &amp; 0 &amp; +\sin(\beta)\\
   0 &amp; 1 &amp; 0 \\
  -\sin(\beta) &amp; 0 &amp; \cos(\beta)\end{bmatrix}
\]</span></p>
<p>Note that the rotation is about the y-axis (use the right hand the thumb is the axis and the fingers shows the direction). Acceding, corresponds to negative values (thatâs the reason we choose negative value)</p>
<div class="cell">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb16"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb16-1"><a href="#cb16-1" aria-hidden="true" tabindex="-1"></a>Ry <span class="ot">=</span> <span class="cf">function</span>(b) <span class="fu">matrix</span>(</span>
<span id="cb16-2"><a href="#cb16-2" aria-hidden="true" tabindex="-1"></a>      <span class="fu">c</span>(<span class="fu">cos</span>(b), <span class="dv">0</span>, <span class="sc">+</span><span class="fu">sin</span>(b), <span class="dv">0</span>, <span class="dv">1</span>, <span class="dv">0</span>, <span class="sc">-</span><span class="fu">sin</span>(b), <span class="dv">0</span>, <span class="fu">cos</span>(b))</span>
<span id="cb16-3"><a href="#cb16-3" aria-hidden="true" tabindex="-1"></a>      , <span class="at">nrow=</span><span class="dv">3</span>, <span class="at">byrow =</span> <span class="cn">TRUE</span>) </span>
<span id="cb16-4"><a href="#cb16-4" aria-hidden="true" tabindex="-1"></a>R.pitch <span class="ot">=</span> <span class="fu">Ry</span>(pitch) </span>
<span id="cb16-5"><a href="#cb16-5" aria-hidden="true" tabindex="-1"></a>R.pitch</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>          [,1] [,2]       [,3]
[1,] 0.6427876    0 -0.7660444
[2,] 0.0000000    1  0.0000000
[3,] 0.7660444    0  0.6427876</code></pre>
</div>
</div>
<section id="takeoff-without-taxiing" class="level6" data-number="1.3.3.2.3.1">
<h6 data-number="1.3.3.2.3.1" class="anchored" data-anchor-id="takeoff-without-taxiing"><span class="header-section-number">1.3.3.2.3.1</span> Takeoff without taxiing</h6>
<div class="cell">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb18"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb18-1"><a href="#cb18-1" aria-hidden="true" tabindex="-1"></a><span class="fu">make_plot</span>(plane, R.pitch <span class="sc">%*%</span> plane)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="Note_on_Quaternion_files/figure-html/unnamed-chunk-4-1.png" class="img-fluid figure-img" width="960"></p>
<p></p><figcaption class="figure-caption">Left: orinial data. Right: data rotated by XXX degrees around y-axis</figcaption><p></p>
</figure>
</div>
</div>
</div>
</section>
<section id="takeoff-with-taxiing" class="level6" data-number="1.3.3.2.3.2">
<h6 data-number="1.3.3.2.3.2" class="anchored" data-anchor-id="takeoff-with-taxiing"><span class="header-section-number">1.3.3.2.3.2</span> Takeoff with taxiing</h6>
<p>Here, we combine the transformations (<strong>note the order</strong>)</p>
<p><span class="math display">\[
x=R^{y}(\beta)R^z(\alpha)x'
\]</span></p>
<div class="cell">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb19"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb19-1"><a href="#cb19-1" aria-hidden="true" tabindex="-1"></a>R <span class="ot">=</span> R.pitch <span class="sc">%*%</span> R.yaw</span>
<span id="cb19-2"><a href="#cb19-2" aria-hidden="true" tabindex="-1"></a>plane.pitch.yaw <span class="ot">=</span> R <span class="sc">%*%</span> plane </span>
<span id="cb19-3"><a href="#cb19-3" aria-hidden="true" tabindex="-1"></a><span class="fu">make_plot</span>(plane.yaw, plane.pitch.yaw,<span class="at">l1=</span><span class="fu">c</span>(<span class="st">"x'"</span>, <span class="st">"y'"</span>, <span class="st">"z''"</span>), <span class="at">l2=</span><span class="fu">c</span>(<span class="st">"x''"</span>, <span class="st">"y''"</span>, <span class="st">"z''"</span>)) </span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="Note_on_Quaternion_files/figure-html/unnamed-chunk-6-1.png" class="img-fluid figure-img" width="960"></p>
<p></p><figcaption class="figure-caption">Left: orinial data. Right: data rotated by XXX degrees around y-axis</figcaption><p></p>
</figure>
</div>
</div>
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb20"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb20-1"><a href="#cb20-1" aria-hidden="true" tabindex="-1"></a><span class="co">#plot3d(plane.pitch.yaw[,1],plane.pitch.yaw[,2],plane.pitch.yaw[,3], xlim=c(-1,1), ylim=c(-1,1), zlim=c(-1,1), col=col) </span></span>
<span id="cb20-2"><a href="#cb20-2" aria-hidden="true" tabindex="-1"></a><span class="co">#rglwidget()</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
</section>
</section>
<section id="in-the-air-the-roll-gamma" class="level5" data-number="1.3.3.2.4">
<h5 data-number="1.3.3.2.4" class="anchored" data-anchor-id="in-the-air-the-roll-gamma"><span class="header-section-number">1.3.3.2.4</span> In the air, the roll <span class="math inline">\(\gamma\)</span></h5>
<p>Now that we are in the air, we roll the plane about a certain degree around the x-axis. This can be done by</p>
<p><span class="math display">\[
R^x(\gamma) = \begin{bmatrix}
1 &amp; 0 &amp; 0\\
0 &amp; \cos(\gamma) &amp; -\sin(\gamma) \\
0 &amp; \sin(\gamma) &amp; \cos(\gamma) \end{bmatrix}
\]</span></p>
<div class="cell">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb21"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb21-1"><a href="#cb21-1" aria-hidden="true" tabindex="-1"></a>Rx <span class="ot">=</span> <span class="cf">function</span>(g) <span class="fu">matrix</span>(</span>
<span id="cb21-2"><a href="#cb21-2" aria-hidden="true" tabindex="-1"></a>      <span class="fu">c</span>(<span class="dv">1</span>,<span class="dv">0</span>,<span class="dv">0</span>, <span class="dv">0</span>, <span class="fu">cos</span>(g), <span class="sc">-</span><span class="fu">sin</span>(g), <span class="dv">0</span>, <span class="fu">sin</span>(g), <span class="fu">cos</span>(g))</span>
<span id="cb21-3"><a href="#cb21-3" aria-hidden="true" tabindex="-1"></a>      , <span class="at">nrow=</span><span class="dv">3</span>, <span class="at">byrow =</span> <span class="cn">TRUE</span>) </span>
<span id="cb21-4"><a href="#cb21-4" aria-hidden="true" tabindex="-1"></a>R.roll<span class="ot">=</span><span class="fu">Rx</span>(roll)</span>
<span id="cb21-5"><a href="#cb21-5" aria-hidden="true" tabindex="-1"></a>R.roll</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>     [,1]      [,2]       [,3]
[1,]    1 0.0000000  0.0000000
[2,]    0 0.7660444 -0.6427876
[3,]    0 0.6427876  0.7660444</code></pre>
</div>
</div>
<p><br>
The final transformation can be found via</p>
<p><span class="math display">\[
x=R(\alpha, \beta, \gamma)\,x= R^{x}(\gamma) R^{y}(\beta)\,R^z(\alpha)x'
\]</span></p>
<div class="cell">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb23"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb23-1"><a href="#cb23-1" aria-hidden="true" tabindex="-1"></a>R <span class="ot">=</span> R.roll <span class="sc">%*%</span> R.pitch <span class="sc">%*%</span> R.yaw</span>
<span id="cb23-2"><a href="#cb23-2" aria-hidden="true" tabindex="-1"></a>plane.roll.pitch.yaw <span class="ot">=</span> R <span class="sc">%*%</span> plane </span>
<span id="cb23-3"><a href="#cb23-3" aria-hidden="true" tabindex="-1"></a><span class="fu">make_plot</span>(plane.pitch.yaw, plane.roll.pitch.yaw,<span class="at">l1=</span><span class="fu">c</span>(<span class="st">"x''"</span>, <span class="st">"y''"</span>, <span class="st">"z''"</span>), <span class="at">l2=</span><span class="fu">c</span>(<span class="st">"x'''"</span>, <span class="st">"y'''"</span>, <span class="st">"z'''"</span>)) </span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="Note_on_Quaternion_files/figure-html/comp_trafo-1.png" class="img-fluid figure-img" width="960"></p>
<p></p><figcaption class="figure-caption">Left: orinial data. Right: data rotated by degrees around y-axis</figcaption><p></p>
</figure>
</div>
</div>
</div>
<p>Playing around (sorry not in document yet)</p>
<div class="cell">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb24"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb24-1"><a href="#cb24-1" aria-hidden="true" tabindex="-1"></a><span class="co">#Return the rotion matrix (Lab  &lt;- Fixed)</span></span>
<span id="cb24-2"><a href="#cb24-2" aria-hidden="true" tabindex="-1"></a>get_R <span class="ot">=</span> <span class="cf">function</span>(yaw, roll, pitch){</span>
<span id="cb24-3"><a href="#cb24-3" aria-hidden="true" tabindex="-1"></a>   Rroll <span class="ot">=</span> <span class="fu">Rx</span>(roll)</span>
<span id="cb24-4"><a href="#cb24-4" aria-hidden="true" tabindex="-1"></a>   Ryaw  <span class="ot">=</span> <span class="fu">Rz</span>(yaw)</span>
<span id="cb24-5"><a href="#cb24-5" aria-hidden="true" tabindex="-1"></a>   Rp <span class="ot">=</span> <span class="fu">Ry</span>(pitch) </span>
<span id="cb24-6"><a href="#cb24-6" aria-hidden="true" tabindex="-1"></a>   Rani <span class="ot">=</span> Rroll <span class="sc">%*%</span> Rp <span class="sc">%*%</span> Ryaw</span>
<span id="cb24-7"><a href="#cb24-7" aria-hidden="true" tabindex="-1"></a>   <span class="fu">return</span>(Rani)</span>
<span id="cb24-8"><a href="#cb24-8" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb24-9"><a href="#cb24-9" aria-hidden="true" tabindex="-1"></a><span class="fu">get_R</span>(yaw, roll, pitch)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>          [,1]       [,2]       [,3]
[1,] 0.3213938 -0.5566704 -0.7660444
[2,] 0.4172120  0.8094565 -0.4131759
[3,] 0.8500824 -0.1868108  0.4924039</code></pre>
</div>
</div>
<div class="cell">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb26"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb26-1"><a href="#cb26-1" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> (<span class="cn">FALSE</span>){</span>
<span id="cb26-2"><a href="#cb26-2" aria-hidden="true" tabindex="-1"></a>  <span class="do">##### copy paste the code below</span></span>
<span id="cb26-3"><a href="#cb26-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">library</span>(manipulate)</span>
<span id="cb26-4"><a href="#cb26-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">manipulate</span>(</span>
<span id="cb26-5"><a href="#cb26-5" aria-hidden="true" tabindex="-1"></a>    {</span>
<span id="cb26-6"><a href="#cb26-6" aria-hidden="true" tabindex="-1"></a>      plane.lab <span class="ot">=</span> <span class="fu">get_R</span>(<span class="at">yaw=</span>yaw, <span class="at">roll=</span>roll, <span class="at">pitch =</span> pitch) <span class="sc">%*%</span> plane</span>
<span id="cb26-7"><a href="#cb26-7" aria-hidden="true" tabindex="-1"></a>      <span class="fu">make_plot</span>(plane, plane.lab,<span class="at">l1=</span><span class="fu">c</span>(<span class="st">"x''"</span>, <span class="st">"y''"</span>, <span class="st">"z''"</span>), <span class="at">l2=</span><span class="fu">c</span>(<span class="st">"x'''"</span>, <span class="st">"y'''"</span>, <span class="st">"z'''"</span>))</span>
<span id="cb26-8"><a href="#cb26-8" aria-hidden="true" tabindex="-1"></a>    },</span>
<span id="cb26-9"><a href="#cb26-9" aria-hidden="true" tabindex="-1"></a>      <span class="at">yaw =</span> <span class="fu">slider</span>(<span class="dv">0</span>, <span class="dv">2</span><span class="sc">*</span>pi, <span class="at">initial =</span> <span class="dv">0</span>),</span>
<span id="cb26-10"><a href="#cb26-10" aria-hidden="true" tabindex="-1"></a>      <span class="at">pitch =</span> <span class="fu">slider</span>(<span class="sc">-</span>pi<span class="sc">/</span><span class="dv">2</span>,pi<span class="sc">/</span><span class="dv">2</span>, <span class="at">initial =</span> <span class="dv">0</span>),</span>
<span id="cb26-11"><a href="#cb26-11" aria-hidden="true" tabindex="-1"></a>      <span class="at">roll =</span> <span class="fu">slider</span>(<span class="sc">-</span>pi, pi, <span class="at">initial =</span> <span class="dv">0</span>)</span>
<span id="cb26-12"><a href="#cb26-12" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb26-13"><a href="#cb26-13" aria-hidden="true" tabindex="-1"></a>}  </span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
</section>
</section>
<section id="note-on-airplane-system" class="level4" data-number="1.3.3.3">
<h4 data-number="1.3.3.3" class="anchored" data-anchor-id="note-on-airplane-system"><span class="header-section-number">1.3.3.3</span> Note on airplane system</h4>
<p>The choice to have the z-axis pointing up and so on has been arbitrary, the only important thing is that we have right handed coordinate systems. If you donât like the fact that you need a negative pitch and that you are willing to give up that the z-axis is pointing upwards, you can use a coordinate system like, shown in the next picture.</p>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><a href="https://www.google.com/url?sa=i&amp;url=https%3A%2F%2Fnovatel.com%2Fsolutions%2Fattitude&amp;psig=AOvVaw2-ILI77A8TF1OFVhpc2vug&amp;ust=1671809153449000&amp;source=images&amp;cd=vfe&amp;ved=0CBAQjRxqFwoTCIjXn8bEjfwCFQAAAAAdAAAAABAI"><img src="images/flight_coordinate.png" class="img-fluid figure-img" width="576"></a></p>
<p></p><figcaption class="figure-caption">Alternative coordinate system. Note the rotations stay the same.</figcaption><p></p>
</figure>
</div>
</section>
<section id="gimbal-look" class="level4" data-number="1.3.3.4">
<h4 data-number="1.3.3.4" class="anchored" data-anchor-id="gimbal-look"><span class="header-section-number">1.3.3.4</span> Gimbal Look</h4>
<p>Further, in this parameterization the effect of changing the angles by a bit has different effects depending on the values. In the extreme case changing the angle does nothing anymore, which is known under the name gimbals look (see e.g.&nbsp;<a href="https://towardsdatascience.com/better-rotation-representations-for-accurate-pose-estimation-e890a7e1317f">here</a> for a nice demonstration).</p>
</section>
</section>
</section>
</section>
<section id="quaternions" class="level1" data-number="2">
<h1 data-number="2"><span class="header-section-number">2</span> Quaternions</h1>
<p>Besides defining a rotation by 3 elementary rotations, with the many implied ambiguities and the gimbal lock there are other possibilities to describe rotations. Quaterions are such a possibility. They used as standard output format of many libraries such as <a href="https://ahrs.readthedocs.io/en/latest/index.html#">AHRS</a> and the IMU sensors. Quaternions are objects which consists of 4 numbers, and the rotation around a vector can be nicely described with them as we will see in a second. But they also have some mathematical raison dâetre.</p>
<section id="definition-of-quaternions" class="level2" data-number="2.1">
<h2 data-number="2.1" class="anchored" data-anchor-id="definition-of-quaternions"><span class="header-section-number">2.1</span> Definition of Quaternions</h2>
<p>Complex numbers <span class="math inline">\(|a|e^{i \theta}\)</span> describe points in the real / imaginary space. Rotations in 2D can be nicely described by them using multiplications. Quaternions can be seen as a generalization of complex numbers with two more imaginary like units <span class="math inline">\(i,j,k\)</span>. Using these, the quaternion can be written as:</p>
<p><span class="math display">\[
q =  (q_w, q_1, q_2, q_3) = q_w + q_1 i + q_2 j + q_3 k
\]</span></p>
<p>The basis have some properties (there are more)</p>
<p><span class="math display">\[
  i^2=j^2=k^2=ijk=-1 \;\; ij = -ji = k
\]</span></p>
<p>The length of a quaternion can be determined as:</p>
<p><span class="math display">\[
  ||q|| = \sqrt{q_w^2 + q_1^2 + q_2^2 + q_3^2 }
\]</span></p>
<p>Here, we are dealing with quaternions of length 1 and almost all quaternions used in Computergraphics are unit quaternions or a.k.a. <em>rotation quaternions</em>.</p>
<div class="callout-note callout callout-style-default callout-captioned">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-caption-container flex-fill">
Note
</div>
</div>
<div class="callout-body-container callout-body">
<p>Only unit quaternions</p>
<p>All quaternions here are unit / rotation quaternions with length = 1</p>
</div>
</div>
<section id="geometric-representation-with-rotation-quaternions" class="level3" data-number="2.1.1">
<h3 data-number="2.1.1" class="anchored" data-anchor-id="geometric-representation-with-rotation-quaternions"><span class="header-section-number">2.1.1</span> Geometric Representation with rotation quaternions</h3>
<p>All rotations can be described by unit vector <span class="math inline">\(\vec{r}=(r_x,r_y,r_z)\)</span> and a counter clock wise rotation (right hand rule) around this vector by an angle <span class="math inline">\(\theta\)</span>. This is shown in the following figure</p>
<div id="fig-rot" class="quarto-figure quarto-figure-center anchored">
<figure class="figure">
<p><img src="images/rotation_abitrary_vector.png" class="img-fluid figure-img" width="400"></p>
<p></p><figcaption class="figure-caption">Figure 4: Rotation around a vector</figcaption><p></p>
</figure>
</div>
<p>A rotation around <span class="math inline">\(\vec{r}\)</span> can parameterized with the unit quaternion</p>
<p><span class="math display">\[
  q(\theta, v) = \cos(\frac{\theta}{2}) + i \sin(\frac{\theta}{2}) r_1 +
  j \sin(\frac{\theta}{2}) r_2 + k \sin(\frac{\theta}{2}) r_3
\]</span></p>
<p>or componentwise</p>
<p><span class="math display">\[
q(\theta, v) =  \left(\cos(\frac{\theta}{2}),\; \sin(\frac{\theta}{2})  v_1, \;\sin(\frac{\theta} {2}) v_2, \;\sin(\frac{\theta}{2}) v_3 \right)
\]</span></p>
<p>The length of <span class="math inline">\(q\)</span> is <span class="math inline">\(||q||=\cos^2(\theta/2) + \sin^2(\theta/2) (v_1^2 + v_2^2 + v_3^2) = \cos^2(\theta/2) + \sin^2(\theta/2) = 1\)</span></p>
<section id="construction-of-quaternion-from-vector-and-angle" class="level4" data-number="2.1.1.1">
<h4 data-number="2.1.1.1" class="anchored" data-anchor-id="construction-of-quaternion-from-vector-and-angle"><span class="header-section-number">2.1.1.1</span> Construction of quaternion from vector and angle</h4>
<p>Some special quaternions. The yawing can be described by a rotation of <span class="math inline">\(\theta\)</span> around the vector <span class="math inline">\(\vec{r} = (0,0,1)\)</span> and is given by</p>
<p><span class="math display">\[
q_{\text yaw} = (\cos(\frac{\theta}{2}) \theta, 0, 0, \sin(\frac{1}{2} \theta))
\]</span></p>
<p>The identity be constructed with <span class="math inline">\(\theta=0\)</span> about any axis <span class="math inline">\(q(0) = (\cos(0), v_1 \sin(0), v_2 \sin(0), v_3 \sin(0) = (1,0,0,0)\)</span>.</p>
</section>
</section>
<section id="quaterion-algebra" class="level3" data-number="2.1.2">
<h3 data-number="2.1.2" class="anchored" data-anchor-id="quaterion-algebra"><span class="header-section-number">2.1.2</span> Quaterion Algebra</h3>
<ul>
<li><p>Addition (easy but no geometeric interpretation), just for reference <span class="math display">\[
q + p = p + q =  q_w + p_w + (q_1 + p_1) i + (q_2 + p_2) j + (q_3 + p_3) k
\]</span></p></li>
<li><p>Multiplication: The multiplication is not commutative <span class="math display">\[
q * p \ne p * q = \tt{Complicated Formula}
\]</span></p></li>
<li><p>Conjugate (just i â&gt; -i same for j and k) <span class="math display">\[
q^* = q_w â i q_x â j q_y â k q_z
\]</span></p></li>
<li><p>Inverse (in gernal) <span class="math display">\[
q^{-1} = q^*/||q||
\]</span></p></li>
<li><p>Inverse (in for rotation quaternions)</p></li>
</ul>
<p><span class="math display">\[
q^{-1}=q^*
\]</span></p>
<p>So for unit quaternions, you just have to conjugate to get the inverse. Luckily, we donât have to remember the formulaes and can use the onion-package.</p>
</section>
<section id="constructing-a-rotation-matrix-from-quaterions-first-solution" class="level3" data-number="2.1.3">
<h3 data-number="2.1.3" class="anchored" data-anchor-id="constructing-a-rotation-matrix-from-quaterions-first-solution"><span class="header-section-number">2.1.3</span> Constructing a rotation matrix from Quaterions (first solution)</h3>
<p>Itâs possible to translate the quaternions back to a rotation matrix, see <a href="https://github.com/oduerr/gesture/blob/main/R/rotation_utils.R">quat_to_mat</a>. The code has been taken <a href="https://automaticaddison.com/how-to-convert-a-quaternion-to-a-rotation-matrix/">from</a> We can construct our yaw matrix via</p>
<div class="cell">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb27"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb27-1"><a href="#cb27-1" aria-hidden="true" tabindex="-1"></a>  q01 <span class="ot">=</span> <span class="fu">c</span>(<span class="fu">cos</span>(yaw<span class="sc">/</span><span class="dv">2</span>), <span class="dv">0</span>, <span class="dv">0</span>, <span class="dv">1</span> <span class="sc">*</span> <span class="fu">sin</span>(yaw<span class="sc">/</span><span class="dv">2</span>))</span>
<span id="cb27-2"><a href="#cb27-2" aria-hidden="true" tabindex="-1"></a>  <span class="co">#sum(q01^2) #1</span></span>
<span id="cb27-3"><a href="#cb27-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">quat_to_mat</span>(q01)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>          [,1]       [,2] [,3]
[1,] 0.5000000 -0.8660254    0
[2,] 0.8660254  0.5000000    0
[3,] 0.0000000  0.0000000    1</code></pre>
</div>
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb29"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb29-1"><a href="#cb29-1" aria-hidden="true" tabindex="-1"></a>  <span class="fu">Rz</span>(yaw)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>          [,1]       [,2] [,3]
[1,] 0.5000000 -0.8660254    0
[2,] 0.8660254  0.5000000    0
[3,] 0.0000000  0.0000000    1</code></pre>
</div>
</div>
</section>
<section id="chaining-rotations-with-quaterions-just-multiply-them" class="level3" data-number="2.1.4">
<h3 data-number="2.1.4" class="anchored" data-anchor-id="chaining-rotations-with-quaterions-just-multiply-them"><span class="header-section-number">2.1.4</span> Chaining rotations with quaterions (just multiply them)</h3>
<p>Now comes properly the most useful thing, that successive rotations can be done by multiplying the respective quaternions. Letâs try this out, and move the rabit. Note we are still considering body to lab rotations.</p>
<p>Letâs multiply several quaternions. We start with <span class="math inline">\(q_0 = (1,0,0,0)\)</span>.</p>
<div class="cell" data-layout-align="center" name="bunny1" data-hash="Note_on_Quaternion_cache/html/unnamed-chunk-14_2fc6a4dfd8ef7535c9d2474b7767dbdd">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb31"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb31-1"><a href="#cb31-1" aria-hidden="true" tabindex="-1"></a>  q0 <span class="ot">=</span> onion<span class="sc">::</span><span class="fu">quaternion</span>(<span class="at">Re =</span> <span class="dv">1</span>)</span>
<span id="cb31-2"><a href="#cb31-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">p3d</span>(rabbit <span class="sc">%*%</span> <span class="fu">quat_to_mat</span>(q0), <span class="at">h=</span><span class="cn">NULL</span>, <span class="at">main =</span> <span class="st">'q0'</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="Note_on_Quaternion_files/figure-html/unnamed-chunk-14-1.png" class="img-fluid figure-img" width="480"></p>
</figure>
</div>
</div>
</div>
<p>We add a second rotation (a first real) around the z-axis.</p>
<div class="cell" data-layout-align="center" name="bunny1" data-hash="Note_on_Quaternion_cache/html/unnamed-chunk-16_933cbd0320c746e587093abb094aec4e">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb32"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb32-1"><a href="#cb32-1" aria-hidden="true" tabindex="-1"></a>  q1 <span class="ot">=</span> <span class="fu">quaternion</span>(<span class="at">Re=</span><span class="fu">cos</span>(<span class="sc">-</span><span class="dv">45</span><span class="sc">/</span><span class="dv">360</span> <span class="sc">*</span>pi), <span class="at">i =</span> <span class="dv">0</span>, <span class="at">j =</span> <span class="dv">0</span>, <span class="at">k =</span> <span class="dv">1</span><span class="sc">*</span><span class="fu">sin</span>(<span class="sc">-</span><span class="dv">45</span><span class="sc">/</span><span class="dv">360</span> <span class="sc">*</span>pi)) </span>
<span id="cb32-2"><a href="#cb32-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">p3d</span>(rabbit <span class="sc">%*%</span> <span class="fu">quat_to_mat</span>(q0 <span class="sc">*</span> q1), <span class="at">h=</span><span class="cn">NULL</span>, <span class="at">main =</span> <span class="st">'q0 * q1'</span>) </span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="Note_on_Quaternion_files/figure-html/unnamed-chunk-16-1.png" class="img-fluid figure-img" width="480"></p>
</figure>
</div>
</div>
</div>
<p>We add a third rotation around the x-axis.</p>
<div class="cell" data-layout-align="center" data-hash="Note_on_Quaternion_cache/html/bunny3_facdd355fd578219ad66808421b2e610">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb33"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb33-1"><a href="#cb33-1" aria-hidden="true" tabindex="-1"></a>  q2 <span class="ot">=</span> <span class="fu">quaternion</span>(<span class="at">Re=</span><span class="fu">cos</span>(<span class="sc">-</span><span class="dv">45</span><span class="sc">/</span><span class="dv">360</span> <span class="sc">*</span>pi), <span class="at">i =</span> <span class="dv">1</span><span class="sc">*</span><span class="fu">sin</span>(<span class="sc">-</span><span class="dv">45</span><span class="sc">/</span><span class="dv">360</span> <span class="sc">*</span>pi), <span class="at">j =</span> <span class="dv">0</span>, <span class="at">k =</span> <span class="dv">0</span>) </span>
<span id="cb33-2"><a href="#cb33-2" aria-hidden="true" tabindex="-1"></a>  q012 <span class="ot">=</span> q0 <span class="sc">*</span> q1 <span class="sc">*</span> q2 </span>
<span id="cb33-3"><a href="#cb33-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">p3d</span>(rabbit <span class="sc">%*%</span> <span class="fu">quat_to_mat</span>(q012), <span class="at">h=</span><span class="cn">NULL</span>, <span class="at">main =</span> <span class="st">'q0 * q1 * q2'</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="Note_on_Quaternion_files/figure-html/bunny3-1.png" class="img-fluid figure-img" width="480"></p>
</figure>
</div>
</div>
</div>
<p>Using the order <span class="math inline">\(q_0 q_1 q_2\)</span> you transfer the data of the bunny into the lab frame.</p>
<div class="callout-important callout callout-style-default callout-captioned">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-caption-container flex-fill">
Important
</div>
</div>
<div class="callout-body-container callout-body">
<p>Quaternions for bodyâto-lab (frame) rotations multiply from left to right.</p>
</div>
</div>
</section>
<section id="pure-quaternions-real-part-0" class="level3" data-number="2.1.5">
<h3 data-number="2.1.5" class="anchored" data-anchor-id="pure-quaternions-real-part-0"><span class="header-section-number">2.1.5</span> Pure Quaternions (real part = 0)</h3>
<p>We can also use quaternions to transform vectors, without the need to explicitly construct the rotation matrix as done with the bunny data above. This is done with so-called <strong>unit</strong> or <strong>vector quaternions</strong>. To obtain a vector quaternions, we set the real part to 0 and use the vector in space as the vector part. That is a vector <span class="math inline">\(\vec{v}\)</span> in a certain direction without coding a rotation. From this vector, we like to know the position to which it gets rotated by <span class="math inline">\(R(q) \vec{v}\)</span> the rotation matrix <span class="math inline">\(R(q)\)</span> corresponding to <span class="math inline">\(q\)</span>. It can be shown that this is</p>
<p><span class="math display">\[
  (0, R(q) \vec{v}) = q \cdot (0,\vec{v}) \cdot q^{*}
\]</span></p>
<div class="cell">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb34"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb34-1"><a href="#cb34-1" aria-hidden="true" tabindex="-1"></a> q <span class="ot">=</span> q0 <span class="sc">*</span> q1 <span class="sc">*</span> q2 <span class="co">#A unit quaterion defining the direction</span></span>
<span id="cb34-2"><a href="#cb34-2" aria-hidden="true" tabindex="-1"></a> vec <span class="ot">=</span> <span class="fu">matrix</span>(<span class="fu">c</span>(<span class="dv">12</span>,<span class="dv">13</span>,<span class="dv">45</span>), <span class="at">ncol=</span><span class="dv">1</span>) <span class="co">#A vector with which we do the </span></span>
<span id="cb34-3"><a href="#cb34-3" aria-hidden="true" tabindex="-1"></a> <span class="fu">quat_to_mat</span>(q) <span class="sc">%*%</span> vec</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>         [,1]
[1,] 37.48528
[2,] 20.51472
[3,] 22.62742</code></pre>
</div>
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb36"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb36-1"><a href="#cb36-1" aria-hidden="true" tabindex="-1"></a> vec_q <span class="ot">=</span> <span class="fu">quaternion</span>(<span class="at">Re =</span> <span class="dv">0</span>, <span class="at">i =</span> vec[<span class="dv">1</span>], <span class="at">j=</span>vec[<span class="dv">2</span>], <span class="at">k=</span>vec[<span class="dv">3</span>])</span>
<span id="cb36-2"><a href="#cb36-2" aria-hidden="true" tabindex="-1"></a> <span class="co">#q^-1 is the inverse, which for rotation quaternions is the conjugate </span></span>
<span id="cb36-3"><a href="#cb36-3" aria-hidden="true" tabindex="-1"></a> q <span class="sc">*</span> vec_q <span class="sc">*</span> q<span class="sc">^-</span><span class="dv">1</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>              Re
Re -3.552714e-15
i   3.748528e+01
j   2.051472e+01
k   2.262742e+01</code></pre>
</div>
</div>
<p><strong>TODO</strong> build intuition for this expression, this looks like bra-ket</p>
<section id="using-pure-quaterions-to-get-the-rotation-matrix." class="level4" data-number="2.1.5.1">
<h4 data-number="2.1.5.1" class="anchored" data-anchor-id="using-pure-quaterions-to-get-the-rotation-matrix."><span class="header-section-number">2.1.5.1</span> Using pure quaterions to get the rotation matrix.</h4>
<p>We can use pure quaterions to get the rotation matrix. To make the problem harder, we use a more complicated quaternion:</p>
<div class="cell">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb38"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb38-1"><a href="#cb38-1" aria-hidden="true" tabindex="-1"></a>q <span class="ot">=</span> <span class="fu">c</span>(<span class="fl">0.320</span>,  <span class="fl">0.300</span>,  <span class="fl">0.290</span>, <span class="sc">-</span><span class="fl">0.850</span>) </span>
<span id="cb38-2"><a href="#cb38-2" aria-hidden="true" tabindex="-1"></a>q <span class="ot">=</span> q <span class="sc">/</span> <span class="fu">sqrt</span>(<span class="fu">sum</span>(q<span class="sc">^</span><span class="dv">2</span>))</span>
<span id="cb38-3"><a href="#cb38-3" aria-hidden="true" tabindex="-1"></a>q <span class="ot">=</span> <span class="fu">quaternion</span>(<span class="at">Re=</span>q[<span class="dv">1</span>], <span class="at">i=</span>q[<span class="dv">2</span>], <span class="at">j=</span>q[<span class="dv">3</span>], <span class="at">k=</span>q[<span class="dv">4</span>])</span>
<span id="cb38-4"><a href="#cb38-4" aria-hidden="true" tabindex="-1"></a><span class="fu">t</span>(q<span class="sc">@</span>x)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>            Re         i         j          k
[1,] 0.3201601 0.3001501 0.2901451 -0.8504253</code></pre>
</div>
</div>
<p>We use the fact that the transformation is given by the results of the unit vectors of the âfrom coordinateâ system:</p>
<div class="cell">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb40"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb40-1"><a href="#cb40-1" aria-hidden="true" tabindex="-1"></a> <span class="fu">round</span>(<span class="fu">quat_to_mat</span>(q), <span class="dv">4</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>        [,1]    [,2]    [,3]
[1,] -0.6148  0.7187 -0.3247
[2,] -0.3704 -0.6266 -0.6857
[3,] -0.6963 -0.3013  0.6515</code></pre>
</div>
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb42"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb42-1"><a href="#cb42-1" aria-hidden="true" tabindex="-1"></a> e1b <span class="ot">=</span> q <span class="sc">*</span> <span class="fu">quaternion</span>(<span class="at">Re =</span> <span class="dv">0</span>, <span class="at">i =</span> <span class="dv">1</span>) <span class="sc">*</span> q<span class="sc">^-</span><span class="dv">1</span> </span>
<span id="cb42-2"><a href="#cb42-2" aria-hidden="true" tabindex="-1"></a> e2b <span class="ot">=</span> q <span class="sc">*</span> <span class="fu">quaternion</span>(<span class="at">Re =</span> <span class="dv">0</span>, <span class="at">j =</span> <span class="dv">1</span>) <span class="sc">*</span> q<span class="sc">^-</span><span class="dv">1</span> </span>
<span id="cb42-3"><a href="#cb42-3" aria-hidden="true" tabindex="-1"></a> e3b <span class="ot">=</span> q <span class="sc">*</span> <span class="fu">quaternion</span>(<span class="at">Re =</span> <span class="dv">0</span>, <span class="at">k =</span> <span class="dv">1</span>) <span class="sc">*</span> q<span class="sc">^-</span><span class="dv">1</span> </span>
<span id="cb42-4"><a href="#cb42-4" aria-hidden="true" tabindex="-1"></a> <span class="fu">matrix</span>(<span class="fu">c</span>(</span>
<span id="cb42-5"><a href="#cb42-5" aria-hidden="true" tabindex="-1"></a>          e1b<span class="sc">@</span>x[<span class="dv">2</span><span class="sc">:</span><span class="dv">4</span>],</span>
<span id="cb42-6"><a href="#cb42-6" aria-hidden="true" tabindex="-1"></a>          e2b<span class="sc">@</span>x[<span class="dv">2</span><span class="sc">:</span><span class="dv">4</span>],</span>
<span id="cb42-7"><a href="#cb42-7" aria-hidden="true" tabindex="-1"></a>          e3b<span class="sc">@</span>x[<span class="dv">2</span><span class="sc">:</span><span class="dv">4</span>])</span>
<span id="cb42-8"><a href="#cb42-8" aria-hidden="true" tabindex="-1"></a> ,<span class="at">nrow=</span><span class="dv">3</span>) <span class="sc">%&gt;%</span> <span class="fu">round</span>(<span class="dv">4</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>        [,1]    [,2]    [,3]
[1,] -0.6148  0.7187 -0.3247
[2,] -0.3704 -0.6266 -0.6857
[3,] -0.6963 -0.3013  0.6515</code></pre>
</div>
</div>
</section>
</section>
<section id="flight-coordinates-from-quaterions" class="level3" data-number="2.1.6">
<h3 data-number="2.1.6" class="anchored" data-anchor-id="flight-coordinates-from-quaterions"><span class="header-section-number">2.1.6</span> Flight Coordinates from Quaterions</h3>
<p>In the definition above has defined as</p>
<p><span class="math display">\[
  R_{\text{Lab} \leftarrow \text{Body}} =  R_{roll} \, R_{pitch}\, R_{yaw}
\]</span></p>
<p>TODO there is something wrong with rotation matrix</p>
<div class="cell">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb44"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb44-1"><a href="#cb44-1" aria-hidden="true" tabindex="-1"></a>  qyaw <span class="ot">=</span> <span class="fu">quaternion</span>(<span class="at">Re=</span><span class="fu">cos</span>(yaw<span class="sc">/</span><span class="dv">2</span>), <span class="at">i=</span><span class="dv">0</span>,<span class="at">j=</span><span class="dv">0</span>,<span class="at">k=</span><span class="fu">sin</span>(yaw<span class="sc">/</span><span class="dv">2</span>))</span>
<span id="cb44-2"><a href="#cb44-2" aria-hidden="true" tabindex="-1"></a>  qpitch <span class="ot">=</span> <span class="fu">quaternion</span>(<span class="at">Re=</span><span class="fu">cos</span>(pitch<span class="sc">/</span><span class="dv">2</span>), <span class="at">i=</span><span class="dv">0</span>,<span class="at">j=</span><span class="fu">sin</span>(pitch<span class="sc">/</span><span class="dv">2</span>),<span class="at">k=</span><span class="dv">0</span>)</span>
<span id="cb44-3"><a href="#cb44-3" aria-hidden="true" tabindex="-1"></a>  qroll <span class="ot">=</span> <span class="fu">quaternion</span>(<span class="at">Re=</span><span class="fu">cos</span>(roll<span class="sc">/</span><span class="dv">2</span>), <span class="at">i=</span><span class="fu">sin</span>(roll<span class="sc">/</span><span class="dv">2</span>), <span class="at">j=</span><span class="dv">0</span>,<span class="at">k=</span><span class="dv">0</span>)</span>
<span id="cb44-4"><a href="#cb44-4" aria-hidden="true" tabindex="-1"></a>  R <span class="ot">=</span> R.roll <span class="sc">%*%</span> R.pitch <span class="sc">%*%</span> R.yaw</span>
<span id="cb44-5"><a href="#cb44-5" aria-hidden="true" tabindex="-1"></a>  <span class="co">#R = R.pitch %*% R.yaw</span></span>
<span id="cb44-6"><a href="#cb44-6" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (<span class="cn">FALSE</span>) { <span class="co">#For debugging</span></span>
<span id="cb44-7"><a href="#cb44-7" aria-hidden="true" tabindex="-1"></a>    <span class="fu">sum</span>(qyaw<span class="sc">@</span>x<span class="sc">^</span><span class="dv">2</span>) <span class="co">#1</span></span>
<span id="cb44-8"><a href="#cb44-8" aria-hidden="true" tabindex="-1"></a>    <span class="fu">sum</span>(qpitch<span class="sc">@</span>x<span class="sc">^</span><span class="dv">2</span>) <span class="co">#1</span></span>
<span id="cb44-9"><a href="#cb44-9" aria-hidden="true" tabindex="-1"></a>    <span class="fu">sum</span>(qroll<span class="sc">@</span>x<span class="sc">^</span><span class="dv">2</span>) <span class="co">#1</span></span>
<span id="cb44-10"><a href="#cb44-10" aria-hidden="true" tabindex="-1"></a>    <span class="fu">sum</span>((<span class="fu">quat_to_mat</span>(qyaw) <span class="sc">-</span> R.yaw)<span class="sc">^</span><span class="dv">2</span>) <span class="co">#2.46519e-32</span></span>
<span id="cb44-11"><a href="#cb44-11" aria-hidden="true" tabindex="-1"></a>    <span class="fu">sum</span>((<span class="fu">quat_to_mat</span>(qpitch) <span class="sc">-</span> R.pitch)<span class="sc">^</span><span class="dv">2</span>) <span class="co">#2.46519e-32</span></span>
<span id="cb44-12"><a href="#cb44-12" aria-hidden="true" tabindex="-1"></a>    <span class="fu">sum</span>((<span class="fu">quat_to_mat</span>(qroll) <span class="sc">-</span> R.roll)<span class="sc">^</span><span class="dv">2</span>) <span class="co">#4.930381e-32</span></span>
<span id="cb44-13"><a href="#cb44-13" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb44-14"><a href="#cb44-14" aria-hidden="true" tabindex="-1"></a>  qcomb_body_to_lab <span class="ot">=</span> (qyaw <span class="sc">*</span> qpitch) <span class="sc">*</span> qroll</span>
<span id="cb44-15"><a href="#cb44-15" aria-hidden="true" tabindex="-1"></a>  qcomb_lab_to_body <span class="ot">=</span> qcomb_body_to_lab<span class="sc">^-</span><span class="dv">1</span></span>
<span id="cb44-16"><a href="#cb44-16" aria-hidden="true" tabindex="-1"></a>  <span class="fu">max</span>(<span class="fu">abs</span>(R <span class="sc">-</span> <span class="fu">quat_to_mat</span>(qcomb_body_to_lab))) <span class="co">#1.4</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 1.029303</code></pre>
</div>
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb46"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb46-1"><a href="#cb46-1" aria-hidden="true" tabindex="-1"></a>  <span class="fu">max</span>(<span class="fu">abs</span>(R <span class="sc">-</span> <span class="fu">quat_to_mat</span>(qcomb_lab_to_body))) <span class="co">#0</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 1.532089</code></pre>
</div>
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb48"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb48-1"><a href="#cb48-1" aria-hidden="true" tabindex="-1"></a>  <span class="co">#---&gt; Quat_to_</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<p>Testing the package</p>
<p>The following translates a quaternion into ypr</p>
<p><span class="math display">\[
roll = atan2(2 \cdot (w \cdot x + y \cdot z), 1 - 2 \cdot (x \cdot x + y \cdot y))\\
pitch = asin(2 \cdot (w \cdot y - x \cdot z))\\
yaw = atan2(2 \cdot (w \cdot z + x \cdot y), 1 - 2 \cdot (z \cdot z + y \cdot y))
\]</span></p>
<div class="cell">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb49"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb49-1"><a href="#cb49-1" aria-hidden="true" tabindex="-1"></a>quart_to_ypr <span class="ot">=</span> <span class="cf">function</span>(q_body2lab){</span>
<span id="cb49-2"><a href="#cb49-2" aria-hidden="true" tabindex="-1"></a>    q <span class="ot">=</span> q_body2lab</span>
<span id="cb49-3"><a href="#cb49-3" aria-hidden="true" tabindex="-1"></a>    w <span class="ot">=</span> q[<span class="dv">1</span>]</span>
<span id="cb49-4"><a href="#cb49-4" aria-hidden="true" tabindex="-1"></a>    x <span class="ot">=</span> q[<span class="dv">2</span>]</span>
<span id="cb49-5"><a href="#cb49-5" aria-hidden="true" tabindex="-1"></a>    y <span class="ot">=</span> q[<span class="dv">3</span>]</span>
<span id="cb49-6"><a href="#cb49-6" aria-hidden="true" tabindex="-1"></a>    z <span class="ot">=</span> q[<span class="dv">4</span>]</span>
<span id="cb49-7"><a href="#cb49-7" aria-hidden="true" tabindex="-1"></a>    roll <span class="ot">=</span> <span class="fu">atan2</span>(<span class="dv">2</span> <span class="sc">*</span> (w <span class="sc">*</span> x <span class="sc">+</span> y <span class="sc">*</span> z), <span class="dv">1</span> <span class="sc">-</span> <span class="dv">2</span> <span class="sc">*</span> (x <span class="sc">*</span> x <span class="sc">+</span> y <span class="sc">*</span> y))</span>
<span id="cb49-8"><a href="#cb49-8" aria-hidden="true" tabindex="-1"></a>    pitch <span class="ot">=</span> <span class="fu">asin</span>(<span class="dv">2</span> <span class="sc">*</span> (w <span class="sc">*</span> y <span class="sc">-</span> x <span class="sc">*</span> z))</span>
<span id="cb49-9"><a href="#cb49-9" aria-hidden="true" tabindex="-1"></a>    yaw <span class="ot">=</span> <span class="fu">atan2</span>(<span class="dv">2</span> <span class="sc">*</span> (w <span class="sc">*</span> z <span class="sc">+</span> x <span class="sc">*</span> y), <span class="dv">1</span> <span class="sc">-</span> <span class="dv">2</span> <span class="sc">*</span> (z <span class="sc">*</span> z <span class="sc">+</span> y <span class="sc">*</span> y))</span>
<span id="cb49-10"><a href="#cb49-10" aria-hidden="true" tabindex="-1"></a>    <span class="fu">return</span>(<span class="fu">c</span>(yaw,pitch,roll))</span>
<span id="cb49-11"><a href="#cb49-11" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb49-12"><a href="#cb49-12" aria-hidden="true" tabindex="-1"></a><span class="fu">quart_to_ypr</span>(qcomb_lab_to_body<span class="sc">@</span>x) <span class="co">#Wrong </span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>[1] -1.2311588 -0.2663981 -1.0351367</code></pre>
</div>
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb51"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb51-1"><a href="#cb51-1" aria-hidden="true" tabindex="-1"></a><span class="fu">quart_to_ypr</span>(qcomb_body_to_lab<span class="sc">@</span>x) <span class="co">#Correct</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>[1]  1.0471976 -0.8726646  0.6981317</code></pre>
</div>
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb53"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb53-1"><a href="#cb53-1" aria-hidden="true" tabindex="-1"></a><span class="fu">c</span>(yaw, pitch, roll)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>[1]  1.0471976 -0.8726646  0.6981317</code></pre>
</div>
</div>
</section>
<section id="rotation-between-two-quaternions." class="level3" data-number="2.1.7">
<h3 data-number="2.1.7" class="anchored" data-anchor-id="rotation-between-two-quaternions."><span class="header-section-number">2.1.7</span> Rotation between two quaternions.</h3>
<p>Consider the two IMUs (like the one on the thumb and the one on the palm), the orientation of the first (w.r.t. the laboratory system) is given by <span class="math inline">\(q_1\)</span> the orientation of the second by <span class="math inline">\(q_2\)</span>. What is the rotation getting you from hand to palm. The questions is: which rotation <span class="math inline">\(q_{12}\)</span> translates between them. So we ask which <span class="math inline">\(q_12\)</span> fulfills</p>
<p><span class="math display">\[
  q_2 = q_1 \; q_{12}
\]</span></p>
<p>Just calculate the inverse of <span class="math inline">\(q_1\)</span> and you are done</p>
<p><span class="math display">\[
  q_1^{-1} \; q_2 = q_{12}  
\]</span></p>
</section>
</section>
<section id="software-package" class="level2" data-number="2.2">
<h2 data-number="2.2" class="anchored" data-anchor-id="software-package"><span class="header-section-number">2.2</span> Software package</h2>
<p>There are several software packages helping to deal with rotations and quaterions. Like the onion package in R.</p>
<section id="the-ahrs-python-package" class="level3" data-number="2.2.1">
<h3 data-number="2.2.1" class="anchored" data-anchor-id="the-ahrs-python-package"><span class="header-section-number">2.2.1</span> The AHRS Python Package</h3>
<p>The AHRS package (https://ahrs.readthedocs.io/en/latest/index.html) used to estimate the rotation of a IMUs (sensors in e.g.&nbsp;cell phones and drones), uses quaternion as lot and also provides some basic operations.</p>
<div class="cell">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb55"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb55-1"><a href="#cb55-1" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> ahrs <span class="im">import</span> Quaternion</span>
<span id="cb55-2"><a href="#cb55-2" aria-hidden="true" tabindex="-1"></a>p <span class="op">=</span> Quaternion([<span class="fl">0.7071</span>, <span class="fl">0.0</span>, <span class="fl">0.7071</span>, <span class="fl">0.0</span>])</span>
<span id="cb55-3"><a href="#cb55-3" aria-hidden="true" tabindex="-1"></a>p </span>
<span id="cb55-4"><a href="#cb55-4" aria-hidden="true" tabindex="-1"></a>q <span class="op">=</span> Quaternion([<span class="dv">0</span>, <span class="fl">0.7071</span>, <span class="fl">0.0</span>, <span class="fl">0.7071</span>])</span>
<span id="cb55-5"><a href="#cb55-5" aria-hidden="true" tabindex="-1"></a>p <span class="op">*</span> q <span class="co">#0., 1., 0., 0.</span></span>
<span id="cb55-6"><a href="#cb55-6" aria-hidden="true" tabindex="-1"></a>q <span class="op">*</span> p <span class="co">#0., 0., 0., 1.</span></span>
<span id="cb55-7"><a href="#cb55-7" aria-hidden="true" tabindex="-1"></a>q.conj<span class="co">#0., -0.70710678, -0., -0.70710678</span></span>
<span id="cb55-8"><a href="#cb55-8" aria-hidden="true" tabindex="-1"></a>d <span class="op">=</span> q<span class="op">*</span>q.conj </span>
<span id="cb55-9"><a href="#cb55-9" aria-hidden="true" tabindex="-1"></a>d</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<!-- -->


</section>
</section>
</section>

<div id="quarto-appendix" class="default"><section class="quarto-appendix-contents" role="doc-bibliography"><h2 class="anchored quarto-appendix-heading">References</h2><div id="refs" class="references csl-bib-body hanging-indent" role="doc-bibliography">
<div id="ref-grossekatthofer2012introduction" class="csl-entry" role="doc-biblioentry">
GroÃekatthÃ¶fer, Karsten, and Zizung Yoon. 2012. <span>âIntroduction into Quaternions for Spacecraft Attitude Representation.â</span> <em>TU Berlin</em> 16.
</div>
</div></section></div></main>
<!-- /main column -->
<script id="quarto-html-after-body" type="application/javascript">
window.document.addEventListener("DOMContentLoaded", function (event) {
  const toggleBodyColorMode = (bsSheetEl) => {
    const mode = bsSheetEl.getAttribute("data-mode");
    const bodyEl = window.document.querySelector("body");
    if (mode === "dark") {
      bodyEl.classList.add("quarto-dark");
      bodyEl.classList.remove("quarto-light");
    } else {
      bodyEl.classList.add("quarto-light");
      bodyEl.classList.remove("quarto-dark");
    }
  }
  const toggleBodyColorPrimary = () => {
    const bsSheetEl = window.document.querySelector("link#quarto-bootstrap");
    if (bsSheetEl) {
      toggleBodyColorMode(bsSheetEl);
    }
  }
  toggleBodyColorPrimary();  
  const icon = "î§";
  const anchorJS = new window.AnchorJS();
  anchorJS.options = {
    placement: 'right',
    icon: icon
  };
  anchorJS.add('.anchored');
  const clipboard = new window.ClipboardJS('.code-copy-button', {
    target: function(trigger) {
      return trigger.previousElementSibling;
    }
  });
  clipboard.on('success', function(e) {
    // button target
    const button = e.trigger;
    // don't keep focus
    button.blur();
    // flash "checked"
    button.classList.add('code-copy-button-checked');
    var currentTitle = button.getAttribute("title");
    button.setAttribute("title", "Copied!");
    setTimeout(function() {
      button.setAttribute("title", currentTitle);
      button.classList.remove('code-copy-button-checked');
    }, 1000);
    // clear code selection
    e.clearSelection();
  });
  const viewSource = window.document.getElementById('quarto-view-source') ||
                     window.document.getElementById('quarto-code-tools-source');
  if (viewSource) {
    const sourceUrl = viewSource.getAttribute("data-quarto-source-url");
    viewSource.addEventListener("click", function(e) {
      if (sourceUrl) {
        // rstudio viewer pane
        if (/\bcapabilities=\b/.test(window.location)) {
          window.open(sourceUrl);
        } else {
          window.location.href = sourceUrl;
        }
      } else {
        const modal = new bootstrap.Modal(document.getElementById('quarto-embedded-source-code-modal'));
        modal.show();
      }
      return false;
    });
  }
  function toggleCodeHandler(show) {
    return function(e) {
      const detailsSrc = window.document.querySelectorAll(".cell > details > .sourceCode");
      for (let i=0; i<detailsSrc.length; i++) {
        const details = detailsSrc[i].parentElement;
        if (show) {
          details.open = true;
        } else {
          details.removeAttribute("open");
        }
      }
      const cellCodeDivs = window.document.querySelectorAll(".cell > .sourceCode");
      const fromCls = show ? "hidden" : "unhidden";
      const toCls = show ? "unhidden" : "hidden";
      for (let i=0; i<cellCodeDivs.length; i++) {
        const codeDiv = cellCodeDivs[i];
        if (codeDiv.classList.contains(fromCls)) {
          codeDiv.classList.remove(fromCls);
          codeDiv.classList.add(toCls);
        } 
      }
      return false;
    }
  }
  const hideAllCode = window.document.getElementById("quarto-hide-all-code");
  if (hideAllCode) {
    hideAllCode.addEventListener("click", toggleCodeHandler(false));
  }
  const showAllCode = window.document.getElementById("quarto-show-all-code");
  if (showAllCode) {
    showAllCode.addEventListener("click", toggleCodeHandler(true));
  }
  function tippyHover(el, contentFn) {
    const config = {
      allowHTML: true,
      content: contentFn,
      maxWidth: 500,
      delay: 100,
      arrow: false,
      appendTo: function(el) {
          return el.parentElement;
      },
      interactive: true,
      interactiveBorder: 10,
      theme: 'quarto',
      placement: 'bottom-start'
    };
    window.tippy(el, config); 
  }
  const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
  for (var i=0; i<noterefs.length; i++) {
    const ref = noterefs[i];
    tippyHover(ref, function() {
      let href = ref.getAttribute('href');
      try { href = new URL(href).hash; } catch {}
      const id = href.replace(/^#\/?/, "");
      const note = window.document.getElementById(id);
      return note.innerHTML;
    });
  }
  var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
  for (var i=0; i<bibliorefs.length; i++) {
    const ref = bibliorefs[i];
    const cites = ref.parentNode.getAttribute('data-cites').split(' ');
    tippyHover(ref, function() {
      var popup = window.document.createElement('div');
      cites.forEach(function(cite) {
        var citeDiv = window.document.createElement('div');
        citeDiv.classList.add('hanging-indent');
        citeDiv.classList.add('csl-entry');
        var biblioDiv = window.document.getElementById('ref-' + cite);
        if (biblioDiv) {
          citeDiv.innerHTML = biblioDiv.innerHTML;
        }
        popup.appendChild(citeDiv);
      });
      return popup.innerHTML;
    });
  }
});
</script><div class="modal fade" id="quarto-embedded-source-code-modal" tabindex="-1" aria-labelledby="quarto-embedded-source-code-modal-label" aria-hidden="true"><div class="modal-dialog modal-dialog-scrollable"><div class="modal-content"><div class="modal-header"><h5 class="modal-title" id="quarto-embedded-source-code-modal-label">Source Code</h5><button class="btn-close" data-bs-dismiss="modal"></button></div><div class="modal-body"><div class="">
<div class="sourceCode" id="cb56" data-shortcodes="false"><pre class="sourceCode markdown code-with-copy"><code class="sourceCode markdown"><span id="cb56-1"><a href="#cb56-1" aria-hidden="true" tabindex="-1"></a><span class="co">---</span></span>
<span id="cb56-2"><a href="#cb56-2" aria-hidden="true" tabindex="-1"></a><span class="an">title:</span><span class="co"> "Notes on Rotations and Quaternions"</span></span>
<span id="cb56-3"><a href="#cb56-3" aria-hidden="true" tabindex="-1"></a><span class="an">format:</span></span>
<span id="cb56-4"><a href="#cb56-4" aria-hidden="true" tabindex="-1"></a><span class="co">    html:</span></span>
<span id="cb56-5"><a href="#cb56-5" aria-hidden="true" tabindex="-1"></a><span class="co">      fig-width: 8</span></span>
<span id="cb56-6"><a href="#cb56-6" aria-hidden="true" tabindex="-1"></a><span class="co">      fig-height: 4</span></span>
<span id="cb56-7"><a href="#cb56-7" aria-hidden="true" tabindex="-1"></a><span class="co">      code-fold: true</span></span>
<span id="cb56-8"><a href="#cb56-8" aria-hidden="true" tabindex="-1"></a><span class="co">      code-tools: true</span></span>
<span id="cb56-9"><a href="#cb56-9" aria-hidden="true" tabindex="-1"></a><span class="an">author:</span><span class="co"> Oliver DÃ¼rr</span></span>
<span id="cb56-10"><a href="#cb56-10" aria-hidden="true" tabindex="-1"></a><span class="an">editor:</span><span class="co"> visual</span></span>
<span id="cb56-11"><a href="#cb56-11" aria-hidden="true" tabindex="-1"></a><span class="an">bibliography:</span><span class="co"> references.bib</span></span>
<span id="cb56-12"><a href="#cb56-12" aria-hidden="true" tabindex="-1"></a><span class="co">---</span></span>
<span id="cb56-13"><a href="#cb56-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb56-14"><a href="#cb56-14" aria-hidden="true" tabindex="-1"></a><span class="in">```{r setup, include=FALSE}</span></span>
<span id="cb56-15"><a href="#cb56-15" aria-hidden="true" tabindex="-1"></a>  <span class="fu">library</span>(tidyverse)</span>
<span id="cb56-16"><a href="#cb56-16" aria-hidden="true" tabindex="-1"></a>  <span class="fu">library</span>(reticulate)</span>
<span id="cb56-17"><a href="#cb56-17" aria-hidden="true" tabindex="-1"></a>  <span class="fu">library</span>(onion) <span class="co">#For quaterions</span></span>
<span id="cb56-18"><a href="#cb56-18" aria-hidden="true" tabindex="-1"></a>  <span class="fu">source</span>(<span class="st">'rotation_utils.R'</span>)</span>
<span id="cb56-19"><a href="#cb56-19" aria-hidden="true" tabindex="-1"></a>  <span class="fu">library</span>(plot3D)</span>
<span id="cb56-20"><a href="#cb56-20" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb56-21"><a href="#cb56-21" aria-hidden="true" tabindex="-1"></a>  <span class="co">#For the final airplane with plot3d</span></span>
<span id="cb56-22"><a href="#cb56-22" aria-hidden="true" tabindex="-1"></a>  <span class="co">#library(rgl)</span></span>
<span id="cb56-23"><a href="#cb56-23" aria-hidden="true" tabindex="-1"></a>  <span class="co">#knitr::knit_hooks$set(webgl = hook_webgl)</span></span>
<span id="cb56-24"><a href="#cb56-24" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb56-25"><a href="#cb56-25" aria-hidden="true" tabindex="-1"></a>  <span class="fu">data</span>(bunny) <span class="co">#This are just many points in the 3 Dimensional space</span></span>
<span id="cb56-26"><a href="#cb56-26" aria-hidden="true" tabindex="-1"></a>  <span class="co">#dim(bunny) #35947     3</span></span>
<span id="cb56-27"><a href="#cb56-27" aria-hidden="true" tabindex="-1"></a>  R <span class="ot">=</span> <span class="fu">from_fixed_to_body</span>(<span class="at">a=</span><span class="dv">0</span>, <span class="at">b=</span><span class="dv">0</span>, <span class="at">g=</span><span class="dv">104</span>)</span>
<span id="cb56-28"><a href="#cb56-28" aria-hidden="true" tabindex="-1"></a>  <span class="fu">set.seed</span>(<span class="dv">42</span>)</span>
<span id="cb56-29"><a href="#cb56-29" aria-hidden="true" tabindex="-1"></a>  idx <span class="ot">=</span> <span class="fu">sample</span>(<span class="dv">1</span><span class="sc">:</span><span class="fu">nrow</span>(bunny), <span class="dv">5000</span>)</span>
<span id="cb56-30"><a href="#cb56-30" aria-hidden="true" tabindex="-1"></a>  rabbit <span class="ot">=</span> bunny[idx,]</span>
<span id="cb56-31"><a href="#cb56-31" aria-hidden="true" tabindex="-1"></a>  rabbit <span class="ot">=</span> rabbit</span>
<span id="cb56-32"><a href="#cb56-32" aria-hidden="true" tabindex="-1"></a>  rabbit <span class="ot">=</span> rabbit <span class="sc">%*%</span> <span class="fu">t</span>(R) </span>
<span id="cb56-33"><a href="#cb56-33" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb56-34"><a href="#cb56-34" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb56-35"><a href="#cb56-35" aria-hidden="true" tabindex="-1"></a>This is a primer on rotations and quaternions, as needed to describe rotations. Rotations are a constant source of confusion and they have confused me several time. This is kind of a letter to my future self.</span>
<span id="cb56-36"><a href="#cb56-36" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb56-37"><a href="#cb56-37" aria-hidden="true" tabindex="-1"></a>**This is Work in Progress TODOS**</span>
<span id="cb56-38"><a href="#cb56-38" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb56-39"><a href="#cb56-39" aria-hidden="true" tabindex="-1"></a><span class="ss">-   </span>**Still need corrections.**</span>
<span id="cb56-40"><a href="#cb56-40" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb56-41"><a href="#cb56-41" aria-hidden="true" tabindex="-1"></a><span class="ss">-   </span>Add arrows showing coordinate system to plane plot</span>
<span id="cb56-42"><a href="#cb56-42" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb56-43"><a href="#cb56-43" aria-hidden="true" tabindex="-1"></a>Some handwritten note are also availible as <span class="co">[</span><span class="ot">pdf</span><span class="co">](https://www.dropbox.com/s/n3oc5fjwrn1zaiu/Rotations%20without%20tears.pdf?dl=0)</span>.</span>
<span id="cb56-44"><a href="#cb56-44" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb56-45"><a href="#cb56-45" aria-hidden="true" tabindex="-1"></a><span class="fu"># A short note on rotations</span></span>
<span id="cb56-46"><a href="#cb56-46" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb56-47"><a href="#cb56-47" aria-hidden="true" tabindex="-1"></a>In the figure, you can see a sketch of the situation for gesture recognition. We are interested in "the relative positions" between the palm and thumb on the one side and the laboratory system on the other. As we will see this (and many more things) can be described in the framework of rotations.</span>
<span id="cb56-48"><a href="#cb56-48" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb56-49"><a href="#cb56-49" aria-hidden="true" tabindex="-1"></a><span class="al">![Rotations transform between coordinate system, such as a fixed coordinate system in space (toothpicks on table), a body centered coordinate system on the thumb and one on the plam.](images/hand.jpg)</span>{#fig-hand width="1000"}</span>
<span id="cb56-50"><a href="#cb56-50" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb56-51"><a href="#cb56-51" aria-hidden="true" tabindex="-1"></a><span class="fu">## A first rotation</span></span>
<span id="cb56-52"><a href="#cb56-52" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb56-53"><a href="#cb56-53" aria-hidden="true" tabindex="-1"></a>Before we go into some math, lets have a first look how a rotation might look like. On the left side you see data points in the original space. On the right side a rotation by 45 degrees around the z-axis that have been applied to the points. This rotation can be obtained by a rotation matrix R:</span>
<span id="cb56-54"><a href="#cb56-54" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb56-55"><a href="#cb56-55" aria-hidden="true" tabindex="-1"></a><span class="in">```{r rot-yaw-bunny}</span></span>
<span id="cb56-56"><a href="#cb56-56" aria-hidden="true" tabindex="-1"></a>R <span class="ot">=</span> <span class="fu">matrix</span>(<span class="fu">c</span>(<span class="fl">0.7071068</span>,  <span class="fl">0.7071068</span>,  <span class="fl">0.0000000</span>, <span class="sc">-</span><span class="fl">0.7071068</span>,  <span class="fl">0.7071068</span>,  <span class="fl">0.0000000</span>,  <span class="fl">0.0000000</span>,  <span class="fl">0.0000000</span>,  <span class="fl">1.0000000</span>), <span class="at">nrow=</span><span class="dv">3</span>)</span>
<span id="cb56-57"><a href="#cb56-57" aria-hidden="true" tabindex="-1"></a><span class="fu">round</span>(R,<span class="dv">4</span>)</span>
<span id="cb56-58"><a href="#cb56-58" aria-hidden="true" tabindex="-1"></a><span class="fu">par</span>(<span class="at">mfrow=</span><span class="fu">c</span>(<span class="dv">1</span>,<span class="dv">2</span>))</span>
<span id="cb56-59"><a href="#cb56-59" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb56-60"><a href="#cb56-60" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb56-61"><a href="#cb56-61" aria-hidden="true" tabindex="-1"></a>As we will see in a second an example a point $x$ of the rabid cloud is transformed via:</span>
<span id="cb56-62"><a href="#cb56-62" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb56-63"><a href="#cb56-63" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb56-64"><a href="#cb56-64" aria-hidden="true" tabindex="-1"></a>  x_\text{rot} = R \, x</span>
<span id="cb56-65"><a href="#cb56-65" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb56-66"><a href="#cb56-66" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb56-67"><a href="#cb56-67" aria-hidden="true" tabindex="-1"></a><span class="in">```{r, rot-bunny-plot, warning=FALSE, fig.width=10, fig.height=5, fig.align='center', cache=TRUE, fig.cap='Left: orinial data. Right: data rotated by 45 degrees around y-axis (or coordinate system rotated by -45) degrees. The y-axis points up and the rotation is done in counter clock-wise manner'}</span></span>
<span id="cb56-68"><a href="#cb56-68" aria-hidden="true" tabindex="-1"></a><span class="fu">p3d</span>(rabbit, <span class="at">h=</span><span class="cn">NULL</span>, <span class="at">xlab=</span><span class="st">'x'</span>, <span class="at">ylab=</span><span class="st">'y'</span>, <span class="at">zlab=</span><span class="st">'z'</span>, )</span>
<span id="cb56-69"><a href="#cb56-69" aria-hidden="true" tabindex="-1"></a><span class="co">#It's vector times Matrix for row-vectors</span></span>
<span id="cb56-70"><a href="#cb56-70" aria-hidden="true" tabindex="-1"></a><span class="co">#Therefore we have to transpose (R x) to x^T R^T</span></span>
<span id="cb56-71"><a href="#cb56-71" aria-hidden="true" tabindex="-1"></a><span class="fu">p3d</span>(rabbit <span class="sc">%*%</span> <span class="fu">t</span>(R), <span class="at">h=</span><span class="cn">NULL</span>) </span>
<span id="cb56-72"><a href="#cb56-72" aria-hidden="true" tabindex="-1"></a><span class="fu">par</span>(<span class="at">mfrow=</span><span class="fu">c</span>(<span class="dv">1</span>,<span class="dv">1</span>))</span>
<span id="cb56-73"><a href="#cb56-73" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb56-74"><a href="#cb56-74" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb56-75"><a href="#cb56-75" aria-hidden="true" tabindex="-1"></a><span class="fu">## Introduction</span></span>
<span id="cb56-76"><a href="#cb56-76" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb56-77"><a href="#cb56-77" aria-hidden="true" tabindex="-1"></a>Rotations between rigid objects can be described as a linear transformation from one coordinate system to another, with the same origin. A first example is the bunny from above. Another similar example of such a rotation is the orientation of your cell phone after you picked it up compared to the position on the table, or the orientation of the thumb in figure compared to the coordinate system of the palm.</span>
<span id="cb56-78"><a href="#cb56-78" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb56-79"><a href="#cb56-79" aria-hidden="true" tabindex="-1"></a>A very illustrative example is an airplane which is at $t=0$ on the ground and is at $t=t$ in the air. Besides the translation, the orientation of the plane at $t=0$ relative to the plane at $t=t$ can be described by a different heading (the *yaw* angle) obtained while taxing, the *pitch* angle obtained in the climbing phase and a rotation around the axis of flight the *roll* angle. During this phase many rotations happen but they can all be summarized in a single rotation.</span>
<span id="cb56-80"><a href="#cb56-80" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb56-81"><a href="#cb56-81" aria-hidden="true" tabindex="-1"></a><span class="fu">## Parameterization</span></span>
<span id="cb56-82"><a href="#cb56-82" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb56-83"><a href="#cb56-83" aria-hidden="true" tabindex="-1"></a><span class="fu">### Definition of rotations</span></span>
<span id="cb56-84"><a href="#cb56-84" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb56-85"><a href="#cb56-85" aria-hidden="true" tabindex="-1"></a>Rotations can be seen as linear transformation from one coordinate system into another. But there are several way to parametrize them. The first is via a rotation matrix.</span>
<span id="cb56-86"><a href="#cb56-86" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb56-87"><a href="#cb56-87" aria-hidden="true" tabindex="-1"></a><span class="fu">### Rotation matrix (general properties)</span></span>
<span id="cb56-88"><a href="#cb56-88" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb56-89"><a href="#cb56-89" aria-hidden="true" tabindex="-1"></a>In principal a rotation is given by the 9 matrix elements of $R$. However they cannot be arbitrary, they still need to describe rotations. What are the defining properties of rotations? It turns out that a rotation, has an inverse and the inverse simply the transposed $R^{-1} = R^T$ (this is the orthogonality). Further, $det(R)=1$ this is a consequence that the volume in the rotated system stays constant and also the orientation (it's $det(R)=1$ and not just $|det(d)|=1$). So in matrix notation a rotation is defined by</span>
<span id="cb56-90"><a href="#cb56-90" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb56-91"><a href="#cb56-91" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb56-92"><a href="#cb56-92" aria-hidden="true" tabindex="-1"></a>R=\begin{bmatrix}r_{11} &amp; r_{12} &amp; r_{13} <span class="sc">\\</span>r_{21} &amp; r_{22} &amp; r_{23} <span class="sc">\\</span>r_{31} &amp; r_{32} &amp; r_{33} \end{bmatrix}, \quad R^TR=RR^T=1,\quad det(R)=1  </span>
<span id="cb56-93"><a href="#cb56-93" aria-hidden="true" tabindex="-1"></a>$$ {#eq-rot}</span>
<span id="cb56-94"><a href="#cb56-94" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb56-95"><a href="#cb56-95" aria-hidden="true" tabindex="-1"></a>Multiplying two rotation matrices $R_1$ and $R_2$ is a again a rotation matrix, this is why rotations in 3D are also called special orthogonal group <span class="in">`SO(3)`</span>. Note that the order of rotations matter and $R_1 R_2 \ne R_2 R_1$</span>
<span id="cb56-96"><a href="#cb56-96" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb56-97"><a href="#cb56-97" aria-hidden="true" tabindex="-1"></a>So it's obvious that is over parameterized using 9 values and there are constrains on the $r_{ij}$ so that eq. 1 is fulfilled.</span>
<span id="cb56-98"><a href="#cb56-98" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb56-99"><a href="#cb56-99" aria-hidden="true" tabindex="-1"></a><span class="fu">#### Rotation-Matrices ("the from to" pitfall)</span></span>
<span id="cb56-100"><a href="#cb56-100" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb56-101"><a href="#cb56-101" aria-hidden="true" tabindex="-1"></a>When we condescend ourselves to the depth of matrix multiplication, the first of two pitfalls lingers around. This is due to the fact that matrix multiplication introduces an order. Say, we want to transform a vector $\vec{f}$ from a "from coordinate system" into a vector $\vec{t}$ given in coordinates of the "to coordinate system". We can do this via:</span>
<span id="cb56-102"><a href="#cb56-102" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb56-103"><a href="#cb56-103" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb56-104"><a href="#cb56-104" aria-hidden="true" tabindex="-1"></a>\vec{t}=R \,\vec{f}</span>
<span id="cb56-105"><a href="#cb56-105" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb56-106"><a href="#cb56-106" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb56-107"><a href="#cb56-107" aria-hidden="true" tabindex="-1"></a>To go the other way around, use $\vec{f}=R^{-1} \vec{t}$. Figure XXX gives an example.</span>
<span id="cb56-108"><a href="#cb56-108" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb56-109"><a href="#cb56-109" aria-hidden="true" tabindex="-1"></a><span class="al">![A rotation, transforms the coordinates of a point, from the red coordinate system into the green.](images/from_to_in_2D.png)</span>{#fig-fromto width="1000"}</span>
<span id="cb56-110"><a href="#cb56-110" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb56-111"><a href="#cb56-111" aria-hidden="true" tabindex="-1"></a><span class="fu">#### The body and the lab frame</span></span>
<span id="cb56-112"><a href="#cb56-112" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb56-113"><a href="#cb56-113" aria-hidden="true" tabindex="-1"></a>Rotations are just transformation between to coordinate system. Some coordinate system have special meanings. It's good to think of the airplane again and think of two coordinate systems. One is fixed with the airplane, this is called body frame one is fixed with the earth this is called lab frame.</span>
<span id="cb56-114"><a href="#cb56-114" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb56-115"><a href="#cb56-115" aria-hidden="true" tabindex="-1"></a><span class="ss">-   </span>In the **body frame** of points of the plane have the same x,y,z coordinates (if nothing bad happens), a plane is rigid body.</span>
<span id="cb56-116"><a href="#cb56-116" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb56-117"><a href="#cb56-117" aria-hidden="true" tabindex="-1"></a><span class="ss">-   </span>In the **lab frame** the gravity stays constant (it points down). People not sitting in the plane see the coordinates of the plane in this system.</span>
<span id="cb56-118"><a href="#cb56-118" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb56-119"><a href="#cb56-119" aria-hidden="true" tabindex="-1"></a><span class="fu">#### Choosing the direction of the rotation</span></span>
<span id="cb56-120"><a href="#cb56-120" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb56-121"><a href="#cb56-121" aria-hidden="true" tabindex="-1"></a>The question is with is the "to system" and which is the "from system". As often when there is no mathematical reason for a certain way to do things, it gets ugly. There is no natural way to choose one over the other but for some applications a certain order is quite handy.</span>
<span id="cb56-122"><a href="#cb56-122" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb56-123"><a href="#cb56-123" aria-hidden="true" tabindex="-1"></a><span class="ss">-   </span>**Body to Lab**: If you do visualizations, it is a least concepually nicer to describe the rotation from body to lab. Knowing the points of the airplane and the rotation, you can draw a picture of the rotated airplane. They are also called **frame rotations**, as they involve rotating an object or coordinate frame around a specific axis. Some call them also just rotations <span class="co">[</span><span class="ot">@grossekatthofer2012introduction</span><span class="co">]</span>.</span>
<span id="cb56-124"><a href="#cb56-124" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb56-125"><a href="#cb56-125" aria-hidden="true" tabindex="-1"></a><span class="ss">-   </span>**Lab to body:** In the lab frame the gravity stays constant, often chosen in z-direction as $(0,0,-g)$, then knowing the rotation allows to calculate the gravity on the x-component of an IMU sensor in the plane. These are also called **point** **rotations** since they are made relative to a fix point in space (such as the gravity). Sometimes they go under the name (coordinate) **transformations**, see <span class="co">[</span><span class="ot">@grossekatthofer2012introduction</span><span class="co">]</span>.</span>
<span id="cb56-126"><a href="#cb56-126" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb56-127"><a href="#cb56-127" aria-hidden="true" tabindex="-1"></a>It is important to state the direction of the transformation and ideally stick to that order. I find it easier use **body to lab** and use this transformation here.</span>
<span id="cb56-128"><a href="#cb56-128" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb56-129"><a href="#cb56-129" aria-hidden="true" tabindex="-1"></a>::: callout-important</span>
<span id="cb56-130"><a href="#cb56-130" aria-hidden="true" tabindex="-1"></a><span class="fu">## We use body to lab (a.k.a. frame) rotations in this text.</span></span>
<span id="cb56-131"><a href="#cb56-131" aria-hidden="true" tabindex="-1"></a>:::</span>
<span id="cb56-132"><a href="#cb56-132" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb56-133"><a href="#cb56-133" aria-hidden="true" tabindex="-1"></a><span class="fu">### Parameterization using elementary rotation.</span></span>
<span id="cb56-134"><a href="#cb56-134" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb56-135"><a href="#cb56-135" aria-hidden="true" tabindex="-1"></a>Many repeated rotations are again a rotation (closure). Moreover it can be shown that an arbitrary rotation can be build out of three elementary rotations. Here the mess begins, there are many ways to define such as decomposition. For example one possibility is: First, a counter-clockwise rotation $R_z(\alpha)$ around the $z$-axis by an angle of $\alpha$. Second, $R_x(\beta)$ rotates around "the new" $x$-axis and finally by $R_z(\gamma)$ around the new $z$-axis.</span>
<span id="cb56-136"><a href="#cb56-136" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb56-137"><a href="#cb56-137" aria-hidden="true" tabindex="-1"></a><span class="co">[</span><span class="al">![Animation showing the sequence of elementary rotation. Taken from wikepedia](images/Euler2a.gif)</span><span class="ot">{#fig-rot-ball}</span><span class="co">](https://en.wikipedia.org/wiki/Euler_angles)</span></span>
<span id="cb56-138"><a href="#cb56-138" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb56-139"><a href="#cb56-139" aria-hidden="true" tabindex="-1"></a>The animation in @fig-rot-ball shows three consecutive rotations. Is is important not to forget that, we use column vector and do matrix times vector hence. The complete rotation for first $R_1$ then $R_2$ then $R_3$ is written as</span>
<span id="cb56-140"><a href="#cb56-140" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb56-141"><a href="#cb56-141" aria-hidden="true" tabindex="-1"></a>::: callout-caution</span>
<span id="cb56-142"><a href="#cb56-142" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb56-143"><a href="#cb56-143" aria-hidden="true" tabindex="-1"></a>R = R_3 R_2 R_1</span>
<span id="cb56-144"><a href="#cb56-144" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb56-145"><a href="#cb56-145" aria-hidden="true" tabindex="-1"></a>:::</span>
<span id="cb56-146"><a href="#cb56-146" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb56-147"><a href="#cb56-147" aria-hidden="true" tabindex="-1"></a>Going the other way around is also possible, you just need to redefine matrix multiplications.</span>
<span id="cb56-148"><a href="#cb56-148" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb56-149"><a href="#cb56-149" aria-hidden="true" tabindex="-1"></a>::: {.callout-caution collapse="true"}</span>
<span id="cb56-150"><a href="#cb56-150" aria-hidden="true" tabindex="-1"></a><span class="fu">## More details on the order.</span></span>
<span id="cb56-151"><a href="#cb56-151" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb56-152"><a href="#cb56-152" aria-hidden="true" tabindex="-1"></a>Here is an explanation (taken from stackexchange)</span>
<span id="cb56-153"><a href="#cb56-153" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb56-154"><a href="#cb56-154" aria-hidden="true" tabindex="-1"></a>The product $AB$ of matrices is the effect of applying $A$ after applying $B$, simply because we write the "effect" of a matrix $A$ on a vector $v$ as $Av$ (i.e., the convention is to work with column vectors). Thus $(AB)v = A(Bv)$ is $A$ applied to $Bv$. Note that this convention matches the usual notation for (nested) functions: $\log(\sin(x))$ is the logarithm function applied to the result from applying the sine function to $x$.</span>
<span id="cb56-155"><a href="#cb56-155" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb56-156"><a href="#cb56-156" aria-hidden="true" tabindex="-1"></a>Of course, the rules for computing the product of matrices are just right for this convention. Or, if one wanted $AB$ to stand for "first apply $A$, then apply $B$", one would use row vectors instead and write "A applied to $v$" as $vA$ - which is very uncommon (and in effect just means that one works with the transposed matrices, relative to the usual convention).</span>
<span id="cb56-157"><a href="#cb56-157" aria-hidden="true" tabindex="-1"></a>:::</span>
<span id="cb56-158"><a href="#cb56-158" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb56-159"><a href="#cb56-159" aria-hidden="true" tabindex="-1"></a><span class="fu">#### Deriving the elementary transformations</span></span>
<span id="cb56-160"><a href="#cb56-160" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb56-161"><a href="#cb56-161" aria-hidden="true" tabindex="-1"></a>The individual transformations can be derived by looking where the unit vectors are transformed. In the figure below you see a derivation of the rotation matrix $R_z(\alpha)$ around the z axis with an angle of $\alpha&gt;0$ . We move the body centric coordinate system w.r.t the fixed system the direction is determined by the right-hand rule (thumb show in direction of the rotation and fingers indicate the direction)</span>
<span id="cb56-162"><a href="#cb56-162" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb56-163"><a href="#cb56-163" aria-hidden="true" tabindex="-1"></a><span class="al">![Rotation around z-axis with positve $\alpha$ the dots from the airplane in the fixed body system.](images/rz_alpha.png)</span></span>
<span id="cb56-164"><a href="#cb56-164" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb56-165"><a href="#cb56-165" aria-hidden="true" tabindex="-1"></a>So in this case we have for a rotation about $\alpha$ around the z-Axis.</span>
<span id="cb56-166"><a href="#cb56-166" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb56-167"><a href="#cb56-167" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb56-168"><a href="#cb56-168" aria-hidden="true" tabindex="-1"></a>  R_z(\alpha) = R_{L \leftarrow B}^z(\alpha) =\begin{bmatrix}\cos(\alpha) &amp; -\sin(\alpha) &amp; 0 <span class="sc">\\</span>\sin(\alpha) &amp;\cos(\alpha) &amp; 0 <span class="sc">\\</span>0 &amp; 0 &amp; 1 \end{bmatrix}</span>
<span id="cb56-169"><a href="#cb56-169" aria-hidden="true" tabindex="-1"></a>$$ {#eq-yaw}</span>
<span id="cb56-170"><a href="#cb56-170" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb56-171"><a href="#cb56-171" aria-hidden="true" tabindex="-1"></a>For moving the rabit , we get the following rotation matrix:</span>
<span id="cb56-172"><a href="#cb56-172" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb56-175"><a href="#cb56-175" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb56-176"><a href="#cb56-176" aria-hidden="true" tabindex="-1"></a>Rz <span class="ot">=</span> <span class="cf">function</span>(a){</span>
<span id="cb56-177"><a href="#cb56-177" aria-hidden="true" tabindex="-1"></a>  <span class="fu">return</span>(</span>
<span id="cb56-178"><a href="#cb56-178" aria-hidden="true" tabindex="-1"></a>    <span class="fu">matrix</span>(</span>
<span id="cb56-179"><a href="#cb56-179" aria-hidden="true" tabindex="-1"></a>        <span class="fu">c</span>(<span class="fu">cos</span>(a), <span class="sc">-</span><span class="fu">sin</span>(a), <span class="dv">0</span>, <span class="fu">sin</span>(a), <span class="fu">cos</span>(a), <span class="dv">0</span>, <span class="dv">0</span>, <span class="dv">0</span>, <span class="dv">1</span>)</span>
<span id="cb56-180"><a href="#cb56-180" aria-hidden="true" tabindex="-1"></a>        , <span class="at">nrow=</span><span class="dv">3</span>, <span class="at">byrow =</span> R<span class="sc">+</span><span class="cn">TRUE</span>) </span>
<span id="cb56-181"><a href="#cb56-181" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb56-182"><a href="#cb56-182" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb56-183"><a href="#cb56-183" aria-hidden="true" tabindex="-1"></a><span class="fu">Rz</span>(<span class="dv">45</span><span class="sc">*</span><span class="dv">2</span><span class="sc">*</span>pi<span class="sc">/</span><span class="dv">360</span>)</span>
<span id="cb56-184"><a href="#cb56-184" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb56-185"><a href="#cb56-185" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb56-186"><a href="#cb56-186" aria-hidden="true" tabindex="-1"></a>which is same rotation as used in the code used to transform the data.</span>
<span id="cb56-187"><a href="#cb56-187" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb56-188"><a href="#cb56-188" aria-hidden="true" tabindex="-1"></a><span class="fu">#### A worked out example (Yaw-Pitch-Roll)</span></span>
<span id="cb56-189"><a href="#cb56-189" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb56-190"><a href="#cb56-190" aria-hidden="true" tabindex="-1"></a>Using an airplane, we know what happens (taxiing, take-off, rolling) and we can derive a nice chain of elementary rotations, which will serve as reference for later. The derivation can also be found at the following <span class="co">[</span><span class="ot">notes</span><span class="co">](https://www.dropbox.com/s/n3oc5fjwrn1zaiu/Rotations%20without%20tears.pdf?dl=0)</span>.</span>
<span id="cb56-191"><a href="#cb56-191" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb56-192"><a href="#cb56-192" aria-hidden="true" tabindex="-1"></a>In the example, we use the following angles</span>
<span id="cb56-193"><a href="#cb56-193" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb56-194"><a href="#cb56-194" aria-hidden="true" tabindex="-1"></a><span class="in">```{r, ypr_used}</span></span>
<span id="cb56-195"><a href="#cb56-195" aria-hidden="true" tabindex="-1"></a>yaw <span class="ot">=</span> <span class="dv">60</span> <span class="sc">*</span> <span class="dv">2</span> <span class="sc">*</span> pi <span class="sc">/</span> <span class="dv">360</span>     <span class="co">#This is w.r.t. the tower / labframe</span></span>
<span id="cb56-196"><a href="#cb56-196" aria-hidden="true" tabindex="-1"></a>pitch <span class="ot">=</span> <span class="sc">-</span><span class="dv">50</span> <span class="sc">*</span> <span class="dv">2</span> <span class="sc">*</span> pi <span class="sc">/</span> <span class="dv">360</span>  <span class="co">#Angle of climb</span></span>
<span id="cb56-197"><a href="#cb56-197" aria-hidden="true" tabindex="-1"></a>roll <span class="ot">=</span> <span class="dv">40</span> <span class="sc">*</span> <span class="dv">2</span> <span class="sc">*</span> pi <span class="sc">/</span> <span class="dv">360</span>    <span class="co">#Angle of roll</span></span>
<span id="cb56-198"><a href="#cb56-198" aria-hidden="true" tabindex="-1"></a><span class="fu">print</span>(<span class="fu">paste</span>(<span class="st">'In rad yaw '</span>, yaw, <span class="st">' pitch '</span>, pitch, <span class="st">' roll '</span>,roll))</span>
<span id="cb56-199"><a href="#cb56-199" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb56-200"><a href="#cb56-200" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb56-201"><a href="#cb56-201" aria-hidden="true" tabindex="-1"></a>The pitch needs to be negative in order that a the rotation leads to a ascent (see later).</span>
<span id="cb56-202"><a href="#cb56-202" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb56-203"><a href="#cb56-203" aria-hidden="true" tabindex="-1"></a><span class="fu">##### Taxiing yaw $\alpha$</span></span>
<span id="cb56-204"><a href="#cb56-204" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb56-205"><a href="#cb56-205" aria-hidden="true" tabindex="-1"></a>For the given yaw we have:</span>
<span id="cb56-206"><a href="#cb56-206" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb56-207"><a href="#cb56-207" aria-hidden="true" tabindex="-1"></a><span class="in">```{r R.yaw_for_example}</span></span>
<span id="cb56-208"><a href="#cb56-208" aria-hidden="true" tabindex="-1"></a>R.yaw <span class="ot">=</span> <span class="fu">Rz</span>(yaw) </span>
<span id="cb56-209"><a href="#cb56-209" aria-hidden="true" tabindex="-1"></a>R.yaw</span>
<span id="cb56-210"><a href="#cb56-210" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb56-211"><a href="#cb56-211" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb56-212"><a href="#cb56-212" aria-hidden="true" tabindex="-1"></a><span class="fu">##### Construction of data points for the airplane.</span></span>
<span id="cb56-213"><a href="#cb56-213" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb56-214"><a href="#cb56-214" aria-hidden="true" tabindex="-1"></a>We create $3 \times N$ data points so that it is easier for plotting. When we want to use the normal data points in statistics, we could use vector times matrix and do proper transposing.</span>
<span id="cb56-215"><a href="#cb56-215" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb56-216"><a href="#cb56-216" aria-hidden="true" tabindex="-1"></a><span class="in">```{r, data_gen, warning=FALSE}</span></span>
<span id="cb56-217"><a href="#cb56-217" aria-hidden="true" tabindex="-1"></a><span class="fu">set.seed</span>(<span class="dv">42</span>)</span>
<span id="cb56-218"><a href="#cb56-218" aria-hidden="true" tabindex="-1"></a>n <span class="ot">=</span> <span class="dv">1100</span></span>
<span id="cb56-219"><a href="#cb56-219" aria-hidden="true" tabindex="-1"></a>x <span class="ot">=</span> <span class="fu">runif</span>(n,<span class="sc">-</span><span class="dv">1</span>,<span class="dv">1</span>)</span>
<span id="cb56-220"><a href="#cb56-220" aria-hidden="true" tabindex="-1"></a>y <span class="ot">=</span> <span class="fu">runif</span>(n, <span class="sc">-</span><span class="fl">0.4</span>,<span class="fl">0.4</span>)</span>
<span id="cb56-221"><a href="#cb56-221" aria-hidden="true" tabindex="-1"></a>z <span class="ot">=</span> <span class="fu">runif</span>(n,<span class="sc">-</span><span class="fl">0.1</span>,<span class="fl">0.1</span>)</span>
<span id="cb56-222"><a href="#cb56-222" aria-hidden="true" tabindex="-1"></a>col <span class="ot">=</span> <span class="fu">rep</span>(<span class="st">'blue'</span>,n)</span>
<span id="cb56-223"><a href="#cb56-223" aria-hidden="true" tabindex="-1"></a>col[x<span class="sc">&gt;</span><span class="fl">0.5</span>] <span class="ot">=</span> <span class="st">'red'</span></span>
<span id="cb56-224"><a href="#cb56-224" aria-hidden="true" tabindex="-1"></a>col[x<span class="sc">&lt;=</span> <span class="sc">-</span><span class="fl">0.5</span>] <span class="ot">=</span> <span class="st">'green'</span></span>
<span id="cb56-225"><a href="#cb56-225" aria-hidden="true" tabindex="-1"></a>col[y<span class="sc">&lt;=</span> <span class="sc">-</span><span class="fl">0.2</span>] <span class="ot">=</span> <span class="st">'gray30'</span></span>
<span id="cb56-226"><a href="#cb56-226" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb56-227"><a href="#cb56-227" aria-hidden="true" tabindex="-1"></a>plane <span class="ot">=</span> <span class="fu">as.matrix</span>(<span class="fu">data.frame</span>(<span class="at">x=</span>x,<span class="at">y=</span>y,<span class="at">z=</span>z))</span>
<span id="cb56-228"><a href="#cb56-228" aria-hidden="true" tabindex="-1"></a>plane <span class="ot">=</span> <span class="fu">t</span>(plane) <span class="co">#3xN</span></span>
<span id="cb56-229"><a href="#cb56-229" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(rgl)</span>
<span id="cb56-230"><a href="#cb56-230" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(scatterplot3d) <span class="co"># load</span></span>
<span id="cb56-231"><a href="#cb56-231" aria-hidden="true" tabindex="-1"></a> </span>
<span id="cb56-232"><a href="#cb56-232" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb56-233"><a href="#cb56-233" aria-hidden="true" tabindex="-1"></a>make_plot <span class="ot">=</span> <span class="cf">function</span>(p1, p2, <span class="at">l1=</span><span class="fu">c</span>(<span class="st">'x'</span>,<span class="st">'y'</span>,<span class="st">'z'</span>), <span class="at">l2=</span><span class="fu">c</span>(<span class="st">'x'</span>,<span class="st">'y'</span>,<span class="st">'z'</span>), <span class="at">angle =</span> <span class="dv">55</span>) {</span>
<span id="cb56-234"><a href="#cb56-234" aria-hidden="true" tabindex="-1"></a>  <span class="fu">par</span>(<span class="at">mfrow=</span><span class="fu">c</span>(<span class="dv">1</span>,<span class="dv">2</span>))</span>
<span id="cb56-235"><a href="#cb56-235" aria-hidden="true" tabindex="-1"></a>  p1 <span class="ot">=</span> <span class="fu">t</span>(p1)</span>
<span id="cb56-236"><a href="#cb56-236" aria-hidden="true" tabindex="-1"></a>  p2 <span class="ot">=</span> <span class="fu">t</span>(p2)</span>
<span id="cb56-237"><a href="#cb56-237" aria-hidden="true" tabindex="-1"></a>  <span class="co">#First plot</span></span>
<span id="cb56-238"><a href="#cb56-238" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scatterplot3d</span>(p1[,<span class="dv">1</span>],p1[,<span class="dv">2</span>],p1[,<span class="dv">3</span>], </span>
<span id="cb56-239"><a href="#cb56-239" aria-hidden="true" tabindex="-1"></a>                <span class="at">xlim=</span><span class="fu">c</span>(<span class="sc">-</span><span class="dv">1</span>,<span class="dv">1</span>), <span class="at">ylim=</span><span class="fu">c</span>(<span class="sc">-</span><span class="dv">1</span>,<span class="dv">1</span>), <span class="at">zlim=</span><span class="fu">c</span>(<span class="sc">-</span><span class="dv">1</span>,<span class="dv">1</span>), </span>
<span id="cb56-240"><a href="#cb56-240" aria-hidden="true" tabindex="-1"></a>                <span class="at">color =</span> col,</span>
<span id="cb56-241"><a href="#cb56-241" aria-hidden="true" tabindex="-1"></a>                <span class="at">xlab=</span>l1[<span class="dv">1</span>], <span class="at">ylab=</span>l1[<span class="dv">2</span>], <span class="at">zlab =</span> l1[<span class="dv">3</span>],<span class="at">angle =</span> angle, <span class="at">pch=</span><span class="dv">16</span>)</span>
<span id="cb56-242"><a href="#cb56-242" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scatterplot3d</span>(p2[,<span class="dv">1</span>],p2[,<span class="dv">2</span>],p2[,<span class="dv">3</span>], </span>
<span id="cb56-243"><a href="#cb56-243" aria-hidden="true" tabindex="-1"></a>                <span class="at">xlim=</span><span class="fu">c</span>(<span class="sc">-</span><span class="dv">1</span>,<span class="dv">1</span>), <span class="at">ylim=</span><span class="fu">c</span>(<span class="sc">-</span><span class="dv">1</span>,<span class="dv">1</span>), <span class="at">zlim=</span><span class="fu">c</span>(<span class="sc">-</span><span class="dv">1</span>,<span class="dv">1</span>), </span>
<span id="cb56-244"><a href="#cb56-244" aria-hidden="true" tabindex="-1"></a>                <span class="at">color =</span> col,</span>
<span id="cb56-245"><a href="#cb56-245" aria-hidden="true" tabindex="-1"></a>                <span class="at">xlab=</span>l2[<span class="dv">1</span>], <span class="at">ylab=</span>l2[<span class="dv">2</span>], <span class="at">zlab =</span> l2[<span class="dv">3</span>],<span class="at">angle =</span> angle, <span class="at">pch=</span><span class="dv">16</span>)</span>
<span id="cb56-246"><a href="#cb56-246" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb56-247"><a href="#cb56-247" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb56-248"><a href="#cb56-248" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb56-249"><a href="#cb56-249" aria-hidden="true" tabindex="-1"></a>To visualize, we need the body coordinates, transformed to lab coordinates.</span>
<span id="cb56-250"><a href="#cb56-250" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb56-251"><a href="#cb56-251" aria-hidden="true" tabindex="-1"></a><span class="in">```{r, yaw-plane, fig.width=10, fig.height=5, fig.cap='Left: orinial data. Right: data rotated by yaw degrees around z-axis'}</span></span>
<span id="cb56-252"><a href="#cb56-252" aria-hidden="true" tabindex="-1"></a><span class="do">##Since we have column vector, we have to transpose once more yielding</span></span>
<span id="cb56-253"><a href="#cb56-253" aria-hidden="true" tabindex="-1"></a>plane.yaw  <span class="ot">=</span> R.yaw <span class="sc">%*%</span> plane </span>
<span id="cb56-254"><a href="#cb56-254" aria-hidden="true" tabindex="-1"></a><span class="fu">make_plot</span>(plane, plane.yaw, <span class="at">l2=</span><span class="fu">c</span>(<span class="st">"x'"</span>,<span class="st">"y'"</span>,<span class="st">"z'"</span>))</span>
<span id="cb56-255"><a href="#cb56-255" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> (<span class="cn">FALSE</span>){<span class="co">#Debuggin</span></span>
<span id="cb56-256"><a href="#cb56-256" aria-hidden="true" tabindex="-1"></a>  <span class="fu">print</span>(<span class="st">'Maximal difference, in x-direction'</span>)</span>
<span id="cb56-257"><a href="#cb56-257" aria-hidden="true" tabindex="-1"></a>  <span class="fu">max</span>(<span class="fu">abs</span>(plane.yaw[,<span class="dv">3</span>] <span class="sc">-</span> plane[,<span class="dv">3</span>]))</span>
<span id="cb56-258"><a href="#cb56-258" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb56-259"><a href="#cb56-259" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb56-260"><a href="#cb56-260" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb56-261"><a href="#cb56-261" aria-hidden="true" tabindex="-1"></a><span class="fu">##### Take-off the pitch $\beta$</span></span>
<span id="cb56-262"><a href="#cb56-262" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb56-263"><a href="#cb56-263" aria-hidden="true" tabindex="-1"></a>When the plane takes off, all rotates rotated about $\beta$ about the y-axis. This is given by</span>
<span id="cb56-264"><a href="#cb56-264" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb56-265"><a href="#cb56-265" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb56-266"><a href="#cb56-266" aria-hidden="true" tabindex="-1"></a>  R^y(\beta) = \begin{bmatrix}\cos(\beta) &amp; 0 &amp; +\sin(\beta)<span class="sc">\\</span></span>
<span id="cb56-267"><a href="#cb56-267" aria-hidden="true" tabindex="-1"></a>   0 &amp; 1 &amp; 0 <span class="sc">\\</span></span>
<span id="cb56-268"><a href="#cb56-268" aria-hidden="true" tabindex="-1"></a>  -\sin(\beta) &amp; 0 &amp; \cos(\beta)\end{bmatrix}</span>
<span id="cb56-269"><a href="#cb56-269" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb56-270"><a href="#cb56-270" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb56-271"><a href="#cb56-271" aria-hidden="true" tabindex="-1"></a>Note that the rotation is about the y-axis (use the right hand the thumb is the axis and the fingers shows the direction). Acceding, corresponds to negative values (that's the reason we choose negative value)</span>
<span id="cb56-272"><a href="#cb56-272" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb56-273"><a href="#cb56-273" aria-hidden="true" tabindex="-1"></a><span class="in">```{r R.pitch_for_example}</span></span>
<span id="cb56-274"><a href="#cb56-274" aria-hidden="true" tabindex="-1"></a>Ry <span class="ot">=</span> <span class="cf">function</span>(b) <span class="fu">matrix</span>(</span>
<span id="cb56-275"><a href="#cb56-275" aria-hidden="true" tabindex="-1"></a>      <span class="fu">c</span>(<span class="fu">cos</span>(b), <span class="dv">0</span>, <span class="sc">+</span><span class="fu">sin</span>(b), <span class="dv">0</span>, <span class="dv">1</span>, <span class="dv">0</span>, <span class="sc">-</span><span class="fu">sin</span>(b), <span class="dv">0</span>, <span class="fu">cos</span>(b))</span>
<span id="cb56-276"><a href="#cb56-276" aria-hidden="true" tabindex="-1"></a>      , <span class="at">nrow=</span><span class="dv">3</span>, <span class="at">byrow =</span> <span class="cn">TRUE</span>) </span>
<span id="cb56-277"><a href="#cb56-277" aria-hidden="true" tabindex="-1"></a>R.pitch <span class="ot">=</span> <span class="fu">Ry</span>(pitch) </span>
<span id="cb56-278"><a href="#cb56-278" aria-hidden="true" tabindex="-1"></a>R.pitch</span>
<span id="cb56-279"><a href="#cb56-279" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb56-280"><a href="#cb56-280" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb56-281"><a href="#cb56-281" aria-hidden="true" tabindex="-1"></a><span class="fu">###### Takeoff without taxiing</span></span>
<span id="cb56-282"><a href="#cb56-282" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb56-283"><a href="#cb56-283" aria-hidden="true" tabindex="-1"></a><span class="in">```{r, fig.cap="Left: orinial data. Right: data rotated by XXX degrees around y-axis", fig.width=10, fig.height=5}</span></span>
<span id="cb56-284"><a href="#cb56-284" aria-hidden="true" tabindex="-1"></a><span class="fu">make_plot</span>(plane, R.pitch <span class="sc">%*%</span> plane)</span>
<span id="cb56-285"><a href="#cb56-285" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb56-286"><a href="#cb56-286" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb56-287"><a href="#cb56-287" aria-hidden="true" tabindex="-1"></a><span class="fu">###### Takeoff with taxiing</span></span>
<span id="cb56-288"><a href="#cb56-288" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb56-289"><a href="#cb56-289" aria-hidden="true" tabindex="-1"></a>Here, we combine the transformations (**note the order**)</span>
<span id="cb56-290"><a href="#cb56-290" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb56-291"><a href="#cb56-291" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb56-292"><a href="#cb56-292" aria-hidden="true" tabindex="-1"></a>x=R^{y}(\beta)R^z(\alpha)x'</span>
<span id="cb56-293"><a href="#cb56-293" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb56-294"><a href="#cb56-294" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb56-295"><a href="#cb56-295" aria-hidden="true" tabindex="-1"></a><span class="in">```{r, fig.cap="Left: orinial data. Right: data rotated by XXX degrees around y-axis", fig.width=10, fig.height=5}</span></span>
<span id="cb56-296"><a href="#cb56-296" aria-hidden="true" tabindex="-1"></a>R <span class="ot">=</span> R.pitch <span class="sc">%*%</span> R.yaw</span>
<span id="cb56-297"><a href="#cb56-297" aria-hidden="true" tabindex="-1"></a>plane.pitch.yaw <span class="ot">=</span> R <span class="sc">%*%</span> plane </span>
<span id="cb56-298"><a href="#cb56-298" aria-hidden="true" tabindex="-1"></a><span class="fu">make_plot</span>(plane.yaw, plane.pitch.yaw,<span class="at">l1=</span><span class="fu">c</span>(<span class="st">"x'"</span>, <span class="st">"y'"</span>, <span class="st">"z''"</span>), <span class="at">l2=</span><span class="fu">c</span>(<span class="st">"x''"</span>, <span class="st">"y''"</span>, <span class="st">"z''"</span>)) </span>
<span id="cb56-299"><a href="#cb56-299" aria-hidden="true" tabindex="-1"></a><span class="co">#plot3d(plane.pitch.yaw[,1],plane.pitch.yaw[,2],plane.pitch.yaw[,3], xlim=c(-1,1), ylim=c(-1,1), zlim=c(-1,1), col=col) </span></span>
<span id="cb56-300"><a href="#cb56-300" aria-hidden="true" tabindex="-1"></a><span class="co">#rglwidget()</span></span>
<span id="cb56-301"><a href="#cb56-301" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb56-302"><a href="#cb56-302" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb56-303"><a href="#cb56-303" aria-hidden="true" tabindex="-1"></a><span class="fu">##### In the air, the roll $\gamma$</span></span>
<span id="cb56-304"><a href="#cb56-304" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb56-305"><a href="#cb56-305" aria-hidden="true" tabindex="-1"></a>Now that we are in the air, we roll the plane about a certain degree around the x-axis. This can be done by</span>
<span id="cb56-306"><a href="#cb56-306" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb56-307"><a href="#cb56-307" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb56-308"><a href="#cb56-308" aria-hidden="true" tabindex="-1"></a>R^x(\gamma) = \begin{bmatrix}</span>
<span id="cb56-309"><a href="#cb56-309" aria-hidden="true" tabindex="-1"></a>1 &amp; 0 &amp; 0<span class="sc">\\</span></span>
<span id="cb56-310"><a href="#cb56-310" aria-hidden="true" tabindex="-1"></a>0 &amp; \cos(\gamma) &amp; -\sin(\gamma) <span class="sc">\\</span></span>
<span id="cb56-311"><a href="#cb56-311" aria-hidden="true" tabindex="-1"></a> 0 &amp; \sin(\gamma) &amp; \cos(\gamma) \end{bmatrix}</span>
<span id="cb56-312"><a href="#cb56-312" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb56-313"><a href="#cb56-313" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb56-316"><a href="#cb56-316" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb56-317"><a href="#cb56-317" aria-hidden="true" tabindex="-1"></a>Rx <span class="ot">=</span> <span class="cf">function</span>(g) <span class="fu">matrix</span>(</span>
<span id="cb56-318"><a href="#cb56-318" aria-hidden="true" tabindex="-1"></a>      <span class="fu">c</span>(<span class="dv">1</span>,<span class="dv">0</span>,<span class="dv">0</span>, <span class="dv">0</span>, <span class="fu">cos</span>(g), <span class="sc">-</span><span class="fu">sin</span>(g), <span class="dv">0</span>, <span class="fu">sin</span>(g), <span class="fu">cos</span>(g))</span>
<span id="cb56-319"><a href="#cb56-319" aria-hidden="true" tabindex="-1"></a>      , <span class="at">nrow=</span><span class="dv">3</span>, <span class="at">byrow =</span> <span class="cn">TRUE</span>) </span>
<span id="cb56-320"><a href="#cb56-320" aria-hidden="true" tabindex="-1"></a>R.roll<span class="ot">=</span><span class="fu">Rx</span>(roll)</span>
<span id="cb56-321"><a href="#cb56-321" aria-hidden="true" tabindex="-1"></a>R.roll</span>
<span id="cb56-322"><a href="#cb56-322" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb56-323"><a href="#cb56-323" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb56-324"><a href="#cb56-324" aria-hidden="true" tabindex="-1"></a>\</span>
<span id="cb56-325"><a href="#cb56-325" aria-hidden="true" tabindex="-1"></a>The final transformation can be found via</span>
<span id="cb56-326"><a href="#cb56-326" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb56-327"><a href="#cb56-327" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb56-328"><a href="#cb56-328" aria-hidden="true" tabindex="-1"></a>x=R(\alpha, \beta, \gamma)\,x= R^{x}(\gamma) R^{y}(\beta)\,R^z(\alpha)x'</span>
<span id="cb56-329"><a href="#cb56-329" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb56-330"><a href="#cb56-330" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb56-331"><a href="#cb56-331" aria-hidden="true" tabindex="-1"></a><span class="in">```{r, comp_trafo, fig.cap="Left: orinial data. Right: data rotated by degrees around y-axis", fig.width=10, fig.height=5}</span></span>
<span id="cb56-332"><a href="#cb56-332" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb56-333"><a href="#cb56-333" aria-hidden="true" tabindex="-1"></a>R <span class="ot">=</span> R.roll <span class="sc">%*%</span> R.pitch <span class="sc">%*%</span> R.yaw</span>
<span id="cb56-334"><a href="#cb56-334" aria-hidden="true" tabindex="-1"></a>plane.roll.pitch.yaw <span class="ot">=</span> R <span class="sc">%*%</span> plane </span>
<span id="cb56-335"><a href="#cb56-335" aria-hidden="true" tabindex="-1"></a><span class="fu">make_plot</span>(plane.pitch.yaw, plane.roll.pitch.yaw,<span class="at">l1=</span><span class="fu">c</span>(<span class="st">"x''"</span>, <span class="st">"y''"</span>, <span class="st">"z''"</span>), <span class="at">l2=</span><span class="fu">c</span>(<span class="st">"x'''"</span>, <span class="st">"y'''"</span>, <span class="st">"z'''"</span>)) </span>
<span id="cb56-336"><a href="#cb56-336" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb56-337"><a href="#cb56-337" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb56-338"><a href="#cb56-338" aria-hidden="true" tabindex="-1"></a>Playing around (sorry not in document yet)</span>
<span id="cb56-339"><a href="#cb56-339" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb56-342"><a href="#cb56-342" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb56-343"><a href="#cb56-343" aria-hidden="true" tabindex="-1"></a><span class="co">#Return the rotion matrix (Lab  &lt;- Fixed)</span></span>
<span id="cb56-344"><a href="#cb56-344" aria-hidden="true" tabindex="-1"></a>get_R <span class="ot">=</span> <span class="cf">function</span>(yaw, roll, pitch){</span>
<span id="cb56-345"><a href="#cb56-345" aria-hidden="true" tabindex="-1"></a>   Rroll <span class="ot">=</span> <span class="fu">Rx</span>(roll)</span>
<span id="cb56-346"><a href="#cb56-346" aria-hidden="true" tabindex="-1"></a>   Ryaw  <span class="ot">=</span> <span class="fu">Rz</span>(yaw)</span>
<span id="cb56-347"><a href="#cb56-347" aria-hidden="true" tabindex="-1"></a>   Rp <span class="ot">=</span> <span class="fu">Ry</span>(pitch) </span>
<span id="cb56-348"><a href="#cb56-348" aria-hidden="true" tabindex="-1"></a>   Rani <span class="ot">=</span> Rroll <span class="sc">%*%</span> Rp <span class="sc">%*%</span> Ryaw</span>
<span id="cb56-349"><a href="#cb56-349" aria-hidden="true" tabindex="-1"></a>   <span class="fu">return</span>(Rani)</span>
<span id="cb56-350"><a href="#cb56-350" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb56-351"><a href="#cb56-351" aria-hidden="true" tabindex="-1"></a><span class="fu">get_R</span>(yaw, roll, pitch)</span>
<span id="cb56-352"><a href="#cb56-352" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb56-353"><a href="#cb56-353" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb56-354"><a href="#cb56-354" aria-hidden="true" tabindex="-1"></a><span class="in">```{r, manipulate, eval=FALSE}</span></span>
<span id="cb56-355"><a href="#cb56-355" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> (<span class="cn">FALSE</span>){</span>
<span id="cb56-356"><a href="#cb56-356" aria-hidden="true" tabindex="-1"></a>  <span class="do">##### copy paste the code below</span></span>
<span id="cb56-357"><a href="#cb56-357" aria-hidden="true" tabindex="-1"></a>  <span class="fu">library</span>(manipulate)</span>
<span id="cb56-358"><a href="#cb56-358" aria-hidden="true" tabindex="-1"></a>  <span class="fu">manipulate</span>(</span>
<span id="cb56-359"><a href="#cb56-359" aria-hidden="true" tabindex="-1"></a>    {</span>
<span id="cb56-360"><a href="#cb56-360" aria-hidden="true" tabindex="-1"></a>      plane.lab <span class="ot">=</span> <span class="fu">get_R</span>(<span class="at">yaw=</span>yaw, <span class="at">roll=</span>roll, <span class="at">pitch =</span> pitch) <span class="sc">%*%</span> plane</span>
<span id="cb56-361"><a href="#cb56-361" aria-hidden="true" tabindex="-1"></a>      <span class="fu">make_plot</span>(plane, plane.lab,<span class="at">l1=</span><span class="fu">c</span>(<span class="st">"x''"</span>, <span class="st">"y''"</span>, <span class="st">"z''"</span>), <span class="at">l2=</span><span class="fu">c</span>(<span class="st">"x'''"</span>, <span class="st">"y'''"</span>, <span class="st">"z'''"</span>))</span>
<span id="cb56-362"><a href="#cb56-362" aria-hidden="true" tabindex="-1"></a>    },</span>
<span id="cb56-363"><a href="#cb56-363" aria-hidden="true" tabindex="-1"></a>      <span class="at">yaw =</span> <span class="fu">slider</span>(<span class="dv">0</span>, <span class="dv">2</span><span class="sc">*</span>pi, <span class="at">initial =</span> <span class="dv">0</span>),</span>
<span id="cb56-364"><a href="#cb56-364" aria-hidden="true" tabindex="-1"></a>      <span class="at">pitch =</span> <span class="fu">slider</span>(<span class="sc">-</span>pi<span class="sc">/</span><span class="dv">2</span>,pi<span class="sc">/</span><span class="dv">2</span>, <span class="at">initial =</span> <span class="dv">0</span>),</span>
<span id="cb56-365"><a href="#cb56-365" aria-hidden="true" tabindex="-1"></a>      <span class="at">roll =</span> <span class="fu">slider</span>(<span class="sc">-</span>pi, pi, <span class="at">initial =</span> <span class="dv">0</span>)</span>
<span id="cb56-366"><a href="#cb56-366" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb56-367"><a href="#cb56-367" aria-hidden="true" tabindex="-1"></a>}  </span>
<span id="cb56-368"><a href="#cb56-368" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb56-369"><a href="#cb56-369" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb56-370"><a href="#cb56-370" aria-hidden="true" tabindex="-1"></a><span class="fu">#### Note on airplane system</span></span>
<span id="cb56-371"><a href="#cb56-371" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb56-372"><a href="#cb56-372" aria-hidden="true" tabindex="-1"></a>The choice to have the z-axis pointing up and so on has been arbitrary, the only important thing is that we have right handed coordinate systems. If you don't like the fact that you need a negative pitch and that you are willing to give up that the z-axis is pointing upwards, you can use a coordinate system like, shown in the next picture.</span>
<span id="cb56-373"><a href="#cb56-373" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb56-374"><a href="#cb56-374" aria-hidden="true" tabindex="-1"></a><span class="co">[</span><span class="al">![Alternative coordinate system. Note the rotations stay the same.](images/flight_coordinate.png)</span><span class="ot">{width="576"}</span><span class="co">](https://www.google.com/url?sa=i&amp;url=https%3A%2F%2Fnovatel.com%2Fsolutions%2Fattitude&amp;psig=AOvVaw2-ILI77A8TF1OFVhpc2vug&amp;ust=1671809153449000&amp;source=images&amp;cd=vfe&amp;ved=0CBAQjRxqFwoTCIjXn8bEjfwCFQAAAAAdAAAAABAI)</span></span>
<span id="cb56-375"><a href="#cb56-375" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb56-376"><a href="#cb56-376" aria-hidden="true" tabindex="-1"></a><span class="fu">#### Gimbal Look</span></span>
<span id="cb56-377"><a href="#cb56-377" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb56-378"><a href="#cb56-378" aria-hidden="true" tabindex="-1"></a>Further, in this parameterization the effect of changing the angles by a bit has different effects depending on the values. In the extreme case changing the angle does nothing anymore, which is known under the name gimbals look (see e.g. <span class="co">[</span><span class="ot">here</span><span class="co">](https://towardsdatascience.com/better-rotation-representations-for-accurate-pose-estimation-e890a7e1317f)</span> for a nice demonstration).</span>
<span id="cb56-379"><a href="#cb56-379" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb56-380"><a href="#cb56-380" aria-hidden="true" tabindex="-1"></a><span class="fu"># Quaternions</span></span>
<span id="cb56-381"><a href="#cb56-381" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb56-382"><a href="#cb56-382" aria-hidden="true" tabindex="-1"></a>Besides defining a rotation by 3 elementary rotations, with the many implied ambiguities and the gimbal lock there are other possibilities to describe rotations. Quaterions are such a possibility. They used as standard output format of many libraries such as <span class="co">[</span><span class="ot">AHRS</span><span class="co">](https://ahrs.readthedocs.io/en/latest/index.html#)</span> and the IMU sensors. Quaternions are objects which consists of 4 numbers, and the rotation around a vector can be nicely described with them as we will see in a second. But they also have some mathematical raison d'etre.</span>
<span id="cb56-383"><a href="#cb56-383" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb56-384"><a href="#cb56-384" aria-hidden="true" tabindex="-1"></a><span class="fu">## Definition of Quaternions</span></span>
<span id="cb56-385"><a href="#cb56-385" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb56-386"><a href="#cb56-386" aria-hidden="true" tabindex="-1"></a>Complex numbers $|a|e^{i \theta}$ describe points in the real / imaginary space. Rotations in 2D can be nicely described by them using multiplications. Quaternions can be seen as a generalization of complex numbers with two more imaginary like units $i,j,k$. Using these, the quaternion can be written as:</span>
<span id="cb56-387"><a href="#cb56-387" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb56-388"><a href="#cb56-388" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb56-389"><a href="#cb56-389" aria-hidden="true" tabindex="-1"></a>q =  (q_w, q_1, q_2, q_3) = q_w + q_1 i + q_2 j + q_3 k</span>
<span id="cb56-390"><a href="#cb56-390" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb56-391"><a href="#cb56-391" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb56-392"><a href="#cb56-392" aria-hidden="true" tabindex="-1"></a>The basis have some properties (there are more)</span>
<span id="cb56-393"><a href="#cb56-393" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb56-394"><a href="#cb56-394" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb56-395"><a href="#cb56-395" aria-hidden="true" tabindex="-1"></a>  i^2=j^2=k^2=ijk=-1 \;\; ij = -ji = k </span>
<span id="cb56-396"><a href="#cb56-396" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb56-397"><a href="#cb56-397" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb56-398"><a href="#cb56-398" aria-hidden="true" tabindex="-1"></a>The length of a quaternion can be determined as:</span>
<span id="cb56-399"><a href="#cb56-399" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb56-400"><a href="#cb56-400" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb56-401"><a href="#cb56-401" aria-hidden="true" tabindex="-1"></a>  ||q|| = \sqrt{q_w^2 + q_1^2 + q_2^2 + q_3^2 }</span>
<span id="cb56-402"><a href="#cb56-402" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb56-403"><a href="#cb56-403" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb56-404"><a href="#cb56-404" aria-hidden="true" tabindex="-1"></a>Here, we are dealing with quaternions of length 1 and almost all quaternions used in Computergraphics are unit quaternions or a.k.a. *rotation quaternions*.</span>
<span id="cb56-405"><a href="#cb56-405" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb56-406"><a href="#cb56-406" aria-hidden="true" tabindex="-1"></a>::: callout-note</span>
<span id="cb56-407"><a href="#cb56-407" aria-hidden="true" tabindex="-1"></a>Only unit quaternions</span>
<span id="cb56-408"><a href="#cb56-408" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb56-409"><a href="#cb56-409" aria-hidden="true" tabindex="-1"></a>All quaternions here are unit / rotation quaternions with length = 1</span>
<span id="cb56-410"><a href="#cb56-410" aria-hidden="true" tabindex="-1"></a>:::</span>
<span id="cb56-411"><a href="#cb56-411" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb56-412"><a href="#cb56-412" aria-hidden="true" tabindex="-1"></a><span class="fu">### Geometric Representation with rotation quaternions</span></span>
<span id="cb56-413"><a href="#cb56-413" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb56-414"><a href="#cb56-414" aria-hidden="true" tabindex="-1"></a>All rotations can be described by unit vector $\vec{r}=(r_x,r_y,r_z)$ and a counter clock wise rotation (right hand rule) around this vector by an angle $\theta$. This is shown in the following figure</span>
<span id="cb56-415"><a href="#cb56-415" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb56-416"><a href="#cb56-416" aria-hidden="true" tabindex="-1"></a><span class="al">![Rotation around a vector](images/rotation_abitrary_vector.png)</span>{#fig-rot width="400"}</span>
<span id="cb56-417"><a href="#cb56-417" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb56-418"><a href="#cb56-418" aria-hidden="true" tabindex="-1"></a>A rotation around $\vec{r}$ can parameterized with the unit quaternion</span>
<span id="cb56-419"><a href="#cb56-419" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb56-420"><a href="#cb56-420" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb56-421"><a href="#cb56-421" aria-hidden="true" tabindex="-1"></a>  q(\theta, v) = \cos(\frac{\theta}{2}) + i \sin(\frac{\theta}{2}) r_1 +</span>
<span id="cb56-422"><a href="#cb56-422" aria-hidden="true" tabindex="-1"></a>  j \sin(\frac{\theta}{2}) r_2 + k \sin(\frac{\theta}{2}) r_3 </span>
<span id="cb56-423"><a href="#cb56-423" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb56-424"><a href="#cb56-424" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb56-425"><a href="#cb56-425" aria-hidden="true" tabindex="-1"></a>or componentwise</span>
<span id="cb56-426"><a href="#cb56-426" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb56-427"><a href="#cb56-427" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb56-428"><a href="#cb56-428" aria-hidden="true" tabindex="-1"></a> q(\theta, v) =  \left(\cos(\frac{\theta}{2}),\; \sin(\frac{\theta}{2})  v_1, \;\sin(\frac{\theta} {2}) v_2, \;\sin(\frac{\theta}{2}) v_3 \right)</span>
<span id="cb56-429"><a href="#cb56-429" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb56-430"><a href="#cb56-430" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb56-431"><a href="#cb56-431" aria-hidden="true" tabindex="-1"></a>The length of $q$ is $||q||=\cos^2(\theta/2) + \sin^2(\theta/2) (v_1^2 + v_2^2 + v_3^2) = \cos^2(\theta/2) + \sin^2(\theta/2) = 1$</span>
<span id="cb56-432"><a href="#cb56-432" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb56-433"><a href="#cb56-433" aria-hidden="true" tabindex="-1"></a><span class="fu">#### Construction of quaternion from vector and angle</span></span>
<span id="cb56-434"><a href="#cb56-434" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb56-435"><a href="#cb56-435" aria-hidden="true" tabindex="-1"></a>Some special quaternions. The yawing can be described by a rotation of $\theta$ around the vector $\vec{r} = (0,0,1)$ and is given by</span>
<span id="cb56-436"><a href="#cb56-436" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb56-437"><a href="#cb56-437" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb56-438"><a href="#cb56-438" aria-hidden="true" tabindex="-1"></a>q_{\text yaw} = (\cos(\frac{\theta}{2}) \theta, 0, 0, \sin(\frac{1}{2} \theta))</span>
<span id="cb56-439"><a href="#cb56-439" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb56-440"><a href="#cb56-440" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb56-441"><a href="#cb56-441" aria-hidden="true" tabindex="-1"></a>The identity be constructed with $\theta=0$ about any axis $q(0) = (\cos(0), v_1 \sin(0), v_2 \sin(0), v_3 \sin(0) = (1,0,0,0)$.</span>
<span id="cb56-442"><a href="#cb56-442" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb56-443"><a href="#cb56-443" aria-hidden="true" tabindex="-1"></a><span class="fu">### Quaterion Algebra</span></span>
<span id="cb56-444"><a href="#cb56-444" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb56-445"><a href="#cb56-445" aria-hidden="true" tabindex="-1"></a><span class="ss">-   </span>Addition (easy but no geometeric interpretation), just for reference $$</span>
<span id="cb56-446"><a href="#cb56-446" aria-hidden="true" tabindex="-1"></a>    q + p = p + q =  q_w + p_w + (q_1 + p_1) i + (q_2 + p_2) j + (q_3 + p_3) k</span>
<span id="cb56-447"><a href="#cb56-447" aria-hidden="true" tabindex="-1"></a>    $$</span>
<span id="cb56-448"><a href="#cb56-448" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb56-449"><a href="#cb56-449" aria-hidden="true" tabindex="-1"></a><span class="ss">-   </span>Multiplication: The multiplication is not commutative $$</span>
<span id="cb56-450"><a href="#cb56-450" aria-hidden="true" tabindex="-1"></a>    q * p \ne p * q = \tt{Complicated Formula}</span>
<span id="cb56-451"><a href="#cb56-451" aria-hidden="true" tabindex="-1"></a>    $$</span>
<span id="cb56-452"><a href="#cb56-452" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb56-453"><a href="#cb56-453" aria-hidden="true" tabindex="-1"></a><span class="ss">-   </span>Conjugate (just i --<span class="sc">\&gt;</span> -i same for j and k) $$</span>
<span id="cb56-454"><a href="#cb56-454" aria-hidden="true" tabindex="-1"></a>    q^* = q_w â i q_x â j q_y â k q_z</span>
<span id="cb56-455"><a href="#cb56-455" aria-hidden="true" tabindex="-1"></a>    $$</span>
<span id="cb56-456"><a href="#cb56-456" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb56-457"><a href="#cb56-457" aria-hidden="true" tabindex="-1"></a><span class="ss">-   </span>Inverse (in gernal) $$</span>
<span id="cb56-458"><a href="#cb56-458" aria-hidden="true" tabindex="-1"></a>    q^{-1} = q^*/||q||</span>
<span id="cb56-459"><a href="#cb56-459" aria-hidden="true" tabindex="-1"></a>    $$</span>
<span id="cb56-460"><a href="#cb56-460" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb56-461"><a href="#cb56-461" aria-hidden="true" tabindex="-1"></a><span class="ss">-   </span>Inverse (in for rotation quaternions)</span>
<span id="cb56-462"><a href="#cb56-462" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb56-463"><a href="#cb56-463" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb56-464"><a href="#cb56-464" aria-hidden="true" tabindex="-1"></a>q^{-1}=q^*</span>
<span id="cb56-465"><a href="#cb56-465" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb56-466"><a href="#cb56-466" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb56-467"><a href="#cb56-467" aria-hidden="true" tabindex="-1"></a>So for unit quaternions, you just have to conjugate to get the inverse. Luckily, we don't have to remember the formulaes and can use the onion-package.</span>
<span id="cb56-468"><a href="#cb56-468" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb56-469"><a href="#cb56-469" aria-hidden="true" tabindex="-1"></a><span class="fu">### Constructing a rotation matrix from Quaterions (first solution)</span></span>
<span id="cb56-470"><a href="#cb56-470" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb56-471"><a href="#cb56-471" aria-hidden="true" tabindex="-1"></a>It's possible to translate the quaternions back to a rotation matrix, see <span class="co">[</span><span class="ot">quat_to_mat</span><span class="co">](https://github.com/oduerr/gesture/blob/main/R/rotation_utils.R)</span>. The code has been taken <span class="co">[</span><span class="ot">from</span><span class="co">](https://automaticaddison.com/how-to-convert-a-quaternion-to-a-rotation-matrix/)</span> We can construct our yaw matrix via</span>
<span id="cb56-472"><a href="#cb56-472" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb56-475"><a href="#cb56-475" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb56-476"><a href="#cb56-476" aria-hidden="true" tabindex="-1"></a>  q01 <span class="ot">=</span> <span class="fu">c</span>(<span class="fu">cos</span>(yaw<span class="sc">/</span><span class="dv">2</span>), <span class="dv">0</span>, <span class="dv">0</span>, <span class="dv">1</span> <span class="sc">*</span> <span class="fu">sin</span>(yaw<span class="sc">/</span><span class="dv">2</span>))</span>
<span id="cb56-477"><a href="#cb56-477" aria-hidden="true" tabindex="-1"></a>  <span class="co">#sum(q01^2) #1</span></span>
<span id="cb56-478"><a href="#cb56-478" aria-hidden="true" tabindex="-1"></a>  <span class="fu">quat_to_mat</span>(q01)</span>
<span id="cb56-479"><a href="#cb56-479" aria-hidden="true" tabindex="-1"></a>  <span class="fu">Rz</span>(yaw)</span>
<span id="cb56-480"><a href="#cb56-480" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb56-481"><a href="#cb56-481" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb56-482"><a href="#cb56-482" aria-hidden="true" tabindex="-1"></a><span class="fu">### Chaining rotations with quaterions (just multiply them)</span></span>
<span id="cb56-483"><a href="#cb56-483" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb56-484"><a href="#cb56-484" aria-hidden="true" tabindex="-1"></a>Now comes properly the most useful thing, that successive rotations can be done by multiplying the respective quaternions. Let's try this out, and move the rabit. Note we are still considering body to lab rotations.</span>
<span id="cb56-485"><a href="#cb56-485" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb56-486"><a href="#cb56-486" aria-hidden="true" tabindex="-1"></a>Let's multiply several quaternions. We start with $q_0 = (1,0,0,0)$.</span>
<span id="cb56-487"><a href="#cb56-487" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb56-488"><a href="#cb56-488" aria-hidden="true" tabindex="-1"></a><span class="in">```{r, warning=FALSE, name='bunny1', fig.width=5, fig.height=5, fig.align='center', cache=TRUE}</span></span>
<span id="cb56-489"><a href="#cb56-489" aria-hidden="true" tabindex="-1"></a>  q0 <span class="ot">=</span> onion<span class="sc">::</span><span class="fu">quaternion</span>(<span class="at">Re =</span> <span class="dv">1</span>)</span>
<span id="cb56-490"><a href="#cb56-490" aria-hidden="true" tabindex="-1"></a>  <span class="fu">p3d</span>(rabbit <span class="sc">%*%</span> <span class="fu">quat_to_mat</span>(q0), <span class="at">h=</span><span class="cn">NULL</span>, <span class="at">main =</span> <span class="st">'q0'</span>)</span>
<span id="cb56-491"><a href="#cb56-491" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb56-492"><a href="#cb56-492" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb56-493"><a href="#cb56-493" aria-hidden="true" tabindex="-1"></a>We add a second rotation (a first real) around the z-axis.</span>
<span id="cb56-494"><a href="#cb56-494" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb56-495"><a href="#cb56-495" aria-hidden="true" tabindex="-1"></a><span class="in">```{r, warning=FALSE, name='bunny1', fig.width=5, fig.height=5, fig.align='center', cache=TRUE}</span></span>
<span id="cb56-496"><a href="#cb56-496" aria-hidden="true" tabindex="-1"></a>  q1 <span class="ot">=</span> <span class="fu">quaternion</span>(<span class="at">Re=</span><span class="fu">cos</span>(<span class="sc">-</span><span class="dv">45</span><span class="sc">/</span><span class="dv">360</span> <span class="sc">*</span>pi), <span class="at">i =</span> <span class="dv">0</span>, <span class="at">j =</span> <span class="dv">0</span>, <span class="at">k =</span> <span class="dv">1</span><span class="sc">*</span><span class="fu">sin</span>(<span class="sc">-</span><span class="dv">45</span><span class="sc">/</span><span class="dv">360</span> <span class="sc">*</span>pi)) </span>
<span id="cb56-497"><a href="#cb56-497" aria-hidden="true" tabindex="-1"></a>  <span class="fu">p3d</span>(rabbit <span class="sc">%*%</span> <span class="fu">quat_to_mat</span>(q0 <span class="sc">*</span> q1), <span class="at">h=</span><span class="cn">NULL</span>, <span class="at">main =</span> <span class="st">'q0 * q1'</span>) </span>
<span id="cb56-498"><a href="#cb56-498" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb56-499"><a href="#cb56-499" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb56-500"><a href="#cb56-500" aria-hidden="true" tabindex="-1"></a>We add a third rotation around the x-axis.</span>
<span id="cb56-501"><a href="#cb56-501" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb56-502"><a href="#cb56-502" aria-hidden="true" tabindex="-1"></a><span class="in">```{r, bunny3, warning=FALSE, fig.width=5, fig.height=5, fig.align='center', cache=TRUE}</span></span>
<span id="cb56-503"><a href="#cb56-503" aria-hidden="true" tabindex="-1"></a>  q2 <span class="ot">=</span> <span class="fu">quaternion</span>(<span class="at">Re=</span><span class="fu">cos</span>(<span class="sc">-</span><span class="dv">45</span><span class="sc">/</span><span class="dv">360</span> <span class="sc">*</span>pi), <span class="at">i =</span> <span class="dv">1</span><span class="sc">*</span><span class="fu">sin</span>(<span class="sc">-</span><span class="dv">45</span><span class="sc">/</span><span class="dv">360</span> <span class="sc">*</span>pi), <span class="at">j =</span> <span class="dv">0</span>, <span class="at">k =</span> <span class="dv">0</span>) </span>
<span id="cb56-504"><a href="#cb56-504" aria-hidden="true" tabindex="-1"></a>  q012 <span class="ot">=</span> q0 <span class="sc">*</span> q1 <span class="sc">*</span> q2 </span>
<span id="cb56-505"><a href="#cb56-505" aria-hidden="true" tabindex="-1"></a>  <span class="fu">p3d</span>(rabbit <span class="sc">%*%</span> <span class="fu">quat_to_mat</span>(q012), <span class="at">h=</span><span class="cn">NULL</span>, <span class="at">main =</span> <span class="st">'q0 * q1 * q2'</span>)</span>
<span id="cb56-506"><a href="#cb56-506" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb56-507"><a href="#cb56-507" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb56-508"><a href="#cb56-508" aria-hidden="true" tabindex="-1"></a>Using the order $q_0 q_1 q_2$ you transfer the data of the bunny into the lab frame.</span>
<span id="cb56-509"><a href="#cb56-509" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb56-510"><a href="#cb56-510" aria-hidden="true" tabindex="-1"></a>::: callout-important</span>
<span id="cb56-511"><a href="#cb56-511" aria-hidden="true" tabindex="-1"></a>Quaternions for body--to-lab (frame) rotations multiply from left to right.</span>
<span id="cb56-512"><a href="#cb56-512" aria-hidden="true" tabindex="-1"></a>:::</span>
<span id="cb56-513"><a href="#cb56-513" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb56-514"><a href="#cb56-514" aria-hidden="true" tabindex="-1"></a><span class="fu">### Pure Quaternions (real part = 0)</span></span>
<span id="cb56-515"><a href="#cb56-515" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb56-516"><a href="#cb56-516" aria-hidden="true" tabindex="-1"></a>We can also use quaternions to transform vectors, without the need to explicitly construct the rotation matrix as done with the bunny data above. This is done with so-called **unit** or **vector quaternions**. To obtain a vector quaternions, we set the real part to 0 and use the vector in space as the vector part. That is a vector $\vec{v}$ in a certain direction without coding a rotation. From this vector, we like to know the position to which it gets rotated by $R(q) \vec{v}$ the rotation matrix $R(q)$ corresponding to $q$. It can be shown that this is</span>
<span id="cb56-517"><a href="#cb56-517" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb56-518"><a href="#cb56-518" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb56-519"><a href="#cb56-519" aria-hidden="true" tabindex="-1"></a>  (0, R(q) \vec{v}) = q \cdot (0,\vec{v}) \cdot q^{*} </span>
<span id="cb56-520"><a href="#cb56-520" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb56-521"><a href="#cb56-521" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb56-524"><a href="#cb56-524" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb56-525"><a href="#cb56-525" aria-hidden="true" tabindex="-1"></a> q <span class="ot">=</span> q0 <span class="sc">*</span> q1 <span class="sc">*</span> q2 <span class="co">#A unit quaterion defining the direction</span></span>
<span id="cb56-526"><a href="#cb56-526" aria-hidden="true" tabindex="-1"></a> vec <span class="ot">=</span> <span class="fu">matrix</span>(<span class="fu">c</span>(<span class="dv">12</span>,<span class="dv">13</span>,<span class="dv">45</span>), <span class="at">ncol=</span><span class="dv">1</span>) <span class="co">#A vector with which we do the </span></span>
<span id="cb56-527"><a href="#cb56-527" aria-hidden="true" tabindex="-1"></a> <span class="fu">quat_to_mat</span>(q) <span class="sc">%*%</span> vec</span>
<span id="cb56-528"><a href="#cb56-528" aria-hidden="true" tabindex="-1"></a> </span>
<span id="cb56-529"><a href="#cb56-529" aria-hidden="true" tabindex="-1"></a> vec_q <span class="ot">=</span> <span class="fu">quaternion</span>(<span class="at">Re =</span> <span class="dv">0</span>, <span class="at">i =</span> vec[<span class="dv">1</span>], <span class="at">j=</span>vec[<span class="dv">2</span>], <span class="at">k=</span>vec[<span class="dv">3</span>])</span>
<span id="cb56-530"><a href="#cb56-530" aria-hidden="true" tabindex="-1"></a> <span class="co">#q^-1 is the inverse, which for rotation quaternions is the conjugate </span></span>
<span id="cb56-531"><a href="#cb56-531" aria-hidden="true" tabindex="-1"></a> q <span class="sc">*</span> vec_q <span class="sc">*</span> q<span class="sc">^-</span><span class="dv">1</span></span>
<span id="cb56-532"><a href="#cb56-532" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb56-533"><a href="#cb56-533" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb56-534"><a href="#cb56-534" aria-hidden="true" tabindex="-1"></a>**TODO** build intuition for this expression, this looks like bra-ket</span>
<span id="cb56-535"><a href="#cb56-535" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb56-536"><a href="#cb56-536" aria-hidden="true" tabindex="-1"></a><span class="fu">#### Using pure quaterions to get the rotation matrix.</span></span>
<span id="cb56-537"><a href="#cb56-537" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb56-538"><a href="#cb56-538" aria-hidden="true" tabindex="-1"></a>We can use pure quaterions to get the rotation matrix. To make the problem harder, we use a more complicated quaternion:</span>
<span id="cb56-539"><a href="#cb56-539" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb56-542"><a href="#cb56-542" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb56-543"><a href="#cb56-543" aria-hidden="true" tabindex="-1"></a>q <span class="ot">=</span> <span class="fu">c</span>(<span class="fl">0.320</span>,  <span class="fl">0.300</span>,  <span class="fl">0.290</span>, <span class="sc">-</span><span class="fl">0.850</span>) </span>
<span id="cb56-544"><a href="#cb56-544" aria-hidden="true" tabindex="-1"></a>q <span class="ot">=</span> q <span class="sc">/</span> <span class="fu">sqrt</span>(<span class="fu">sum</span>(q<span class="sc">^</span><span class="dv">2</span>))</span>
<span id="cb56-545"><a href="#cb56-545" aria-hidden="true" tabindex="-1"></a>q <span class="ot">=</span> <span class="fu">quaternion</span>(<span class="at">Re=</span>q[<span class="dv">1</span>], <span class="at">i=</span>q[<span class="dv">2</span>], <span class="at">j=</span>q[<span class="dv">3</span>], <span class="at">k=</span>q[<span class="dv">4</span>])</span>
<span id="cb56-546"><a href="#cb56-546" aria-hidden="true" tabindex="-1"></a><span class="fu">t</span>(q<span class="sc">@</span>x)</span>
<span id="cb56-547"><a href="#cb56-547" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb56-548"><a href="#cb56-548" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb56-549"><a href="#cb56-549" aria-hidden="true" tabindex="-1"></a>We use the fact that the transformation is given by the results of the unit vectors of the "from coordinate" system:</span>
<span id="cb56-550"><a href="#cb56-550" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb56-553"><a href="#cb56-553" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb56-554"><a href="#cb56-554" aria-hidden="true" tabindex="-1"></a> <span class="fu">round</span>(<span class="fu">quat_to_mat</span>(q), <span class="dv">4</span>)</span>
<span id="cb56-555"><a href="#cb56-555" aria-hidden="true" tabindex="-1"></a> </span>
<span id="cb56-556"><a href="#cb56-556" aria-hidden="true" tabindex="-1"></a> e1b <span class="ot">=</span> q <span class="sc">*</span> <span class="fu">quaternion</span>(<span class="at">Re =</span> <span class="dv">0</span>, <span class="at">i =</span> <span class="dv">1</span>) <span class="sc">*</span> q<span class="sc">^-</span><span class="dv">1</span> </span>
<span id="cb56-557"><a href="#cb56-557" aria-hidden="true" tabindex="-1"></a> e2b <span class="ot">=</span> q <span class="sc">*</span> <span class="fu">quaternion</span>(<span class="at">Re =</span> <span class="dv">0</span>, <span class="at">j =</span> <span class="dv">1</span>) <span class="sc">*</span> q<span class="sc">^-</span><span class="dv">1</span> </span>
<span id="cb56-558"><a href="#cb56-558" aria-hidden="true" tabindex="-1"></a> e3b <span class="ot">=</span> q <span class="sc">*</span> <span class="fu">quaternion</span>(<span class="at">Re =</span> <span class="dv">0</span>, <span class="at">k =</span> <span class="dv">1</span>) <span class="sc">*</span> q<span class="sc">^-</span><span class="dv">1</span> </span>
<span id="cb56-559"><a href="#cb56-559" aria-hidden="true" tabindex="-1"></a> <span class="fu">matrix</span>(<span class="fu">c</span>(</span>
<span id="cb56-560"><a href="#cb56-560" aria-hidden="true" tabindex="-1"></a>          e1b<span class="sc">@</span>x[<span class="dv">2</span><span class="sc">:</span><span class="dv">4</span>],</span>
<span id="cb56-561"><a href="#cb56-561" aria-hidden="true" tabindex="-1"></a>          e2b<span class="sc">@</span>x[<span class="dv">2</span><span class="sc">:</span><span class="dv">4</span>],</span>
<span id="cb56-562"><a href="#cb56-562" aria-hidden="true" tabindex="-1"></a>          e3b<span class="sc">@</span>x[<span class="dv">2</span><span class="sc">:</span><span class="dv">4</span>])</span>
<span id="cb56-563"><a href="#cb56-563" aria-hidden="true" tabindex="-1"></a> ,<span class="at">nrow=</span><span class="dv">3</span>) <span class="sc">%&gt;%</span> <span class="fu">round</span>(<span class="dv">4</span>)</span>
<span id="cb56-564"><a href="#cb56-564" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb56-565"><a href="#cb56-565" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb56-566"><a href="#cb56-566" aria-hidden="true" tabindex="-1"></a><span class="fu">### Flight Coordinates from Quaterions</span></span>
<span id="cb56-567"><a href="#cb56-567" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb56-568"><a href="#cb56-568" aria-hidden="true" tabindex="-1"></a>In the definition above has defined as</span>
<span id="cb56-569"><a href="#cb56-569" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb56-570"><a href="#cb56-570" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb56-571"><a href="#cb56-571" aria-hidden="true" tabindex="-1"></a>  R_{\text{Lab} \leftarrow \text{Body}} =  R_{roll} \, R_{pitch}\, R_{yaw} </span>
<span id="cb56-572"><a href="#cb56-572" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb56-573"><a href="#cb56-573" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb56-574"><a href="#cb56-574" aria-hidden="true" tabindex="-1"></a>TODO there is something wrong with rotation matrix</span>
<span id="cb56-575"><a href="#cb56-575" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb56-576"><a href="#cb56-576" aria-hidden="true" tabindex="-1"></a><span class="in">```{r, comparison_rot_mat}</span></span>
<span id="cb56-577"><a href="#cb56-577" aria-hidden="true" tabindex="-1"></a>  qyaw <span class="ot">=</span> <span class="fu">quaternion</span>(<span class="at">Re=</span><span class="fu">cos</span>(yaw<span class="sc">/</span><span class="dv">2</span>), <span class="at">i=</span><span class="dv">0</span>,<span class="at">j=</span><span class="dv">0</span>,<span class="at">k=</span><span class="fu">sin</span>(yaw<span class="sc">/</span><span class="dv">2</span>))</span>
<span id="cb56-578"><a href="#cb56-578" aria-hidden="true" tabindex="-1"></a>  qpitch <span class="ot">=</span> <span class="fu">quaternion</span>(<span class="at">Re=</span><span class="fu">cos</span>(pitch<span class="sc">/</span><span class="dv">2</span>), <span class="at">i=</span><span class="dv">0</span>,<span class="at">j=</span><span class="fu">sin</span>(pitch<span class="sc">/</span><span class="dv">2</span>),<span class="at">k=</span><span class="dv">0</span>)</span>
<span id="cb56-579"><a href="#cb56-579" aria-hidden="true" tabindex="-1"></a>  qroll <span class="ot">=</span> <span class="fu">quaternion</span>(<span class="at">Re=</span><span class="fu">cos</span>(roll<span class="sc">/</span><span class="dv">2</span>), <span class="at">i=</span><span class="fu">sin</span>(roll<span class="sc">/</span><span class="dv">2</span>), <span class="at">j=</span><span class="dv">0</span>,<span class="at">k=</span><span class="dv">0</span>)</span>
<span id="cb56-580"><a href="#cb56-580" aria-hidden="true" tabindex="-1"></a>  R <span class="ot">=</span> R.roll <span class="sc">%*%</span> R.pitch <span class="sc">%*%</span> R.yaw</span>
<span id="cb56-581"><a href="#cb56-581" aria-hidden="true" tabindex="-1"></a>  <span class="co">#R = R.pitch %*% R.yaw</span></span>
<span id="cb56-582"><a href="#cb56-582" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (<span class="cn">FALSE</span>) { <span class="co">#For debugging</span></span>
<span id="cb56-583"><a href="#cb56-583" aria-hidden="true" tabindex="-1"></a>    <span class="fu">sum</span>(qyaw<span class="sc">@</span>x<span class="sc">^</span><span class="dv">2</span>) <span class="co">#1</span></span>
<span id="cb56-584"><a href="#cb56-584" aria-hidden="true" tabindex="-1"></a>    <span class="fu">sum</span>(qpitch<span class="sc">@</span>x<span class="sc">^</span><span class="dv">2</span>) <span class="co">#1</span></span>
<span id="cb56-585"><a href="#cb56-585" aria-hidden="true" tabindex="-1"></a>    <span class="fu">sum</span>(qroll<span class="sc">@</span>x<span class="sc">^</span><span class="dv">2</span>) <span class="co">#1</span></span>
<span id="cb56-586"><a href="#cb56-586" aria-hidden="true" tabindex="-1"></a>    <span class="fu">sum</span>((<span class="fu">quat_to_mat</span>(qyaw) <span class="sc">-</span> R.yaw)<span class="sc">^</span><span class="dv">2</span>) <span class="co">#2.46519e-32</span></span>
<span id="cb56-587"><a href="#cb56-587" aria-hidden="true" tabindex="-1"></a>    <span class="fu">sum</span>((<span class="fu">quat_to_mat</span>(qpitch) <span class="sc">-</span> R.pitch)<span class="sc">^</span><span class="dv">2</span>) <span class="co">#2.46519e-32</span></span>
<span id="cb56-588"><a href="#cb56-588" aria-hidden="true" tabindex="-1"></a>    <span class="fu">sum</span>((<span class="fu">quat_to_mat</span>(qroll) <span class="sc">-</span> R.roll)<span class="sc">^</span><span class="dv">2</span>) <span class="co">#4.930381e-32</span></span>
<span id="cb56-589"><a href="#cb56-589" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb56-590"><a href="#cb56-590" aria-hidden="true" tabindex="-1"></a>  qcomb_body_to_lab <span class="ot">=</span> (qyaw <span class="sc">*</span> qpitch) <span class="sc">*</span> qroll</span>
<span id="cb56-591"><a href="#cb56-591" aria-hidden="true" tabindex="-1"></a>  qcomb_lab_to_body <span class="ot">=</span> qcomb_body_to_lab<span class="sc">^-</span><span class="dv">1</span></span>
<span id="cb56-592"><a href="#cb56-592" aria-hidden="true" tabindex="-1"></a>  <span class="fu">max</span>(<span class="fu">abs</span>(R <span class="sc">-</span> <span class="fu">quat_to_mat</span>(qcomb_body_to_lab))) <span class="co">#1.4</span></span>
<span id="cb56-593"><a href="#cb56-593" aria-hidden="true" tabindex="-1"></a>  <span class="fu">max</span>(<span class="fu">abs</span>(R <span class="sc">-</span> <span class="fu">quat_to_mat</span>(qcomb_lab_to_body))) <span class="co">#0</span></span>
<span id="cb56-594"><a href="#cb56-594" aria-hidden="true" tabindex="-1"></a>  <span class="co">#---&gt; Quat_to_</span></span>
<span id="cb56-595"><a href="#cb56-595" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb56-596"><a href="#cb56-596" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb56-597"><a href="#cb56-597" aria-hidden="true" tabindex="-1"></a>Testing the package</span>
<span id="cb56-598"><a href="#cb56-598" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb56-599"><a href="#cb56-599" aria-hidden="true" tabindex="-1"></a>The following translates a quaternion into ypr</span>
<span id="cb56-600"><a href="#cb56-600" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb56-601"><a href="#cb56-601" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb56-602"><a href="#cb56-602" aria-hidden="true" tabindex="-1"></a>roll = atan2(2 \cdot (w \cdot x + y \cdot z), 1 - 2 \cdot (x \cdot x + y \cdot y))<span class="sc">\\</span></span>
<span id="cb56-603"><a href="#cb56-603" aria-hidden="true" tabindex="-1"></a>pitch = asin(2 \cdot (w \cdot y - x \cdot z))<span class="sc">\\</span></span>
<span id="cb56-604"><a href="#cb56-604" aria-hidden="true" tabindex="-1"></a>yaw = atan2(2 \cdot (w \cdot z + x \cdot y), 1 - 2 \cdot (z \cdot z + y \cdot y))</span>
<span id="cb56-605"><a href="#cb56-605" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb56-606"><a href="#cb56-606" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb56-607"><a href="#cb56-607" aria-hidden="true" tabindex="-1"></a><span class="in">```{r, test_package}</span></span>
<span id="cb56-608"><a href="#cb56-608" aria-hidden="true" tabindex="-1"></a>quart_to_ypr <span class="ot">=</span> <span class="cf">function</span>(q_body2lab){</span>
<span id="cb56-609"><a href="#cb56-609" aria-hidden="true" tabindex="-1"></a>    q <span class="ot">=</span> q_body2lab</span>
<span id="cb56-610"><a href="#cb56-610" aria-hidden="true" tabindex="-1"></a>    w <span class="ot">=</span> q[<span class="dv">1</span>]</span>
<span id="cb56-611"><a href="#cb56-611" aria-hidden="true" tabindex="-1"></a>    x <span class="ot">=</span> q[<span class="dv">2</span>]</span>
<span id="cb56-612"><a href="#cb56-612" aria-hidden="true" tabindex="-1"></a>    y <span class="ot">=</span> q[<span class="dv">3</span>]</span>
<span id="cb56-613"><a href="#cb56-613" aria-hidden="true" tabindex="-1"></a>    z <span class="ot">=</span> q[<span class="dv">4</span>]</span>
<span id="cb56-614"><a href="#cb56-614" aria-hidden="true" tabindex="-1"></a>    roll <span class="ot">=</span> <span class="fu">atan2</span>(<span class="dv">2</span> <span class="sc">*</span> (w <span class="sc">*</span> x <span class="sc">+</span> y <span class="sc">*</span> z), <span class="dv">1</span> <span class="sc">-</span> <span class="dv">2</span> <span class="sc">*</span> (x <span class="sc">*</span> x <span class="sc">+</span> y <span class="sc">*</span> y))</span>
<span id="cb56-615"><a href="#cb56-615" aria-hidden="true" tabindex="-1"></a>    pitch <span class="ot">=</span> <span class="fu">asin</span>(<span class="dv">2</span> <span class="sc">*</span> (w <span class="sc">*</span> y <span class="sc">-</span> x <span class="sc">*</span> z))</span>
<span id="cb56-616"><a href="#cb56-616" aria-hidden="true" tabindex="-1"></a>    yaw <span class="ot">=</span> <span class="fu">atan2</span>(<span class="dv">2</span> <span class="sc">*</span> (w <span class="sc">*</span> z <span class="sc">+</span> x <span class="sc">*</span> y), <span class="dv">1</span> <span class="sc">-</span> <span class="dv">2</span> <span class="sc">*</span> (z <span class="sc">*</span> z <span class="sc">+</span> y <span class="sc">*</span> y))</span>
<span id="cb56-617"><a href="#cb56-617" aria-hidden="true" tabindex="-1"></a>    <span class="fu">return</span>(<span class="fu">c</span>(yaw,pitch,roll))</span>
<span id="cb56-618"><a href="#cb56-618" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb56-619"><a href="#cb56-619" aria-hidden="true" tabindex="-1"></a><span class="fu">quart_to_ypr</span>(qcomb_lab_to_body<span class="sc">@</span>x) <span class="co">#Wrong </span></span>
<span id="cb56-620"><a href="#cb56-620" aria-hidden="true" tabindex="-1"></a><span class="fu">quart_to_ypr</span>(qcomb_body_to_lab<span class="sc">@</span>x) <span class="co">#Correct</span></span>
<span id="cb56-621"><a href="#cb56-621" aria-hidden="true" tabindex="-1"></a><span class="fu">c</span>(yaw, pitch, roll)</span>
<span id="cb56-622"><a href="#cb56-622" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb56-623"><a href="#cb56-623" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb56-624"><a href="#cb56-624" aria-hidden="true" tabindex="-1"></a><span class="fu">### Rotation between two quaternions.</span></span>
<span id="cb56-625"><a href="#cb56-625" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb56-626"><a href="#cb56-626" aria-hidden="true" tabindex="-1"></a>Consider the two IMUs (like the one on the thumb and the one on the palm), the orientation of the first (w.r.t. the laboratory system) is given by $q_1$ the orientation of the second by $q_2$. What is the rotation getting you from hand to palm. The questions is: which rotation $q_{12}$ translates between them. So we ask which $q_12$ fulfills</span>
<span id="cb56-627"><a href="#cb56-627" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb56-628"><a href="#cb56-628" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb56-629"><a href="#cb56-629" aria-hidden="true" tabindex="-1"></a>  q_2 = q_1 \; q_{12} </span>
<span id="cb56-630"><a href="#cb56-630" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb56-631"><a href="#cb56-631" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb56-632"><a href="#cb56-632" aria-hidden="true" tabindex="-1"></a>Just calculate the inverse of $q_1$ and you are done</span>
<span id="cb56-633"><a href="#cb56-633" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb56-634"><a href="#cb56-634" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb56-635"><a href="#cb56-635" aria-hidden="true" tabindex="-1"></a>  q_1^{-1} \; q_2 = q_{12}  </span>
<span id="cb56-636"><a href="#cb56-636" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb56-637"><a href="#cb56-637" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb56-638"><a href="#cb56-638" aria-hidden="true" tabindex="-1"></a><span class="fu">## Software package</span></span>
<span id="cb56-639"><a href="#cb56-639" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb56-640"><a href="#cb56-640" aria-hidden="true" tabindex="-1"></a>There are several software packages helping to deal with rotations and quaterions. Like the onion package in R.</span>
<span id="cb56-641"><a href="#cb56-641" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb56-642"><a href="#cb56-642" aria-hidden="true" tabindex="-1"></a><span class="fu">### The AHRS Python Package</span></span>
<span id="cb56-643"><a href="#cb56-643" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb56-644"><a href="#cb56-644" aria-hidden="true" tabindex="-1"></a>The AHRS package (https://ahrs.readthedocs.io/en/latest/index.html) used to estimate the rotation of a IMUs (sensors in e.g. cell phones and drones), uses quaternion as lot and also provides some basic operations.</span>
<span id="cb56-645"><a href="#cb56-645" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb56-646"><a href="#cb56-646" aria-hidden="true" tabindex="-1"></a><span class="in">```{python, echo=TRUE, eval=FALSE}</span></span>
<span id="cb56-647"><a href="#cb56-647" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> ahrs <span class="im">import</span> Quaternion</span>
<span id="cb56-648"><a href="#cb56-648" aria-hidden="true" tabindex="-1"></a>p <span class="op">=</span> Quaternion([<span class="fl">0.7071</span>, <span class="fl">0.0</span>, <span class="fl">0.7071</span>, <span class="fl">0.0</span>])</span>
<span id="cb56-649"><a href="#cb56-649" aria-hidden="true" tabindex="-1"></a>p </span>
<span id="cb56-650"><a href="#cb56-650" aria-hidden="true" tabindex="-1"></a>q <span class="op">=</span> Quaternion([<span class="dv">0</span>, <span class="fl">0.7071</span>, <span class="fl">0.0</span>, <span class="fl">0.7071</span>])</span>
<span id="cb56-651"><a href="#cb56-651" aria-hidden="true" tabindex="-1"></a>p <span class="op">*</span> q <span class="co">#0., 1., 0., 0.</span></span>
<span id="cb56-652"><a href="#cb56-652" aria-hidden="true" tabindex="-1"></a>q <span class="op">*</span> p <span class="co">#0., 0., 0., 1.</span></span>
<span id="cb56-653"><a href="#cb56-653" aria-hidden="true" tabindex="-1"></a>q.conj<span class="co">#0., -0.70710678, -0., -0.70710678</span></span>
<span id="cb56-654"><a href="#cb56-654" aria-hidden="true" tabindex="-1"></a>d <span class="op">=</span> q<span class="op">*</span>q.conj </span>
<span id="cb56-655"><a href="#cb56-655" aria-hidden="true" tabindex="-1"></a>d</span>
<span id="cb56-656"><a href="#cb56-656" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
</code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div></div></div></div></div>
</div> <!-- /content -->



</body></html>