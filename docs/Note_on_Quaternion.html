<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.0.36">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">

<meta name="author" content="Oliver Dürr">

<title>Notes on Rotations and Quaternions</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
span.underline{text-decoration: underline;}
div.column{display: inline-block; vertical-align: top; width: 50%;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
    color: #aaaaaa;
  }
pre.numberSource { margin-left: 3em; border-left: 1px solid #aaaaaa;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
code span.al { color: #ff0000; font-weight: bold; } /* Alert */
code span.an { color: #60a0b0; font-weight: bold; font-style: italic; } /* Annotation */
code span.at { color: #7d9029; } /* Attribute */
code span.bn { color: #40a070; } /* BaseN */
code span.bu { } /* BuiltIn */
code span.cf { color: #007020; font-weight: bold; } /* ControlFlow */
code span.ch { color: #4070a0; } /* Char */
code span.cn { color: #880000; } /* Constant */
code span.co { color: #60a0b0; font-style: italic; } /* Comment */
code span.cv { color: #60a0b0; font-weight: bold; font-style: italic; } /* CommentVar */
code span.do { color: #ba2121; font-style: italic; } /* Documentation */
code span.dt { color: #902000; } /* DataType */
code span.dv { color: #40a070; } /* DecVal */
code span.er { color: #ff0000; font-weight: bold; } /* Error */
code span.ex { } /* Extension */
code span.fl { color: #40a070; } /* Float */
code span.fu { color: #06287e; } /* Function */
code span.im { } /* Import */
code span.in { color: #60a0b0; font-weight: bold; font-style: italic; } /* Information */
code span.kw { color: #007020; font-weight: bold; } /* Keyword */
code span.op { color: #666666; } /* Operator */
code span.ot { color: #007020; } /* Other */
code span.pp { color: #bc7a00; } /* Preprocessor */
code span.sc { color: #4070a0; } /* SpecialChar */
code span.ss { color: #bb6688; } /* SpecialString */
code span.st { color: #4070a0; } /* String */
code span.va { color: #19177c; } /* Variable */
code span.vs { color: #4070a0; } /* VerbatimString */
code span.wa { color: #60a0b0; font-weight: bold; font-style: italic; } /* Warning */
div.csl-bib-body { }
div.csl-entry {
  clear: both;
}
.hanging div.csl-entry {
  margin-left:2em;
  text-indent:-2em;
}
div.csl-left-margin {
  min-width:2em;
  float:left;
}
div.csl-right-inline {
  margin-left:2em;
  padding-left:1em;
}
div.csl-indent {
  margin-left: 2em;
}
</style>


<script src="Note_on_Quaternion_files/libs/clipboard/clipboard.min.js"></script>
<script src="Note_on_Quaternion_files/libs/quarto-html/quarto.js"></script>
<script src="Note_on_Quaternion_files/libs/quarto-html/popper.min.js"></script>
<script src="Note_on_Quaternion_files/libs/quarto-html/tippy.umd.min.js"></script>
<script src="Note_on_Quaternion_files/libs/quarto-html/anchor.min.js"></script>
<link href="Note_on_Quaternion_files/libs/quarto-html/tippy.css" rel="stylesheet">
<link href="Note_on_Quaternion_files/libs/quarto-html/quarto-syntax-highlighting.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="Note_on_Quaternion_files/libs/bootstrap/bootstrap.min.js"></script>
<link href="Note_on_Quaternion_files/libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="Note_on_Quaternion_files/libs/bootstrap/bootstrap.min.css" rel="stylesheet" id="quarto-bootstrap" data-mode="light">

  <script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-chtml-full.js" type="text/javascript"></script>

</head>

<body>

<div id="quarto-content" class="page-columns page-rows-contents page-layout-article">
<div id="quarto-margin-sidebar" class="sidebar margin-sidebar">
  <nav id="TOC" role="doc-toc">
    <h2 id="toc-title">Table of contents</h2>
   
  <ul>
  <li><a href="#a-short-note-on-rotations" id="toc-a-short-note-on-rotations" class="nav-link active" data-scroll-target="#a-short-note-on-rotations"> <span class="header-section-number">1</span> A short note on rotations</a>
  <ul class="collapse">
  <li><a href="#a-first-rotation" id="toc-a-first-rotation" class="nav-link" data-scroll-target="#a-first-rotation"> <span class="header-section-number">1.1</span> A first rotation</a></li>
  <li><a href="#introduction" id="toc-introduction" class="nav-link" data-scroll-target="#introduction"> <span class="header-section-number">1.2</span> Introduction</a></li>
  <li><a href="#parameterization" id="toc-parameterization" class="nav-link" data-scroll-target="#parameterization"> <span class="header-section-number">1.3</span> Parameterization</a>
  <ul class="collapse">
  <li><a href="#definition-of-rotations" id="toc-definition-of-rotations" class="nav-link" data-scroll-target="#definition-of-rotations"> <span class="header-section-number">1.3.1</span> Definition of rotations</a></li>
  <li><a href="#rotation-matrix" id="toc-rotation-matrix" class="nav-link" data-scroll-target="#rotation-matrix"> <span class="header-section-number">1.3.2</span> Rotation matrix</a></li>
  <li><a href="#parameterization-using-elementary-rotation." id="toc-parameterization-using-elementary-rotation." class="nav-link" data-scroll-target="#parameterization-using-elementary-rotation."> <span class="header-section-number">1.3.3</span> Parameterization using elementary rotation.</a></li>
  </ul></li>
  </ul></li>
  <li><a href="#quaternions" id="toc-quaternions" class="nav-link" data-scroll-target="#quaternions"> <span class="header-section-number">2</span> Quaternions</a>
  <ul class="collapse">
  <li><a href="#definition-of-quaternions" id="toc-definition-of-quaternions" class="nav-link" data-scroll-target="#definition-of-quaternions"> <span class="header-section-number">2.0.1</span> Definition of Quaternions</a></li>
  <li><a href="#geometric-representation" id="toc-geometric-representation" class="nav-link" data-scroll-target="#geometric-representation"> <span class="header-section-number">2.0.2</span> Geometric Representation</a></li>
  <li><a href="#quaterion-algebra" id="toc-quaterion-algebra" class="nav-link" data-scroll-target="#quaterion-algebra"> <span class="header-section-number">2.0.3</span> Quaterion Algebra</a></li>
  <li><a href="#constructing-a-rotation-matrix-from-quaterions-first-solution" id="toc-constructing-a-rotation-matrix-from-quaterions-first-solution" class="nav-link" data-scroll-target="#constructing-a-rotation-matrix-from-quaterions-first-solution"> <span class="header-section-number">2.0.4</span> Constructing a rotation matrix from Quaterions (first solution)</a></li>
  <li><a href="#chaining-rotations-with-quaterions-just-multiply-them" id="toc-chaining-rotations-with-quaterions-just-multiply-them" class="nav-link" data-scroll-target="#chaining-rotations-with-quaterions-just-multiply-them"> <span class="header-section-number">2.0.5</span> Chaining rotations with quaterions (just multiply them)</a></li>
  <li><a href="#pure-quaternions-real-part-0" id="toc-pure-quaternions-real-part-0" class="nav-link" data-scroll-target="#pure-quaternions-real-part-0"> <span class="header-section-number">2.0.6</span> Pure Quaternions (real part = 0)</a></li>
  <li><a href="#flight-coordinates-from-quaterions" id="toc-flight-coordinates-from-quaterions" class="nav-link" data-scroll-target="#flight-coordinates-from-quaterions"> <span class="header-section-number">2.0.7</span> Flight Coordinates from Quaterions</a></li>
  <li><a href="#rotation-between-two-quaternions." id="toc-rotation-between-two-quaternions." class="nav-link" data-scroll-target="#rotation-between-two-quaternions."> <span class="header-section-number">2.0.8</span> Rotation between two quaternions.</a></li>
  <li><a href="#software-package" id="toc-software-package" class="nav-link" data-scroll-target="#software-package"> <span class="header-section-number">2.1</span> Software package</a>
  <ul class="collapse">
  <li><a href="#the-ahrs-python-package" id="toc-the-ahrs-python-package" class="nav-link" data-scroll-target="#the-ahrs-python-package"> <span class="header-section-number">2.1.1</span> The AHRS Python Package</a></li>
  </ul></li>
  </ul></li>
  </ul>
</nav>
</div>
<main class="content" id="quarto-document-content">

<header id="title-block-header" class="quarto-title-block default">
<div class="quarto-title">
<div class="quarto-title-block"><div><h1 class="title">Notes on Rotations and Quaternions</h1><button type="button" class="btn code-tools-button dropdown-toggle" id="quarto-code-tools-menu" data-bs-toggle="dropdown" aria-expanded="false"><i class="bi"></i> Code</button><ul class="dropdown-menu dropdown-menu-end" aria-labelelledby="quarto-code-tools-menu"><li><a id="quarto-show-all-code" class="dropdown-item" href="javascript:void(0)" role="button">Show All Code</a></li><li><a id="quarto-hide-all-code" class="dropdown-item" href="javascript:void(0)" role="button">Hide All Code</a></li><li><hr class="dropdown-divider"></li><li><a id="quarto-view-source" class="dropdown-item" href="javascript:void(0)" role="button">View Source</a></li></ul></div></div>
</div>



<div class="quarto-title-meta">

    <div>
    <div class="quarto-title-meta-heading">Author</div>
    <div class="quarto-title-meta-contents">
             <p>Oliver Dürr </p>
          </div>
  </div>
    
    
  </div>
  

</header>

<p>This is a primer on rotations and quaternions, as needed to describe rotations.</p>
<p><strong>This is Work in Progress still need corrections.</strong></p>
<section id="a-short-note-on-rotations" class="level1" data-number="1">
<h1 data-number="1"><span class="header-section-number">1</span> A short note on rotations</h1>
<p>In the figure, you can see a sketch of the situation for gesture recognition. We are interested in “the relative positions” between the palm and thumb on the one side and the laboratory system. As we will see this can be described in the framework of rotations.</p>
<div id="fig-hand" class="quarto-figure quarto-figure-center anchored">
<figure class="figure">
<p><img src="images/hand.jpg" class="img-fluid figure-img" width="1000"></p>
<p></p><figcaption class="figure-caption">Figure 1: Simplyfied gesture recognition with 2 IMUs (thumb, palm). Show are a fixed coordinate system in space (toothpicks on table), a body centered coordinate system on the thumb and one on the plam.</figcaption><p></p>
</figure>
</div>
<section id="a-first-rotation" class="level2" data-number="1.1">
<h2 data-number="1.1" class="anchored" data-anchor-id="a-first-rotation"><span class="header-section-number">1.1</span> A first rotation</h2>
<p>Before we go into some math, lets have a first look how a rotation might look like. On the left side you see data points in the original space. On the right side a rotation by 45 degrees around the z-axis that have been applied to the points. This rotation can be obtained by a rotation matrix R:</p>
<div class="cell">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb1"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a>R <span class="ot">=</span> <span class="fu">matrix</span>(<span class="fu">c</span>(<span class="fl">0.7071068</span>,  <span class="fl">0.7071068</span>,  <span class="fl">0.0000000</span>, <span class="sc">-</span><span class="fl">0.7071068</span>,  <span class="fl">0.7071068</span>,  <span class="fl">0.0000000</span>,  <span class="fl">0.0000000</span>,  <span class="fl">0.0000000</span>,  <span class="fl">1.0000000</span>), <span class="at">nrow=</span><span class="dv">3</span>)</span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true" tabindex="-1"></a><span class="fu">round</span>(R,<span class="dv">4</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>       [,1]    [,2] [,3]
[1,] 0.7071 -0.7071    0
[2,] 0.7071  0.7071    0
[3,] 0.0000  0.0000    1</code></pre>
</div>
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb3"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb3-1"><a href="#cb3-1" aria-hidden="true" tabindex="-1"></a><span class="fu">par</span>(<span class="at">mfrow=</span><span class="fu">c</span>(<span class="dv">1</span>,<span class="dv">2</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<p>As we will see in a second an example a point <span class="math inline">\(x\)</span> of the rabid cloud is transformed via:</p>
<p><span class="math display">\[
  x_\text{rot} = R \, x
\]</span></p>
<div class="cell" data-layout-align="center" data-hash="Note_on_Quaternion_cache/html/rot-bunny-plot_726dc3a3331617c266b0e64cbfd2d469">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb4"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb4-1"><a href="#cb4-1" aria-hidden="true" tabindex="-1"></a><span class="fu">p3d</span>(rabbit, <span class="at">h=</span><span class="cn">NULL</span>, <span class="at">xlab=</span><span class="st">'x'</span>, <span class="at">ylab=</span><span class="st">'y'</span>, <span class="at">zlab=</span><span class="st">'z'</span>, )</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="Note_on_Quaternion_files/figure-html/rot-bunny-plot-1.png" class="img-fluid figure-img" width="960"></p>
<p></p><figcaption class="figure-caption">Left: orinial data. Right: data rotated by 45 degrees around y-axis (or coordinate system rotated by -45) degrees. The y-axis points up and the rotation is done in counter clock-wise manner</figcaption><p></p>
</figure>
</div>
</div>
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb5"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb5-1"><a href="#cb5-1" aria-hidden="true" tabindex="-1"></a><span class="co">#It's vector times Matrix for row-vectors</span></span>
<span id="cb5-2"><a href="#cb5-2" aria-hidden="true" tabindex="-1"></a><span class="co">#Therefore we have to transpose (R x) to x^T R^T</span></span>
<span id="cb5-3"><a href="#cb5-3" aria-hidden="true" tabindex="-1"></a><span class="fu">p3d</span>(rabbit <span class="sc">%*%</span> <span class="fu">t</span>(R), <span class="at">h=</span><span class="cn">NULL</span>) </span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="Note_on_Quaternion_files/figure-html/rot-bunny-plot-2.png" class="img-fluid figure-img" width="960"></p>
<p></p><figcaption class="figure-caption">Left: orinial data. Right: data rotated by 45 degrees around y-axis (or coordinate system rotated by -45) degrees. The y-axis points up and the rotation is done in counter clock-wise manner</figcaption><p></p>
</figure>
</div>
</div>
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb6"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb6-1"><a href="#cb6-1" aria-hidden="true" tabindex="-1"></a><span class="fu">par</span>(<span class="at">mfrow=</span><span class="fu">c</span>(<span class="dv">1</span>,<span class="dv">1</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
</section>
<section id="introduction" class="level2" data-number="1.2">
<h2 data-number="1.2" class="anchored" data-anchor-id="introduction"><span class="header-section-number">1.2</span> Introduction</h2>
<p>Rotations between rigid objects can be described as a linear transformation from one coordinate system to another, with the same origin. A first example is the bunny from above. Anexample of such a rotation is the orientation of your cell phone after you picked it up compared to the position on the table, or the orientation of the thumb in figure compared to the coordinate system of the palm. A very illustrative example is an airplane which is at <span class="math inline">\(t=0\)</span> on the ground and is at <span class="math inline">\(t=t\)</span> in the air. Besides the translation, the orientation of the plane at <span class="math inline">\(t=0\)</span> relative to the plane at <span class="math inline">\(t=t\)</span> can be described by a different heading (the <em>yaw</em> angle) obtained while taxing, the <em>pitch</em> angle obtained in the climbing phase and a rotation around the axis of flight the <em>roll</em> angle. During this phase many rotations can happen but they can all be summarized in a single rotation.</p>
<p>More formally the rotations between the two planes can be described by a rotation matrix <span class="math inline">\(R\)</span> , which transforms the coordinate system of the plane at <span class="math inline">\(t=0\)</span> to the coordinate system of the plane at <span class="math inline">\(t=t\)</span>. This matrix is defined by the transformation of unit vectors <span class="math inline">\(\vec{e_x},\vec{e_y},\vec{e_z}\)</span> of coordinate system (say that at <span class="math inline">\(t=0\)</span>) to a coordinate system <span class="math inline">\(\vec{e'_x},\vec{e'_y},\vec{e'_z}\)</span> at <span class="math inline">\(t=t\)</span>. As my famous professor in linear algebra always repeated the columns of a (transformation) matrix are the images of the unit vectors<a href="#fn1" class="footnote-ref" id="fnref1" role="doc-noteref"><sup>1</sup></a>. So the first column of <span class="math inline">\(R\)</span> is given by <span class="math inline">\(R \cdot \vec{e_x}\)</span> second by <span class="math inline">\(R \cdot \vec{e_y}\)</span>, and the third by <span class="math inline">\(R \cdot \vec{e_z}\)</span>.</p>
<p>Important to note is that there are to directions the rotation (airplane in the fixed coordinate system like the tower, or tower in the coordinate system of the airplane) can go. Since the solution are so similar, this sometimes causes confusion.</p>
</section>
<section id="parameterization" class="level2" data-number="1.3">
<h2 data-number="1.3" class="anchored" data-anchor-id="parameterization"><span class="header-section-number">1.3</span> Parameterization</h2>
<section id="definition-of-rotations" class="level3" data-number="1.3.1">
<h3 data-number="1.3.1" class="anchored" data-anchor-id="definition-of-rotations"><span class="header-section-number">1.3.1</span> Definition of rotations</h3>
<p>Rotations can be seen as linear transformation from one coordinate system into another. But there are several way to parametrize them. The first is via a rotation matrix.</p>
</section>
<section id="rotation-matrix" class="level3" data-number="1.3.2">
<h3 data-number="1.3.2" class="anchored" data-anchor-id="rotation-matrix"><span class="header-section-number">1.3.2</span> Rotation matrix</h3>
<p>In principal a rotation is given by the 9 matrix elements of <span class="math inline">\(R\)</span>. However they cannot be arbitrary, they still need to describe rotations. What are the defining properties of rotations? It turns out that a rotation, has an inverse and the inverse simply the transposed <span class="math inline">\(R^{-1} = R^T\)</span> (this is the orthogonality). Further, <span class="math inline">\(det(R)=1\)</span> this is a consequence that the volume in the rotated system stays constant and also the orientation (it’s <span class="math inline">\(det(R)=1\)</span> and not just <span class="math inline">\(|det(d)|=1\)</span>). So in matrix notation a rotation is defined by</p>
<p><span id="eq-rot"><span class="math display">\[
R=\begin{bmatrix}r_{11} &amp; r_{12} &amp; r_{13} \\r_{21} &amp; r_{22} &amp; r_{23} \\r_{31} &amp; r_{32} &amp; r_{33} \end{bmatrix}, \quad R^TR=RR^T=1,\quad det(R)=1  
\tag{1}\]</span></span></p>
<p>Multiplying two rotation matrices <span class="math inline">\(R_1\)</span> and <span class="math inline">\(R_2\)</span> is a again a rotation matrix, this is why rotations in 3D are also called special orthogonal group <code>SO(3)</code>. Note that the order of rotations matter and <span class="math inline">\(R_1 R_2 \ne R_2 R_1\)</span></p>
<p>So it’s obvious that is over parameterized using 9 values and there are constrains on the <span class="math inline">\(r_{ij}\)</span> so that eq. 1 is fulfilled.</p>
<section id="rotation-matrices-from-to-pitfall" class="level4" data-number="1.3.2.1">
<h4 data-number="1.3.2.1" class="anchored" data-anchor-id="rotation-matrices-from-to-pitfall"><span class="header-section-number">1.3.2.1</span> Rotation-Matrices (“From To” pitfall)</h4>
<p>When we condescend ourselves to the depth of matrix multiplication, the first of two pitfalls lingers around. This is due to the fact that matrix multiplication introduces an order. Say, we want to transform a vector <span class="math inline">\(\vec{f}\)</span> from a “from coordinate system” into a vector <span class="math inline">\(\vec{t}\)</span> given in coordinates of the “to coordinate system”. We can do this via:</p>
<p><span class="math display">\[
\vec{t}=R \,\vec{f}
\]</span></p>
<p>To go the other way around, use <span class="math inline">\(\vec{f}=R^{-1} \vec{t}\)</span>. The problem occurs with intermediate steps, for example when decomposing the rotation into several intermediate steps <span class="math inline">\(R=R_2 R_1\)</span> then</p>
<p>TODO</p>
<p>It is handy to make the distinction, between <em>rotations</em> and <em>transformations</em> and think of one coordinate system as the <em>world coordinate system</em> or lab system.A transformation is defined as an operation, which leaves the points (in the world coordinate system) as they are and just moves the coordinate system. A rotation on the other hand, moves the points in the world coordinate system, see e.g.<span class="citation" data-cites="grossekatthofer2012introduction">(<a href="#ref-grossekatthofer2012introduction" role="doc-biblioref">Großekatthöfer and Yoon 2012</a>)</span>. However, you might wonder why we break the symmetry and consider one coordinate system as fixed. Here is an explanation (taken from <a href="https://math.stackexchange.com/a/2243057">stackexchange</a>)</p>
<p>The product <span class="math inline">\(AB\)</span> of matrices is the effect of applying <span class="math inline">\(A\)</span> after applying <span class="math inline">\(B\)</span>, simply because we write the “effect” of a matrix <span class="math inline">\(A\)</span> on a vector <span class="math inline">\(v\)</span> as <span class="math inline">\(Av\)</span> (i.e., the convention is to work with column vectors). Thus <span class="math inline">\((AB)v = A(Bv)\)</span> is <span class="math inline">\(A\)</span> applied to <span class="math inline">\(Bv\)</span>. Note that this convention matches the usual notation for (nested) functions: <span class="math inline">\(\log(\sin(x))\)</span> is the logarithm function applied to the result from applying the sine function to <span class="math inline">\(x\)</span>.</p>
<p>Of course, the rules for computing the product of matrices are just right for this convention. Or, if one wanted <span class="math inline">\(AB\)</span> to stand for “first apply <span class="math inline">\(A\)</span>, then apply <span class="math inline">\(B\)</span>”, one would use row vectors instead and write “A applied to <span class="math inline">\(v\)</span>” as <span class="math inline">\(vA\)</span> - which is very uncommon (and in effect just means that one works with the transposed matrices, relative to the usual convention).</p>
<p><strong>Only transformations can be chained by the usual matrix multiplication.</strong> I don’t know how often I did this wrong.</p>
</section>
</section>
<section id="parameterization-using-elementary-rotation." class="level3" data-number="1.3.3">
<h3 data-number="1.3.3" class="anchored" data-anchor-id="parameterization-using-elementary-rotation."><span class="header-section-number">1.3.3</span> Parameterization using elementary rotation.</h3>
<p>Many repeated rotations are again a rotation (closure). Moreover it can be shown that an arbitrary rotation can be build out of three elementary rotations. Here the mess begins, there are many ways to define such as decomposition. For example one possibility is: First, a counter-clockwise rotation <span class="math inline">\(R_z(\alpha)\)</span> around the <span class="math inline">\(z\)</span>-axis by an angle of <span class="math inline">\(\alpha\)</span>. Second, <span class="math inline">\(R_x(\beta)\)</span> rotates around “the new” <span class="math inline">\(x\)</span>-axis and finally by <span class="math inline">\(R_z(\gamma)\)</span> around the new <span class="math inline">\(z\)</span>-axis. So the complete transformation is given by <span class="math inline">\(R(\alpha, \beta, \gamma) = R_z(\gamma) R_y(\beta) R_x(\alpha)\)</span>.</p>
<div id="fig-rot-ball" class="quarto-figure quarto-figure-center anchored">
<figure class="figure">
<p><a href="https://en.wikipedia.org/wiki/Euler_angles"><img src="images/Euler2a.gif" class="img-fluid figure-img"></a></p>
<p></p><figcaption class="figure-caption">Figure 2: Animation showing the sequence $R_z(\gamma) R_y(\beta) R_x(\alpha)$ of elementary rotation. Taken from wikepedia</figcaption><p></p>
</figure>
</div>
<p>The individual transformations can be derived by looking where the unit vectors are transformed. In the figure below you see a derivation of the rotation matrix, we have an original system denoted by <span class="math inline">\(x,y,z\)</span> and a system rotatated about <span class="math inline">\(\vartheta\)</span> around the z-axis. We ask “how does the original system look like in the rotated one.”.</p>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="images/rz_gamma.png" class="img-fluid figure-img" width="700"></p>
<p></p><figcaption class="figure-caption">Derivation of the Transformation matrix transforming from a fixed coordinate system to a rotated one.</figcaption><p></p>
</figure>
</div>
<p>This transformation matrix transforms from the laboratory L system to the “body centric system” B. To make this clearer sometimes, expressions like <span class="math inline">\(R_{B \leftarrow L}\)</span> are written <span class="citation" data-cites="grossekatthofer2012introduction">(<a href="#ref-grossekatthofer2012introduction" role="doc-biblioref">Großekatthöfer and Yoon 2012</a>)</span>. For transforming points from the rotated system back to the initial system, we ask for the inverse transformation <span class="math inline">\(R_{L \leftarrow B}\)</span> :“How does the transformed points look in the original system”. Luckily<a href="#fn2" class="footnote-ref" id="fnref2" role="doc-noteref"><sup>2</sup></a> the inverse is the transposed and this corresponds to setting <span class="math inline">\(\gamma\)</span> to <span class="math inline">\(-\gamma\)</span> since <span class="math inline">\(\sin\)</span> is asymmetric. So in this case we have for a rotation about say <span class="math inline">\(\alpha\)</span> around the z-Axis.</p>
<p><span id="eq-yaw"><span class="math display">\[
  R_{L \leftarrow B}^z(\alpha) = R_{B \leftarrow L}^z(-\alpha)=\begin{bmatrix}\cos(\alpha) &amp; -\sin(\alpha) &amp; 0 \\\sin(\alpha) &amp;\cos(\alpha) &amp; 0 \\0 &amp; 0 &amp; 1 \end{bmatrix}
\tag{2}\]</span></span></p>
<p>When we rotated the rabbit, we rotated the data and not the coordinate system. So we have to use a rotation as <span class="math inline">\(R^z_{B\leftarrow L}(-\alpha)\)</span> and with <span class="math inline">\(\sin(45^0) = \cos(45^0) \approx 0.7071\)</span>, we get:</p>
<div class="cell">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb7"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb7-1"><a href="#cb7-1" aria-hidden="true" tabindex="-1"></a>Ra <span class="ot">=</span> <span class="cf">function</span>(a){</span>
<span id="cb7-2"><a href="#cb7-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">return</span>(</span>
<span id="cb7-3"><a href="#cb7-3" aria-hidden="true" tabindex="-1"></a>    <span class="fu">matrix</span>(</span>
<span id="cb7-4"><a href="#cb7-4" aria-hidden="true" tabindex="-1"></a>        <span class="fu">c</span>(<span class="fu">cos</span>(a), <span class="fu">sin</span>(a), <span class="dv">0</span>, <span class="sc">-</span><span class="fu">sin</span>(a), <span class="fu">cos</span>(a), <span class="dv">0</span>, <span class="dv">0</span>, <span class="dv">0</span>, <span class="dv">1</span>)</span>
<span id="cb7-5"><a href="#cb7-5" aria-hidden="true" tabindex="-1"></a>        , <span class="at">nrow=</span><span class="dv">3</span>, <span class="at">byrow =</span> <span class="cn">TRUE</span>) </span>
<span id="cb7-6"><a href="#cb7-6" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb7-7"><a href="#cb7-7" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb7-8"><a href="#cb7-8" aria-hidden="true" tabindex="-1"></a><span class="fu">Ra</span>(<span class="sc">-</span><span class="dv">45</span><span class="sc">*</span><span class="dv">2</span><span class="sc">*</span>pi<span class="sc">/</span><span class="dv">360</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>          [,1]       [,2] [,3]
[1,] 0.7071068 -0.7071068    0
[2,] 0.7071068  0.7071068    0
[3,] 0.0000000  0.0000000    1</code></pre>
</div>
</div>
<p>which is same rotation as used in the code used to transform the data.</p>
<section id="ambiguities" class="level4" data-number="1.3.3.1">
<h4 data-number="1.3.3.1" class="anchored" data-anchor-id="ambiguities"><span class="header-section-number">1.3.3.1</span> Ambiguities</h4>
<p>The problem with the approach of elementary rotations is, that there are many (12) possible combinations to chain the elementary operations<a href="#fn3" class="footnote-ref" id="fnref3" role="doc-noteref"><sup>3</sup></a>. For example often used is the sequence <span class="math inline">\(R_{L \leftarrow B}=R^z(\gamma) R^y(\beta) R^z(\alpha)\)</span> i.e.&nbsp;using <span class="math inline">\(R^z\)</span> twice. This sequence is shown in the animation <a href="#fig-rot-ball">Figure&nbsp;2</a></p>
</section>
<section id="a-worked-out-example-yaw-pitch-roll" class="level4" data-number="1.3.3.2">
<h4 data-number="1.3.3.2" class="anchored" data-anchor-id="a-worked-out-example-yaw-pitch-roll"><span class="header-section-number">1.3.3.2</span> A worked out example (Yaw-Pitch-Roll)</h4>
<p>Using an airplane, we know what happens (taxiing, take-off, rolling) and we can derive a nice chain of elementary rotations, which will serve as reference for later. First of all, we have to define the direction. We want a transformation that starts with coordinates in the lab frame, and transforms that into coordinate in the airplane frame.</p>
<p><span class="math display">\[
\vec{x}_{B} = R_{B \leftarrow L} \cdot \vec{x}_L
\]</span> Going from the lab to the body, first does a yaw, followed by a pitch and then by a roll. Hence:</p>
<p><span class="math display">\[
\vec{x}_{B} = R^{\text{roll}}_{L \leftarrow B''} R^{\text{pitch}}_{B'' \leftarrow B'} R^{\text{yaw}}_{B' \leftarrow L}\cdot \vec{x}_L
\]</span></p>
<p>In the example, we use the following angles</p>
<div class="cell">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb9"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb9-1"><a href="#cb9-1" aria-hidden="true" tabindex="-1"></a>yaw <span class="ot">=</span> <span class="dv">60</span> <span class="sc">*</span> <span class="dv">2</span> <span class="sc">*</span> pi <span class="sc">/</span> <span class="dv">360</span>    <span class="co">#This is w.r.t. the tower / labframe</span></span>
<span id="cb9-2"><a href="#cb9-2" aria-hidden="true" tabindex="-1"></a>pitch <span class="ot">=</span> <span class="sc">-</span><span class="dv">50</span> <span class="sc">*</span> <span class="dv">2</span> <span class="sc">*</span> pi <span class="sc">/</span> <span class="dv">360</span>  <span class="co">#Angle of climb</span></span>
<span id="cb9-3"><a href="#cb9-3" aria-hidden="true" tabindex="-1"></a>roll <span class="ot">=</span> <span class="dv">40</span> <span class="sc">*</span> <span class="dv">2</span> <span class="sc">*</span> pi <span class="sc">/</span> <span class="dv">360</span>   <span class="co">#Angle of roll</span></span>
<span id="cb9-4"><a href="#cb9-4" aria-hidden="true" tabindex="-1"></a><span class="fu">print</span>(<span class="fu">paste</span>(<span class="st">'yaw '</span>, yaw, <span class="st">' pitch '</span>, pitch, <span class="st">' roll '</span>,roll))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>[1] "yaw  1.0471975511966  pitch  -0.872664625997165  roll  0.698131700797732"</code></pre>
</div>
</div>
<p>The pitch needs to be negative in order that a the rotation leads to a descent.</p>
<section id="taxiing-yaw-alpha" class="level5" data-number="1.3.3.2.1">
<h5 data-number="1.3.3.2.1" class="anchored" data-anchor-id="taxiing-yaw-alpha"><span class="header-section-number">1.3.3.2.1</span> Taxiing yaw <span class="math inline">\(\alpha\)</span></h5>
<p>The plane first rotates about the z-axis by an angle of <span class="math inline">\(\alpha\)</span>. In the lab-system it moves away in counter clock-wise manner. So we have:</p>
<p><span class="math display">\[
\begin{bmatrix}x_L\\y_L \\ z_L \end{bmatrix}
=
\begin{bmatrix}\cos(\alpha) &amp; -\sin(\alpha) &amp; 0 \\\sin(\alpha) &amp;\cos(\alpha) &amp; 0 \\0 &amp; 0 &amp; 1 \end{bmatrix}
\cdot
\begin{bmatrix}x_B\\y_B \\ z_B \end{bmatrix}
\]</span></p>
<p>The rotation matrix, we are looking at is the inverse of the above and hence</p>
<p><span class="math display">\[
\begin{bmatrix}x_B\\y_B \\ z_B \end{bmatrix}
=
\underbrace{
\begin{bmatrix}\cos(\alpha) &amp; \sin(\alpha) &amp; 0 \\-\sin(\alpha) &amp;\cos(\alpha) &amp; 0 \\0 &amp; 0 &amp; 1 \end{bmatrix}}_
{R_{B \leftarrow L}}
\cdot
\begin{bmatrix}x_L\\y_L \\ z_L \end{bmatrix}
\]</span></p>
<p>This described by the transformation matrix <span class="math inline">\(R_z(\alpha)\)</span> in <a href="#eq-yaw">Equation&nbsp;2</a>. We use a rotation of yaw for all points <span class="math inline">\(x\)</span> in the plane the following transformation is done:</p>
<div class="cell">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb11"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb11-1"><a href="#cb11-1" aria-hidden="true" tabindex="-1"></a>R.yaw <span class="ot">=</span> <span class="fu">Ra</span>(yaw) </span>
<span id="cb11-2"><a href="#cb11-2" aria-hidden="true" tabindex="-1"></a>R.yaw</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>           [,1]      [,2] [,3]
[1,]  0.5000000 0.8660254    0
[2,] -0.8660254 0.5000000    0
[3,]  0.0000000 0.0000000    1</code></pre>
</div>
</div>
<div class="cell">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb13"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb13-1"><a href="#cb13-1" aria-hidden="true" tabindex="-1"></a><span class="fu">set.seed</span>(<span class="dv">42</span>)</span>
<span id="cb13-2"><a href="#cb13-2" aria-hidden="true" tabindex="-1"></a>n <span class="ot">=</span> <span class="dv">1100</span></span>
<span id="cb13-3"><a href="#cb13-3" aria-hidden="true" tabindex="-1"></a>x <span class="ot">=</span> <span class="fu">runif</span>(n,<span class="sc">-</span><span class="dv">1</span>,<span class="dv">1</span>)</span>
<span id="cb13-4"><a href="#cb13-4" aria-hidden="true" tabindex="-1"></a>y <span class="ot">=</span> <span class="fu">runif</span>(n, <span class="sc">-</span><span class="fl">0.4</span>,<span class="fl">0.4</span>)</span>
<span id="cb13-5"><a href="#cb13-5" aria-hidden="true" tabindex="-1"></a>z <span class="ot">=</span> <span class="fu">runif</span>(n,<span class="sc">-</span><span class="fl">0.1</span>,<span class="fl">0.1</span>)</span>
<span id="cb13-6"><a href="#cb13-6" aria-hidden="true" tabindex="-1"></a>col <span class="ot">=</span> <span class="fu">rep</span>(<span class="st">'blue'</span>,n)</span>
<span id="cb13-7"><a href="#cb13-7" aria-hidden="true" tabindex="-1"></a>col[x<span class="sc">&gt;</span><span class="fl">0.5</span>] <span class="ot">=</span> <span class="st">'red'</span></span>
<span id="cb13-8"><a href="#cb13-8" aria-hidden="true" tabindex="-1"></a>col[x<span class="sc">&lt;=</span> <span class="sc">-</span><span class="fl">0.5</span>] <span class="ot">=</span> <span class="st">'green'</span></span>
<span id="cb13-9"><a href="#cb13-9" aria-hidden="true" tabindex="-1"></a>col[y<span class="sc">&lt;=</span> <span class="sc">-</span><span class="fl">0.2</span>] <span class="ot">=</span> <span class="st">'gray30'</span></span>
<span id="cb13-10"><a href="#cb13-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-11"><a href="#cb13-11" aria-hidden="true" tabindex="-1"></a>plane <span class="ot">=</span> <span class="fu">as.matrix</span>(<span class="fu">data.frame</span>(<span class="at">x=</span>x,<span class="at">y=</span>y,<span class="at">z=</span>z))</span>
<span id="cb13-12"><a href="#cb13-12" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(rgl)</span>
<span id="cb13-13"><a href="#cb13-13" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(scatterplot3d) <span class="co"># load</span></span>
<span id="cb13-14"><a href="#cb13-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-15"><a href="#cb13-15" aria-hidden="true" tabindex="-1"></a>make_plot <span class="ot">=</span> <span class="cf">function</span>(p1, p2, <span class="at">l1=</span><span class="fu">c</span>(<span class="st">'x'</span>,<span class="st">'y'</span>,<span class="st">'z'</span>), <span class="at">l2=</span><span class="fu">c</span>(<span class="st">'x'</span>,<span class="st">'y'</span>,<span class="st">'z'</span>), <span class="at">angle =</span> <span class="dv">55</span>) {</span>
<span id="cb13-16"><a href="#cb13-16" aria-hidden="true" tabindex="-1"></a>  <span class="fu">par</span>(<span class="at">mfrow=</span><span class="fu">c</span>(<span class="dv">1</span>,<span class="dv">2</span>))</span>
<span id="cb13-17"><a href="#cb13-17" aria-hidden="true" tabindex="-1"></a>  <span class="co">#First plot</span></span>
<span id="cb13-18"><a href="#cb13-18" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scatterplot3d</span>(p1[,<span class="dv">1</span>],p1[,<span class="dv">2</span>],p1[,<span class="dv">3</span>], </span>
<span id="cb13-19"><a href="#cb13-19" aria-hidden="true" tabindex="-1"></a>                <span class="at">xlim=</span><span class="fu">c</span>(<span class="sc">-</span><span class="dv">1</span>,<span class="dv">1</span>), <span class="at">ylim=</span><span class="fu">c</span>(<span class="sc">-</span><span class="dv">1</span>,<span class="dv">1</span>), <span class="at">zlim=</span><span class="fu">c</span>(<span class="sc">-</span><span class="dv">1</span>,<span class="dv">1</span>), </span>
<span id="cb13-20"><a href="#cb13-20" aria-hidden="true" tabindex="-1"></a>                <span class="at">color =</span> col,</span>
<span id="cb13-21"><a href="#cb13-21" aria-hidden="true" tabindex="-1"></a>                <span class="at">xlab=</span>l1[<span class="dv">1</span>], <span class="at">ylab=</span>l1[<span class="dv">2</span>], <span class="at">zlab =</span> l1[<span class="dv">3</span>],<span class="at">angle =</span> angle, <span class="at">pch=</span><span class="dv">16</span>)</span>
<span id="cb13-22"><a href="#cb13-22" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scatterplot3d</span>(p2[,<span class="dv">1</span>],p2[,<span class="dv">2</span>],p2[,<span class="dv">3</span>], </span>
<span id="cb13-23"><a href="#cb13-23" aria-hidden="true" tabindex="-1"></a>                <span class="at">xlim=</span><span class="fu">c</span>(<span class="sc">-</span><span class="dv">1</span>,<span class="dv">1</span>), <span class="at">ylim=</span><span class="fu">c</span>(<span class="sc">-</span><span class="dv">1</span>,<span class="dv">1</span>), <span class="at">zlim=</span><span class="fu">c</span>(<span class="sc">-</span><span class="dv">1</span>,<span class="dv">1</span>), </span>
<span id="cb13-24"><a href="#cb13-24" aria-hidden="true" tabindex="-1"></a>                <span class="at">color =</span> col,</span>
<span id="cb13-25"><a href="#cb13-25" aria-hidden="true" tabindex="-1"></a>                <span class="at">xlab=</span>l2[<span class="dv">1</span>], <span class="at">ylab=</span>l2[<span class="dv">2</span>], <span class="at">zlab =</span> l2[<span class="dv">3</span>],<span class="at">angle =</span> angle, <span class="at">pch=</span><span class="dv">16</span>)</span>
<span id="cb13-26"><a href="#cb13-26" aria-hidden="true" tabindex="-1"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<p>To visualize, we need the body coordinates, transformed to lab coordinates. Hence, we use the transpose of the rotation and apply it to the coordinates in the body system.</p>
<div class="cell">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb14"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb14-1"><a href="#cb14-1" aria-hidden="true" tabindex="-1"></a><span class="do">##Since we have column vector, we have to transpose once more yielding</span></span>
<span id="cb14-2"><a href="#cb14-2" aria-hidden="true" tabindex="-1"></a>plane.yaw  <span class="ot">=</span> plane <span class="sc">%*%</span> R.yaw <span class="co">#t(t(R.yaw))</span></span>
<span id="cb14-3"><a href="#cb14-3" aria-hidden="true" tabindex="-1"></a><span class="fu">make_plot</span>(plane, plane.yaw, <span class="at">l2=</span><span class="fu">c</span>(<span class="st">"x'"</span>,<span class="st">"y'"</span>,<span class="st">"z'"</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="Note_on_Quaternion_files/figure-html/yaw-plane-1.png" class="img-fluid figure-img" width="960"></p>
<p></p><figcaption class="figure-caption">Left: orinial data. Right: data rotated by yaw degrees around z-axis</figcaption><p></p>
</figure>
</div>
</div>
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb15"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb15-1"><a href="#cb15-1" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> (<span class="cn">FALSE</span>){<span class="co">#Debuggin</span></span>
<span id="cb15-2"><a href="#cb15-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">print</span>(<span class="st">'Maximal difference, in x-direction'</span>)</span>
<span id="cb15-3"><a href="#cb15-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">max</span>(<span class="fu">abs</span>(plane.yaw[,<span class="dv">3</span>] <span class="sc">-</span> plane[,<span class="dv">3</span>]))</span>
<span id="cb15-4"><a href="#cb15-4" aria-hidden="true" tabindex="-1"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
</section>
<section id="take-off-the-pitch-beta" class="level5" data-number="1.3.3.2.2">
<h5 data-number="1.3.3.2.2" class="anchored" data-anchor-id="take-off-the-pitch-beta"><span class="header-section-number">1.3.3.2.2</span> Take-off the pitch <span class="math inline">\(\beta\)</span></h5>
<p>When the plane takes off, all rotates rotated about <span class="math inline">\(\beta\)</span> about the y-axis. This <em>transformation</em> (lab to body) is given by</p>
<p><span class="math display">\[
  R^y(\beta) = \begin{bmatrix}\cos(\beta) &amp; 0 &amp; -\sin(\beta)\\
   0 &amp; 1 &amp; 0 \\
  \sin(\beta) &amp; 0 &amp; \cos(\beta)\end{bmatrix}
\]</span></p>
<p>Note that the rotation is about the y-axis (use the right hand the thumb is the axis and the fingers shows the direction). Acceding, corresponds to negative values (that’s the reason we choose negative value)</p>
<div class="cell">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb16"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb16-1"><a href="#cb16-1" aria-hidden="true" tabindex="-1"></a>Rb <span class="ot">=</span> <span class="cf">function</span>(b) <span class="fu">matrix</span>(</span>
<span id="cb16-2"><a href="#cb16-2" aria-hidden="true" tabindex="-1"></a>      <span class="fu">c</span>(<span class="fu">cos</span>(b), <span class="dv">0</span>, <span class="sc">-</span><span class="fu">sin</span>(b), <span class="dv">0</span>, <span class="dv">1</span>, <span class="dv">0</span>, <span class="fu">sin</span>(b), <span class="dv">0</span>, <span class="fu">cos</span>(b))</span>
<span id="cb16-3"><a href="#cb16-3" aria-hidden="true" tabindex="-1"></a>      , <span class="at">nrow=</span><span class="dv">3</span>, <span class="at">byrow =</span> <span class="cn">TRUE</span>) </span>
<span id="cb16-4"><a href="#cb16-4" aria-hidden="true" tabindex="-1"></a>R.pitch <span class="ot">=</span> <span class="fu">Rb</span>(pitch) </span>
<span id="cb16-5"><a href="#cb16-5" aria-hidden="true" tabindex="-1"></a>R.pitch</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>           [,1] [,2]      [,3]
[1,]  0.6427876    0 0.7660444
[2,]  0.0000000    1 0.0000000
[3,] -0.7660444    0 0.6427876</code></pre>
</div>
</div>
<section id="takeoff-without-taxiing" class="level6" data-number="1.3.3.2.2.1">
<h6 data-number="1.3.3.2.2.1" class="anchored" data-anchor-id="takeoff-without-taxiing"><span class="header-section-number">1.3.3.2.2.1</span> Takeoff without taxiing</h6>
<div class="cell">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb18"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb18-1"><a href="#cb18-1" aria-hidden="true" tabindex="-1"></a><span class="co">#We use -pitch to get the rotation into the lab frame</span></span>
<span id="cb18-2"><a href="#cb18-2" aria-hidden="true" tabindex="-1"></a><span class="fu">make_plot</span>(plane, plane <span class="sc">%*%</span> R.pitch) </span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="Note_on_Quaternion_files/figure-html/unnamed-chunk-10-1.png" class="img-fluid figure-img" width="960"></p>
<p></p><figcaption class="figure-caption">Left: orinial data. Right: data rotated by XXX degrees around y-axis</figcaption><p></p>
</figure>
</div>
</div>
</div>
</section>
<section id="takeoff-with-taxiing" class="level6" data-number="1.3.3.2.2.2">
<h6 data-number="1.3.3.2.2.2" class="anchored" data-anchor-id="takeoff-with-taxiing"><span class="header-section-number">1.3.3.2.2.2</span> Takeoff with taxiing</h6>
<p>Here, we combine the transformations. Note that this only works with transformations and <strong>rotating the points after the taxiing happened will note work</strong>. A secure way is to start with combined transformation is:</p>
<p><span class="math display">\[
x''=R^{2}_{B \leftarrow L}(\alpha, \beta)\,x=R^{y}(\beta)\,R^z(\alpha)x
\]</span></p>
<p>for visualization, we have to invert (transpose)</p>
<p><span class="math display">\[
x=(R^{y}(\beta)\,R^z(\alpha))^Tx''=(R^z(\alpha))^T\,(R^{y}(\beta))^Tx''=R^z(-\alpha)\,R^{y}(-\beta)x''
\]</span></p>
<div class="cell">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb19"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb19-1"><a href="#cb19-1" aria-hidden="true" tabindex="-1"></a>R <span class="ot">=</span> R.pitch <span class="sc">%*%</span> R.yaw</span>
<span id="cb19-2"><a href="#cb19-2" aria-hidden="true" tabindex="-1"></a>plane.pitch.yaw <span class="ot">=</span> plane <span class="sc">%*%</span> R</span>
<span id="cb19-3"><a href="#cb19-3" aria-hidden="true" tabindex="-1"></a><span class="fu">make_plot</span>(plane.yaw, plane.pitch.yaw,<span class="at">l1=</span><span class="fu">c</span>(<span class="st">"x'"</span>, <span class="st">"y'"</span>, <span class="st">"z''"</span>), <span class="at">l2=</span><span class="fu">c</span>(<span class="st">"x''"</span>, <span class="st">"y''"</span>, <span class="st">"z''"</span>)) </span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="Note_on_Quaternion_files/figure-html/unnamed-chunk-12-1.png" class="img-fluid figure-img" width="960"></p>
<p></p><figcaption class="figure-caption">Left: orinial data. Right: data rotated by XXX degrees around y-axis</figcaption><p></p>
</figure>
</div>
</div>
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb20"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb20-1"><a href="#cb20-1" aria-hidden="true" tabindex="-1"></a><span class="co">#plot3d(plane.pitch.yaw[,1],plane.pitch.yaw[,2],plane.pitch.yaw[,3], xlim=c(-1,1), ylim=c(-1,1), zlim=c(-1,1), col=col) </span></span>
<span id="cb20-2"><a href="#cb20-2" aria-hidden="true" tabindex="-1"></a><span class="co">#rglwidget()</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
</section>
</section>
<section id="in-the-air-the-roll-gamma" class="level5" data-number="1.3.3.2.3">
<h5 data-number="1.3.3.2.3" class="anchored" data-anchor-id="in-the-air-the-roll-gamma"><span class="header-section-number">1.3.3.2.3</span> In the air, the roll <span class="math inline">\(\gamma\)</span></h5>
<p>Now that we are in the air, we roll the plane about a certain degree around the x-axis. This can be done by</p>
<p><span class="math display">\[
R^x(\gamma) = \begin{bmatrix}
1 &amp; 0 &amp; 0\\
0 &amp; \cos(\gamma) &amp; \sin(\gamma) \\
0 &amp; -\sin(\gamma) &amp; \cos(\gamma) \end{bmatrix}
\]</span></p>
<div class="cell">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb21"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb21-1"><a href="#cb21-1" aria-hidden="true" tabindex="-1"></a>roll <span class="ot">=</span> <span class="dv">45</span> <span class="sc">*</span> <span class="dv">2</span> <span class="sc">*</span> pi <span class="sc">/</span> <span class="dv">360</span>   <span class="co">#Angle of roll</span></span>
<span id="cb21-2"><a href="#cb21-2" aria-hidden="true" tabindex="-1"></a>Rg <span class="ot">=</span> <span class="cf">function</span>(g) <span class="fu">matrix</span>(</span>
<span id="cb21-3"><a href="#cb21-3" aria-hidden="true" tabindex="-1"></a>      <span class="fu">c</span>(<span class="dv">1</span>,<span class="dv">0</span>,<span class="dv">0</span>, <span class="dv">0</span>, <span class="fu">cos</span>(g), <span class="fu">sin</span>(g), <span class="dv">0</span>, <span class="sc">-</span><span class="fu">sin</span>(g), <span class="fu">cos</span>(g))</span>
<span id="cb21-4"><a href="#cb21-4" aria-hidden="true" tabindex="-1"></a>      , <span class="at">nrow=</span><span class="dv">3</span>, <span class="at">byrow =</span> <span class="cn">TRUE</span>) </span>
<span id="cb21-5"><a href="#cb21-5" aria-hidden="true" tabindex="-1"></a>R.roll<span class="ot">=</span><span class="fu">Rg</span>(roll)</span>
<span id="cb21-6"><a href="#cb21-6" aria-hidden="true" tabindex="-1"></a>R.roll</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>     [,1]       [,2]      [,3]
[1,]    1  0.0000000 0.0000000
[2,]    0  0.7071068 0.7071068
[3,]    0 -0.7071068 0.7071068</code></pre>
</div>
</div>
<p><br>
The final transformation can be found via</p>
<p><span class="math display">\[
x'''=R^{3}_{B \leftarrow L}(\alpha, \beta, \gamma)\,x= R^{z}(\gamma) R^{y}(\beta)\,R^z(\alpha)x
\]</span></p>
<div class="cell">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb23"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb23-1"><a href="#cb23-1" aria-hidden="true" tabindex="-1"></a>R <span class="ot">=</span> R.roll <span class="sc">%*%</span> R.pitch <span class="sc">%*%</span> R.yaw</span>
<span id="cb23-2"><a href="#cb23-2" aria-hidden="true" tabindex="-1"></a>plane.roll.pitch.yaw <span class="ot">=</span> plane <span class="sc">%*%</span> R</span>
<span id="cb23-3"><a href="#cb23-3" aria-hidden="true" tabindex="-1"></a><span class="fu">make_plot</span>(plane.pitch.yaw, plane.roll.pitch.yaw,<span class="at">l1=</span><span class="fu">c</span>(<span class="st">"x''"</span>, <span class="st">"y''"</span>, <span class="st">"z''"</span>), <span class="at">l2=</span><span class="fu">c</span>(<span class="st">"x'''"</span>, <span class="st">"y'''"</span>, <span class="st">"z'''"</span>)) </span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="Note_on_Quaternion_files/figure-html/comp_trafo-1.png" class="img-fluid figure-img" width="960"></p>
<p></p><figcaption class="figure-caption">Left: orinial data. Right: data rotated by XXX degrees around y-axis</figcaption><p></p>
</figure>
</div>
</div>
</div>
<div class="cell">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb24"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb24-1"><a href="#cb24-1" aria-hidden="true" tabindex="-1"></a><span class="co">#if (FALSE){</span></span>
<span id="cb24-2"><a href="#cb24-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">library</span>(manipulate)</span>
<span id="cb24-3"><a href="#cb24-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">manipulate</span>(</span>
<span id="cb24-4"><a href="#cb24-4" aria-hidden="true" tabindex="-1"></a>    {</span>
<span id="cb24-5"><a href="#cb24-5" aria-hidden="true" tabindex="-1"></a>      Rroll <span class="ot">=</span> <span class="fu">Rg</span>(roll <span class="sc">*</span> <span class="dv">2</span><span class="sc">*</span>pi<span class="sc">/</span><span class="dv">360</span>)</span>
<span id="cb24-6"><a href="#cb24-6" aria-hidden="true" tabindex="-1"></a>      Ryaw  <span class="ot">=</span> <span class="fu">Ra</span>(yaw <span class="sc">*</span> <span class="dv">2</span><span class="sc">*</span>pi<span class="sc">/</span><span class="dv">360</span>)</span>
<span id="cb24-7"><a href="#cb24-7" aria-hidden="true" tabindex="-1"></a>      Rp <span class="ot">=</span> <span class="fu">Rb</span>(pitch<span class="sc">*</span> <span class="dv">2</span><span class="sc">*</span>pi<span class="sc">/</span><span class="dv">360</span>) </span>
<span id="cb24-8"><a href="#cb24-8" aria-hidden="true" tabindex="-1"></a>      Rani <span class="ot">=</span> Rroll <span class="sc">%*%</span> Rp <span class="sc">%*%</span> Ryaw</span>
<span id="cb24-9"><a href="#cb24-9" aria-hidden="true" tabindex="-1"></a>      plane.lab <span class="ot">=</span> plane <span class="sc">%*%</span> Rani</span>
<span id="cb24-10"><a href="#cb24-10" aria-hidden="true" tabindex="-1"></a>      <span class="fu">make_plot</span>(plane, plane.lab,<span class="at">l1=</span><span class="fu">c</span>(<span class="st">"x''"</span>, <span class="st">"y''"</span>, <span class="st">"z''"</span>), <span class="at">l2=</span><span class="fu">c</span>(<span class="st">"x'''"</span>, <span class="st">"y'''"</span>, <span class="st">"z'''"</span>))</span>
<span id="cb24-11"><a href="#cb24-11" aria-hidden="true" tabindex="-1"></a>    },</span>
<span id="cb24-12"><a href="#cb24-12" aria-hidden="true" tabindex="-1"></a>      <span class="at">yaw =</span> <span class="fu">slider</span>(<span class="dv">0</span>, <span class="dv">360</span>, <span class="at">initial =</span> <span class="dv">0</span>),</span>
<span id="cb24-13"><a href="#cb24-13" aria-hidden="true" tabindex="-1"></a>      <span class="at">pitch =</span> <span class="fu">slider</span>(<span class="sc">-</span><span class="dv">90</span>,<span class="dv">90</span>, <span class="at">initial =</span> <span class="dv">0</span>),</span>
<span id="cb24-14"><a href="#cb24-14" aria-hidden="true" tabindex="-1"></a>      <span class="at">roll =</span> <span class="fu">slider</span>(<span class="sc">-</span><span class="dv">180</span>, <span class="dv">180</span>, <span class="at">initial =</span> <span class="dv">0</span>)</span>
<span id="cb24-15"><a href="#cb24-15" aria-hidden="true" tabindex="-1"></a>  )</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
</section>
</section>
<section id="gimbal-look" class="level4" data-number="1.3.3.3">
<h4 data-number="1.3.3.3" class="anchored" data-anchor-id="gimbal-look"><span class="header-section-number">1.3.3.3</span> Gimbal Look</h4>
<p>Further, in this parameterization the effect of changing the angles by a bit has different effects depending on the values. In the extreme case changing the angle does nothing anymore, which is known under the name gimbals look (see e.g.&nbsp;<a href="https://towardsdatascience.com/better-rotation-representations-for-accurate-pose-estimation-e890a7e1317f">here</a> for a nice demonstration).</p>
</section>
</section>
</section>
</section>
<section id="quaternions" class="level1" data-number="2">
<h1 data-number="2"><span class="header-section-number">2</span> Quaternions</h1>
<p>Besides defining a rotation by 3 elementary rotations, with the many implied ambiguities and the gimbal lock there are other possibilities to describe rotations. Quaterions are such a possibility. They used as standard output format of many libraries such as <a href="https://ahrs.readthedocs.io/en/latest/index.html#">AHRS</a> and the IMU sensors. Quaternions are objects which consists of 4 numbers, and the rotation around a vector can be nicely described with them as we will see in a second. But they also have some mathematical raison d’etre.</p>
<section id="definition-of-quaternions" class="level3" data-number="2.0.1">
<h3 data-number="2.0.1" class="anchored" data-anchor-id="definition-of-quaternions"><span class="header-section-number">2.0.1</span> Definition of Quaternions</h3>
<p>Complex numbers <span class="math inline">\(|a|e^{i \theta}\)</span> describe points in the real / imaginary space. Rotations in 2D can be nicely described by them using multiplications. Quaternions can be seen as a generalization of complex numbers with two more imaginary like units <span class="math inline">\(i,j,k\)</span>. Using these, the quaternion can be written as:</p>
<p><span class="math display">\[
q =  (q_w, q_1, q_2, q_3) = q_w + q_1 i + q_2 j + q_3 k
\]</span></p>
<p>The basis have some properties (there are more)</p>
<p><span class="math display">\[
  i^2=j^2=k^2=ijk=-1 \;\; ij = -ji = k
\]</span></p>
<p>The length of a quaternion can be determined as:</p>
<p><span class="math display">\[
  ||q|| = \sqrt{q_w^2 + q_1^2 + q_2^2 + q_3^2 }
\]</span></p>
<p>Here, we are dealing with quaternions of length 1 and almost all quaternions used in Computergraphics are unit quaternions or a.k.a. <em>rotation quaternions</em>.</p>
</section>
<section id="geometric-representation" class="level3" data-number="2.0.2">
<h3 data-number="2.0.2" class="anchored" data-anchor-id="geometric-representation"><span class="header-section-number">2.0.2</span> Geometric Representation</h3>
<p>Rotations can be described by unit vector <span class="math inline">\(\vec{v}=(v_x,v_y,v_z)\)</span> and a counter clock wise rotation around this vector by an angle <span class="math inline">\(\theta\)</span>. This is shown in the following figure</p>
<div id="fig-rot" class="quarto-figure quarto-figure-center anchored">
<figure class="figure">
<p><img src="images/rotation_abitrary_vector.png" class="img-fluid figure-img"></p>
<p></p><figcaption class="figure-caption">Figure 3: Rotation around a vector</figcaption><p></p>
</figure>
</div>
<p>Unit quaternions <span class="math inline">\(q = (w, q_1, q_2, q_3)\)</span> with <span class="math inline">\(||q||_2=1\)</span> can be translated</p>
<p>the following connection to the unit rotation vector <span class="math inline">\(\vec{r}=(v_1, v_2, v_3)\)</span> holds:</p>
<p><span class="math display">\[
  q(\theta, v) = \cos(\frac{\theta}{2}) w + i \sin(\frac{\theta}{2}) v_1 +
  j \sin(\frac{\theta}{2}) v_2 + k \sin(\frac{\theta}{2}) v_3
\]</span></p>
<p>or componentwise</p>
<p><span class="math display">\[
q(\theta, v) =  \left(\cos(\frac{\theta}{2}) w,\; \sin(\frac{\theta}{2})  v_1, \;\sin(\frac{\theta} {2}) v_2, \;\sin(\frac{\theta}{2}) v_3 \right)
\]</span></p>
<p>here <span class="math inline">\(\theta\)</span> is the rotation about the unit vector.</p>
<p>The length of <span class="math inline">\(q\)</span> is <span class="math inline">\(||q||=\cos^2(\theta/2) w + \sin^2(\theta/2) (v_1^2 + v_2^2 + v_3^2) = \cos^2(\theta/2) w + \sin^2(\theta/2)\)</span> and hence we need to choose <span class="math inline">\(w=1\)</span> for the unit quaternion.</p>
<section id="construction-of-quaternion-from-vector-and-angle" class="level4" data-number="2.0.2.1">
<h4 data-number="2.0.2.1" class="anchored" data-anchor-id="construction-of-quaternion-from-vector-and-angle"><span class="header-section-number">2.0.2.1</span> Construction of quaternion from vector and angle</h4>
<p>Consider the plane from above. At the start (<span class="math inline">\(t=0\)</span>) the laboratory coordinate system corresponds to the one in the plane. This can be described by no rotation <span class="math inline">\(\theta=0\)</span> about any axis <span class="math inline">\(q(0) = (\cos(0), v_1 \sin(0), v_2 \sin(0), v_3 \sin(0) = (1,0,0,0)\)</span>. Then before the liftoff it looks in the xy-direction, that is a rotation about 45 degres (<span class="math inline">\(\theta = 45/360 \cdot 2 \cdot pi \approx 0.785\)</span>) around <span class="math inline">\(\vec{r} = (0,0,1)\)</span> and <span class="math inline">\(q(1) = (\cos(0.785/2), 0, 0, \sin(0.785/2))\)</span>.</p>
</section>
</section>
<section id="quaterion-algebra" class="level3" data-number="2.0.3">
<h3 data-number="2.0.3" class="anchored" data-anchor-id="quaterion-algebra"><span class="header-section-number">2.0.3</span> Quaterion Algebra</h3>
<ul>
<li><p>Addition (easy but no geometeric interpretation), just for reference <span class="math display">\[
q + p = p + q =  q_w + p_w + (q_1 + p_1) i + (q_2 + p_2) j + (q_3 + p_3) k
\]</span></p></li>
<li><p>Multiplication: The multiplication is not commutative <span class="math display">\[
q * p \ne p * q = \tt{Complicated Formula}
\]</span></p></li>
<li><p>Conjugate (just i –&gt; -i same for j and k) <span class="math display">\[
q^* = q_w − i q_x − j q_y − k q_z
\]</span></p></li>
<li><p>Inverse <span class="math display">\[
q^{-1} = q^*/||q||
\]</span></p></li>
</ul>
<p>So for unit quaternions, you just have to conjugate to get the inverse. Luckily, we don’t have to remember the formulaes and can use the onion-package.</p>
</section>
<section id="constructing-a-rotation-matrix-from-quaterions-first-solution" class="level3" data-number="2.0.4">
<h3 data-number="2.0.4" class="anchored" data-anchor-id="constructing-a-rotation-matrix-from-quaterions-first-solution"><span class="header-section-number">2.0.4</span> Constructing a rotation matrix from Quaterions (first solution)</h3>
<p>It’s possible to translate the quaternions back to a rotation matrix, see <a href="https://github.com/oduerr/gesture/blob/main/R/rotation_utils.R">quat_to_mat</a>. The code has been taken from https://automaticaddison.com/how-to-convert-a-quaternion-to-a-rotation-matrix/</p>
<div class="cell">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb25"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb25-1"><a href="#cb25-1" aria-hidden="true" tabindex="-1"></a>  t_05 <span class="ot">=</span> <span class="dv">0</span> <span class="co">#half of theta</span></span>
<span id="cb25-2"><a href="#cb25-2" aria-hidden="true" tabindex="-1"></a>  q0_d <span class="ot">=</span> <span class="fu">c</span>(<span class="fu">cos</span>(t_05), <span class="fu">sin</span>(t_05), <span class="fu">sin</span>(t_05), <span class="fu">sin</span>(t_05))</span>
<span id="cb25-3"><a href="#cb25-3" aria-hidden="true" tabindex="-1"></a>  t_05 <span class="ot">=</span> <span class="dv">45</span><span class="sc">/</span><span class="dv">360</span> <span class="sc">*</span> pi <span class="co">#half of theta</span></span>
<span id="cb25-4"><a href="#cb25-4" aria-hidden="true" tabindex="-1"></a>  q01 <span class="ot">=</span> <span class="fu">c</span>(<span class="fu">cos</span>(t_05), <span class="dv">0</span><span class="sc">*</span><span class="fu">sin</span>(t_05), <span class="dv">0</span><span class="sc">*</span><span class="fu">sin</span>(t_05), <span class="dv">1</span><span class="sc">*</span><span class="fu">sin</span>(t_05))</span>
<span id="cb25-5"><a href="#cb25-5" aria-hidden="true" tabindex="-1"></a>  <span class="co">#sum(q01^2) #1</span></span>
<span id="cb25-6"><a href="#cb25-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">quat_to_mat</span>(q01)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>          [,1]       [,2] [,3]
[1,] 0.7071068 -0.7071068    0
[2,] 0.7071068  0.7071068    0
[3,] 0.0000000  0.0000000    1</code></pre>
</div>
</div>
</section>
<section id="chaining-rotations-with-quaterions-just-multiply-them" class="level3" data-number="2.0.5">
<h3 data-number="2.0.5" class="anchored" data-anchor-id="chaining-rotations-with-quaterions-just-multiply-them"><span class="header-section-number">2.0.5</span> Chaining rotations with quaterions (just multiply them)</h3>
<p>Now comes properly the most useful thing, that successive rotations can be done by multiplying the respective quaternions. Let’s try this out.</p>
<p>Let’s multiply several quaternions. We start with <span class="math inline">\(q_0 = (1,0,0,0)\)</span>.</p>
<div class="cell" data-layout-align="center" name="bunny1" data-hash="Note_on_Quaternion_cache/html/unnamed-chunk-18_6203468eeb37e306b24e200f9503e15d">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb27"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb27-1"><a href="#cb27-1" aria-hidden="true" tabindex="-1"></a>  q0 <span class="ot">=</span> onion<span class="sc">::</span><span class="fu">quaternion</span>(<span class="at">Re =</span> <span class="dv">1</span>)</span>
<span id="cb27-2"><a href="#cb27-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">p3d</span>(rabbit <span class="sc">%*%</span> <span class="fu">quat_to_mat</span>(q0), <span class="at">h=</span><span class="cn">NULL</span>, <span class="at">main =</span> <span class="st">'q0'</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="Note_on_Quaternion_files/figure-html/unnamed-chunk-18-1.png" class="img-fluid figure-img" width="480"></p>
</figure>
</div>
</div>
</div>
<p>We add a second rotation (a first real) around the z-axis.</p>
<div class="cell" data-layout-align="center" name="bunny1" data-hash="Note_on_Quaternion_cache/html/unnamed-chunk-20_d8a643ae4afc6fda118566a9bf233a04">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb28"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb28-1"><a href="#cb28-1" aria-hidden="true" tabindex="-1"></a>  q1 <span class="ot">=</span> <span class="fu">quaternion</span>(<span class="at">Re=</span><span class="fu">cos</span>(<span class="sc">-</span><span class="dv">45</span><span class="sc">/</span><span class="dv">360</span> <span class="sc">*</span>pi), <span class="at">i =</span> <span class="dv">0</span>, <span class="at">j =</span> <span class="dv">0</span>, <span class="at">k =</span> <span class="dv">1</span><span class="sc">*</span><span class="fu">sin</span>(<span class="sc">-</span><span class="dv">45</span><span class="sc">/</span><span class="dv">360</span> <span class="sc">*</span>pi)) </span>
<span id="cb28-2"><a href="#cb28-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">p3d</span>(rabbit <span class="sc">%*%</span> <span class="fu">quat_to_mat</span>(q0 <span class="sc">*</span> q1), <span class="at">h=</span><span class="cn">NULL</span>, <span class="at">main =</span> <span class="st">'q0 * q1'</span>) </span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="Note_on_Quaternion_files/figure-html/unnamed-chunk-20-1.png" class="img-fluid figure-img" width="480"></p>
</figure>
</div>
</div>
</div>
<p>We add a third rotation around the x-axis.</p>
<div class="cell" data-layout-align="center" data-hash="Note_on_Quaternion_cache/html/bunny3_facdd355fd578219ad66808421b2e610">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb29"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb29-1"><a href="#cb29-1" aria-hidden="true" tabindex="-1"></a>  q2 <span class="ot">=</span> <span class="fu">quaternion</span>(<span class="at">Re=</span><span class="fu">cos</span>(<span class="sc">-</span><span class="dv">45</span><span class="sc">/</span><span class="dv">360</span> <span class="sc">*</span>pi), <span class="at">i =</span> <span class="dv">1</span><span class="sc">*</span><span class="fu">sin</span>(<span class="sc">-</span><span class="dv">45</span><span class="sc">/</span><span class="dv">360</span> <span class="sc">*</span>pi), <span class="at">j =</span> <span class="dv">0</span>, <span class="at">k =</span> <span class="dv">0</span>) </span>
<span id="cb29-2"><a href="#cb29-2" aria-hidden="true" tabindex="-1"></a>  q012 <span class="ot">=</span> q0 <span class="sc">*</span> q1 <span class="sc">*</span> q2 </span>
<span id="cb29-3"><a href="#cb29-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">p3d</span>(rabbit <span class="sc">%*%</span> <span class="fu">quat_to_mat</span>(q012), <span class="at">h=</span><span class="cn">NULL</span>, <span class="at">main =</span> <span class="st">'q0 * q1 * q2'</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="Note_on_Quaternion_files/figure-html/bunny3-1.png" class="img-fluid figure-img" width="480"></p>
</figure>
</div>
</div>
</div>
<p>Using the order <span class="math inline">\(q_0 q_1 q_2\)</span> you transfer the data of the bunny.</p>
</section>
<section id="pure-quaternions-real-part-0" class="level3" data-number="2.0.6">
<h3 data-number="2.0.6" class="anchored" data-anchor-id="pure-quaternions-real-part-0"><span class="header-section-number">2.0.6</span> Pure Quaternions (real part = 0)</h3>
<p>We can also use quaterions to transform vectors, without the need to explicitly construct the rotation matrix as done with the bunny data above. This is done with so-called unit or vector quaternions. To obtain a vector quaternions, we set the real part to 0 and use the vector in space as the vector part. That is a vector <span class="math inline">\(\vec{v}\)</span> in a certain direction without coding a rotation. From this vector, we like to know the position to which it gets rotated by <span class="math inline">\(R(q) \vec{v}\)</span> the rotation matrix <span class="math inline">\(R(q)\)</span> corresponding to <span class="math inline">\(q\)</span>. It can be shown that this is</p>
<p><span class="math display">\[
  R(q) \vec{v} = q \cdot (0,\vec{v}) \cdot q^{-1}
\]</span></p>
<div class="cell">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb30"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb30-1"><a href="#cb30-1" aria-hidden="true" tabindex="-1"></a> q <span class="ot">=</span> q0 <span class="sc">*</span> q1 <span class="sc">*</span> q2 <span class="co">#A unit quaterion defining the direction</span></span>
<span id="cb30-2"><a href="#cb30-2" aria-hidden="true" tabindex="-1"></a> vec <span class="ot">=</span> <span class="fu">matrix</span>(<span class="fu">c</span>(<span class="dv">12</span>,<span class="dv">13</span>,<span class="dv">45</span>), <span class="at">ncol=</span><span class="dv">1</span>) <span class="co">#A vector with which we do the </span></span>
<span id="cb30-3"><a href="#cb30-3" aria-hidden="true" tabindex="-1"></a> <span class="fu">quat_to_mat</span>(q) <span class="sc">%*%</span> vec</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>         [,1]
[1,] 37.48528
[2,] 20.51472
[3,] 22.62742</code></pre>
</div>
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb32"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb32-1"><a href="#cb32-1" aria-hidden="true" tabindex="-1"></a> vec_q <span class="ot">=</span> <span class="fu">quaternion</span>(<span class="at">Re =</span> <span class="dv">0</span>, <span class="at">i =</span> vec[<span class="dv">1</span>], <span class="at">j=</span>vec[<span class="dv">2</span>], <span class="at">k=</span>vec[<span class="dv">3</span>])</span>
<span id="cb32-2"><a href="#cb32-2" aria-hidden="true" tabindex="-1"></a> <span class="co">#q^-1 is the inverse, which for rotation quaternions is the conjugate </span></span>
<span id="cb32-3"><a href="#cb32-3" aria-hidden="true" tabindex="-1"></a> q <span class="sc">*</span> vec_q <span class="sc">*</span> q<span class="sc">^-</span><span class="dv">1</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>              Re
Re -3.552714e-15
i   3.748528e+01
j   2.051472e+01
k   2.262742e+01</code></pre>
</div>
</div>
<p>TODO build intuition for this expression.</p>
<section id="using-pure-quaterions-to-get-the-rotation-matrix." class="level4" data-number="2.0.6.1">
<h4 data-number="2.0.6.1" class="anchored" data-anchor-id="using-pure-quaterions-to-get-the-rotation-matrix."><span class="header-section-number">2.0.6.1</span> Using pure quaterions to get the rotation matrix.</h4>
<p>We can use pure quaterions to get the rotation matrix. To make the problem harder, we use a more complicated quaternion:</p>
<div class="cell">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb34"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb34-1"><a href="#cb34-1" aria-hidden="true" tabindex="-1"></a>q <span class="ot">=</span> <span class="fu">c</span>(<span class="fl">0.320</span>,  <span class="fl">0.300</span>,  <span class="fl">0.290</span>, <span class="sc">-</span><span class="fl">0.850</span>) </span>
<span id="cb34-2"><a href="#cb34-2" aria-hidden="true" tabindex="-1"></a>q <span class="ot">=</span> q <span class="sc">/</span> <span class="fu">sqrt</span>(<span class="fu">sum</span>(q<span class="sc">^</span><span class="dv">2</span>))</span>
<span id="cb34-3"><a href="#cb34-3" aria-hidden="true" tabindex="-1"></a>q <span class="ot">=</span> <span class="fu">quaternion</span>(<span class="at">Re=</span>q[<span class="dv">1</span>], <span class="at">i=</span>q[<span class="dv">2</span>], <span class="at">j=</span>q[<span class="dv">3</span>], <span class="at">k=</span>q[<span class="dv">4</span>])</span>
<span id="cb34-4"><a href="#cb34-4" aria-hidden="true" tabindex="-1"></a><span class="fu">t</span>(q<span class="sc">@</span>x)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>            Re         i         j          k
[1,] 0.3201601 0.3001501 0.2901451 -0.8504253</code></pre>
</div>
</div>
<p>We use the fact that the transformation is given by the results of the unit vectors of the first coordinate system:</p>
<div class="cell">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb36"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb36-1"><a href="#cb36-1" aria-hidden="true" tabindex="-1"></a> <span class="fu">round</span>(<span class="fu">quat_to_mat</span>(q), <span class="dv">4</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>        [,1]    [,2]    [,3]
[1,] -0.6148  0.7187 -0.3247
[2,] -0.3704 -0.6266 -0.6857
[3,] -0.6963 -0.3013  0.6515</code></pre>
</div>
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb38"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb38-1"><a href="#cb38-1" aria-hidden="true" tabindex="-1"></a> e1b <span class="ot">=</span> q <span class="sc">*</span> <span class="fu">quaternion</span>(<span class="at">Re =</span> <span class="dv">0</span>, <span class="at">i =</span> <span class="dv">1</span>) <span class="sc">*</span> q<span class="sc">^-</span><span class="dv">1</span> </span>
<span id="cb38-2"><a href="#cb38-2" aria-hidden="true" tabindex="-1"></a> e2b <span class="ot">=</span> q <span class="sc">*</span> <span class="fu">quaternion</span>(<span class="at">Re =</span> <span class="dv">0</span>, <span class="at">j =</span> <span class="dv">1</span>) <span class="sc">*</span> q<span class="sc">^-</span><span class="dv">1</span> </span>
<span id="cb38-3"><a href="#cb38-3" aria-hidden="true" tabindex="-1"></a> e3b <span class="ot">=</span> q <span class="sc">*</span> <span class="fu">quaternion</span>(<span class="at">Re =</span> <span class="dv">0</span>, <span class="at">k =</span> <span class="dv">1</span>) <span class="sc">*</span> q<span class="sc">^-</span><span class="dv">1</span> </span>
<span id="cb38-4"><a href="#cb38-4" aria-hidden="true" tabindex="-1"></a> <span class="fu">matrix</span>(<span class="fu">c</span>(</span>
<span id="cb38-5"><a href="#cb38-5" aria-hidden="true" tabindex="-1"></a>          e1b<span class="sc">@</span>x[<span class="dv">2</span><span class="sc">:</span><span class="dv">4</span>],</span>
<span id="cb38-6"><a href="#cb38-6" aria-hidden="true" tabindex="-1"></a>          e2b<span class="sc">@</span>x[<span class="dv">2</span><span class="sc">:</span><span class="dv">4</span>],</span>
<span id="cb38-7"><a href="#cb38-7" aria-hidden="true" tabindex="-1"></a>          e3b<span class="sc">@</span>x[<span class="dv">2</span><span class="sc">:</span><span class="dv">4</span>])</span>
<span id="cb38-8"><a href="#cb38-8" aria-hidden="true" tabindex="-1"></a> ,<span class="at">nrow=</span><span class="dv">3</span>) <span class="sc">%&gt;%</span> <span class="fu">round</span>(<span class="dv">4</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>        [,1]    [,2]    [,3]
[1,] -0.6148  0.7187 -0.3247
[2,] -0.3704 -0.6266 -0.6857
[3,] -0.6963 -0.3013  0.6515</code></pre>
</div>
</div>
</section>
</section>
<section id="flight-coordinates-from-quaterions" class="level3" data-number="2.0.7">
<h3 data-number="2.0.7" class="anchored" data-anchor-id="flight-coordinates-from-quaterions"><span class="header-section-number">2.0.7</span> Flight Coordinates from Quaterions</h3>
<p>In the definition above has defined as</p>
<p><span class="math display">\[
  R_{\text{Body} \leftarrow \text{Lab}} =  R_{roll} \, R_{pitch}\, R_{yaw}
\]</span></p>
<div class="cell">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb40"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb40-1"><a href="#cb40-1" aria-hidden="true" tabindex="-1"></a>  qyaw <span class="ot">=</span> <span class="fu">quaternion</span>(<span class="at">Re=</span><span class="fu">cos</span>(yaw<span class="sc">/</span><span class="dv">2</span>), <span class="at">i=</span><span class="dv">0</span>,<span class="at">j=</span><span class="dv">0</span>,<span class="at">k=</span><span class="fu">sin</span>(yaw<span class="sc">/</span><span class="dv">2</span>))</span>
<span id="cb40-2"><a href="#cb40-2" aria-hidden="true" tabindex="-1"></a>  qpitch <span class="ot">=</span> <span class="fu">quaternion</span>(<span class="at">Re=</span><span class="fu">cos</span>(pitch<span class="sc">/</span><span class="dv">2</span>), <span class="at">i=</span><span class="dv">0</span>,<span class="at">j=</span><span class="fu">sin</span>(pitch<span class="sc">/</span><span class="dv">2</span>),<span class="at">k=</span><span class="dv">0</span>)</span>
<span id="cb40-3"><a href="#cb40-3" aria-hidden="true" tabindex="-1"></a>  qroll <span class="ot">=</span> <span class="fu">quaternion</span>(<span class="at">Re=</span><span class="fu">cos</span>(roll<span class="sc">/</span><span class="dv">2</span>), <span class="at">i=</span><span class="fu">sin</span>(roll<span class="sc">/</span><span class="dv">2</span>), <span class="at">j=</span><span class="dv">0</span>,<span class="at">k=</span><span class="dv">0</span>)</span>
<span id="cb40-4"><a href="#cb40-4" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (<span class="cn">FALSE</span>) { <span class="co">#For debugging</span></span>
<span id="cb40-5"><a href="#cb40-5" aria-hidden="true" tabindex="-1"></a>    <span class="fu">sum</span>(qyaw<span class="sc">@</span>x<span class="sc">^</span><span class="dv">2</span>) <span class="co">#1</span></span>
<span id="cb40-6"><a href="#cb40-6" aria-hidden="true" tabindex="-1"></a>    <span class="fu">sum</span>(qpitch<span class="sc">@</span>x<span class="sc">^</span><span class="dv">2</span>) <span class="co">#1</span></span>
<span id="cb40-7"><a href="#cb40-7" aria-hidden="true" tabindex="-1"></a>    <span class="fu">sum</span>(qroll<span class="sc">@</span>x<span class="sc">^</span><span class="dv">2</span>) <span class="co">#1</span></span>
<span id="cb40-8"><a href="#cb40-8" aria-hidden="true" tabindex="-1"></a>    <span class="co">#R = R.roll %*% R.pitch %*% R.yaw</span></span>
<span id="cb40-9"><a href="#cb40-9" aria-hidden="true" tabindex="-1"></a>    <span class="fu">sum</span>((<span class="fu">quat_to_mat</span>(qyaw) <span class="sc">-</span> <span class="fu">t</span>(R.yaw))<span class="sc">^</span><span class="dv">2</span>) <span class="co">#2.46519e-32</span></span>
<span id="cb40-10"><a href="#cb40-10" aria-hidden="true" tabindex="-1"></a>    <span class="fu">sum</span>((<span class="fu">quat_to_mat</span>(qpitch) <span class="sc">-</span> <span class="fu">t</span>(R.pitch))<span class="sc">^</span><span class="dv">2</span>) <span class="co">#2.46519e-32</span></span>
<span id="cb40-11"><a href="#cb40-11" aria-hidden="true" tabindex="-1"></a>    <span class="fu">sum</span>((<span class="fu">quat_to_mat</span>(qroll) <span class="sc">-</span> <span class="fu">t</span>(R.roll))<span class="sc">^</span><span class="dv">2</span>) <span class="co">#4.930381e-32</span></span>
<span id="cb40-12"><a href="#cb40-12" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb40-13"><a href="#cb40-13" aria-hidden="true" tabindex="-1"></a>  <span class="co">#In that definition the quanterions describe the inverse</span></span>
<span id="cb40-14"><a href="#cb40-14" aria-hidden="true" tabindex="-1"></a>  qcomb_body_to_lab <span class="ot">=</span> qyaw <span class="sc">*</span> qpitch <span class="sc">*</span> qroll</span>
<span id="cb40-15"><a href="#cb40-15" aria-hidden="true" tabindex="-1"></a>  qcomb_lab_to_body <span class="ot">=</span> qcomb_body_to_lab<span class="sc">^-</span><span class="dv">1</span></span>
<span id="cb40-16"><a href="#cb40-16" aria-hidden="true" tabindex="-1"></a>  <span class="fu">quat_to_mat</span>(qcomb_lab_to_body)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>           [,1]       [,2]      [,3]
[1,]  0.3213938  0.5566704 0.7660444
[2,] -0.8832100 -0.1155511 0.4545195
[3,]  0.3415348 -0.8226579 0.4545195</code></pre>
</div>
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb42"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb42-1"><a href="#cb42-1" aria-hidden="true" tabindex="-1"></a>  R </span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>           [,1]       [,2]      [,3]
[1,]  0.3213938  0.5566704 0.7660444
[2,] -0.8832100 -0.1155511 0.4545195
[3,]  0.3415348 -0.8226579 0.4545195</code></pre>
</div>
</div>
<p>Testing the package</p>
<div class="cell">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb44"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb44-1"><a href="#cb44-1" aria-hidden="true" tabindex="-1"></a>quart_to_ypr <span class="ot">=</span> <span class="cf">function</span>(q){</span>
<span id="cb44-2"><a href="#cb44-2" aria-hidden="true" tabindex="-1"></a>    w <span class="ot">=</span> q[<span class="dv">1</span>]</span>
<span id="cb44-3"><a href="#cb44-3" aria-hidden="true" tabindex="-1"></a>    x <span class="ot">=</span> q[<span class="dv">2</span>]</span>
<span id="cb44-4"><a href="#cb44-4" aria-hidden="true" tabindex="-1"></a>    y <span class="ot">=</span> q[<span class="dv">3</span>]</span>
<span id="cb44-5"><a href="#cb44-5" aria-hidden="true" tabindex="-1"></a>    z <span class="ot">=</span> q[<span class="dv">4</span>]</span>
<span id="cb44-6"><a href="#cb44-6" aria-hidden="true" tabindex="-1"></a>    roll <span class="ot">=</span> <span class="fu">atan2</span>(<span class="dv">2</span> <span class="sc">*</span> (w <span class="sc">*</span> x <span class="sc">+</span> y <span class="sc">*</span> z), <span class="dv">1</span> <span class="sc">-</span> <span class="dv">2</span> <span class="sc">*</span> (x <span class="sc">*</span> x <span class="sc">+</span> y <span class="sc">*</span> y))</span>
<span id="cb44-7"><a href="#cb44-7" aria-hidden="true" tabindex="-1"></a>    pitch <span class="ot">=</span> <span class="fu">asin</span>(<span class="dv">2</span> <span class="sc">*</span> (w <span class="sc">*</span> y <span class="sc">-</span> x <span class="sc">*</span> z))</span>
<span id="cb44-8"><a href="#cb44-8" aria-hidden="true" tabindex="-1"></a>    yaw <span class="ot">=</span> <span class="fu">atan2</span>(<span class="dv">2</span> <span class="sc">*</span> (w <span class="sc">*</span> z <span class="sc">+</span> x <span class="sc">*</span> y), <span class="dv">1</span> <span class="sc">-</span> <span class="dv">2</span> <span class="sc">*</span> (z <span class="sc">*</span> z <span class="sc">+</span> y <span class="sc">*</span> y))</span>
<span id="cb44-9"><a href="#cb44-9" aria-hidden="true" tabindex="-1"></a>    <span class="fu">return</span>(<span class="fu">c</span>(yaw,pitch,roll))</span>
<span id="cb44-10"><a href="#cb44-10" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb44-11"><a href="#cb44-11" aria-hidden="true" tabindex="-1"></a><span class="fu">quart_to_ypr</span>(qcomb_lab_to_body<span class="sc">@</span>x) <span class="co">#Wrong </span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>[1] -1.2217988 -0.3485494 -1.0660348</code></pre>
</div>
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb46"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb46-1"><a href="#cb46-1" aria-hidden="true" tabindex="-1"></a><span class="fu">quart_to_ypr</span>(qcomb_body_to_lab<span class="sc">@</span>x) <span class="co">#Correct</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>[1]  1.0471976 -0.8726646  0.7853982</code></pre>
</div>
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb48"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb48-1"><a href="#cb48-1" aria-hidden="true" tabindex="-1"></a><span class="fu">c</span>(yaw, pitch, roll)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>[1]  1.0471976 -0.8726646  0.7853982</code></pre>
</div>
</div>
<div class="cell">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb50"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb50-1"><a href="#cb50-1" aria-hidden="true" tabindex="-1"></a><span class="co">#As it is currently implented</span></span>
<span id="cb50-2"><a href="#cb50-2" aria-hidden="true" tabindex="-1"></a>dmpGetGravity <span class="ot">=</span> <span class="cf">function</span>(q){</span>
<span id="cb50-3"><a href="#cb50-3" aria-hidden="true" tabindex="-1"></a>  qw <span class="ot">=</span> q[<span class="dv">1</span>]</span>
<span id="cb50-4"><a href="#cb50-4" aria-hidden="true" tabindex="-1"></a>  qx <span class="ot">=</span> q[<span class="dv">2</span>]</span>
<span id="cb50-5"><a href="#cb50-5" aria-hidden="true" tabindex="-1"></a>  qy <span class="ot">=</span> q[<span class="dv">3</span>]</span>
<span id="cb50-6"><a href="#cb50-6" aria-hidden="true" tabindex="-1"></a>  qz <span class="ot">=</span> q[<span class="dv">4</span>]</span>
<span id="cb50-7"><a href="#cb50-7" aria-hidden="true" tabindex="-1"></a>  vx <span class="ot">=</span> <span class="dv">2</span> <span class="sc">*</span> (qx <span class="sc">*</span> qz <span class="sc">-</span> qw<span class="sc">*</span>qy)</span>
<span id="cb50-8"><a href="#cb50-8" aria-hidden="true" tabindex="-1"></a>  vy <span class="ot">=</span> <span class="dv">2</span> <span class="sc">*</span> (qw <span class="sc">*</span> qx <span class="sc">+</span> qy<span class="sc">*</span>qz)</span>
<span id="cb50-9"><a href="#cb50-9" aria-hidden="true" tabindex="-1"></a>  vz <span class="ot">=</span> qw<span class="sc">^</span><span class="dv">2</span> <span class="sc">-</span> qx<span class="sc">^</span><span class="dv">2</span> <span class="sc">-</span> qy<span class="sc">^</span><span class="dv">2</span> <span class="sc">+</span> qz<span class="sc">^</span><span class="dv">2</span></span>
<span id="cb50-10"><a href="#cb50-10" aria-hidden="true" tabindex="-1"></a>  <span class="fu">return</span>(<span class="fu">c</span>(vx,vy,vz))</span>
<span id="cb50-11"><a href="#cb50-11" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb50-12"><a href="#cb50-12" aria-hidden="true" tabindex="-1"></a>dmpGetYawPitchRoll <span class="ot">=</span> <span class="cf">function</span>(q, gravity){</span>
<span id="cb50-13"><a href="#cb50-13" aria-hidden="true" tabindex="-1"></a>  qw <span class="ot">=</span> q[<span class="dv">1</span>]</span>
<span id="cb50-14"><a href="#cb50-14" aria-hidden="true" tabindex="-1"></a>  qx <span class="ot">=</span> q[<span class="dv">2</span>]</span>
<span id="cb50-15"><a href="#cb50-15" aria-hidden="true" tabindex="-1"></a>  qy <span class="ot">=</span> q[<span class="dv">3</span>]</span>
<span id="cb50-16"><a href="#cb50-16" aria-hidden="true" tabindex="-1"></a>  qz <span class="ot">=</span> q[<span class="dv">4</span>]</span>
<span id="cb50-17"><a href="#cb50-17" aria-hidden="true" tabindex="-1"></a>  yaw <span class="ot">=</span> <span class="fu">atan2</span>(<span class="dv">2</span><span class="sc">*</span>qx<span class="sc">*</span>qy <span class="sc">-</span> <span class="dv">2</span><span class="sc">*</span>qw<span class="sc">*</span>qz, <span class="dv">2</span><span class="sc">*</span>qw<span class="sc">*</span>qw<span class="sc">+</span><span class="dv">2</span><span class="sc">*</span>qx<span class="sc">*</span>qx<span class="dv">-1</span>)</span>
<span id="cb50-18"><a href="#cb50-18" aria-hidden="true" tabindex="-1"></a>  pitch <span class="ot">=</span> <span class="fu">atan</span>(gravity[<span class="dv">1</span>]<span class="sc">/</span><span class="fu">sqrt</span>(gravity[<span class="dv">2</span>]<span class="sc">^</span><span class="dv">2</span><span class="sc">+</span>gravity[<span class="dv">3</span>]<span class="sc">^</span><span class="dv">2</span>))</span>
<span id="cb50-19"><a href="#cb50-19" aria-hidden="true" tabindex="-1"></a>  roll <span class="ot">=</span> <span class="fu">atan</span>(gravity[<span class="dv">2</span>]<span class="sc">/</span><span class="fu">sqrt</span>(gravity[<span class="dv">1</span>]<span class="sc">^</span><span class="dv">2</span><span class="sc">+</span>gravity[<span class="dv">3</span>]<span class="sc">^</span><span class="dv">2</span>))</span>
<span id="cb50-20"><a href="#cb50-20" aria-hidden="true" tabindex="-1"></a>  <span class="fu">return</span>(<span class="fu">c</span>(yaw, pitch, roll))</span>
<span id="cb50-21"><a href="#cb50-21" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb50-22"><a href="#cb50-22" aria-hidden="true" tabindex="-1"></a>g <span class="ot">=</span> <span class="fu">dmpGetGravity</span>(qcomb_body_to_lab<span class="sc">@</span>x)</span>
<span id="cb50-23"><a href="#cb50-23" aria-hidden="true" tabindex="-1"></a><span class="fu">dmpGetYawPitchRoll</span>(qcomb_body_to_lab<span class="sc">@</span>x, g)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>[1] -1.2217988  0.8726646  0.4718327</code></pre>
</div>
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb52"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb52-1"><a href="#cb52-1" aria-hidden="true" tabindex="-1"></a>g <span class="ot">=</span> <span class="fu">dmpGetGravity</span>(qcomb_lab_to_body<span class="sc">@</span>x)</span>
<span id="cb52-2"><a href="#cb52-2" aria-hidden="true" tabindex="-1"></a><span class="fu">dmpGetYawPitchRoll</span>(qcomb_lab_to_body<span class="sc">@</span>x, g)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>[1]  1.0471976  0.3485494 -0.9660703</code></pre>
</div>
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb54"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb54-1"><a href="#cb54-1" aria-hidden="true" tabindex="-1"></a><span class="fu">c</span>(yaw, pitch, roll)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>[1]  1.0471976 -0.8726646  0.7853982</code></pre>
</div>
</div>
</section>
<section id="rotation-between-two-quaternions." class="level3" data-number="2.0.8">
<h3 data-number="2.0.8" class="anchored" data-anchor-id="rotation-between-two-quaternions."><span class="header-section-number">2.0.8</span> Rotation between two quaternions.</h3>
<p>Consider the two IMUs (like the one on the thumb and the one on the palm), the orientation of the first (w.r.t. the laboratory system) is given by <span class="math inline">\(q_1\)</span> the orientation of the second by <span class="math inline">\(q_2\)</span>. What is the rotation getting you from hand to palm. The questions is: which rotation <span class="math inline">\(q_{12}\)</span> translates between them. So we ask which <span class="math inline">\(q_12\)</span> fulfills</p>
<p><span class="math display">\[
  q_2 = q_1 \; q_{12}
\]</span></p>
<p>Just calculate the inverse of <span class="math inline">\(q_1\)</span> and you are done</p>
<p><span class="math display">\[
  q_1^{-1} \; q_2 = q_{12}  
\]</span></p>
</section>
<section id="software-package" class="level2" data-number="2.1">
<h2 data-number="2.1" class="anchored" data-anchor-id="software-package"><span class="header-section-number">2.1</span> Software package</h2>
<p>There are several software packages helping to deal with rotations and quaterions. Like the onion package in R.</p>
<section id="the-ahrs-python-package" class="level3" data-number="2.1.1">
<h3 data-number="2.1.1" class="anchored" data-anchor-id="the-ahrs-python-package"><span class="header-section-number">2.1.1</span> The AHRS Python Package</h3>
<p>The AHRS package (https://ahrs.readthedocs.io/en/latest/index.html) used to estimate the rotation of a IMUs (sensors in e.g.&nbsp;cell phones and drones), uses quaternion as lot and also provides some basic operations.</p>
<div class="cell">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb56"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb56-1"><a href="#cb56-1" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> ahrs <span class="im">import</span> Quaternion</span>
<span id="cb56-2"><a href="#cb56-2" aria-hidden="true" tabindex="-1"></a>p <span class="op">=</span> Quaternion([<span class="fl">0.7071</span>, <span class="fl">0.0</span>, <span class="fl">0.7071</span>, <span class="fl">0.0</span>])</span>
<span id="cb56-3"><a href="#cb56-3" aria-hidden="true" tabindex="-1"></a>p </span>
<span id="cb56-4"><a href="#cb56-4" aria-hidden="true" tabindex="-1"></a>q <span class="op">=</span> Quaternion([<span class="dv">0</span>, <span class="fl">0.7071</span>, <span class="fl">0.0</span>, <span class="fl">0.7071</span>])</span>
<span id="cb56-5"><a href="#cb56-5" aria-hidden="true" tabindex="-1"></a>p <span class="op">*</span> q <span class="co">#0., 1., 0., 0.</span></span>
<span id="cb56-6"><a href="#cb56-6" aria-hidden="true" tabindex="-1"></a>q <span class="op">*</span> p <span class="co">#0., 0., 0., 1.</span></span>
<span id="cb56-7"><a href="#cb56-7" aria-hidden="true" tabindex="-1"></a>q.conj<span class="co">#0., -0.70710678, -0., -0.70710678</span></span>
<span id="cb56-8"><a href="#cb56-8" aria-hidden="true" tabindex="-1"></a>d <span class="op">=</span> q<span class="op">*</span>q.conj </span>
<span id="cb56-9"><a href="#cb56-9" aria-hidden="true" tabindex="-1"></a>d</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<!-- -->


</section>
</section>
</section>


<div id="quarto-appendix" class="default"><section class="quarto-appendix-contents" role="doc-bibliography"><h2 class="anchored quarto-appendix-heading">References</h2><div id="refs" class="references csl-bib-body hanging-indent" role="doc-bibliography">
<div id="ref-grossekatthofer2012introduction" class="csl-entry" role="doc-biblioentry">
Großekatthöfer, Karsten, and Zizung Yoon. 2012. <span>“Introduction into Quaternions for Spacecraft Attitude Representation.”</span> <em>TU Berlin</em> 16.
</div>
</div></section><section class="footnotes footnotes-end-of-document" role="doc-endnotes"><h2 class="anchored quarto-appendix-heading">Footnotes</h2>

<ol>
<li id="fn1" role="doc-endnote"><p>He was German and said: “Die Spalten einer Matrix sind die Bilder der Einheitsvektoren”.<a href="#fnref1" class="footnote-back" role="doc-backlink">↩︎</a></p></li>
<li id="fn2" role="doc-endnote"><p>Or not so luckily, since this leads to many confusions. You can always fix your code by transposing the matrix.<a href="#fnref2" class="footnote-back" role="doc-backlink">↩︎</a></p></li>
<li id="fn3" role="doc-endnote"><p>There are three transformations done. For the first transformation, we have 3 axis to choose. The second transformation, cannot be the same as the first and so there are 2 possibilities. The third transformation must be different then the second (same as first is OK) leaving 2 possibilities. In total we have $3 \cdot 2 \cdot 2 = 12$ possibilities.<a href="#fnref3" class="footnote-back" role="doc-backlink">↩︎</a></p></li>
</ol>
</section></div></main>
<!-- /main column -->
<script id="quarto-html-after-body" type="application/javascript">
window.document.addEventListener("DOMContentLoaded", function (event) {
  const toggleBodyColorMode = (bsSheetEl) => {
    const mode = bsSheetEl.getAttribute("data-mode");
    const bodyEl = window.document.querySelector("body");
    if (mode === "dark") {
      bodyEl.classList.add("quarto-dark");
      bodyEl.classList.remove("quarto-light");
    } else {
      bodyEl.classList.add("quarto-light");
      bodyEl.classList.remove("quarto-dark");
    }
  }
  const toggleBodyColorPrimary = () => {
    const bsSheetEl = window.document.querySelector("link#quarto-bootstrap");
    if (bsSheetEl) {
      toggleBodyColorMode(bsSheetEl);
    }
  }
  toggleBodyColorPrimary();  
  const icon = "";
  const anchorJS = new window.AnchorJS();
  anchorJS.options = {
    placement: 'right',
    icon: icon
  };
  anchorJS.add('.anchored');
  const clipboard = new window.ClipboardJS('.code-copy-button', {
    target: function(trigger) {
      return trigger.previousElementSibling;
    }
  });
  clipboard.on('success', function(e) {
    // button target
    const button = e.trigger;
    // don't keep focus
    button.blur();
    // flash "checked"
    button.classList.add('code-copy-button-checked');
    var currentTitle = button.getAttribute("title");
    button.setAttribute("title", "Copied!");
    setTimeout(function() {
      button.setAttribute("title", currentTitle);
      button.classList.remove('code-copy-button-checked');
    }, 1000);
    // clear code selection
    e.clearSelection();
  });
  const viewSource = window.document.getElementById('quarto-view-source') ||
                     window.document.getElementById('quarto-code-tools-source');
  if (viewSource) {
    const sourceUrl = viewSource.getAttribute("data-quarto-source-url");
    viewSource.addEventListener("click", function(e) {
      if (sourceUrl) {
        // rstudio viewer pane
        if (/\bcapabilities=\b/.test(window.location)) {
          window.open(sourceUrl);
        } else {
          window.location.href = sourceUrl;
        }
      } else {
        const modal = new bootstrap.Modal(document.getElementById('quarto-embedded-source-code-modal'));
        modal.show();
      }
      return false;
    });
  }
  function toggleCodeHandler(show) {
    return function(e) {
      const detailsSrc = window.document.querySelectorAll(".cell > details > .sourceCode");
      for (let i=0; i<detailsSrc.length; i++) {
        const details = detailsSrc[i].parentElement;
        if (show) {
          details.open = true;
        } else {
          details.removeAttribute("open");
        }
      }
      const cellCodeDivs = window.document.querySelectorAll(".cell > .sourceCode");
      const fromCls = show ? "hidden" : "unhidden";
      const toCls = show ? "unhidden" : "hidden";
      for (let i=0; i<cellCodeDivs.length; i++) {
        const codeDiv = cellCodeDivs[i];
        if (codeDiv.classList.contains(fromCls)) {
          codeDiv.classList.remove(fromCls);
          codeDiv.classList.add(toCls);
        } 
      }
      return false;
    }
  }
  const hideAllCode = window.document.getElementById("quarto-hide-all-code");
  if (hideAllCode) {
    hideAllCode.addEventListener("click", toggleCodeHandler(false));
  }
  const showAllCode = window.document.getElementById("quarto-show-all-code");
  if (showAllCode) {
    showAllCode.addEventListener("click", toggleCodeHandler(true));
  }
  function tippyHover(el, contentFn) {
    const config = {
      allowHTML: true,
      content: contentFn,
      maxWidth: 500,
      delay: 100,
      arrow: false,
      appendTo: function(el) {
          return el.parentElement;
      },
      interactive: true,
      interactiveBorder: 10,
      theme: 'quarto',
      placement: 'bottom-start'
    };
    window.tippy(el, config); 
  }
  const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
  for (var i=0; i<noterefs.length; i++) {
    const ref = noterefs[i];
    tippyHover(ref, function() {
      let href = ref.getAttribute('href');
      try { href = new URL(href).hash; } catch {}
      const id = href.replace(/^#\/?/, "");
      const note = window.document.getElementById(id);
      return note.innerHTML;
    });
  }
  var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
  for (var i=0; i<bibliorefs.length; i++) {
    const ref = bibliorefs[i];
    const cites = ref.parentNode.getAttribute('data-cites').split(' ');
    tippyHover(ref, function() {
      var popup = window.document.createElement('div');
      cites.forEach(function(cite) {
        var citeDiv = window.document.createElement('div');
        citeDiv.classList.add('hanging-indent');
        citeDiv.classList.add('csl-entry');
        var biblioDiv = window.document.getElementById('ref-' + cite);
        if (biblioDiv) {
          citeDiv.innerHTML = biblioDiv.innerHTML;
        }
        popup.appendChild(citeDiv);
      });
      return popup.innerHTML;
    });
  }
});
</script><div class="modal fade" id="quarto-embedded-source-code-modal" tabindex="-1" aria-labelledby="quarto-embedded-source-code-modal-label" aria-hidden="true"><div class="modal-dialog modal-dialog-scrollable"><div class="modal-content"><div class="modal-header"><h5 class="modal-title" id="quarto-embedded-source-code-modal-label">Source Code</h5><button class="btn-close" data-bs-dismiss="modal"></button></div><div class="modal-body"><div class="">
<div class="sourceCode" id="cb57" data-shortcodes="false"><pre class="sourceCode markdown code-with-copy"><code class="sourceCode markdown"><span id="cb57-1"><a href="#cb57-1" aria-hidden="true" tabindex="-1"></a><span class="co">---</span></span>
<span id="cb57-2"><a href="#cb57-2" aria-hidden="true" tabindex="-1"></a><span class="an">title:</span><span class="co"> "Notes on Rotations and Quaternions"</span></span>
<span id="cb57-3"><a href="#cb57-3" aria-hidden="true" tabindex="-1"></a><span class="an">format:</span></span>
<span id="cb57-4"><a href="#cb57-4" aria-hidden="true" tabindex="-1"></a><span class="co">    html:</span></span>
<span id="cb57-5"><a href="#cb57-5" aria-hidden="true" tabindex="-1"></a><span class="co">      fig-width: 8</span></span>
<span id="cb57-6"><a href="#cb57-6" aria-hidden="true" tabindex="-1"></a><span class="co">      fig-height: 4</span></span>
<span id="cb57-7"><a href="#cb57-7" aria-hidden="true" tabindex="-1"></a><span class="co">      code-fold: true</span></span>
<span id="cb57-8"><a href="#cb57-8" aria-hidden="true" tabindex="-1"></a><span class="co">      code-tools: true</span></span>
<span id="cb57-9"><a href="#cb57-9" aria-hidden="true" tabindex="-1"></a><span class="an">author:</span><span class="co"> Oliver Dürr</span></span>
<span id="cb57-10"><a href="#cb57-10" aria-hidden="true" tabindex="-1"></a><span class="an">editor:</span><span class="co"> visual</span></span>
<span id="cb57-11"><a href="#cb57-11" aria-hidden="true" tabindex="-1"></a><span class="an">bibliography:</span><span class="co"> references.bib</span></span>
<span id="cb57-12"><a href="#cb57-12" aria-hidden="true" tabindex="-1"></a><span class="co">---</span></span>
<span id="cb57-13"><a href="#cb57-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb57-14"><a href="#cb57-14" aria-hidden="true" tabindex="-1"></a><span class="in">```{r setup, include=FALSE}</span></span>
<span id="cb57-15"><a href="#cb57-15" aria-hidden="true" tabindex="-1"></a>  <span class="fu">library</span>(tidyverse)</span>
<span id="cb57-16"><a href="#cb57-16" aria-hidden="true" tabindex="-1"></a>  <span class="fu">library</span>(reticulate)</span>
<span id="cb57-17"><a href="#cb57-17" aria-hidden="true" tabindex="-1"></a>  <span class="fu">library</span>(onion) <span class="co">#For quaterions</span></span>
<span id="cb57-18"><a href="#cb57-18" aria-hidden="true" tabindex="-1"></a>  <span class="fu">source</span>(<span class="st">'rotation_utils.R'</span>)</span>
<span id="cb57-19"><a href="#cb57-19" aria-hidden="true" tabindex="-1"></a>  <span class="fu">library</span>(plot3D)</span>
<span id="cb57-20"><a href="#cb57-20" aria-hidden="true" tabindex="-1"></a>  <span class="fu">data</span>(bunny) <span class="co">#This are just many points in the 3 Dimensional space</span></span>
<span id="cb57-21"><a href="#cb57-21" aria-hidden="true" tabindex="-1"></a>  <span class="co">#dim(bunny) #35947     3</span></span>
<span id="cb57-22"><a href="#cb57-22" aria-hidden="true" tabindex="-1"></a>  R <span class="ot">=</span> <span class="fu">from_fixed_to_body</span>(<span class="at">a=</span><span class="dv">0</span>, <span class="at">b=</span><span class="dv">0</span>, <span class="at">g=</span><span class="dv">104</span>)</span>
<span id="cb57-23"><a href="#cb57-23" aria-hidden="true" tabindex="-1"></a>  <span class="fu">set.seed</span>(<span class="dv">42</span>)</span>
<span id="cb57-24"><a href="#cb57-24" aria-hidden="true" tabindex="-1"></a>  idx <span class="ot">=</span> <span class="fu">sample</span>(<span class="dv">1</span><span class="sc">:</span><span class="fu">nrow</span>(bunny), <span class="dv">5000</span>)</span>
<span id="cb57-25"><a href="#cb57-25" aria-hidden="true" tabindex="-1"></a>  rabbit <span class="ot">=</span> bunny[idx,]</span>
<span id="cb57-26"><a href="#cb57-26" aria-hidden="true" tabindex="-1"></a>  rabbit <span class="ot">=</span> rabbit</span>
<span id="cb57-27"><a href="#cb57-27" aria-hidden="true" tabindex="-1"></a>  rabbit <span class="ot">=</span> rabbit <span class="sc">%*%</span> <span class="fu">t</span>(R) </span>
<span id="cb57-28"><a href="#cb57-28" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb57-29"><a href="#cb57-29" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb57-30"><a href="#cb57-30" aria-hidden="true" tabindex="-1"></a>This is a primer on rotations and quaternions, as needed to describe rotations.</span>
<span id="cb57-31"><a href="#cb57-31" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb57-32"><a href="#cb57-32" aria-hidden="true" tabindex="-1"></a>**This is Work in Progress still need corrections.**</span>
<span id="cb57-33"><a href="#cb57-33" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb57-34"><a href="#cb57-34" aria-hidden="true" tabindex="-1"></a><span class="fu"># A short note on rotations</span></span>
<span id="cb57-35"><a href="#cb57-35" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb57-36"><a href="#cb57-36" aria-hidden="true" tabindex="-1"></a>In the figure, you can see a sketch of the situation for gesture recognition. We are interested in "the relative positions" between the palm and thumb on the one side and the laboratory system. As we will see this can be described in the framework of rotations.</span>
<span id="cb57-37"><a href="#cb57-37" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb57-38"><a href="#cb57-38" aria-hidden="true" tabindex="-1"></a><span class="al">![Simplyfied gesture recognition with 2 IMUs (thumb, palm). Show are a fixed coordinate system in space (toothpicks on table), a body centered coordinate system on the thumb and one on the plam.](images/hand.jpg)</span>{#fig-hand width="1000"}</span>
<span id="cb57-39"><a href="#cb57-39" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb57-40"><a href="#cb57-40" aria-hidden="true" tabindex="-1"></a><span class="fu">## A first rotation</span></span>
<span id="cb57-41"><a href="#cb57-41" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb57-42"><a href="#cb57-42" aria-hidden="true" tabindex="-1"></a>Before we go into some math, lets have a first look how a rotation might look like. On the left side you see data points in the original space. On the right side a rotation by 45 degrees around the z-axis that have been applied to the points. This rotation can be obtained by a rotation matrix R:</span>
<span id="cb57-43"><a href="#cb57-43" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb57-44"><a href="#cb57-44" aria-hidden="true" tabindex="-1"></a><span class="in">```{r rot-yaw-bunny}</span></span>
<span id="cb57-45"><a href="#cb57-45" aria-hidden="true" tabindex="-1"></a>R <span class="ot">=</span> <span class="fu">matrix</span>(<span class="fu">c</span>(<span class="fl">0.7071068</span>,  <span class="fl">0.7071068</span>,  <span class="fl">0.0000000</span>, <span class="sc">-</span><span class="fl">0.7071068</span>,  <span class="fl">0.7071068</span>,  <span class="fl">0.0000000</span>,  <span class="fl">0.0000000</span>,  <span class="fl">0.0000000</span>,  <span class="fl">1.0000000</span>), <span class="at">nrow=</span><span class="dv">3</span>)</span>
<span id="cb57-46"><a href="#cb57-46" aria-hidden="true" tabindex="-1"></a><span class="fu">round</span>(R,<span class="dv">4</span>)</span>
<span id="cb57-47"><a href="#cb57-47" aria-hidden="true" tabindex="-1"></a><span class="fu">par</span>(<span class="at">mfrow=</span><span class="fu">c</span>(<span class="dv">1</span>,<span class="dv">2</span>))</span>
<span id="cb57-48"><a href="#cb57-48" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb57-49"><a href="#cb57-49" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb57-50"><a href="#cb57-50" aria-hidden="true" tabindex="-1"></a>As we will see in a second an example a point $x$ of the rabid cloud is transformed via:</span>
<span id="cb57-51"><a href="#cb57-51" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb57-52"><a href="#cb57-52" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb57-53"><a href="#cb57-53" aria-hidden="true" tabindex="-1"></a>  x_\text{rot} = R \, x</span>
<span id="cb57-54"><a href="#cb57-54" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb57-55"><a href="#cb57-55" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb57-56"><a href="#cb57-56" aria-hidden="true" tabindex="-1"></a><span class="in">```{r, rot-bunny-plot, warning=FALSE, fig.width=10, fig.height=5, fig.align='center', cache=TRUE, fig.cap='Left: orinial data. Right: data rotated by 45 degrees around y-axis (or coordinate system rotated by -45) degrees. The y-axis points up and the rotation is done in counter clock-wise manner'}</span></span>
<span id="cb57-57"><a href="#cb57-57" aria-hidden="true" tabindex="-1"></a><span class="fu">p3d</span>(rabbit, <span class="at">h=</span><span class="cn">NULL</span>, <span class="at">xlab=</span><span class="st">'x'</span>, <span class="at">ylab=</span><span class="st">'y'</span>, <span class="at">zlab=</span><span class="st">'z'</span>, )</span>
<span id="cb57-58"><a href="#cb57-58" aria-hidden="true" tabindex="-1"></a><span class="co">#It's vector times Matrix for row-vectors</span></span>
<span id="cb57-59"><a href="#cb57-59" aria-hidden="true" tabindex="-1"></a><span class="co">#Therefore we have to transpose (R x) to x^T R^T</span></span>
<span id="cb57-60"><a href="#cb57-60" aria-hidden="true" tabindex="-1"></a><span class="fu">p3d</span>(rabbit <span class="sc">%*%</span> <span class="fu">t</span>(R), <span class="at">h=</span><span class="cn">NULL</span>) </span>
<span id="cb57-61"><a href="#cb57-61" aria-hidden="true" tabindex="-1"></a><span class="fu">par</span>(<span class="at">mfrow=</span><span class="fu">c</span>(<span class="dv">1</span>,<span class="dv">1</span>))</span>
<span id="cb57-62"><a href="#cb57-62" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb57-63"><a href="#cb57-63" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb57-64"><a href="#cb57-64" aria-hidden="true" tabindex="-1"></a><span class="fu">## Introduction</span></span>
<span id="cb57-65"><a href="#cb57-65" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb57-66"><a href="#cb57-66" aria-hidden="true" tabindex="-1"></a>Rotations between rigid objects can be described as a linear transformation from one coordinate system to another, with the same origin. A first example is the bunny from above. Anexample of such a rotation is the orientation of your cell phone after you picked it up compared to the position on the table, or the orientation of the thumb in figure compared to the coordinate system of the palm. A very illustrative example is an airplane which is at $t=0$ on the ground and is at $t=t$ in the air. Besides the translation, the orientation of the plane at $t=0$ relative to the plane at $t=t$ can be described by a different heading (the *yaw* angle) obtained while taxing, the *pitch* angle obtained in the climbing phase and a rotation around the axis of flight the *roll* angle. During this phase many rotations can happen but they can all be summarized in a single rotation.</span>
<span id="cb57-67"><a href="#cb57-67" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb57-68"><a href="#cb57-68" aria-hidden="true" tabindex="-1"></a>More formally the rotations between the two planes can be described by a rotation matrix $R$ , which transforms the coordinate system of the plane at $t=0$ to the coordinate system of the plane at $t=t$. This matrix is defined by the transformation of unit vectors $\vec{e_x},\vec{e_y},\vec{e_z}$ of coordinate system (say that at $t=0$) to a coordinate system $\vec{e'_x},\vec{e'_y},\vec{e'_z}$ at $t=t$. As my famous professor in linear algebra always repeated the columns of a (transformation) matrix are the images of the unit vectors<span class="ot">[^1]</span>. So the first column of $R$ is given by $R \cdot \vec{e_x}$ second by $R \cdot \vec{e_y}$, and the third by $R \cdot \vec{e_z}$.</span>
<span id="cb57-69"><a href="#cb57-69" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb57-70"><a href="#cb57-70" aria-hidden="true" tabindex="-1"></a><span class="ot">[^1]: </span>He was German and said: "Die Spalten einer Matrix sind die Bilder der Einheitsvektoren".</span>
<span id="cb57-71"><a href="#cb57-71" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb57-72"><a href="#cb57-72" aria-hidden="true" tabindex="-1"></a>Important to note is that there are to directions the rotation (airplane in the fixed coordinate system like the tower, or tower in the coordinate system of the airplane) can go. Since the solution are so similar, this sometimes causes confusion.</span>
<span id="cb57-73"><a href="#cb57-73" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb57-74"><a href="#cb57-74" aria-hidden="true" tabindex="-1"></a><span class="fu">## Parameterization</span></span>
<span id="cb57-75"><a href="#cb57-75" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb57-76"><a href="#cb57-76" aria-hidden="true" tabindex="-1"></a><span class="fu">### Definition of rotations</span></span>
<span id="cb57-77"><a href="#cb57-77" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb57-78"><a href="#cb57-78" aria-hidden="true" tabindex="-1"></a>Rotations can be seen as linear transformation from one coordinate system into another. But there are several way to parametrize them. The first is via a rotation matrix.</span>
<span id="cb57-79"><a href="#cb57-79" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb57-80"><a href="#cb57-80" aria-hidden="true" tabindex="-1"></a><span class="fu">### Rotation matrix</span></span>
<span id="cb57-81"><a href="#cb57-81" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb57-82"><a href="#cb57-82" aria-hidden="true" tabindex="-1"></a>In principal a rotation is given by the 9 matrix elements of $R$. However they cannot be arbitrary, they still need to describe rotations. What are the defining properties of rotations? It turns out that a rotation, has an inverse and the inverse simply the transposed $R^{-1} = R^T$ (this is the orthogonality). Further, $det(R)=1$ this is a consequence that the volume in the rotated system stays constant and also the orientation (it's $det(R)=1$ and not just $|det(d)|=1$). So in matrix notation a rotation is defined by</span>
<span id="cb57-83"><a href="#cb57-83" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb57-84"><a href="#cb57-84" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb57-85"><a href="#cb57-85" aria-hidden="true" tabindex="-1"></a>R=\begin{bmatrix}r_{11} &amp; r_{12} &amp; r_{13} <span class="sc">\\</span>r_{21} &amp; r_{22} &amp; r_{23} <span class="sc">\\</span>r_{31} &amp; r_{32} &amp; r_{33} \end{bmatrix}, \quad R^TR=RR^T=1,\quad det(R)=1  </span>
<span id="cb57-86"><a href="#cb57-86" aria-hidden="true" tabindex="-1"></a>$$ {#eq-rot}</span>
<span id="cb57-87"><a href="#cb57-87" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb57-88"><a href="#cb57-88" aria-hidden="true" tabindex="-1"></a>Multiplying two rotation matrices $R_1$ and $R_2$ is a again a rotation matrix, this is why rotations in 3D are also called special orthogonal group <span class="in">`SO(3)`</span>. Note that the order of rotations matter and $R_1 R_2 \ne R_2 R_1$</span>
<span id="cb57-89"><a href="#cb57-89" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb57-90"><a href="#cb57-90" aria-hidden="true" tabindex="-1"></a>So it's obvious that is over parameterized using 9 values and there are constrains on the $r_{ij}$ so that eq. 1 is fulfilled.</span>
<span id="cb57-91"><a href="#cb57-91" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb57-92"><a href="#cb57-92" aria-hidden="true" tabindex="-1"></a><span class="fu">#### Rotation-Matrices ("From To" pitfall)</span></span>
<span id="cb57-93"><a href="#cb57-93" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb57-94"><a href="#cb57-94" aria-hidden="true" tabindex="-1"></a>When we condescend ourselves to the depth of matrix multiplication, the first of two pitfalls lingers around. This is due to the fact that matrix multiplication introduces an order. Say, we want to transform a vector $\vec{f}$ from a "from coordinate system" into a vector $\vec{t}$ given in coordinates of the "to coordinate system". We can do this via:</span>
<span id="cb57-95"><a href="#cb57-95" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb57-96"><a href="#cb57-96" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb57-97"><a href="#cb57-97" aria-hidden="true" tabindex="-1"></a>\vec{t}=R \,\vec{f}</span>
<span id="cb57-98"><a href="#cb57-98" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb57-99"><a href="#cb57-99" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb57-100"><a href="#cb57-100" aria-hidden="true" tabindex="-1"></a>To go the other way around, use $\vec{f}=R^{-1} \vec{t}$. The problem occurs with intermediate steps, for example when decomposing the rotation into several intermediate steps $R=R_2 R_1$ then</span>
<span id="cb57-101"><a href="#cb57-101" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb57-102"><a href="#cb57-102" aria-hidden="true" tabindex="-1"></a>TODO</span>
<span id="cb57-103"><a href="#cb57-103" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb57-104"><a href="#cb57-104" aria-hidden="true" tabindex="-1"></a>It is handy to make the distinction, between *rotations* and *transformations* and think of one coordinate system as the *world coordinate system* or lab system.A transformation is defined as an operation, which leaves the points (in the world coordinate system) as they are and just moves the coordinate system. A rotation on the other hand, moves the points in the world coordinate system, see e.g.<span class="co">[</span><span class="ot">@grossekatthofer2012introduction</span><span class="co">]</span>. However, you might wonder why we break the symmetry and consider one coordinate system as fixed. Here is an explanation (taken from <span class="co">[</span><span class="ot">stackexchange</span><span class="co">](https://math.stackexchange.com/a/2243057)</span>)</span>
<span id="cb57-105"><a href="#cb57-105" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb57-106"><a href="#cb57-106" aria-hidden="true" tabindex="-1"></a>The product $AB$ of matrices is the effect of applying $A$ after applying $B$, simply because we write the "effect" of a matrix $A$ on a vector $v$ as $Av$ (i.e., the convention is to work with column vectors). Thus $(AB)v = A(Bv)$ is $A$ applied to $Bv$. Note that this convention matches the usual notation for (nested) functions: $\log(\sin(x))$ is the logarithm function applied to the result from applying the sine function to $x$.</span>
<span id="cb57-107"><a href="#cb57-107" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb57-108"><a href="#cb57-108" aria-hidden="true" tabindex="-1"></a>Of course, the rules for computing the product of matrices are just right for this convention. Or, if one wanted $AB$ to stand for "first apply $A$, then apply $B$", one would use row vectors instead and write "A applied to $v$" as $vA$ - which is very uncommon (and in effect just means that one works with the transposed matrices, relative to the usual convention).</span>
<span id="cb57-109"><a href="#cb57-109" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb57-110"><a href="#cb57-110" aria-hidden="true" tabindex="-1"></a>**Only transformations can be chained by the usual matrix multiplication.** I don't know how often I did this wrong.</span>
<span id="cb57-111"><a href="#cb57-111" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb57-112"><a href="#cb57-112" aria-hidden="true" tabindex="-1"></a><span class="fu">### Parameterization using elementary rotation.</span></span>
<span id="cb57-113"><a href="#cb57-113" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb57-114"><a href="#cb57-114" aria-hidden="true" tabindex="-1"></a>Many repeated rotations are again a rotation (closure). Moreover it can be shown that an arbitrary rotation can be build out of three elementary rotations. Here the mess begins, there are many ways to define such as decomposition. For example one possibility is: First, a counter-clockwise rotation $R_z(\alpha)$ around the $z$-axis by an angle of $\alpha$. Second, $R_x(\beta)$ rotates around "the new" $x$-axis and finally by $R_z(\gamma)$ around the new $z$-axis. So the complete transformation is given by $R(\alpha, \beta, \gamma) = R_z(\gamma) R_y(\beta) R_x(\alpha)$.</span>
<span id="cb57-115"><a href="#cb57-115" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb57-116"><a href="#cb57-116" aria-hidden="true" tabindex="-1"></a><span class="co">[</span><span class="al">![Animation showing the sequence \$R_z(\\gamma) R_y(\\beta) R_x(\\alpha)\$ of elementary rotation. Taken from wikepedia](images/Euler2a.gif)</span><span class="ot">{#fig-rot-ball}</span><span class="co">](https://en.wikipedia.org/wiki/Euler_angles)</span></span>
<span id="cb57-117"><a href="#cb57-117" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb57-118"><a href="#cb57-118" aria-hidden="true" tabindex="-1"></a>The individual transformations can be derived by looking where the unit vectors are transformed. In the figure below you see a derivation of the rotation matrix, we have an original system denoted by $x,y,z$ and a system rotatated about $\vartheta$ around the z-axis. We ask "how does the original system look like in the rotated one.".</span>
<span id="cb57-119"><a href="#cb57-119" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb57-120"><a href="#cb57-120" aria-hidden="true" tabindex="-1"></a><span class="al">![Derivation of the Transformation matrix transforming from a fixed coordinate system to a rotated one.](images/rz_gamma.png)</span>{width="700"}</span>
<span id="cb57-121"><a href="#cb57-121" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb57-122"><a href="#cb57-122" aria-hidden="true" tabindex="-1"></a>This transformation matrix transforms from the laboratory L system to the "body centric system" B. To make this clearer sometimes, expressions like $R_{B \leftarrow L}$ are written <span class="co">[</span><span class="ot">@grossekatthofer2012introduction</span><span class="co">]</span>. For transforming points from the rotated system back to the initial system, we ask for the inverse transformation $R_{L \leftarrow B}$ :"How does the transformed points look in the original system". Luckily<span class="ot">[^2]</span> the inverse is the transposed and this corresponds to setting $\gamma$ to $-\gamma$ since $\sin$ is asymmetric. So in this case we have for a rotation about say $\alpha$ around the z-Axis.</span>
<span id="cb57-123"><a href="#cb57-123" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb57-124"><a href="#cb57-124" aria-hidden="true" tabindex="-1"></a><span class="ot">[^2]: </span>Or not so luckily, since this leads to many confusions. You can always fix your code by transposing the matrix.</span>
<span id="cb57-125"><a href="#cb57-125" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb57-126"><a href="#cb57-126" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb57-127"><a href="#cb57-127" aria-hidden="true" tabindex="-1"></a>  R_{L \leftarrow B}^z(\alpha) = R_{B \leftarrow L}^z(-\alpha)=\begin{bmatrix}\cos(\alpha) &amp; -\sin(\alpha) &amp; 0 <span class="sc">\\</span>\sin(\alpha) &amp;\cos(\alpha) &amp; 0 <span class="sc">\\</span>0 &amp; 0 &amp; 1 \end{bmatrix}</span>
<span id="cb57-128"><a href="#cb57-128" aria-hidden="true" tabindex="-1"></a>$$ {#eq-yaw}</span>
<span id="cb57-129"><a href="#cb57-129" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb57-130"><a href="#cb57-130" aria-hidden="true" tabindex="-1"></a>When we rotated the rabbit, we rotated the data and not the coordinate system. So we have to use a rotation as $R^z_{B\leftarrow L}(-\alpha)$ and with $\sin(45^0) = \cos(45^0) \approx 0.7071$, we get:</span>
<span id="cb57-131"><a href="#cb57-131" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb57-134"><a href="#cb57-134" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb57-135"><a href="#cb57-135" aria-hidden="true" tabindex="-1"></a>Ra <span class="ot">=</span> <span class="cf">function</span>(a){</span>
<span id="cb57-136"><a href="#cb57-136" aria-hidden="true" tabindex="-1"></a>  <span class="fu">return</span>(</span>
<span id="cb57-137"><a href="#cb57-137" aria-hidden="true" tabindex="-1"></a>    <span class="fu">matrix</span>(</span>
<span id="cb57-138"><a href="#cb57-138" aria-hidden="true" tabindex="-1"></a>        <span class="fu">c</span>(<span class="fu">cos</span>(a), <span class="fu">sin</span>(a), <span class="dv">0</span>, <span class="sc">-</span><span class="fu">sin</span>(a), <span class="fu">cos</span>(a), <span class="dv">0</span>, <span class="dv">0</span>, <span class="dv">0</span>, <span class="dv">1</span>)</span>
<span id="cb57-139"><a href="#cb57-139" aria-hidden="true" tabindex="-1"></a>        , <span class="at">nrow=</span><span class="dv">3</span>, <span class="at">byrow =</span> <span class="cn">TRUE</span>) </span>
<span id="cb57-140"><a href="#cb57-140" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb57-141"><a href="#cb57-141" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb57-142"><a href="#cb57-142" aria-hidden="true" tabindex="-1"></a><span class="fu">Ra</span>(<span class="sc">-</span><span class="dv">45</span><span class="sc">*</span><span class="dv">2</span><span class="sc">*</span>pi<span class="sc">/</span><span class="dv">360</span>)</span>
<span id="cb57-143"><a href="#cb57-143" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb57-144"><a href="#cb57-144" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb57-145"><a href="#cb57-145" aria-hidden="true" tabindex="-1"></a>which is same rotation as used in the code used to transform the data.</span>
<span id="cb57-146"><a href="#cb57-146" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb57-147"><a href="#cb57-147" aria-hidden="true" tabindex="-1"></a><span class="fu">#### Ambiguities</span></span>
<span id="cb57-148"><a href="#cb57-148" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb57-149"><a href="#cb57-149" aria-hidden="true" tabindex="-1"></a>The problem with the approach of elementary rotations is, that there are many (12) possible combinations to chain the elementary operations<span class="ot">[^3]</span>. For example often used is the sequence $R_{L \leftarrow B}=R^z(\gamma) R^y(\beta) R^z(\alpha)$ i.e. using $R^z$ twice. This sequence is shown in the animation @fig-rot-ball</span>
<span id="cb57-150"><a href="#cb57-150" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb57-151"><a href="#cb57-151" aria-hidden="true" tabindex="-1"></a><span class="ot">[^3]: </span>There are three transformations done. For the first transformation, we have 3 axis to choose. The second transformation, cannot be the same as the first and so there are 2 possibilities. The third transformation must be different then the second (same as first is OK) leaving 2 possibilities. In total we have \$3 <span class="sc">\\</span>cdot 2 <span class="sc">\\</span>cdot 2 = 12\$ possibilities.</span>
<span id="cb57-152"><a href="#cb57-152" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb57-153"><a href="#cb57-153" aria-hidden="true" tabindex="-1"></a><span class="fu">#### A worked out example (Yaw-Pitch-Roll)</span></span>
<span id="cb57-154"><a href="#cb57-154" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb57-155"><a href="#cb57-155" aria-hidden="true" tabindex="-1"></a>Using an airplane, we know what happens (taxiing, take-off, rolling) and we can derive a nice chain of elementary rotations, which will serve as reference for later. First of all, we have to define the direction. We want a transformation that starts with coordinates in the lab frame, and transforms that into coordinate in the airplane frame.</span>
<span id="cb57-156"><a href="#cb57-156" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb57-157"><a href="#cb57-157" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb57-158"><a href="#cb57-158" aria-hidden="true" tabindex="-1"></a>\vec{x}_{B} = R_{B \leftarrow L} \cdot \vec{x}_L</span>
<span id="cb57-159"><a href="#cb57-159" aria-hidden="true" tabindex="-1"></a>$$ Going from the lab to the body, first does a yaw, followed by a pitch and then by a roll. Hence:</span>
<span id="cb57-160"><a href="#cb57-160" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb57-161"><a href="#cb57-161" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb57-162"><a href="#cb57-162" aria-hidden="true" tabindex="-1"></a>\vec{x}_{B} = R^{\text{roll}}_{L \leftarrow B''} R^{\text{pitch}}_{B'' \leftarrow B'} R^{\text{yaw}}_{B' \leftarrow L}\cdot \vec{x}_L</span>
<span id="cb57-163"><a href="#cb57-163" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb57-164"><a href="#cb57-164" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb57-165"><a href="#cb57-165" aria-hidden="true" tabindex="-1"></a>In the example, we use the following angles</span>
<span id="cb57-166"><a href="#cb57-166" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb57-169"><a href="#cb57-169" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb57-170"><a href="#cb57-170" aria-hidden="true" tabindex="-1"></a>yaw <span class="ot">=</span> <span class="dv">60</span> <span class="sc">*</span> <span class="dv">2</span> <span class="sc">*</span> pi <span class="sc">/</span> <span class="dv">360</span>    <span class="co">#This is w.r.t. the tower / labframe</span></span>
<span id="cb57-171"><a href="#cb57-171" aria-hidden="true" tabindex="-1"></a>pitch <span class="ot">=</span> <span class="sc">-</span><span class="dv">50</span> <span class="sc">*</span> <span class="dv">2</span> <span class="sc">*</span> pi <span class="sc">/</span> <span class="dv">360</span>  <span class="co">#Angle of climb</span></span>
<span id="cb57-172"><a href="#cb57-172" aria-hidden="true" tabindex="-1"></a>roll <span class="ot">=</span> <span class="dv">40</span> <span class="sc">*</span> <span class="dv">2</span> <span class="sc">*</span> pi <span class="sc">/</span> <span class="dv">360</span>   <span class="co">#Angle of roll</span></span>
<span id="cb57-173"><a href="#cb57-173" aria-hidden="true" tabindex="-1"></a><span class="fu">print</span>(<span class="fu">paste</span>(<span class="st">'yaw '</span>, yaw, <span class="st">' pitch '</span>, pitch, <span class="st">' roll '</span>,roll))</span>
<span id="cb57-174"><a href="#cb57-174" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb57-175"><a href="#cb57-175" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb57-176"><a href="#cb57-176" aria-hidden="true" tabindex="-1"></a>The pitch needs to be negative in order that a the rotation leads to a descent.</span>
<span id="cb57-177"><a href="#cb57-177" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb57-178"><a href="#cb57-178" aria-hidden="true" tabindex="-1"></a><span class="fu">##### Taxiing yaw $\alpha$</span></span>
<span id="cb57-179"><a href="#cb57-179" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb57-180"><a href="#cb57-180" aria-hidden="true" tabindex="-1"></a>The plane first rotates about the z-axis by an angle of $\alpha$. In the lab-system it moves away in counter clock-wise manner. So we have:</span>
<span id="cb57-181"><a href="#cb57-181" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb57-182"><a href="#cb57-182" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb57-183"><a href="#cb57-183" aria-hidden="true" tabindex="-1"></a> \begin{bmatrix}x_L<span class="sc">\\</span>y_L <span class="sc">\\</span> z_L \end{bmatrix}</span>
<span id="cb57-184"><a href="#cb57-184" aria-hidden="true" tabindex="-1"></a>=</span>
<span id="cb57-185"><a href="#cb57-185" aria-hidden="true" tabindex="-1"></a>\begin{bmatrix}\cos(\alpha) &amp; -\sin(\alpha) &amp; 0 <span class="sc">\\</span>\sin(\alpha) &amp;\cos(\alpha) &amp; 0 <span class="sc">\\</span>0 &amp; 0 &amp; 1 \end{bmatrix} </span>
<span id="cb57-186"><a href="#cb57-186" aria-hidden="true" tabindex="-1"></a>\cdot</span>
<span id="cb57-187"><a href="#cb57-187" aria-hidden="true" tabindex="-1"></a>\begin{bmatrix}x_B<span class="sc">\\</span>y_B <span class="sc">\\</span> z_B \end{bmatrix}</span>
<span id="cb57-188"><a href="#cb57-188" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb57-189"><a href="#cb57-189" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb57-190"><a href="#cb57-190" aria-hidden="true" tabindex="-1"></a>The rotation matrix, we are looking at is the inverse of the above and hence</span>
<span id="cb57-191"><a href="#cb57-191" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb57-192"><a href="#cb57-192" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb57-193"><a href="#cb57-193" aria-hidden="true" tabindex="-1"></a> \begin{bmatrix}x_B<span class="sc">\\</span>y_B <span class="sc">\\</span> z_B \end{bmatrix}</span>
<span id="cb57-194"><a href="#cb57-194" aria-hidden="true" tabindex="-1"></a>=</span>
<span id="cb57-195"><a href="#cb57-195" aria-hidden="true" tabindex="-1"></a>\underbrace{</span>
<span id="cb57-196"><a href="#cb57-196" aria-hidden="true" tabindex="-1"></a>\begin{bmatrix}\cos(\alpha) &amp; \sin(\alpha) &amp; 0 <span class="sc">\\</span>-\sin(\alpha) &amp;\cos(\alpha) &amp; 0 <span class="sc">\\</span>0 &amp; 0 &amp; 1 \end{bmatrix}}_</span>
<span id="cb57-197"><a href="#cb57-197" aria-hidden="true" tabindex="-1"></a>{R_{B \leftarrow L}}</span>
<span id="cb57-198"><a href="#cb57-198" aria-hidden="true" tabindex="-1"></a>\cdot</span>
<span id="cb57-199"><a href="#cb57-199" aria-hidden="true" tabindex="-1"></a>\begin{bmatrix}x_L<span class="sc">\\</span>y_L <span class="sc">\\</span> z_L \end{bmatrix}</span>
<span id="cb57-200"><a href="#cb57-200" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb57-201"><a href="#cb57-201" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb57-202"><a href="#cb57-202" aria-hidden="true" tabindex="-1"></a>This described by the transformation matrix $R_z(\alpha)$ in @eq-yaw. We use a rotation of yaw for all points $x$ in the plane the following transformation is done:</span>
<span id="cb57-203"><a href="#cb57-203" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb57-206"><a href="#cb57-206" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb57-207"><a href="#cb57-207" aria-hidden="true" tabindex="-1"></a>R.yaw <span class="ot">=</span> <span class="fu">Ra</span>(yaw) </span>
<span id="cb57-208"><a href="#cb57-208" aria-hidden="true" tabindex="-1"></a>R.yaw</span>
<span id="cb57-209"><a href="#cb57-209" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb57-210"><a href="#cb57-210" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb57-211"><a href="#cb57-211" aria-hidden="true" tabindex="-1"></a><span class="in">```{r, data_gen, warning=FALSE}</span></span>
<span id="cb57-212"><a href="#cb57-212" aria-hidden="true" tabindex="-1"></a><span class="fu">set.seed</span>(<span class="dv">42</span>)</span>
<span id="cb57-213"><a href="#cb57-213" aria-hidden="true" tabindex="-1"></a>n <span class="ot">=</span> <span class="dv">1100</span></span>
<span id="cb57-214"><a href="#cb57-214" aria-hidden="true" tabindex="-1"></a>x <span class="ot">=</span> <span class="fu">runif</span>(n,<span class="sc">-</span><span class="dv">1</span>,<span class="dv">1</span>)</span>
<span id="cb57-215"><a href="#cb57-215" aria-hidden="true" tabindex="-1"></a>y <span class="ot">=</span> <span class="fu">runif</span>(n, <span class="sc">-</span><span class="fl">0.4</span>,<span class="fl">0.4</span>)</span>
<span id="cb57-216"><a href="#cb57-216" aria-hidden="true" tabindex="-1"></a>z <span class="ot">=</span> <span class="fu">runif</span>(n,<span class="sc">-</span><span class="fl">0.1</span>,<span class="fl">0.1</span>)</span>
<span id="cb57-217"><a href="#cb57-217" aria-hidden="true" tabindex="-1"></a>col <span class="ot">=</span> <span class="fu">rep</span>(<span class="st">'blue'</span>,n)</span>
<span id="cb57-218"><a href="#cb57-218" aria-hidden="true" tabindex="-1"></a>col[x<span class="sc">&gt;</span><span class="fl">0.5</span>] <span class="ot">=</span> <span class="st">'red'</span></span>
<span id="cb57-219"><a href="#cb57-219" aria-hidden="true" tabindex="-1"></a>col[x<span class="sc">&lt;=</span> <span class="sc">-</span><span class="fl">0.5</span>] <span class="ot">=</span> <span class="st">'green'</span></span>
<span id="cb57-220"><a href="#cb57-220" aria-hidden="true" tabindex="-1"></a>col[y<span class="sc">&lt;=</span> <span class="sc">-</span><span class="fl">0.2</span>] <span class="ot">=</span> <span class="st">'gray30'</span></span>
<span id="cb57-221"><a href="#cb57-221" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb57-222"><a href="#cb57-222" aria-hidden="true" tabindex="-1"></a>plane <span class="ot">=</span> <span class="fu">as.matrix</span>(<span class="fu">data.frame</span>(<span class="at">x=</span>x,<span class="at">y=</span>y,<span class="at">z=</span>z))</span>
<span id="cb57-223"><a href="#cb57-223" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(rgl)</span>
<span id="cb57-224"><a href="#cb57-224" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(scatterplot3d) <span class="co"># load</span></span>
<span id="cb57-225"><a href="#cb57-225" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb57-226"><a href="#cb57-226" aria-hidden="true" tabindex="-1"></a>make_plot <span class="ot">=</span> <span class="cf">function</span>(p1, p2, <span class="at">l1=</span><span class="fu">c</span>(<span class="st">'x'</span>,<span class="st">'y'</span>,<span class="st">'z'</span>), <span class="at">l2=</span><span class="fu">c</span>(<span class="st">'x'</span>,<span class="st">'y'</span>,<span class="st">'z'</span>), <span class="at">angle =</span> <span class="dv">55</span>) {</span>
<span id="cb57-227"><a href="#cb57-227" aria-hidden="true" tabindex="-1"></a>  <span class="fu">par</span>(<span class="at">mfrow=</span><span class="fu">c</span>(<span class="dv">1</span>,<span class="dv">2</span>))</span>
<span id="cb57-228"><a href="#cb57-228" aria-hidden="true" tabindex="-1"></a>  <span class="co">#First plot</span></span>
<span id="cb57-229"><a href="#cb57-229" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scatterplot3d</span>(p1[,<span class="dv">1</span>],p1[,<span class="dv">2</span>],p1[,<span class="dv">3</span>], </span>
<span id="cb57-230"><a href="#cb57-230" aria-hidden="true" tabindex="-1"></a>                <span class="at">xlim=</span><span class="fu">c</span>(<span class="sc">-</span><span class="dv">1</span>,<span class="dv">1</span>), <span class="at">ylim=</span><span class="fu">c</span>(<span class="sc">-</span><span class="dv">1</span>,<span class="dv">1</span>), <span class="at">zlim=</span><span class="fu">c</span>(<span class="sc">-</span><span class="dv">1</span>,<span class="dv">1</span>), </span>
<span id="cb57-231"><a href="#cb57-231" aria-hidden="true" tabindex="-1"></a>                <span class="at">color =</span> col,</span>
<span id="cb57-232"><a href="#cb57-232" aria-hidden="true" tabindex="-1"></a>                <span class="at">xlab=</span>l1[<span class="dv">1</span>], <span class="at">ylab=</span>l1[<span class="dv">2</span>], <span class="at">zlab =</span> l1[<span class="dv">3</span>],<span class="at">angle =</span> angle, <span class="at">pch=</span><span class="dv">16</span>)</span>
<span id="cb57-233"><a href="#cb57-233" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scatterplot3d</span>(p2[,<span class="dv">1</span>],p2[,<span class="dv">2</span>],p2[,<span class="dv">3</span>], </span>
<span id="cb57-234"><a href="#cb57-234" aria-hidden="true" tabindex="-1"></a>                <span class="at">xlim=</span><span class="fu">c</span>(<span class="sc">-</span><span class="dv">1</span>,<span class="dv">1</span>), <span class="at">ylim=</span><span class="fu">c</span>(<span class="sc">-</span><span class="dv">1</span>,<span class="dv">1</span>), <span class="at">zlim=</span><span class="fu">c</span>(<span class="sc">-</span><span class="dv">1</span>,<span class="dv">1</span>), </span>
<span id="cb57-235"><a href="#cb57-235" aria-hidden="true" tabindex="-1"></a>                <span class="at">color =</span> col,</span>
<span id="cb57-236"><a href="#cb57-236" aria-hidden="true" tabindex="-1"></a>                <span class="at">xlab=</span>l2[<span class="dv">1</span>], <span class="at">ylab=</span>l2[<span class="dv">2</span>], <span class="at">zlab =</span> l2[<span class="dv">3</span>],<span class="at">angle =</span> angle, <span class="at">pch=</span><span class="dv">16</span>)</span>
<span id="cb57-237"><a href="#cb57-237" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb57-238"><a href="#cb57-238" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb57-239"><a href="#cb57-239" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb57-240"><a href="#cb57-240" aria-hidden="true" tabindex="-1"></a>To visualize, we need the body coordinates, transformed to lab coordinates. Hence, we use the transpose of the rotation and apply it to the coordinates in the body system.</span>
<span id="cb57-241"><a href="#cb57-241" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb57-242"><a href="#cb57-242" aria-hidden="true" tabindex="-1"></a><span class="in">```{r, yaw-plane, fig.width=10, fig.height=5, fig.cap='Left: orinial data. Right: data rotated by yaw degrees around z-axis'}</span></span>
<span id="cb57-243"><a href="#cb57-243" aria-hidden="true" tabindex="-1"></a><span class="do">##Since we have column vector, we have to transpose once more yielding</span></span>
<span id="cb57-244"><a href="#cb57-244" aria-hidden="true" tabindex="-1"></a>plane.yaw  <span class="ot">=</span> plane <span class="sc">%*%</span> R.yaw <span class="co">#t(t(R.yaw))</span></span>
<span id="cb57-245"><a href="#cb57-245" aria-hidden="true" tabindex="-1"></a><span class="fu">make_plot</span>(plane, plane.yaw, <span class="at">l2=</span><span class="fu">c</span>(<span class="st">"x'"</span>,<span class="st">"y'"</span>,<span class="st">"z'"</span>))</span>
<span id="cb57-246"><a href="#cb57-246" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> (<span class="cn">FALSE</span>){<span class="co">#Debuggin</span></span>
<span id="cb57-247"><a href="#cb57-247" aria-hidden="true" tabindex="-1"></a>  <span class="fu">print</span>(<span class="st">'Maximal difference, in x-direction'</span>)</span>
<span id="cb57-248"><a href="#cb57-248" aria-hidden="true" tabindex="-1"></a>  <span class="fu">max</span>(<span class="fu">abs</span>(plane.yaw[,<span class="dv">3</span>] <span class="sc">-</span> plane[,<span class="dv">3</span>]))</span>
<span id="cb57-249"><a href="#cb57-249" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb57-250"><a href="#cb57-250" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb57-251"><a href="#cb57-251" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb57-252"><a href="#cb57-252" aria-hidden="true" tabindex="-1"></a><span class="fu">##### Take-off the pitch $\beta$</span></span>
<span id="cb57-253"><a href="#cb57-253" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb57-254"><a href="#cb57-254" aria-hidden="true" tabindex="-1"></a>When the plane takes off, all rotates rotated about $\beta$ about the y-axis. This *transformation* (lab to body) is given by</span>
<span id="cb57-255"><a href="#cb57-255" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb57-256"><a href="#cb57-256" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb57-257"><a href="#cb57-257" aria-hidden="true" tabindex="-1"></a>  R^y(\beta) = \begin{bmatrix}\cos(\beta) &amp; 0 &amp; -\sin(\beta)<span class="sc">\\</span></span>
<span id="cb57-258"><a href="#cb57-258" aria-hidden="true" tabindex="-1"></a>   0 &amp; 1 &amp; 0 <span class="sc">\\</span></span>
<span id="cb57-259"><a href="#cb57-259" aria-hidden="true" tabindex="-1"></a>  \sin(\beta) &amp; 0 &amp; \cos(\beta)\end{bmatrix}</span>
<span id="cb57-260"><a href="#cb57-260" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb57-261"><a href="#cb57-261" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb57-262"><a href="#cb57-262" aria-hidden="true" tabindex="-1"></a>Note that the rotation is about the y-axis (use the right hand the thumb is the axis and the fingers shows the direction). Acceding, corresponds to negative values (that's the reason we choose negative value)</span>
<span id="cb57-263"><a href="#cb57-263" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb57-266"><a href="#cb57-266" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb57-267"><a href="#cb57-267" aria-hidden="true" tabindex="-1"></a>Rb <span class="ot">=</span> <span class="cf">function</span>(b) <span class="fu">matrix</span>(</span>
<span id="cb57-268"><a href="#cb57-268" aria-hidden="true" tabindex="-1"></a>      <span class="fu">c</span>(<span class="fu">cos</span>(b), <span class="dv">0</span>, <span class="sc">-</span><span class="fu">sin</span>(b), <span class="dv">0</span>, <span class="dv">1</span>, <span class="dv">0</span>, <span class="fu">sin</span>(b), <span class="dv">0</span>, <span class="fu">cos</span>(b))</span>
<span id="cb57-269"><a href="#cb57-269" aria-hidden="true" tabindex="-1"></a>      , <span class="at">nrow=</span><span class="dv">3</span>, <span class="at">byrow =</span> <span class="cn">TRUE</span>) </span>
<span id="cb57-270"><a href="#cb57-270" aria-hidden="true" tabindex="-1"></a>R.pitch <span class="ot">=</span> <span class="fu">Rb</span>(pitch) </span>
<span id="cb57-271"><a href="#cb57-271" aria-hidden="true" tabindex="-1"></a>R.pitch</span>
<span id="cb57-272"><a href="#cb57-272" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb57-273"><a href="#cb57-273" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb57-274"><a href="#cb57-274" aria-hidden="true" tabindex="-1"></a><span class="fu">###### Takeoff without taxiing</span></span>
<span id="cb57-275"><a href="#cb57-275" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb57-276"><a href="#cb57-276" aria-hidden="true" tabindex="-1"></a><span class="in">```{r, fig.cap="Left: orinial data. Right: data rotated by XXX degrees around y-axis", fig.width=10, fig.height=5}</span></span>
<span id="cb57-277"><a href="#cb57-277" aria-hidden="true" tabindex="-1"></a><span class="co">#We use -pitch to get the rotation into the lab frame</span></span>
<span id="cb57-278"><a href="#cb57-278" aria-hidden="true" tabindex="-1"></a><span class="fu">make_plot</span>(plane, plane <span class="sc">%*%</span> R.pitch) </span>
<span id="cb57-279"><a href="#cb57-279" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb57-280"><a href="#cb57-280" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb57-281"><a href="#cb57-281" aria-hidden="true" tabindex="-1"></a><span class="fu">###### Takeoff with taxiing</span></span>
<span id="cb57-282"><a href="#cb57-282" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb57-283"><a href="#cb57-283" aria-hidden="true" tabindex="-1"></a>Here, we combine the transformations. Note that this only works with transformations and **rotating the points after the taxiing happened will note work**. A secure way is to start with combined transformation is:</span>
<span id="cb57-284"><a href="#cb57-284" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb57-285"><a href="#cb57-285" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb57-286"><a href="#cb57-286" aria-hidden="true" tabindex="-1"></a>x''=R^{2}_{B \leftarrow L}(\alpha, \beta)\,x=R^{y}(\beta)\,R^z(\alpha)x</span>
<span id="cb57-287"><a href="#cb57-287" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb57-288"><a href="#cb57-288" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb57-289"><a href="#cb57-289" aria-hidden="true" tabindex="-1"></a>for visualization, we have to invert (transpose)</span>
<span id="cb57-290"><a href="#cb57-290" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb57-291"><a href="#cb57-291" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb57-292"><a href="#cb57-292" aria-hidden="true" tabindex="-1"></a>x=(R^{y}(\beta)\,R^z(\alpha))^Tx''=(R^z(\alpha))^T\,(R^{y}(\beta))^Tx''=R^z(-\alpha)\,R^{y}(-\beta)x''</span>
<span id="cb57-293"><a href="#cb57-293" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb57-294"><a href="#cb57-294" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb57-295"><a href="#cb57-295" aria-hidden="true" tabindex="-1"></a><span class="in">```{r, fig.cap="Left: orinial data. Right: data rotated by XXX degrees around y-axis", fig.width=10, fig.height=5}</span></span>
<span id="cb57-296"><a href="#cb57-296" aria-hidden="true" tabindex="-1"></a>R <span class="ot">=</span> R.pitch <span class="sc">%*%</span> R.yaw</span>
<span id="cb57-297"><a href="#cb57-297" aria-hidden="true" tabindex="-1"></a>plane.pitch.yaw <span class="ot">=</span> plane <span class="sc">%*%</span> R</span>
<span id="cb57-298"><a href="#cb57-298" aria-hidden="true" tabindex="-1"></a><span class="fu">make_plot</span>(plane.yaw, plane.pitch.yaw,<span class="at">l1=</span><span class="fu">c</span>(<span class="st">"x'"</span>, <span class="st">"y'"</span>, <span class="st">"z''"</span>), <span class="at">l2=</span><span class="fu">c</span>(<span class="st">"x''"</span>, <span class="st">"y''"</span>, <span class="st">"z''"</span>)) </span>
<span id="cb57-299"><a href="#cb57-299" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb57-300"><a href="#cb57-300" aria-hidden="true" tabindex="-1"></a><span class="co">#plot3d(plane.pitch.yaw[,1],plane.pitch.yaw[,2],plane.pitch.yaw[,3], xlim=c(-1,1), ylim=c(-1,1), zlim=c(-1,1), col=col) </span></span>
<span id="cb57-301"><a href="#cb57-301" aria-hidden="true" tabindex="-1"></a><span class="co">#rglwidget()</span></span>
<span id="cb57-302"><a href="#cb57-302" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb57-303"><a href="#cb57-303" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb57-304"><a href="#cb57-304" aria-hidden="true" tabindex="-1"></a><span class="fu">##### In the air, the roll $\gamma$</span></span>
<span id="cb57-305"><a href="#cb57-305" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb57-306"><a href="#cb57-306" aria-hidden="true" tabindex="-1"></a>Now that we are in the air, we roll the plane about a certain degree around the x-axis. This can be done by</span>
<span id="cb57-307"><a href="#cb57-307" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb57-308"><a href="#cb57-308" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb57-309"><a href="#cb57-309" aria-hidden="true" tabindex="-1"></a>R^x(\gamma) = \begin{bmatrix}</span>
<span id="cb57-310"><a href="#cb57-310" aria-hidden="true" tabindex="-1"></a>1 &amp; 0 &amp; 0<span class="sc">\\</span></span>
<span id="cb57-311"><a href="#cb57-311" aria-hidden="true" tabindex="-1"></a>0 &amp; \cos(\gamma) &amp; \sin(\gamma) <span class="sc">\\</span></span>
<span id="cb57-312"><a href="#cb57-312" aria-hidden="true" tabindex="-1"></a> 0 &amp; -\sin(\gamma) &amp; \cos(\gamma) \end{bmatrix}</span>
<span id="cb57-313"><a href="#cb57-313" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb57-314"><a href="#cb57-314" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb57-317"><a href="#cb57-317" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb57-318"><a href="#cb57-318" aria-hidden="true" tabindex="-1"></a>roll <span class="ot">=</span> <span class="dv">45</span> <span class="sc">*</span> <span class="dv">2</span> <span class="sc">*</span> pi <span class="sc">/</span> <span class="dv">360</span>   <span class="co">#Angle of roll</span></span>
<span id="cb57-319"><a href="#cb57-319" aria-hidden="true" tabindex="-1"></a>Rg <span class="ot">=</span> <span class="cf">function</span>(g) <span class="fu">matrix</span>(</span>
<span id="cb57-320"><a href="#cb57-320" aria-hidden="true" tabindex="-1"></a>      <span class="fu">c</span>(<span class="dv">1</span>,<span class="dv">0</span>,<span class="dv">0</span>, <span class="dv">0</span>, <span class="fu">cos</span>(g), <span class="fu">sin</span>(g), <span class="dv">0</span>, <span class="sc">-</span><span class="fu">sin</span>(g), <span class="fu">cos</span>(g))</span>
<span id="cb57-321"><a href="#cb57-321" aria-hidden="true" tabindex="-1"></a>      , <span class="at">nrow=</span><span class="dv">3</span>, <span class="at">byrow =</span> <span class="cn">TRUE</span>) </span>
<span id="cb57-322"><a href="#cb57-322" aria-hidden="true" tabindex="-1"></a>R.roll<span class="ot">=</span><span class="fu">Rg</span>(roll)</span>
<span id="cb57-323"><a href="#cb57-323" aria-hidden="true" tabindex="-1"></a>R.roll</span>
<span id="cb57-324"><a href="#cb57-324" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb57-325"><a href="#cb57-325" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb57-326"><a href="#cb57-326" aria-hidden="true" tabindex="-1"></a>\</span>
<span id="cb57-327"><a href="#cb57-327" aria-hidden="true" tabindex="-1"></a>The final transformation can be found via</span>
<span id="cb57-328"><a href="#cb57-328" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb57-329"><a href="#cb57-329" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb57-330"><a href="#cb57-330" aria-hidden="true" tabindex="-1"></a>x'''=R^{3}_{B \leftarrow L}(\alpha, \beta, \gamma)\,x= R^{z}(\gamma) R^{y}(\beta)\,R^z(\alpha)x</span>
<span id="cb57-331"><a href="#cb57-331" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb57-332"><a href="#cb57-332" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb57-333"><a href="#cb57-333" aria-hidden="true" tabindex="-1"></a><span class="in">```{r, comp_trafo, fig.cap="Left: orinial data. Right: data rotated by XXX degrees around y-axis", fig.width=10, fig.height=5}</span></span>
<span id="cb57-334"><a href="#cb57-334" aria-hidden="true" tabindex="-1"></a>R <span class="ot">=</span> R.roll <span class="sc">%*%</span> R.pitch <span class="sc">%*%</span> R.yaw</span>
<span id="cb57-335"><a href="#cb57-335" aria-hidden="true" tabindex="-1"></a>plane.roll.pitch.yaw <span class="ot">=</span> plane <span class="sc">%*%</span> R</span>
<span id="cb57-336"><a href="#cb57-336" aria-hidden="true" tabindex="-1"></a><span class="fu">make_plot</span>(plane.pitch.yaw, plane.roll.pitch.yaw,<span class="at">l1=</span><span class="fu">c</span>(<span class="st">"x''"</span>, <span class="st">"y''"</span>, <span class="st">"z''"</span>), <span class="at">l2=</span><span class="fu">c</span>(<span class="st">"x'''"</span>, <span class="st">"y'''"</span>, <span class="st">"z'''"</span>)) </span>
<span id="cb57-337"><a href="#cb57-337" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb57-338"><a href="#cb57-338" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb57-339"><a href="#cb57-339" aria-hidden="true" tabindex="-1"></a><span class="in">```{r, animation, eval=FALSE}</span></span>
<span id="cb57-340"><a href="#cb57-340" aria-hidden="true" tabindex="-1"></a><span class="co">#if (FALSE){</span></span>
<span id="cb57-341"><a href="#cb57-341" aria-hidden="true" tabindex="-1"></a>  <span class="fu">library</span>(manipulate)</span>
<span id="cb57-342"><a href="#cb57-342" aria-hidden="true" tabindex="-1"></a>  <span class="fu">manipulate</span>(</span>
<span id="cb57-343"><a href="#cb57-343" aria-hidden="true" tabindex="-1"></a>    {</span>
<span id="cb57-344"><a href="#cb57-344" aria-hidden="true" tabindex="-1"></a>      Rroll <span class="ot">=</span> <span class="fu">Rg</span>(roll <span class="sc">*</span> <span class="dv">2</span><span class="sc">*</span>pi<span class="sc">/</span><span class="dv">360</span>)</span>
<span id="cb57-345"><a href="#cb57-345" aria-hidden="true" tabindex="-1"></a>      Ryaw  <span class="ot">=</span> <span class="fu">Ra</span>(yaw <span class="sc">*</span> <span class="dv">2</span><span class="sc">*</span>pi<span class="sc">/</span><span class="dv">360</span>)</span>
<span id="cb57-346"><a href="#cb57-346" aria-hidden="true" tabindex="-1"></a>      Rp <span class="ot">=</span> <span class="fu">Rb</span>(pitch<span class="sc">*</span> <span class="dv">2</span><span class="sc">*</span>pi<span class="sc">/</span><span class="dv">360</span>) </span>
<span id="cb57-347"><a href="#cb57-347" aria-hidden="true" tabindex="-1"></a>      Rani <span class="ot">=</span> Rroll <span class="sc">%*%</span> Rp <span class="sc">%*%</span> Ryaw</span>
<span id="cb57-348"><a href="#cb57-348" aria-hidden="true" tabindex="-1"></a>      plane.lab <span class="ot">=</span> plane <span class="sc">%*%</span> Rani</span>
<span id="cb57-349"><a href="#cb57-349" aria-hidden="true" tabindex="-1"></a>      <span class="fu">make_plot</span>(plane, plane.lab,<span class="at">l1=</span><span class="fu">c</span>(<span class="st">"x''"</span>, <span class="st">"y''"</span>, <span class="st">"z''"</span>), <span class="at">l2=</span><span class="fu">c</span>(<span class="st">"x'''"</span>, <span class="st">"y'''"</span>, <span class="st">"z'''"</span>))</span>
<span id="cb57-350"><a href="#cb57-350" aria-hidden="true" tabindex="-1"></a>    },</span>
<span id="cb57-351"><a href="#cb57-351" aria-hidden="true" tabindex="-1"></a>      <span class="at">yaw =</span> <span class="fu">slider</span>(<span class="dv">0</span>, <span class="dv">360</span>, <span class="at">initial =</span> <span class="dv">0</span>),</span>
<span id="cb57-352"><a href="#cb57-352" aria-hidden="true" tabindex="-1"></a>      <span class="at">pitch =</span> <span class="fu">slider</span>(<span class="sc">-</span><span class="dv">90</span>,<span class="dv">90</span>, <span class="at">initial =</span> <span class="dv">0</span>),</span>
<span id="cb57-353"><a href="#cb57-353" aria-hidden="true" tabindex="-1"></a>      <span class="at">roll =</span> <span class="fu">slider</span>(<span class="sc">-</span><span class="dv">180</span>, <span class="dv">180</span>, <span class="at">initial =</span> <span class="dv">0</span>)</span>
<span id="cb57-354"><a href="#cb57-354" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb57-355"><a href="#cb57-355" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb57-356"><a href="#cb57-356" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb57-357"><a href="#cb57-357" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb57-358"><a href="#cb57-358" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb57-359"><a href="#cb57-359" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb57-360"><a href="#cb57-360" aria-hidden="true" tabindex="-1"></a><span class="fu">#### Gimbal Look</span></span>
<span id="cb57-361"><a href="#cb57-361" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb57-362"><a href="#cb57-362" aria-hidden="true" tabindex="-1"></a>Further, in this parameterization the effect of changing the angles by a bit has different effects depending on the values. In the extreme case changing the angle does nothing anymore, which is known under the name gimbals look (see e.g. <span class="co">[</span><span class="ot">here</span><span class="co">](https://towardsdatascience.com/better-rotation-representations-for-accurate-pose-estimation-e890a7e1317f)</span> for a nice demonstration).</span>
<span id="cb57-363"><a href="#cb57-363" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb57-364"><a href="#cb57-364" aria-hidden="true" tabindex="-1"></a><span class="fu"># Quaternions</span></span>
<span id="cb57-365"><a href="#cb57-365" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb57-366"><a href="#cb57-366" aria-hidden="true" tabindex="-1"></a>Besides defining a rotation by 3 elementary rotations, with the many implied ambiguities and the gimbal lock there are other possibilities to describe rotations. Quaterions are such a possibility. They used as standard output format of many libraries such as <span class="co">[</span><span class="ot">AHRS</span><span class="co">](https://ahrs.readthedocs.io/en/latest/index.html#)</span> and the IMU sensors. Quaternions are objects which consists of 4 numbers, and the rotation around a vector can be nicely described with them as we will see in a second. But they also have some mathematical raison d'etre.</span>
<span id="cb57-367"><a href="#cb57-367" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb57-368"><a href="#cb57-368" aria-hidden="true" tabindex="-1"></a><span class="fu">### Definition of Quaternions</span></span>
<span id="cb57-369"><a href="#cb57-369" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb57-370"><a href="#cb57-370" aria-hidden="true" tabindex="-1"></a>Complex numbers $|a|e^{i \theta}$ describe points in the real / imaginary space. Rotations in 2D can be nicely described by them using multiplications. Quaternions can be seen as a generalization of complex numbers with two more imaginary like units $i,j,k$. Using these, the quaternion can be written as:</span>
<span id="cb57-371"><a href="#cb57-371" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb57-372"><a href="#cb57-372" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb57-373"><a href="#cb57-373" aria-hidden="true" tabindex="-1"></a>q =  (q_w, q_1, q_2, q_3) = q_w + q_1 i + q_2 j + q_3 k</span>
<span id="cb57-374"><a href="#cb57-374" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb57-375"><a href="#cb57-375" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb57-376"><a href="#cb57-376" aria-hidden="true" tabindex="-1"></a>The basis have some properties (there are more)</span>
<span id="cb57-377"><a href="#cb57-377" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb57-378"><a href="#cb57-378" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb57-379"><a href="#cb57-379" aria-hidden="true" tabindex="-1"></a>  i^2=j^2=k^2=ijk=-1 \;\; ij = -ji = k </span>
<span id="cb57-380"><a href="#cb57-380" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb57-381"><a href="#cb57-381" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb57-382"><a href="#cb57-382" aria-hidden="true" tabindex="-1"></a>The length of a quaternion can be determined as:</span>
<span id="cb57-383"><a href="#cb57-383" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb57-384"><a href="#cb57-384" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb57-385"><a href="#cb57-385" aria-hidden="true" tabindex="-1"></a>  ||q|| = \sqrt{q_w^2 + q_1^2 + q_2^2 + q_3^2 }</span>
<span id="cb57-386"><a href="#cb57-386" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb57-387"><a href="#cb57-387" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb57-388"><a href="#cb57-388" aria-hidden="true" tabindex="-1"></a>Here, we are dealing with quaternions of length 1 and almost all quaternions used in Computergraphics are unit quaternions or a.k.a. *rotation quaternions*.</span>
<span id="cb57-389"><a href="#cb57-389" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb57-390"><a href="#cb57-390" aria-hidden="true" tabindex="-1"></a><span class="fu">### Geometric Representation</span></span>
<span id="cb57-391"><a href="#cb57-391" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb57-392"><a href="#cb57-392" aria-hidden="true" tabindex="-1"></a>Rotations can be described by unit vector $\vec{v}=(v_x,v_y,v_z)$ and a counter clock wise rotation around this vector by an angle $\theta$. This is shown in the following figure</span>
<span id="cb57-393"><a href="#cb57-393" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb57-394"><a href="#cb57-394" aria-hidden="true" tabindex="-1"></a><span class="al">![Rotation around a vector](images/rotation_abitrary_vector.png)</span>{#fig-rot}</span>
<span id="cb57-395"><a href="#cb57-395" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb57-396"><a href="#cb57-396" aria-hidden="true" tabindex="-1"></a>Unit quaternions $q = (w, q_1, q_2, q_3)$ with $||q||_2=1$ can be translated</span>
<span id="cb57-397"><a href="#cb57-397" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb57-398"><a href="#cb57-398" aria-hidden="true" tabindex="-1"></a>the following connection to the unit rotation vector $\vec{r}=(v_1, v_2, v_3)$ holds:</span>
<span id="cb57-399"><a href="#cb57-399" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb57-400"><a href="#cb57-400" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb57-401"><a href="#cb57-401" aria-hidden="true" tabindex="-1"></a>  q(\theta, v) = \cos(\frac{\theta}{2}) w + i \sin(\frac{\theta}{2}) v_1 +</span>
<span id="cb57-402"><a href="#cb57-402" aria-hidden="true" tabindex="-1"></a>  j \sin(\frac{\theta}{2}) v_2 + k \sin(\frac{\theta}{2}) v_3 </span>
<span id="cb57-403"><a href="#cb57-403" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb57-404"><a href="#cb57-404" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb57-405"><a href="#cb57-405" aria-hidden="true" tabindex="-1"></a>or componentwise</span>
<span id="cb57-406"><a href="#cb57-406" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb57-407"><a href="#cb57-407" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb57-408"><a href="#cb57-408" aria-hidden="true" tabindex="-1"></a> q(\theta, v) =  \left(\cos(\frac{\theta}{2}) w,\; \sin(\frac{\theta}{2})  v_1, \;\sin(\frac{\theta} {2}) v_2, \;\sin(\frac{\theta}{2}) v_3 \right)</span>
<span id="cb57-409"><a href="#cb57-409" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb57-410"><a href="#cb57-410" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb57-411"><a href="#cb57-411" aria-hidden="true" tabindex="-1"></a>here $\theta$ is the rotation about the unit vector.</span>
<span id="cb57-412"><a href="#cb57-412" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb57-413"><a href="#cb57-413" aria-hidden="true" tabindex="-1"></a>The length of $q$ is $||q||=\cos^2(\theta/2) w + \sin^2(\theta/2) (v_1^2 + v_2^2 + v_3^2) = \cos^2(\theta/2) w + \sin^2(\theta/2)$ and hence we need to choose $w=1$ for the unit quaternion.</span>
<span id="cb57-414"><a href="#cb57-414" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb57-415"><a href="#cb57-415" aria-hidden="true" tabindex="-1"></a><span class="fu">#### Construction of quaternion from vector and angle</span></span>
<span id="cb57-416"><a href="#cb57-416" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb57-417"><a href="#cb57-417" aria-hidden="true" tabindex="-1"></a>Consider the plane from above. At the start ($t=0$) the laboratory coordinate system corresponds to the one in the plane. This can be described by no rotation $\theta=0$ about any axis $q(0) = (\cos(0), v_1 \sin(0), v_2 \sin(0), v_3 \sin(0) = (1,0,0,0)$. Then before the liftoff it looks in the xy-direction, that is a rotation about 45 degres ($\theta = 45/360 \cdot 2 \cdot pi \approx 0.785$) around $\vec{r} = (0,0,1)$ and $q(1) = (\cos(0.785/2), 0, 0, \sin(0.785/2))$.</span>
<span id="cb57-418"><a href="#cb57-418" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb57-419"><a href="#cb57-419" aria-hidden="true" tabindex="-1"></a><span class="fu">### Quaterion Algebra</span></span>
<span id="cb57-420"><a href="#cb57-420" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb57-421"><a href="#cb57-421" aria-hidden="true" tabindex="-1"></a><span class="ss">-   </span>Addition (easy but no geometeric interpretation), just for reference $$</span>
<span id="cb57-422"><a href="#cb57-422" aria-hidden="true" tabindex="-1"></a>    q + p = p + q =  q_w + p_w + (q_1 + p_1) i + (q_2 + p_2) j + (q_3 + p_3) k</span>
<span id="cb57-423"><a href="#cb57-423" aria-hidden="true" tabindex="-1"></a>    $$</span>
<span id="cb57-424"><a href="#cb57-424" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb57-425"><a href="#cb57-425" aria-hidden="true" tabindex="-1"></a><span class="ss">-   </span>Multiplication: The multiplication is not commutative $$</span>
<span id="cb57-426"><a href="#cb57-426" aria-hidden="true" tabindex="-1"></a>    q * p \ne p * q = \tt{Complicated Formula}</span>
<span id="cb57-427"><a href="#cb57-427" aria-hidden="true" tabindex="-1"></a>    $$</span>
<span id="cb57-428"><a href="#cb57-428" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb57-429"><a href="#cb57-429" aria-hidden="true" tabindex="-1"></a><span class="ss">-   </span>Conjugate (just i --<span class="sc">\&gt;</span> -i same for j and k) $$</span>
<span id="cb57-430"><a href="#cb57-430" aria-hidden="true" tabindex="-1"></a>    q^* = q_w − i q_x − j q_y − k q_z</span>
<span id="cb57-431"><a href="#cb57-431" aria-hidden="true" tabindex="-1"></a>    $$</span>
<span id="cb57-432"><a href="#cb57-432" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb57-433"><a href="#cb57-433" aria-hidden="true" tabindex="-1"></a><span class="ss">-   </span>Inverse $$</span>
<span id="cb57-434"><a href="#cb57-434" aria-hidden="true" tabindex="-1"></a>    q^{-1} = q^*/||q||</span>
<span id="cb57-435"><a href="#cb57-435" aria-hidden="true" tabindex="-1"></a>    $$</span>
<span id="cb57-436"><a href="#cb57-436" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb57-437"><a href="#cb57-437" aria-hidden="true" tabindex="-1"></a>So for unit quaternions, you just have to conjugate to get the inverse. Luckily, we don't have to remember the formulaes and can use the onion-package.</span>
<span id="cb57-438"><a href="#cb57-438" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb57-439"><a href="#cb57-439" aria-hidden="true" tabindex="-1"></a><span class="fu">### Constructing a rotation matrix from Quaterions (first solution)</span></span>
<span id="cb57-440"><a href="#cb57-440" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb57-441"><a href="#cb57-441" aria-hidden="true" tabindex="-1"></a>It's possible to translate the quaternions back to a rotation matrix, see <span class="co">[</span><span class="ot">quat_to_mat</span><span class="co">](https://github.com/oduerr/gesture/blob/main/R/rotation_utils.R)</span>. The code has been taken from https://automaticaddison.com/how-to-convert-a-quaternion-to-a-rotation-matrix/</span>
<span id="cb57-442"><a href="#cb57-442" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb57-445"><a href="#cb57-445" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb57-446"><a href="#cb57-446" aria-hidden="true" tabindex="-1"></a>  t_05 <span class="ot">=</span> <span class="dv">0</span> <span class="co">#half of theta</span></span>
<span id="cb57-447"><a href="#cb57-447" aria-hidden="true" tabindex="-1"></a>  q0_d <span class="ot">=</span> <span class="fu">c</span>(<span class="fu">cos</span>(t_05), <span class="fu">sin</span>(t_05), <span class="fu">sin</span>(t_05), <span class="fu">sin</span>(t_05))</span>
<span id="cb57-448"><a href="#cb57-448" aria-hidden="true" tabindex="-1"></a>  t_05 <span class="ot">=</span> <span class="dv">45</span><span class="sc">/</span><span class="dv">360</span> <span class="sc">*</span> pi <span class="co">#half of theta</span></span>
<span id="cb57-449"><a href="#cb57-449" aria-hidden="true" tabindex="-1"></a>  q01 <span class="ot">=</span> <span class="fu">c</span>(<span class="fu">cos</span>(t_05), <span class="dv">0</span><span class="sc">*</span><span class="fu">sin</span>(t_05), <span class="dv">0</span><span class="sc">*</span><span class="fu">sin</span>(t_05), <span class="dv">1</span><span class="sc">*</span><span class="fu">sin</span>(t_05))</span>
<span id="cb57-450"><a href="#cb57-450" aria-hidden="true" tabindex="-1"></a>  <span class="co">#sum(q01^2) #1</span></span>
<span id="cb57-451"><a href="#cb57-451" aria-hidden="true" tabindex="-1"></a>  <span class="fu">quat_to_mat</span>(q01)</span>
<span id="cb57-452"><a href="#cb57-452" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb57-453"><a href="#cb57-453" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb57-454"><a href="#cb57-454" aria-hidden="true" tabindex="-1"></a><span class="fu">### Chaining rotations with quaterions (just multiply them)</span></span>
<span id="cb57-455"><a href="#cb57-455" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb57-456"><a href="#cb57-456" aria-hidden="true" tabindex="-1"></a>Now comes properly the most useful thing, that successive rotations can be done by multiplying the respective quaternions. Let's try this out.</span>
<span id="cb57-457"><a href="#cb57-457" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb57-458"><a href="#cb57-458" aria-hidden="true" tabindex="-1"></a>Let's multiply several quaternions. We start with $q_0 = (1,0,0,0)$.</span>
<span id="cb57-459"><a href="#cb57-459" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb57-460"><a href="#cb57-460" aria-hidden="true" tabindex="-1"></a><span class="in">```{r, warning=FALSE, name='bunny1', fig.width=5, fig.height=5, fig.align='center', cache=TRUE}</span></span>
<span id="cb57-461"><a href="#cb57-461" aria-hidden="true" tabindex="-1"></a>  q0 <span class="ot">=</span> onion<span class="sc">::</span><span class="fu">quaternion</span>(<span class="at">Re =</span> <span class="dv">1</span>)</span>
<span id="cb57-462"><a href="#cb57-462" aria-hidden="true" tabindex="-1"></a>  <span class="fu">p3d</span>(rabbit <span class="sc">%*%</span> <span class="fu">quat_to_mat</span>(q0), <span class="at">h=</span><span class="cn">NULL</span>, <span class="at">main =</span> <span class="st">'q0'</span>)</span>
<span id="cb57-463"><a href="#cb57-463" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb57-464"><a href="#cb57-464" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb57-465"><a href="#cb57-465" aria-hidden="true" tabindex="-1"></a>We add a second rotation (a first real) around the z-axis.</span>
<span id="cb57-466"><a href="#cb57-466" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb57-467"><a href="#cb57-467" aria-hidden="true" tabindex="-1"></a><span class="in">```{r, warning=FALSE, name='bunny1', fig.width=5, fig.height=5, fig.align='center', cache=TRUE}</span></span>
<span id="cb57-468"><a href="#cb57-468" aria-hidden="true" tabindex="-1"></a>  q1 <span class="ot">=</span> <span class="fu">quaternion</span>(<span class="at">Re=</span><span class="fu">cos</span>(<span class="sc">-</span><span class="dv">45</span><span class="sc">/</span><span class="dv">360</span> <span class="sc">*</span>pi), <span class="at">i =</span> <span class="dv">0</span>, <span class="at">j =</span> <span class="dv">0</span>, <span class="at">k =</span> <span class="dv">1</span><span class="sc">*</span><span class="fu">sin</span>(<span class="sc">-</span><span class="dv">45</span><span class="sc">/</span><span class="dv">360</span> <span class="sc">*</span>pi)) </span>
<span id="cb57-469"><a href="#cb57-469" aria-hidden="true" tabindex="-1"></a>  <span class="fu">p3d</span>(rabbit <span class="sc">%*%</span> <span class="fu">quat_to_mat</span>(q0 <span class="sc">*</span> q1), <span class="at">h=</span><span class="cn">NULL</span>, <span class="at">main =</span> <span class="st">'q0 * q1'</span>) </span>
<span id="cb57-470"><a href="#cb57-470" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb57-471"><a href="#cb57-471" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb57-472"><a href="#cb57-472" aria-hidden="true" tabindex="-1"></a>We add a third rotation around the x-axis.</span>
<span id="cb57-473"><a href="#cb57-473" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb57-474"><a href="#cb57-474" aria-hidden="true" tabindex="-1"></a><span class="in">```{r, bunny3, warning=FALSE, fig.width=5, fig.height=5, fig.align='center', cache=TRUE}</span></span>
<span id="cb57-475"><a href="#cb57-475" aria-hidden="true" tabindex="-1"></a>  q2 <span class="ot">=</span> <span class="fu">quaternion</span>(<span class="at">Re=</span><span class="fu">cos</span>(<span class="sc">-</span><span class="dv">45</span><span class="sc">/</span><span class="dv">360</span> <span class="sc">*</span>pi), <span class="at">i =</span> <span class="dv">1</span><span class="sc">*</span><span class="fu">sin</span>(<span class="sc">-</span><span class="dv">45</span><span class="sc">/</span><span class="dv">360</span> <span class="sc">*</span>pi), <span class="at">j =</span> <span class="dv">0</span>, <span class="at">k =</span> <span class="dv">0</span>) </span>
<span id="cb57-476"><a href="#cb57-476" aria-hidden="true" tabindex="-1"></a>  q012 <span class="ot">=</span> q0 <span class="sc">*</span> q1 <span class="sc">*</span> q2 </span>
<span id="cb57-477"><a href="#cb57-477" aria-hidden="true" tabindex="-1"></a>  <span class="fu">p3d</span>(rabbit <span class="sc">%*%</span> <span class="fu">quat_to_mat</span>(q012), <span class="at">h=</span><span class="cn">NULL</span>, <span class="at">main =</span> <span class="st">'q0 * q1 * q2'</span>)</span>
<span id="cb57-478"><a href="#cb57-478" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb57-479"><a href="#cb57-479" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb57-480"><a href="#cb57-480" aria-hidden="true" tabindex="-1"></a>Using the order $q_0 q_1 q_2$ you transfer the data of the bunny.</span>
<span id="cb57-481"><a href="#cb57-481" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb57-482"><a href="#cb57-482" aria-hidden="true" tabindex="-1"></a><span class="fu">### Pure Quaternions (real part = 0)</span></span>
<span id="cb57-483"><a href="#cb57-483" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb57-484"><a href="#cb57-484" aria-hidden="true" tabindex="-1"></a>We can also use quaterions to transform vectors, without the need to explicitly construct the rotation matrix as done with the bunny data above. This is done with so-called unit or vector quaternions. To obtain a vector quaternions, we set the real part to 0 and use the vector in space as the vector part. That is a vector $\vec{v}$ in a certain direction without coding a rotation. From this vector, we like to know the position to which it gets rotated by $R(q) \vec{v}$ the rotation matrix $R(q)$ corresponding to $q$. It can be shown that this is</span>
<span id="cb57-485"><a href="#cb57-485" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb57-486"><a href="#cb57-486" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb57-487"><a href="#cb57-487" aria-hidden="true" tabindex="-1"></a>  R(q) \vec{v} = q \cdot (0,\vec{v}) \cdot q^{-1} </span>
<span id="cb57-488"><a href="#cb57-488" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb57-489"><a href="#cb57-489" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb57-492"><a href="#cb57-492" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb57-493"><a href="#cb57-493" aria-hidden="true" tabindex="-1"></a> q <span class="ot">=</span> q0 <span class="sc">*</span> q1 <span class="sc">*</span> q2 <span class="co">#A unit quaterion defining the direction</span></span>
<span id="cb57-494"><a href="#cb57-494" aria-hidden="true" tabindex="-1"></a> vec <span class="ot">=</span> <span class="fu">matrix</span>(<span class="fu">c</span>(<span class="dv">12</span>,<span class="dv">13</span>,<span class="dv">45</span>), <span class="at">ncol=</span><span class="dv">1</span>) <span class="co">#A vector with which we do the </span></span>
<span id="cb57-495"><a href="#cb57-495" aria-hidden="true" tabindex="-1"></a> <span class="fu">quat_to_mat</span>(q) <span class="sc">%*%</span> vec</span>
<span id="cb57-496"><a href="#cb57-496" aria-hidden="true" tabindex="-1"></a> </span>
<span id="cb57-497"><a href="#cb57-497" aria-hidden="true" tabindex="-1"></a> vec_q <span class="ot">=</span> <span class="fu">quaternion</span>(<span class="at">Re =</span> <span class="dv">0</span>, <span class="at">i =</span> vec[<span class="dv">1</span>], <span class="at">j=</span>vec[<span class="dv">2</span>], <span class="at">k=</span>vec[<span class="dv">3</span>])</span>
<span id="cb57-498"><a href="#cb57-498" aria-hidden="true" tabindex="-1"></a> <span class="co">#q^-1 is the inverse, which for rotation quaternions is the conjugate </span></span>
<span id="cb57-499"><a href="#cb57-499" aria-hidden="true" tabindex="-1"></a> q <span class="sc">*</span> vec_q <span class="sc">*</span> q<span class="sc">^-</span><span class="dv">1</span></span>
<span id="cb57-500"><a href="#cb57-500" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb57-501"><a href="#cb57-501" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb57-502"><a href="#cb57-502" aria-hidden="true" tabindex="-1"></a>TODO build intuition for this expression.</span>
<span id="cb57-503"><a href="#cb57-503" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb57-504"><a href="#cb57-504" aria-hidden="true" tabindex="-1"></a><span class="fu">#### Using pure quaterions to get the rotation matrix.</span></span>
<span id="cb57-505"><a href="#cb57-505" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb57-506"><a href="#cb57-506" aria-hidden="true" tabindex="-1"></a>We can use pure quaterions to get the rotation matrix. To make the problem harder, we use a more complicated quaternion:</span>
<span id="cb57-507"><a href="#cb57-507" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb57-510"><a href="#cb57-510" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb57-511"><a href="#cb57-511" aria-hidden="true" tabindex="-1"></a>q <span class="ot">=</span> <span class="fu">c</span>(<span class="fl">0.320</span>,  <span class="fl">0.300</span>,  <span class="fl">0.290</span>, <span class="sc">-</span><span class="fl">0.850</span>) </span>
<span id="cb57-512"><a href="#cb57-512" aria-hidden="true" tabindex="-1"></a>q <span class="ot">=</span> q <span class="sc">/</span> <span class="fu">sqrt</span>(<span class="fu">sum</span>(q<span class="sc">^</span><span class="dv">2</span>))</span>
<span id="cb57-513"><a href="#cb57-513" aria-hidden="true" tabindex="-1"></a>q <span class="ot">=</span> <span class="fu">quaternion</span>(<span class="at">Re=</span>q[<span class="dv">1</span>], <span class="at">i=</span>q[<span class="dv">2</span>], <span class="at">j=</span>q[<span class="dv">3</span>], <span class="at">k=</span>q[<span class="dv">4</span>])</span>
<span id="cb57-514"><a href="#cb57-514" aria-hidden="true" tabindex="-1"></a><span class="fu">t</span>(q<span class="sc">@</span>x)</span>
<span id="cb57-515"><a href="#cb57-515" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb57-516"><a href="#cb57-516" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb57-517"><a href="#cb57-517" aria-hidden="true" tabindex="-1"></a>We use the fact that the transformation is given by the results of the unit vectors of the first coordinate system:</span>
<span id="cb57-518"><a href="#cb57-518" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb57-521"><a href="#cb57-521" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb57-522"><a href="#cb57-522" aria-hidden="true" tabindex="-1"></a> <span class="fu">round</span>(<span class="fu">quat_to_mat</span>(q), <span class="dv">4</span>)</span>
<span id="cb57-523"><a href="#cb57-523" aria-hidden="true" tabindex="-1"></a> </span>
<span id="cb57-524"><a href="#cb57-524" aria-hidden="true" tabindex="-1"></a> e1b <span class="ot">=</span> q <span class="sc">*</span> <span class="fu">quaternion</span>(<span class="at">Re =</span> <span class="dv">0</span>, <span class="at">i =</span> <span class="dv">1</span>) <span class="sc">*</span> q<span class="sc">^-</span><span class="dv">1</span> </span>
<span id="cb57-525"><a href="#cb57-525" aria-hidden="true" tabindex="-1"></a> e2b <span class="ot">=</span> q <span class="sc">*</span> <span class="fu">quaternion</span>(<span class="at">Re =</span> <span class="dv">0</span>, <span class="at">j =</span> <span class="dv">1</span>) <span class="sc">*</span> q<span class="sc">^-</span><span class="dv">1</span> </span>
<span id="cb57-526"><a href="#cb57-526" aria-hidden="true" tabindex="-1"></a> e3b <span class="ot">=</span> q <span class="sc">*</span> <span class="fu">quaternion</span>(<span class="at">Re =</span> <span class="dv">0</span>, <span class="at">k =</span> <span class="dv">1</span>) <span class="sc">*</span> q<span class="sc">^-</span><span class="dv">1</span> </span>
<span id="cb57-527"><a href="#cb57-527" aria-hidden="true" tabindex="-1"></a> <span class="fu">matrix</span>(<span class="fu">c</span>(</span>
<span id="cb57-528"><a href="#cb57-528" aria-hidden="true" tabindex="-1"></a>          e1b<span class="sc">@</span>x[<span class="dv">2</span><span class="sc">:</span><span class="dv">4</span>],</span>
<span id="cb57-529"><a href="#cb57-529" aria-hidden="true" tabindex="-1"></a>          e2b<span class="sc">@</span>x[<span class="dv">2</span><span class="sc">:</span><span class="dv">4</span>],</span>
<span id="cb57-530"><a href="#cb57-530" aria-hidden="true" tabindex="-1"></a>          e3b<span class="sc">@</span>x[<span class="dv">2</span><span class="sc">:</span><span class="dv">4</span>])</span>
<span id="cb57-531"><a href="#cb57-531" aria-hidden="true" tabindex="-1"></a> ,<span class="at">nrow=</span><span class="dv">3</span>) <span class="sc">%&gt;%</span> <span class="fu">round</span>(<span class="dv">4</span>)</span>
<span id="cb57-532"><a href="#cb57-532" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb57-533"><a href="#cb57-533" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb57-534"><a href="#cb57-534" aria-hidden="true" tabindex="-1"></a><span class="fu">### Flight Coordinates from Quaterions</span></span>
<span id="cb57-535"><a href="#cb57-535" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb57-536"><a href="#cb57-536" aria-hidden="true" tabindex="-1"></a>In the definition above has defined as</span>
<span id="cb57-537"><a href="#cb57-537" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb57-538"><a href="#cb57-538" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb57-539"><a href="#cb57-539" aria-hidden="true" tabindex="-1"></a>  R_{\text{Body} \leftarrow \text{Lab}} =  R_{roll} \, R_{pitch}\, R_{yaw} </span>
<span id="cb57-540"><a href="#cb57-540" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb57-541"><a href="#cb57-541" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb57-542"><a href="#cb57-542" aria-hidden="true" tabindex="-1"></a><span class="in">```{r, comparison_rot_mat}</span></span>
<span id="cb57-543"><a href="#cb57-543" aria-hidden="true" tabindex="-1"></a>  qyaw <span class="ot">=</span> <span class="fu">quaternion</span>(<span class="at">Re=</span><span class="fu">cos</span>(yaw<span class="sc">/</span><span class="dv">2</span>), <span class="at">i=</span><span class="dv">0</span>,<span class="at">j=</span><span class="dv">0</span>,<span class="at">k=</span><span class="fu">sin</span>(yaw<span class="sc">/</span><span class="dv">2</span>))</span>
<span id="cb57-544"><a href="#cb57-544" aria-hidden="true" tabindex="-1"></a>  qpitch <span class="ot">=</span> <span class="fu">quaternion</span>(<span class="at">Re=</span><span class="fu">cos</span>(pitch<span class="sc">/</span><span class="dv">2</span>), <span class="at">i=</span><span class="dv">0</span>,<span class="at">j=</span><span class="fu">sin</span>(pitch<span class="sc">/</span><span class="dv">2</span>),<span class="at">k=</span><span class="dv">0</span>)</span>
<span id="cb57-545"><a href="#cb57-545" aria-hidden="true" tabindex="-1"></a>  qroll <span class="ot">=</span> <span class="fu">quaternion</span>(<span class="at">Re=</span><span class="fu">cos</span>(roll<span class="sc">/</span><span class="dv">2</span>), <span class="at">i=</span><span class="fu">sin</span>(roll<span class="sc">/</span><span class="dv">2</span>), <span class="at">j=</span><span class="dv">0</span>,<span class="at">k=</span><span class="dv">0</span>)</span>
<span id="cb57-546"><a href="#cb57-546" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (<span class="cn">FALSE</span>) { <span class="co">#For debugging</span></span>
<span id="cb57-547"><a href="#cb57-547" aria-hidden="true" tabindex="-1"></a>    <span class="fu">sum</span>(qyaw<span class="sc">@</span>x<span class="sc">^</span><span class="dv">2</span>) <span class="co">#1</span></span>
<span id="cb57-548"><a href="#cb57-548" aria-hidden="true" tabindex="-1"></a>    <span class="fu">sum</span>(qpitch<span class="sc">@</span>x<span class="sc">^</span><span class="dv">2</span>) <span class="co">#1</span></span>
<span id="cb57-549"><a href="#cb57-549" aria-hidden="true" tabindex="-1"></a>    <span class="fu">sum</span>(qroll<span class="sc">@</span>x<span class="sc">^</span><span class="dv">2</span>) <span class="co">#1</span></span>
<span id="cb57-550"><a href="#cb57-550" aria-hidden="true" tabindex="-1"></a>    <span class="co">#R = R.roll %*% R.pitch %*% R.yaw</span></span>
<span id="cb57-551"><a href="#cb57-551" aria-hidden="true" tabindex="-1"></a>    <span class="fu">sum</span>((<span class="fu">quat_to_mat</span>(qyaw) <span class="sc">-</span> <span class="fu">t</span>(R.yaw))<span class="sc">^</span><span class="dv">2</span>) <span class="co">#2.46519e-32</span></span>
<span id="cb57-552"><a href="#cb57-552" aria-hidden="true" tabindex="-1"></a>    <span class="fu">sum</span>((<span class="fu">quat_to_mat</span>(qpitch) <span class="sc">-</span> <span class="fu">t</span>(R.pitch))<span class="sc">^</span><span class="dv">2</span>) <span class="co">#2.46519e-32</span></span>
<span id="cb57-553"><a href="#cb57-553" aria-hidden="true" tabindex="-1"></a>    <span class="fu">sum</span>((<span class="fu">quat_to_mat</span>(qroll) <span class="sc">-</span> <span class="fu">t</span>(R.roll))<span class="sc">^</span><span class="dv">2</span>) <span class="co">#4.930381e-32</span></span>
<span id="cb57-554"><a href="#cb57-554" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb57-555"><a href="#cb57-555" aria-hidden="true" tabindex="-1"></a>  <span class="co">#In that definition the quanterions describe the inverse</span></span>
<span id="cb57-556"><a href="#cb57-556" aria-hidden="true" tabindex="-1"></a>  qcomb_body_to_lab <span class="ot">=</span> qyaw <span class="sc">*</span> qpitch <span class="sc">*</span> qroll</span>
<span id="cb57-557"><a href="#cb57-557" aria-hidden="true" tabindex="-1"></a>  qcomb_lab_to_body <span class="ot">=</span> qcomb_body_to_lab<span class="sc">^-</span><span class="dv">1</span></span>
<span id="cb57-558"><a href="#cb57-558" aria-hidden="true" tabindex="-1"></a>  <span class="fu">quat_to_mat</span>(qcomb_lab_to_body)</span>
<span id="cb57-559"><a href="#cb57-559" aria-hidden="true" tabindex="-1"></a>  R </span>
<span id="cb57-560"><a href="#cb57-560" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb57-561"><a href="#cb57-561" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb57-562"><a href="#cb57-562" aria-hidden="true" tabindex="-1"></a>Testing the package</span>
<span id="cb57-563"><a href="#cb57-563" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb57-564"><a href="#cb57-564" aria-hidden="true" tabindex="-1"></a><span class="in">```{r, test_package}</span></span>
<span id="cb57-565"><a href="#cb57-565" aria-hidden="true" tabindex="-1"></a>quart_to_ypr <span class="ot">=</span> <span class="cf">function</span>(q){</span>
<span id="cb57-566"><a href="#cb57-566" aria-hidden="true" tabindex="-1"></a>    w <span class="ot">=</span> q[<span class="dv">1</span>]</span>
<span id="cb57-567"><a href="#cb57-567" aria-hidden="true" tabindex="-1"></a>    x <span class="ot">=</span> q[<span class="dv">2</span>]</span>
<span id="cb57-568"><a href="#cb57-568" aria-hidden="true" tabindex="-1"></a>    y <span class="ot">=</span> q[<span class="dv">3</span>]</span>
<span id="cb57-569"><a href="#cb57-569" aria-hidden="true" tabindex="-1"></a>    z <span class="ot">=</span> q[<span class="dv">4</span>]</span>
<span id="cb57-570"><a href="#cb57-570" aria-hidden="true" tabindex="-1"></a>    roll <span class="ot">=</span> <span class="fu">atan2</span>(<span class="dv">2</span> <span class="sc">*</span> (w <span class="sc">*</span> x <span class="sc">+</span> y <span class="sc">*</span> z), <span class="dv">1</span> <span class="sc">-</span> <span class="dv">2</span> <span class="sc">*</span> (x <span class="sc">*</span> x <span class="sc">+</span> y <span class="sc">*</span> y))</span>
<span id="cb57-571"><a href="#cb57-571" aria-hidden="true" tabindex="-1"></a>    pitch <span class="ot">=</span> <span class="fu">asin</span>(<span class="dv">2</span> <span class="sc">*</span> (w <span class="sc">*</span> y <span class="sc">-</span> x <span class="sc">*</span> z))</span>
<span id="cb57-572"><a href="#cb57-572" aria-hidden="true" tabindex="-1"></a>    yaw <span class="ot">=</span> <span class="fu">atan2</span>(<span class="dv">2</span> <span class="sc">*</span> (w <span class="sc">*</span> z <span class="sc">+</span> x <span class="sc">*</span> y), <span class="dv">1</span> <span class="sc">-</span> <span class="dv">2</span> <span class="sc">*</span> (z <span class="sc">*</span> z <span class="sc">+</span> y <span class="sc">*</span> y))</span>
<span id="cb57-573"><a href="#cb57-573" aria-hidden="true" tabindex="-1"></a>    <span class="fu">return</span>(<span class="fu">c</span>(yaw,pitch,roll))</span>
<span id="cb57-574"><a href="#cb57-574" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb57-575"><a href="#cb57-575" aria-hidden="true" tabindex="-1"></a><span class="fu">quart_to_ypr</span>(qcomb_lab_to_body<span class="sc">@</span>x) <span class="co">#Wrong </span></span>
<span id="cb57-576"><a href="#cb57-576" aria-hidden="true" tabindex="-1"></a><span class="fu">quart_to_ypr</span>(qcomb_body_to_lab<span class="sc">@</span>x) <span class="co">#Correct</span></span>
<span id="cb57-577"><a href="#cb57-577" aria-hidden="true" tabindex="-1"></a><span class="fu">c</span>(yaw, pitch, roll)</span>
<span id="cb57-578"><a href="#cb57-578" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb57-579"><a href="#cb57-579" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb57-582"><a href="#cb57-582" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb57-583"><a href="#cb57-583" aria-hidden="true" tabindex="-1"></a><span class="co">#As it is currently implented</span></span>
<span id="cb57-584"><a href="#cb57-584" aria-hidden="true" tabindex="-1"></a>dmpGetGravity <span class="ot">=</span> <span class="cf">function</span>(q){</span>
<span id="cb57-585"><a href="#cb57-585" aria-hidden="true" tabindex="-1"></a>  qw <span class="ot">=</span> q[<span class="dv">1</span>]</span>
<span id="cb57-586"><a href="#cb57-586" aria-hidden="true" tabindex="-1"></a>  qx <span class="ot">=</span> q[<span class="dv">2</span>]</span>
<span id="cb57-587"><a href="#cb57-587" aria-hidden="true" tabindex="-1"></a>  qy <span class="ot">=</span> q[<span class="dv">3</span>]</span>
<span id="cb57-588"><a href="#cb57-588" aria-hidden="true" tabindex="-1"></a>  qz <span class="ot">=</span> q[<span class="dv">4</span>]</span>
<span id="cb57-589"><a href="#cb57-589" aria-hidden="true" tabindex="-1"></a>  vx <span class="ot">=</span> <span class="dv">2</span> <span class="sc">*</span> (qx <span class="sc">*</span> qz <span class="sc">-</span> qw<span class="sc">*</span>qy)</span>
<span id="cb57-590"><a href="#cb57-590" aria-hidden="true" tabindex="-1"></a>  vy <span class="ot">=</span> <span class="dv">2</span> <span class="sc">*</span> (qw <span class="sc">*</span> qx <span class="sc">+</span> qy<span class="sc">*</span>qz)</span>
<span id="cb57-591"><a href="#cb57-591" aria-hidden="true" tabindex="-1"></a>  vz <span class="ot">=</span> qw<span class="sc">^</span><span class="dv">2</span> <span class="sc">-</span> qx<span class="sc">^</span><span class="dv">2</span> <span class="sc">-</span> qy<span class="sc">^</span><span class="dv">2</span> <span class="sc">+</span> qz<span class="sc">^</span><span class="dv">2</span></span>
<span id="cb57-592"><a href="#cb57-592" aria-hidden="true" tabindex="-1"></a>  <span class="fu">return</span>(<span class="fu">c</span>(vx,vy,vz))</span>
<span id="cb57-593"><a href="#cb57-593" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb57-594"><a href="#cb57-594" aria-hidden="true" tabindex="-1"></a>dmpGetYawPitchRoll <span class="ot">=</span> <span class="cf">function</span>(q, gravity){</span>
<span id="cb57-595"><a href="#cb57-595" aria-hidden="true" tabindex="-1"></a>  qw <span class="ot">=</span> q[<span class="dv">1</span>]</span>
<span id="cb57-596"><a href="#cb57-596" aria-hidden="true" tabindex="-1"></a>  qx <span class="ot">=</span> q[<span class="dv">2</span>]</span>
<span id="cb57-597"><a href="#cb57-597" aria-hidden="true" tabindex="-1"></a>  qy <span class="ot">=</span> q[<span class="dv">3</span>]</span>
<span id="cb57-598"><a href="#cb57-598" aria-hidden="true" tabindex="-1"></a>  qz <span class="ot">=</span> q[<span class="dv">4</span>]</span>
<span id="cb57-599"><a href="#cb57-599" aria-hidden="true" tabindex="-1"></a>  yaw <span class="ot">=</span> <span class="fu">atan2</span>(<span class="dv">2</span><span class="sc">*</span>qx<span class="sc">*</span>qy <span class="sc">-</span> <span class="dv">2</span><span class="sc">*</span>qw<span class="sc">*</span>qz, <span class="dv">2</span><span class="sc">*</span>qw<span class="sc">*</span>qw<span class="sc">+</span><span class="dv">2</span><span class="sc">*</span>qx<span class="sc">*</span>qx<span class="dv">-1</span>)</span>
<span id="cb57-600"><a href="#cb57-600" aria-hidden="true" tabindex="-1"></a>  pitch <span class="ot">=</span> <span class="fu">atan</span>(gravity[<span class="dv">1</span>]<span class="sc">/</span><span class="fu">sqrt</span>(gravity[<span class="dv">2</span>]<span class="sc">^</span><span class="dv">2</span><span class="sc">+</span>gravity[<span class="dv">3</span>]<span class="sc">^</span><span class="dv">2</span>))</span>
<span id="cb57-601"><a href="#cb57-601" aria-hidden="true" tabindex="-1"></a>  roll <span class="ot">=</span> <span class="fu">atan</span>(gravity[<span class="dv">2</span>]<span class="sc">/</span><span class="fu">sqrt</span>(gravity[<span class="dv">1</span>]<span class="sc">^</span><span class="dv">2</span><span class="sc">+</span>gravity[<span class="dv">3</span>]<span class="sc">^</span><span class="dv">2</span>))</span>
<span id="cb57-602"><a href="#cb57-602" aria-hidden="true" tabindex="-1"></a>  <span class="fu">return</span>(<span class="fu">c</span>(yaw, pitch, roll))</span>
<span id="cb57-603"><a href="#cb57-603" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb57-604"><a href="#cb57-604" aria-hidden="true" tabindex="-1"></a>g <span class="ot">=</span> <span class="fu">dmpGetGravity</span>(qcomb_body_to_lab<span class="sc">@</span>x)</span>
<span id="cb57-605"><a href="#cb57-605" aria-hidden="true" tabindex="-1"></a><span class="fu">dmpGetYawPitchRoll</span>(qcomb_body_to_lab<span class="sc">@</span>x, g)</span>
<span id="cb57-606"><a href="#cb57-606" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb57-607"><a href="#cb57-607" aria-hidden="true" tabindex="-1"></a>g <span class="ot">=</span> <span class="fu">dmpGetGravity</span>(qcomb_lab_to_body<span class="sc">@</span>x)</span>
<span id="cb57-608"><a href="#cb57-608" aria-hidden="true" tabindex="-1"></a><span class="fu">dmpGetYawPitchRoll</span>(qcomb_lab_to_body<span class="sc">@</span>x, g)</span>
<span id="cb57-609"><a href="#cb57-609" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb57-610"><a href="#cb57-610" aria-hidden="true" tabindex="-1"></a><span class="fu">c</span>(yaw, pitch, roll)</span>
<span id="cb57-611"><a href="#cb57-611" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb57-612"><a href="#cb57-612" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb57-613"><a href="#cb57-613" aria-hidden="true" tabindex="-1"></a><span class="fu">### Rotation between two quaternions.</span></span>
<span id="cb57-614"><a href="#cb57-614" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb57-615"><a href="#cb57-615" aria-hidden="true" tabindex="-1"></a>Consider the two IMUs (like the one on the thumb and the one on the palm), the orientation of the first (w.r.t. the laboratory system) is given by $q_1$ the orientation of the second by $q_2$. What is the rotation getting you from hand to palm. The questions is: which rotation $q_{12}$ translates between them. So we ask which $q_12$ fulfills</span>
<span id="cb57-616"><a href="#cb57-616" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb57-617"><a href="#cb57-617" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb57-618"><a href="#cb57-618" aria-hidden="true" tabindex="-1"></a>  q_2 = q_1 \; q_{12} </span>
<span id="cb57-619"><a href="#cb57-619" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb57-620"><a href="#cb57-620" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb57-621"><a href="#cb57-621" aria-hidden="true" tabindex="-1"></a>Just calculate the inverse of $q_1$ and you are done</span>
<span id="cb57-622"><a href="#cb57-622" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb57-623"><a href="#cb57-623" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb57-624"><a href="#cb57-624" aria-hidden="true" tabindex="-1"></a>  q_1^{-1} \; q_2 = q_{12}  </span>
<span id="cb57-625"><a href="#cb57-625" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb57-626"><a href="#cb57-626" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb57-627"><a href="#cb57-627" aria-hidden="true" tabindex="-1"></a><span class="fu">## Software package</span></span>
<span id="cb57-628"><a href="#cb57-628" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb57-629"><a href="#cb57-629" aria-hidden="true" tabindex="-1"></a>There are several software packages helping to deal with rotations and quaterions. Like the onion package in R.</span>
<span id="cb57-630"><a href="#cb57-630" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb57-631"><a href="#cb57-631" aria-hidden="true" tabindex="-1"></a><span class="fu">### The AHRS Python Package</span></span>
<span id="cb57-632"><a href="#cb57-632" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb57-633"><a href="#cb57-633" aria-hidden="true" tabindex="-1"></a>The AHRS package (https://ahrs.readthedocs.io/en/latest/index.html) used to estimate the rotation of a IMUs (sensors in e.g. cell phones and drones), uses quaternion as lot and also provides some basic operations.</span>
<span id="cb57-634"><a href="#cb57-634" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb57-635"><a href="#cb57-635" aria-hidden="true" tabindex="-1"></a><span class="in">```{python, echo=TRUE, eval=FALSE}</span></span>
<span id="cb57-636"><a href="#cb57-636" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> ahrs <span class="im">import</span> Quaternion</span>
<span id="cb57-637"><a href="#cb57-637" aria-hidden="true" tabindex="-1"></a>p <span class="op">=</span> Quaternion([<span class="fl">0.7071</span>, <span class="fl">0.0</span>, <span class="fl">0.7071</span>, <span class="fl">0.0</span>])</span>
<span id="cb57-638"><a href="#cb57-638" aria-hidden="true" tabindex="-1"></a>p </span>
<span id="cb57-639"><a href="#cb57-639" aria-hidden="true" tabindex="-1"></a>q <span class="op">=</span> Quaternion([<span class="dv">0</span>, <span class="fl">0.7071</span>, <span class="fl">0.0</span>, <span class="fl">0.7071</span>])</span>
<span id="cb57-640"><a href="#cb57-640" aria-hidden="true" tabindex="-1"></a>p <span class="op">*</span> q <span class="co">#0., 1., 0., 0.</span></span>
<span id="cb57-641"><a href="#cb57-641" aria-hidden="true" tabindex="-1"></a>q <span class="op">*</span> p <span class="co">#0., 0., 0., 1.</span></span>
<span id="cb57-642"><a href="#cb57-642" aria-hidden="true" tabindex="-1"></a>q.conj<span class="co">#0., -0.70710678, -0., -0.70710678</span></span>
<span id="cb57-643"><a href="#cb57-643" aria-hidden="true" tabindex="-1"></a>d <span class="op">=</span> q<span class="op">*</span>q.conj </span>
<span id="cb57-644"><a href="#cb57-644" aria-hidden="true" tabindex="-1"></a>d</span>
<span id="cb57-645"><a href="#cb57-645" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
</code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div></div></div></div></div>
</div> <!-- /content -->



</body></html>